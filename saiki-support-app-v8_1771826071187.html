<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{COMPANY_NAME}} ご葬儀サポート</title>
<style>
  /* ===================================================
     カラーパレット（CSS変数）
     primary  : ライムグリーン #7CB342
     secondary: 淡いピンク   #F48FB1
  =================================================== */
  :root {
    --clr-primary:     #7CB342;
    --clr-primary-d:   #558B2F;
    --clr-primary-l:   #9CCC65;
    --clr-primary-bg:  #F1F8E9;
    --clr-primary-lt:  #DCEDC8;
    --clr-pink:        #F48FB1;
    --clr-pink-d:      #E91E63;
    --clr-pink-bg:     #FCE4EC;
    --clr-pink-lt:     #F8BBD0;
    --clr-bg:          #F4FBF0;
    --clr-text:        #2E3A1F;
    --clr-text-sub:    #5A6A3A;
    --clr-border:      #C5E1A5;
    --clr-white:       #FFFFFF;
    --radius:          12px;
    --shadow:          0 4px 14px rgba(124,179,66,0.15);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Noto Sans JP', 'Hiragino Kaku Gothic Pro', Meiryo, sans-serif;
    background: var(--clr-bg);
    color: var(--clr-text);
    font-size: 16px;
    -webkit-text-size-adjust: 100%;
  }

  /* ===== ヘッダー ===== */
  .app-header {
    background: linear-gradient(135deg, var(--clr-primary-d) 0%, var(--clr-primary) 60%, #A5D66A 100%);
    color: #fff;
    padding: 18px 20px;
    text-align: center;
    box-shadow: 0 3px 12px rgba(85,139,47,0.35);
    position: relative;
    overflow: hidden;
  }
  .app-header::before {
    content: '';
    position: absolute; inset: 0;
    background: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.06'%3E%3Ccircle cx='20' cy='20' r='8'/%3E%3C/g%3E%3C/svg%3E");
  }
  .app-header h1 {
    font-size: 1.3rem;
    letter-spacing: 2px;
    text-shadow: 0 1px 3px rgba(0,0,0,0.2);
    position: relative;
  }
  .app-header p { font-size: 0.8rem; opacity: 0.9; margin-top: 4px; position: relative; }

  /* ===== ブランドヘッダー（ロゴ + タイトル） ===== */
  .brand-header {
    display: flex; align-items: center; justify-content: center;
    gap: 12px; flex-wrap: wrap;
    position: relative; z-index: 1;
  }
  .brand-logo-wrap { display: inline-flex; align-items: center; justify-content: center; }
  .brand-logo {
    height: 44px; width: auto;
    background: transparent;
    border-radius: 0;
    padding: 0;
    box-shadow: none;
    /* 透過っぽい見え方：背景チップを消しつつ、視認性だけ確保 */
    filter: drop-shadow(0 2px 6px rgba(0,0,0,0.25));
  }
  @media (max-width: 420px) {
    .brand-logo { height: 38px; }
  }

  /* ===== 音声入力案内バナー ===== */
  .voice-notice {
    background: linear-gradient(135deg, var(--clr-primary-bg), var(--clr-primary-lt));
    border: 2px solid var(--clr-primary);
    border-radius: 10px;
    padding: 14px 16px;
    margin: 12px 16px;
    line-height: 1.7;
    display: flex; align-items: center; gap: 10px;
  }
  .voice-notice .icon { font-size: 1.8rem; }
  .voice-notice .text { font-size: 0.85rem; color: var(--clr-primary-d); font-weight: bold; line-height: 1.5; }

  /* ===== プログレスバー ===== */
  .progress-bar {
    background: var(--clr-primary-lt);
    padding: 12px 16px;
    display: flex; gap: 6px; justify-content: flex-start; align-items: center;
    overflow-x: auto; scroll-behavior: smooth; -webkit-overflow-scrolling: touch;
  }
  .step-dot {
    width: 28px; height: 28px; border-radius: 50%;
    background: #C8E6C9; color: #fff; font-size: 0.7rem;
    display: flex; align-items: center; justify-content: center;
    font-weight: bold; flex-shrink: 0; transition: all 0.3s;
  }
  .step-dot.active {
    background: var(--clr-primary);
    box-shadow: 0 0 0 3px var(--clr-primary-lt), 0 0 0 5px var(--clr-primary);
    transform: scale(1.18);
  }
  .step-dot.done { background: var(--clr-primary-d); }
  .step-connector { width: 20px; height: 2px; background: #C8E6C9; flex-shrink: 0; transition: background 0.3s; }
  .step-connector.done { background: var(--clr-primary-d); }

  /* ===== ステップコンテンツ ===== */
  .step { display: none; padding: 20px 18px; }
  .step.active { display: block; }

  .step-title {
    font-size: 1.1rem; font-weight: bold; color: var(--clr-primary-d);
    margin-bottom: 16px; padding-bottom: 8px;
    border-bottom: 2.5px solid var(--clr-primary);
    display: flex; align-items: center; gap: 8px;
    position: relative;
  }
  .step-title .step-num {
    background: linear-gradient(135deg, var(--clr-primary), var(--clr-primary-d));
    color: #fff; width: 28px; height: 28px;
    border-radius: 50%; display: flex; align-items: center;
    justify-content: center; font-size: 0.85rem; flex-shrink: 0;
    box-shadow: 0 2px 6px rgba(124,179,66,0.4);
  }

  /* ===== フォーム要素 ===== */
  .form-group { margin-bottom: 18px; }
  .form-label { font-size: 0.9rem; font-weight: bold; color: var(--clr-primary-d); margin-bottom: 8px; display: block; }
  .form-input {
    width: 100%; padding: 12px; border: 2px solid var(--clr-border);
    border-radius: 8px; font-size: 0.95rem;
    background: #fff; transition: border-color 0.2s, box-shadow 0.2s;
  }
  .form-input:focus { outline: none; border-color: var(--clr-primary); box-shadow: 0 0 0 3px rgba(124,179,66,0.15); }
  .form-select {
    width: 100%; padding: 12px; border: 2px solid var(--clr-border);
    border-radius: 8px; font-size: 0.95rem;
    background: #fff; appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M0 0l6 8 6-8z' fill='%237CB342'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 12px center;
    cursor: pointer; transition: border-color 0.2s;
  }
  .form-select:focus { outline: none; border-color: var(--clr-primary); }

  /* ===== 選択ボタングループ ===== */
  .btn-group { display: flex; flex-direction: column; gap: 8px; }
  .btn-choice {
    width: 100%; padding: 14px 16px; border: 2px solid var(--clr-border);
    border-radius: 10px; background: #fff; cursor: pointer;
    text-align: left; font-size: 0.95rem; color: #333;
    transition: all 0.2s; display: flex; align-items: center; gap: 10px;
  }
  .btn-choice:hover { border-color: var(--clr-primary); background: var(--clr-primary-bg); }
  .btn-choice.selected {
    border-color: var(--clr-primary);
    background: linear-gradient(135deg, var(--clr-primary-bg), #E8F5E9);
    color: var(--clr-primary-d); font-weight: bold;
    box-shadow: 0 2px 8px rgba(124,179,66,0.2);
  }
  .btn-choice .choice-icon { font-size: 1.4rem; flex-shrink: 0; }
  .btn-choice .choice-text { flex: 1; }
  .btn-choice .choice-desc { font-size: 0.78rem; color: #888; margin-top: 2px; }
  .btn-choice.selected .choice-desc { color: var(--clr-primary); }
  .btn-choice .check-mark { display: none; color: var(--clr-primary); font-size: 1.2rem; }
  .btn-choice.selected .check-mark { display: block; }

  /* ===== プラン提案カード ===== */
  .plan-cards { display: flex; flex-direction: column; gap: 12px; margin-bottom: 16px; }
  .plan-card {
    border-radius: var(--radius); overflow: hidden;
    border: 2px solid var(--clr-border); background: #fff;
    transition: all 0.2s; cursor: pointer;
  }
  .plan-card:hover { border-color: var(--clr-primary); box-shadow: var(--shadow); }
  .plan-card.selected {
    border-color: var(--clr-primary);
    box-shadow: 0 4px 16px rgba(124,179,66,0.3);
  }
  .plan-card-badge {
    padding: 6px 14px; font-size: 0.78rem; font-weight: bold;
    display: flex; align-items: center; gap: 6px;
  }
  .badge-small { background: var(--clr-primary-bg); color: var(--clr-primary-d); }
  .badge-rec { background: linear-gradient(135deg, var(--clr-pink-lt), var(--clr-pink)); color: #880e4f; }
  .badge-large { background: var(--clr-pink-bg); color: #880e4f; }
  .plan-card-body { padding: 14px; }
  .plan-card-title { font-size: 1.05rem; font-weight: bold; color: #333; margin-bottom: 4px; }
  .plan-card-sub { font-size: 0.82rem; color: #888; margin-bottom: 8px; }
  .plan-card-desc { font-size: 0.85rem; color: #555; line-height: 1.6; }

  /* ===== ホールカード ===== */
  .hall-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
  @media (max-width: 400px) { .hall-cards { grid-template-columns: 1fr; } }
  .hall-card {
    border-radius: var(--radius); overflow: hidden;
    border: 2px solid var(--clr-border); background: #fff;
    cursor: pointer; transition: all 0.2s;
  }
  .hall-card:hover { border-color: var(--clr-primary); box-shadow: var(--shadow); }
  .hall-card.selected {
    border-color: var(--clr-primary);
    box-shadow: 0 4px 16px rgba(124,179,66,0.3);
  }
  .hall-card-img { width: 100%; height: 110px; object-fit: cover; }
  .hall-card-body { padding: 10px; }
  .hall-card-name { font-size: 0.85rem; font-weight: bold; color: #333; margin-bottom: 4px; }
  .hall-card-cap { font-size: 0.73rem; color: #888; margin-bottom: 3px; }
  .hall-card-addr { font-size: 0.7rem; color: #aaa; }
  .hall-recommended-badge {
    position: absolute; top: 6px; right: 6px;
    background: linear-gradient(135deg, var(--clr-pink), var(--clr-pink-d));
    color: #fff; font-size: 0.65rem;
    padding: 2px 6px; border-radius: 10px; font-weight: bold;
  }
  .hall-card-wrapper { position: relative; }
  .hall-selected-check {
    position: absolute; top: 6px; left: 6px; display: none;
    background: var(--clr-primary); color: #fff; width: 24px; height: 24px;
    border-radius: 50%; align-items: center; justify-content: center; font-size: 0.9rem;
  }
  .hall-card.selected .hall-selected-check { display: flex; }

  /* ===== コースカード ===== */
  .course-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
  @media (max-width: 400px) { .course-cards { grid-template-columns: 1fr; } }
  .course-card {
    border-radius: var(--radius); overflow: hidden;
    border: 2px solid var(--clr-border); background: #fff;
    cursor: pointer; transition: all 0.2s;
  }
  .course-card:hover { border-color: var(--clr-primary); box-shadow: var(--shadow); }
  .course-card.selected {
    border-color: var(--clr-pink);
    box-shadow: 0 4px 16px rgba(244,143,177,0.35);
  }
  .course-card-img { width: 100%; height: 130px; object-fit: cover; }
  .course-card-body { padding: 12px; }
  .course-card-name { font-size: 1rem; font-weight: bold; color: var(--clr-primary-d); margin-bottom: 4px; }
  .course-card-price { font-size: 0.82rem; color: #888; }
  .course-card-price .member-price { font-size: 1rem; font-weight: bold; color: var(--clr-primary); }
  .course-card-desc { font-size: 0.75rem; color: #888; margin-top: 4px; line-height: 1.5; }
  .course-selected-mark {
    display: none; text-align: center; padding: 4px;
    background: linear-gradient(90deg, var(--clr-primary-bg), var(--clr-pink-bg));
    font-size: 0.8rem; color: var(--clr-primary-d); font-weight: bold;
  }
  .course-card.selected .course-selected-mark { display: block; }

  /* ===== ナビボタン ===== */
  .nav-buttons { display: flex; gap: 10px; margin-top: 20px; }
  .btn-back {
    flex: 1; padding: 14px; border: 2px solid var(--clr-border);
    border-radius: 10px; background: #fff; color: var(--clr-primary-d);
    font-size: 1rem; cursor: pointer; font-weight: bold;
    transition: all 0.2s;
  }
  .btn-back:hover { background: var(--clr-primary-bg); border-color: var(--clr-primary); }
  .btn-next {
    flex: 2; padding: 14px; border: none;
    border-radius: 10px;
    background: linear-gradient(135deg, var(--clr-primary), var(--clr-primary-d));
    color: #fff; font-size: 1rem; cursor: pointer;
    font-weight: bold; transition: all 0.2s;
    box-shadow: 0 3px 8px rgba(124,179,66,0.4);
  }
  .btn-next:hover {
    background: linear-gradient(135deg, var(--clr-primary-l), var(--clr-primary));
    transform: translateY(-1px);
  }
  .btn-next:disabled { background: #C8E6C9; cursor: not-allowed; transform: none; box-shadow: none; }
  .btn-finish {
    flex: 2; padding: 14px; border: none;
    border-radius: 10px;
    background: linear-gradient(135deg, var(--clr-primary), var(--clr-primary-d));
    color: #fff; font-size: 1rem; cursor: pointer;
    font-weight: bold; transition: all 0.2s;
    box-shadow: 0 3px 8px rgba(124,179,66,0.4);
  }

  /* ===== テキストエリア ===== */
  .form-textarea {
    width: 100%; padding: 12px; border: 2px solid var(--clr-border);
    border-radius: 8px; font-size: 0.95rem; background: #fff;
    resize: vertical; min-height: 100px; font-family: inherit;
    transition: border-color 0.2s;
  }
  .form-textarea:focus { outline: none; border-color: var(--clr-primary); }

  /* ===== 見積もりカード ===== */
  .estimate-card {
    background: #fff; border-radius: 14px;
    border: 2px solid var(--clr-border); padding: 20px 18px;
    margin-bottom: 16px;
    box-shadow: var(--shadow);
  }
  .estimate-section-title {
    font-size: 1.05rem; font-weight: bold; color: var(--clr-primary-d);
    margin-bottom: 12px; padding-bottom: 8px;
    border-bottom: 2px solid var(--clr-primary-lt);
  }
  .estimate-row {
    display: flex; justify-content: space-between;
    align-items: flex-start; padding: 10px 0;
    border-bottom: 1px solid var(--clr-primary-bg); font-size: 1rem;
  }
  .estimate-row:last-child { border-bottom: none; }
  .estimate-label { color: #666; flex: 1; }
  .estimate-value { color: #333; font-weight: bold; text-align: right; flex-shrink: 0; word-break: keep-all; max-width: 55%; }
  .estimate-total {
    background: linear-gradient(135deg, var(--clr-primary), var(--clr-primary-d));
    color: #fff; padding: 16px; border-radius: 12px;
    margin-top: 14px; text-align: center;
    box-shadow: 0 4px 12px rgba(124,179,66,0.3);
  }
  .estimate-total-label { font-size: 0.85rem; opacity: 0.9; margin-bottom: 4px; }
  .estimate-total-price { font-size: 1.9rem; font-weight: bold; }
  .estimate-total-note { font-size: 0.73rem; opacity: 0.8; margin-top: 4px; }
  
  /* 総合計直下の警告 */
  .estimate-total-warning {
    margin-top: 10px;
    padding: 12px 14px;
    background: linear-gradient(135deg, #fff3e0, #ffe0b2);
    border: 2px solid #ff6f00;
    border-radius: 8px;
    text-align: left;
  }
  .estimate-total-warning-title {
    font-size: 0.95rem;
    font-weight: bold;
    color: #d84315;
    margin-bottom: 6px;
    text-align: center;
  }
  .estimate-total-warning-text {
    font-size: 0.85rem;
    color: #bf360c;
    line-height: 1.6;
    font-weight: 500;
  }

  /* ===== STEP8 完了画面 ===== */
  /* 紙吹雪アニメーション */
  @keyframes confettiFall {
    0%   { transform: translateY(-20px) rotate(0deg);  opacity: 1; }
    100% { transform: translateY(120px) rotate(360deg); opacity: 0; }
  }
  @keyframes confettiSway {
    0%,100% { margin-left: 0; }
    50%      { margin-left: 14px; }
  }
  @keyframes pulse-ring {
    0%   { transform: scale(0.85); box-shadow: 0 0 0 0 rgba(124,179,66,0.5); }
    70%  { transform: scale(1);    box-shadow: 0 0 0 16px rgba(124,179,66,0); }
    100% { transform: scale(0.85); box-shadow: 0 0 0 0  rgba(124,179,66,0); }
  }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(18px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  @keyframes heartbeat {
    0%,100% { transform: scale(1); }
    14%     { transform: scale(1.2); }
    28%     { transform: scale(1); }
    42%     { transform: scale(1.15); }
    70%     { transform: scale(1); }
  }

  .confetti-wrap {
    position: relative; height: 56px; overflow: hidden;
    margin-bottom: 4px; pointer-events: none;
  }
  .confetti-piece {
    position: absolute; top: -10px; width: 8px; height: 8px;
    border-radius: 2px;
    animation: confettiFall 1.8s ease-in infinite, confettiSway 1.2s ease-in-out infinite;
  }

  .complete-card {
    background: linear-gradient(160deg, var(--clr-primary-bg) 0%, #fff 40%, var(--clr-pink-bg) 100%);
    border-radius: 20px;
    border: 2.5px solid var(--clr-primary);
    padding: 28px 22px 22px;
    text-align: center; margin-bottom: 18px;
    box-shadow: 0 8px 32px rgba(124,179,66,0.18), 0 2px 8px rgba(244,143,177,0.15);
    animation: fadeInUp 0.6s ease both;
  }
  .complete-icon {
    font-size: 3.6rem; margin-bottom: 10px;
    display: inline-block;
    animation: heartbeat 2.4s ease-in-out infinite;
  }
  .complete-badge {
    display: inline-block;
    background: linear-gradient(135deg, var(--clr-primary), var(--clr-primary-d));
    color: #fff; font-size: 0.72rem; font-weight: bold;
    padding: 4px 14px; border-radius: 20px; letter-spacing: 1px;
    margin-bottom: 12px;
    box-shadow: 0 2px 8px rgba(124,179,66,0.3);
  }
  .complete-title {
    font-size: 1.45rem; font-weight: bold;
    background: linear-gradient(135deg, var(--clr-primary-d), var(--clr-pink-d));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 10px; line-height: 1.4;
  }
  .complete-subtitle {
    font-size: 0.9rem; color: var(--clr-primary-d); font-weight: bold;
    margin-bottom: 14px; opacity: 0.85;
  }
  .complete-divider {
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--clr-primary-lt), var(--clr-pink-lt), transparent);
    margin: 14px 0;
    border-radius: 1px;
  }
  .complete-text {
    font-size: 0.9rem; color: #555; line-height: 1.9;
    background: rgba(255,255,255,0.7); border-radius: 10px;
    padding: 14px; margin-top: 4px;
  }
  .complete-phone {
    display: inline-flex; align-items: center; gap: 8px;
    background: linear-gradient(135deg, var(--clr-primary), var(--clr-primary-d));
    color: #fff; font-size: 1.15rem; font-weight: bold;
    padding: 10px 22px; border-radius: 30px; margin: 10px 0;
    box-shadow: 0 4px 12px rgba(124,179,66,0.35);
    text-decoration: none;
  }
  .complete-hours { font-size: 0.78rem; color: var(--clr-primary-d); margin-top: 4px; opacity: 0.8; }

  /* STEP8 アクションボタン */
  .step8-actions {
    display: flex; flex-direction: column; gap: 12px;
    margin: 20px 0 10px;
    animation: fadeInUp 0.8s ease 0.3s both;
  }
  .step8-actions-title {
    text-align: center; font-size: 0.88rem; font-weight: bold;
    color: var(--clr-primary-d); margin-bottom: 4px;
    display: flex; align-items: center; justify-content: center; gap: 6px;
  }
  .btn-s8 {
    display: flex; align-items: center; justify-content: center; gap: 10px;
    padding: 16px 20px; border: none; border-radius: 14px;
    font-size: 1.05rem; font-weight: bold; letter-spacing: 0.04em;
    cursor: pointer; width: 100%; min-height: 58px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.14);
    transition: transform 0.15s, box-shadow 0.15s;
    text-decoration: none;
  }
  .btn-s8:active { transform: scale(0.97); box-shadow: 0 2px 6px rgba(0,0,0,0.12); }
  .btn-s8 .s8-icon { font-size: 1.5rem; flex-shrink: 0; }
  .btn-s8 .s8-label { display: flex; flex-direction: column; align-items: flex-start; line-height: 1.3; }
  .btn-s8 .s8-main { font-size: 1.05rem; font-weight: bold; }
  .btn-s8 .s8-sub  { font-size: 0.78rem; opacity: 0.88; font-weight: normal; }

  .btn-s8-line  { background: linear-gradient(135deg, #00B900, #008000); color: #fff; }
  .btn-s8-sms   { background: linear-gradient(135deg, var(--clr-primary), var(--clr-primary-d)); color: #fff; }
  .btn-s8-pdf   { background: linear-gradient(135deg, #EF5350, #B71C1C); color: #fff; }
  .btn-s8-restart {
    background: linear-gradient(135deg, var(--clr-pink-lt), var(--clr-pink));
    color: #4a148c; border: none;
  }

  /* ===== 情報ボックス ===== */
  /* ===== 強調警告ボックス（正式見積もりではない注意） ===== */
  .warning-box-strong {
    background: linear-gradient(135deg, #fff3e0, #ffe0b2);
    border: 3px solid #ff6f00;
    border-radius: 12px;
    padding: 18px 16px;
    margin: 16px 0;
    box-shadow: 0 4px 12px rgba(255, 111, 0, 0.25);
    animation: warning-pulse 2s ease-in-out infinite;
  }
  
  @keyframes warning-pulse {
    0%, 100% { box-shadow: 0 4px 12px rgba(255, 111, 0, 0.25); }
    50% { box-shadow: 0 4px 16px rgba(255, 111, 0, 0.4), 0 0 0 4px rgba(255, 111, 0, 0.1); }
  }
  
  .warning-box-strong .warning-icon {
    font-size: 2.5rem;
    text-align: center;
    margin-bottom: 8px;
    animation: warning-shake 3s ease-in-out infinite;
  }
  
  @keyframes warning-shake {
    0%, 100% { transform: rotate(0deg); }
    10%, 30%, 50%, 70%, 90% { transform: rotate(-5deg); }
    20%, 40%, 60%, 80% { transform: rotate(5deg); }
  }
  
  .warning-box-strong .warning-title {
    font-size: 1.15rem;
    font-weight: bold;
    color: #e65100;
    text-align: center;
    margin-bottom: 10px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }
  
  .warning-box-strong .warning-content {
    font-size: 0.95rem;
    color: #bf360c;
    line-height: 1.8;
    background: rgba(255, 255, 255, 0.7);
    padding: 12px;
    border-radius: 8px;
    font-weight: 500;
  }
  
  .warning-box-strong .warning-emphasis {
    display: block;
    font-size: 1.05rem;
    font-weight: bold;
    color: #d84315;
    margin-top: 10px;
    text-align: center;
    padding: 8px;
    background: rgba(255, 111, 0, 0.15);
    border-radius: 6px;
    border: 2px dashed #ff6f00;
  }

  .info-box {
    background: linear-gradient(135deg, var(--clr-primary-bg), var(--clr-pink-bg));
    border: 1px solid var(--clr-primary-lt);
    border-radius: 8px; padding: 14px; margin-top: 12px;
    font-size: 0.92rem; color: #666; line-height: 1.8;
  }

  /* ===== ホール詳細 ===== */
  .selected-hall-detail {
    background: var(--clr-primary-bg); border-radius: 8px;
    padding: 12px; margin-top: 12px;
    border: 1px solid var(--clr-border); font-size: 0.83rem;
    color: #666; line-height: 1.7;
  }

  /* ===== エラー表示 ===== */
  .error-msg { color: #E53935; font-size: 0.8rem; margin-top: 4px; display: none; }
  .required  { color: #E53935; margin-left: 4px; }

  /* ===== 選択サマリー ===== */
  .selection-summary {
    background: var(--clr-primary-bg); border-radius: 8px; padding: 10px 14px;
    margin-bottom: 14px; font-size: 0.82rem; color: var(--clr-primary-d);
    border-left: 3px solid var(--clr-primary);
  }

  /* ===== やすらぎリビング特別バッジ ===== */
  .living-badge {
    display: inline-block; background: var(--clr-primary-bg); color: var(--clr-primary-d);
    font-size: 0.7rem; padding: 2px 8px; border-radius: 10px;
    font-weight: bold; margin-top: 4px;
  }

  .hall-all-btn {
    width: 100%; padding: 12px; border: 2px dashed var(--clr-border);
    border-radius: 10px; background: #fafafa; cursor: pointer;
    text-align: center; font-size: 0.9rem; color: var(--clr-primary-d);
    transition: all 0.2s; margin-top: 8px; font-weight: bold;
  }
  .hall-all-btn:hover { background: var(--clr-primary-bg); border-color: var(--clr-primary); }

  /* ===== プランタイプラベル ===== */
  .plan-type-tag {
    display: inline-block; font-size: 0.7rem; padding: 2px 8px;
    border-radius: 10px; font-weight: bold; margin-left: 6px;
  }
  .tag-compact { background: var(--clr-primary-bg);  color: var(--clr-primary-d); }
  .tag-living  { background: #E8F5E9; color: #2E7D32; }
  .tag-family  { background: #FFF3E0; color: #E65100; }
  .tag-normal  { background: var(--clr-pink-bg);     color: #880E4F; }

  /* ===== チャットボット ===== */
  .chat-window {
    background: var(--clr-primary-bg); border-radius: 14px; overflow: hidden;
    border: 2px solid var(--clr-border); margin-bottom: 14px;
    display: flex; flex-direction: column; height: 380px;
  }
  .chat-header {
    background: linear-gradient(135deg, var(--clr-primary), var(--clr-primary-d));
    color: #fff; padding: 10px 14px;
    display: flex; align-items: center; gap: 8px;
    font-size: 0.88rem; font-weight: bold; flex-shrink: 0;
  }
  .chat-header .bot-avatar {
    width: 30px; height: 30px; border-radius: 50%;
    background: #fff; display: flex; align-items: center;
    justify-content: center; font-size: 1rem;
  }
  .chat-messages {
    flex: 1; overflow-y: auto; padding: 12px;
    display: flex; flex-direction: column; gap: 10px;
  }
  .chat-msg { display: flex; gap: 8px; align-items: flex-end; max-width: 88%; }
  .chat-msg.bot  { align-self: flex-start; }
  .chat-msg.user { align-self: flex-end; flex-direction: row-reverse; }
  .msg-avatar {
    width: 28px; height: 28px; border-radius: 50%;
    background: var(--clr-primary); color: #fff; font-size: 0.8rem;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  }
  .msg-avatar.user-av { background: var(--clr-primary-d); }
  .msg-bubble {
    padding: 10px 13px; border-radius: 16px;
    font-size: 0.88rem; line-height: 1.6; max-width: 100%;
  }
  .bot  .msg-bubble {
    background: #fff; color: #333;
    border-bottom-left-radius: 4px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  }
  .user .msg-bubble {
    background: linear-gradient(135deg, var(--clr-primary), var(--clr-primary-d));
    color: #fff; border-bottom-right-radius: 4px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  }
  .chat-typing {
    display: none; align-self: flex-start;
    padding: 8px 14px; background: #fff; border-radius: 16px;
    border-bottom-left-radius: 4px; font-size: 0.82rem; color: #999;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  }
  .chat-typing.show { display: block; }
  .typing-dots { display: inline-flex; gap: 3px; }
  .typing-dots span {
    width: 6px; height: 6px; background: #bbb; border-radius: 50%;
    animation: typingBounce 1.2s infinite;
  }
  .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
  .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes typingBounce {
    0%,60%,100% { transform: translateY(0); }
    30%          { transform: translateY(-5px); }
  }
  /* クイックリプライ */
  .quick-replies {
    padding: 8px 12px; display: flex; flex-wrap: wrap;
    gap: 6px; background: #fff; border-top: 1px solid var(--clr-primary-lt);
    flex-shrink: 0;
  }
  .quick-reply-btn {
    padding: 6px 12px; border: 1.5px solid var(--clr-primary);
    border-radius: 20px; background: #fff; color: var(--clr-primary-d);
    font-size: 0.78rem; cursor: pointer; font-weight: bold;
    transition: all 0.2s; white-space: nowrap;
  }
  .quick-reply-btn:hover { background: var(--clr-primary-bg); }
  /* チャット入力エリア */
  .chat-input-area {
    display: flex; gap: 6px; padding: 8px 12px;
    background: #fff; border-top: 2px solid var(--clr-primary-lt);
    flex-shrink: 0; align-items: center;
  }
  .chat-input {
    flex: 1; padding: 8px 12px; border: 2px solid var(--clr-border);
    border-radius: 20px; font-size: 0.9rem;
    outline: none; font-family: inherit; resize: none;
    max-height: 80px; line-height: 1.4;
  }
  .chat-input:focus { border-color: var(--clr-primary); }
  .chat-send-btn {
    width: 36px; height: 36px; border: none;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--clr-primary), var(--clr-primary-d));
    color: #fff; font-size: 1rem; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; transition: all 0.2s;
  }
  .chat-send-btn:hover { transform: scale(1.08); }
  .chat-send-btn:disabled { background: #C8E6C9; cursor: not-allowed; }
  /* チャット完了バナー */
  .chat-done-banner {
    display: none; background: var(--clr-primary-bg); border: 2px solid var(--clr-primary);
    border-radius: 10px; padding: 10px 14px; margin-bottom: 10px;
    font-size: 0.85rem; color: var(--clr-primary-d); font-weight: bold;
  }
  .chat-done-banner.show { display: block; }

  /* ===== 写真イメージ注記 ===== */
  .image-notice {
    background: var(--clr-primary-bg); border: 1px solid var(--clr-primary-lt);
    border-radius: 8px; padding: 8px 12px;
    font-size: 0.78rem; color: var(--clr-primary-d);
    margin-bottom: 10px; text-align: center; font-weight: bold;
  }

  /* ===== 当日入会バッジ ===== */
  .join-badge {
    display: inline-block; background: var(--clr-pink-bg); color: var(--clr-pink-d);
    font-size: 0.68rem; padding: 1px 6px; border-radius: 8px;
    font-weight: bold; margin-left: 4px; border: 1px solid var(--clr-pink-lt);
  }

  /* ===== 印刷用スタイル ===== */
  @media print {
    body { background: #fff !important; }

    /* 画面用UIは非表示（A4用に情報だけ残す） */
    .app-header, .voice-notice, .progress-bar, .nav-buttons,
    .btn-finish, .step:not(#step8), .chat-window,
    .chat-input-area, .quick-replies, #autoSaveBanner,
    .confetti-wrap, .step8-actions, .flow-section, .submit-result-banner,
    .complete-card { display: none !important; }

    #step8 { display: block !important; }
    .print-header { display: block !important; }
.print-summary { display: block !important; }
    .no-print { display: none !important; }

    /* A4見やすさ強化 */
    #finalSummary { font-size: 12px !important; line-height: 1.75 !important; border: 2px solid #999 !important; }
    #finalSummary table { width: 100% !important; border-collapse: collapse !important; }
    #finalSummary td { padding: 4px 0 !important; vertical-align: top !important; }
    #finalSummary strong { font-weight: 900 !important; }

    /* チャット履歴は2ページ目から */
.pdf-chat-row { break-inside: avoid; page-break-inside: avoid; }

    .pdf-chat-bubble-bot  { background: #f5f5f5 !important; }
    .pdf-chat-bubble-user { background: var(--clr-primary-lt) !important; }

    

    /* ★1枚に収めるため：チャット履歴は印刷しない */
    .print-chat-log, #printChatLog { display: none !important; }

    /* ★A4 1枚用に詰める */
    body { font-size: 11px !important; line-height: 1.55 !important; }
    .print-header h2 { font-size: 14px !important; letter-spacing: 1px !important; }
    .print-header p { font-size: 10px !important; }
    #finalSummary { font-size: 11px !important; line-height: 1.6 !important; padding: 10px !important; margin-bottom: 0 !important; }
    #finalSummary td { padding: 2px 0 !important; }

    @page { margin: 15mm; size: A4; }
  }

  /* ===== 印刷専用ヘッダー ===== */
  .print-header {
    display: none; text-align: center; padding: 16px 0 10px;
    border-bottom: 2px solid var(--clr-primary); margin-bottom: 14px;
  }
  .print-header h2 { font-size: 1.2rem; color: var(--clr-primary-d); letter-spacing: 2px; }
  .print-header p  { font-size: 0.78rem; color: #888; margin-top: 4px; }

  /* ===== チャット履歴PDF用 ===== */
  .print-chat-log {
    display: none;
    background: var(--clr-primary-bg); border: 2px solid var(--clr-border);
    border-radius: 12px; padding: 16px; margin-bottom: 14px;
  }
  .print-chat-log-title {
    font-size: 0.95rem; font-weight: bold; color: var(--clr-primary-d);
    margin-bottom: 12px; padding-bottom: 6px;
    border-bottom: 2px solid var(--clr-primary);
    display: flex; align-items: center; gap: 6px;
  }
  .pdf-chat-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: flex-start; }
  .pdf-chat-row.user-row { flex-direction: row-reverse; }
  .pdf-chat-label {
    font-size: 0.72rem; font-weight: bold; white-space: nowrap;
    padding-top: 3px; color: #888; flex-shrink: 0;
  }
  .pdf-chat-row.user-row .pdf-chat-label { color: var(--clr-primary-d); }
  .pdf-chat-bubble-bot {
    background: #fff; border: 1px solid var(--clr-border);
    border-radius: 12px; border-bottom-left-radius: 3px;
    padding: 8px 12px; font-size: 0.85rem; line-height: 1.65;
    color: #333; max-width: 82%;
  }
  .pdf-chat-bubble-user {
    background: var(--clr-primary-lt); border: 1px solid var(--clr-primary);
    border-radius: 12px; border-bottom-right-radius: 3px;
    padding: 8px 12px; font-size: 0.85rem; line-height: 1.65;
    color: var(--clr-primary-d); font-weight: bold; max-width: 82%;
  }
  .pdf-chat-time { font-size: 0.68rem; color: #bbb; margin-top: 2px; text-align: right; }
  .pdf-chat-row.user-row .pdf-chat-time { text-align: left; }

  /* ===== FAQパネル ===== */
  .faq-panel {
    background: #fff; border: 2px solid var(--clr-border);
    border-radius: 14px; margin-bottom: 12px; overflow: hidden;
  }
  .faq-panel-header {
    background: linear-gradient(135deg, var(--clr-primary-bg), var(--clr-primary-lt));
    padding: 10px 14px; display: flex; align-items: center;
    justify-content: space-between; cursor: pointer; user-select: none;
  }
  .faq-panel-header-left {
    display: flex; align-items: center; gap: 8px;
    font-size: 0.88rem; font-weight: bold; color: var(--clr-primary-d);
  }
  .faq-toggle-icon { font-size: 0.75rem; color: var(--clr-primary); transition: transform 0.3s; }
  .faq-toggle-icon.open { transform: rotate(180deg); }
  .faq-body { display: none; padding: 10px 12px 12px; }
  .faq-body.open { display: block; }
  .faq-category { margin-bottom: 10px; }
  .faq-category-label {
    font-size: 0.75rem; font-weight: bold; color: var(--clr-primary-d);
    margin-bottom: 6px; padding: 3px 8px;
    background: var(--clr-primary-bg); border-radius: 6px; display: inline-block;
  }
  .faq-items { display: flex; flex-wrap: wrap; gap: 6px; }
  .faq-btn {
    padding: 7px 12px; border: 1.5px solid var(--clr-primary);
    border-radius: 20px; background: #fff; color: var(--clr-primary-d);
    font-size: 0.78rem; cursor: pointer; font-weight: bold;
    transition: all 0.2s; display: flex; align-items: center; gap: 4px;
  }
  .faq-btn:hover {
    background: var(--clr-primary-bg); border-color: var(--clr-primary-d);
    transform: translateY(-1px); box-shadow: 0 2px 6px rgba(124,179,66,0.2);
  }
  .faq-btn .faq-icon { font-size: 0.9rem; }
  .faq-btn.used { background: var(--clr-primary-bg); border-color: var(--clr-primary); color: var(--clr-primary-d); cursor: default; }
  .faq-btn.used:hover { transform: none; box-shadow: none; }

  /* FAQ提案バナー */
  .chat-faq-suggest {
    background: linear-gradient(135deg, var(--clr-primary-bg), #fff);
    border: 1.5px solid var(--clr-primary-lt);
    border-radius: 10px; padding: 8px 10px;
    margin: 6px 0 2px; font-size: 0.78rem; color: var(--clr-primary-d);
  }
  .chat-faq-suggest-title { font-weight: bold; margin-bottom: 5px; display: flex; align-items: center; gap: 4px; }
  .chat-faq-suggest-btns { display: flex; flex-wrap: wrap; gap: 5px; }
  .chat-faq-suggest-btn {
    padding: 5px 10px; border: 1.5px solid var(--clr-primary);
    border-radius: 16px; background: #fff; color: var(--clr-primary-d);
    font-size: 0.75rem; cursor: pointer; font-weight: bold; transition: all 0.18s;
  }
  .chat-faq-suggest-btn:hover { background: var(--clr-primary-bg); }

  /* FAQ回答バブル */
  .faq-answer-bubble {
    background: #fffeff; border: 1px solid var(--clr-primary-lt);
    border-radius: 12px; border-bottom-left-radius: 3px;
    padding: 10px 13px; font-size: 0.85rem; line-height: 1.7;
    color: #333; max-width: 100%;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  }
  .faq-answer-bubble strong { color: var(--clr-primary-d); }
  .faq-answer-badge {
    display: inline-block; font-size: 0.68rem;
    background: var(--clr-primary-bg); color: var(--clr-primary-d);
    border: 1px solid var(--clr-primary-lt); border-radius: 8px;
    padding: 1px 6px; margin-bottom: 4px; font-weight: bold;
  }

  /* ===== 送信処理UI ===== */
  .submit-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.55); z-index: 9999;
    align-items: center; justify-content: center;
    flex-direction: column; gap: 14px;
  }
  .submit-overlay.show { display: flex; }
  .submit-spinner {
    width: 52px; height: 52px; border: 5px solid var(--clr-primary-lt);
    border-top-color: var(--clr-primary); border-radius: 50%;
    animation: spin 0.9s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .submit-overlay-text { color: #fff; font-size: 1.05rem; font-weight: bold; }
  .submit-result-banner {
    display: none; margin: 12px 0; padding: 14px 16px;
    border-radius: 10px; font-size: 0.9rem; line-height: 1.7; text-align: center;
  }
  .submit-result-banner.success { display: block; background: var(--clr-primary-bg); border: 2px solid var(--clr-primary); color: var(--clr-primary-d); }
  .submit-result-banner.error   { display: block; background: #fce4ec; border: 2px solid #ef9a9a; color: #b71c1c; }

  /* ===== 見積もりアクションボタン ===== */
  .estimate-action-buttons { display: flex; flex-direction: column; gap: 12px; margin: 20px 0 10px; }
  .btn-estimate-action {
    display: flex; align-items: center; justify-content: center; gap: 8px;
    padding: 16px 20px; border: none; border-radius: 14px;
    font-size: 1.05rem; font-weight: bold; letter-spacing: 0.05em;
    cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.18);
    transition: transform 0.15s, box-shadow 0.15s;
    width: 100%; min-height: 56px; text-decoration: none;
  }
  .btn-estimate-action:active { transform: scale(0.97); box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
  .btn-pdf   { background: linear-gradient(135deg, #E53935, #B71C1C); color: #fff; }
  .btn-line  { background: linear-gradient(135deg, #00C300, #008000); color: #fff; }
  .btn-copy  { background: linear-gradient(135deg, #FF8F00, #E65100); color: #fff; }
  .btn-email { background: linear-gradient(135deg, #1565C0, #0D47A1); color: #fff; }
  .btn-estimate-action .btn-icon { font-size: 1.4rem; flex-shrink: 0; }
  .btn-estimate-action .btn-label { display: flex; flex-direction: column; align-items: flex-start; line-height: 1.3; }
  .btn-estimate-action .btn-label-main { font-size: 1.05rem; font-weight: bold; }
  .btn-estimate-action .btn-label-sub  { font-size: 0.80rem; opacity: 0.9; font-weight: normal; letter-spacing: 0.02em; }
  #estimateEmailBanner { margin: 10px 0; padding: 12px 14px; border-radius: 10px; font-size: 0.88rem; text-align: center; display: none; }
  .email-banner-success { background: var(--clr-primary-bg); color: var(--clr-primary-d); border: 1.5px solid var(--clr-primary); }
  .email-banner-error   { background: #fff5f5; color: #c62828; border: 1.5px solid #e53935; }

  /* ===== スマホ向け追加改善 ===== */
  @media (max-width: 480px) {
    .step { padding: 18px 14px; }
    .estimate-card { padding: 16px 13px; margin-bottom: 14px; }
    .estimate-row { padding: 10px 0; font-size: 0.97rem; }
    .estimate-total-price { font-size: 1.85rem; }
    /* ===== 強調警告ボックス（正式見積もりではない注意） ===== */
  .warning-box-strong {
    background: linear-gradient(135deg, #fff3e0, #ffe0b2);
    border: 3px solid #ff6f00;
    border-radius: 12px;
    padding: 18px 16px;
    margin: 16px 0;
    box-shadow: 0 4px 12px rgba(255, 111, 0, 0.25);
    animation: warning-pulse 2s ease-in-out infinite;
  }
  
  @keyframes warning-pulse {
    0%, 100% { box-shadow: 0 4px 12px rgba(255, 111, 0, 0.25); }
    50% { box-shadow: 0 4px 16px rgba(255, 111, 0, 0.4), 0 0 0 4px rgba(255, 111, 0, 0.1); }
  }
  
  .warning-box-strong .warning-icon {
    font-size: 2.5rem;
    text-align: center;
    margin-bottom: 8px;
    animation: warning-shake 3s ease-in-out infinite;
  }
  
  @keyframes warning-shake {
    0%, 100% { transform: rotate(0deg); }
    10%, 30%, 50%, 70%, 90% { transform: rotate(-5deg); }
    20%, 40%, 60%, 80% { transform: rotate(5deg); }
  }
  
  .warning-box-strong .warning-title {
    font-size: 1.15rem;
    font-weight: bold;
    color: #e65100;
    text-align: center;
    margin-bottom: 10px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }
  
  .warning-box-strong .warning-content {
    font-size: 0.95rem;
    color: #bf360c;
    line-height: 1.8;
    background: rgba(255, 255, 255, 0.7);
    padding: 12px;
    border-radius: 8px;
    font-weight: 500;
  }
  
  .warning-box-strong .warning-emphasis {
    display: block;
    font-size: 1.05rem;
    font-weight: bold;
    color: #d84315;
    margin-top: 10px;
    text-align: center;
    padding: 8px;
    background: rgba(255, 111, 0, 0.15);
    border-radius: 6px;
    border: 2px dashed #ff6f00;
  }

  .info-box { font-size: 0.88rem; padding: 14px 12px; line-height: 1.8; }
    .btn-estimate-action { padding: 15px 16px; font-size: 1rem; min-height: 58px; }
    .estimate-section-title { font-size: 1rem; margin: 16px 0 8px; }
    .btn-s8 { padding: 14px 16px; font-size: 1rem; min-height: 56px; }
    .complete-title { font-size: 1.25rem; }
  }

  /* ===== 最初に戻るボタン ===== */
  .restart-btn-wrap { text-align: center; margin-top: 10px; margin-bottom: 4px; }
  .btn-restart-top {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 10px 24px; background: transparent;
    color: var(--clr-primary-d); border: 2px solid var(--clr-border);
    border-radius: 20px; font-size: 0.88rem; font-weight: bold;
    cursor: pointer; transition: background .15s, color .15s;
  }
  .btn-restart-top:hover { background: var(--clr-primary-bg); border-color: var(--clr-primary); }

  /* ===== STEP3〜7: 右上「最初に戻る」ボタン ===== */
  .step-title { position: relative; }
  .btn-restart-topright {
    position: absolute; top: 50%; right: 0; transform: translateY(-50%);
    display: inline-flex; align-items: center; gap: 4px;
    padding: 5px 10px; background: rgba(255,255,255,0.9);
    color: var(--clr-primary-d); border: 1.5px solid var(--clr-border);
    border-radius: 16px; font-size: 0.75rem; font-weight: bold;
    cursor: pointer; white-space: nowrap;
    box-shadow: 0 2px 6px rgba(124,179,66,0.15);
    transition: background .15s, color .15s, border-color .15s; z-index: 10;
  }
  .btn-restart-topright:active { background: var(--clr-primary-bg); border-color: var(--clr-primary); }
  .step-title-text { display: inline-block; padding-right: 90px; }

  /* ===== SMS button (STEP7) ===== */
  .btn-sms { background: linear-gradient(135deg, var(--clr-primary), var(--clr-primary-d)); color: #fff; }
  .btn-sms:hover { background: linear-gradient(135deg, var(--clr-primary-l), var(--clr-primary)); transform: translateY(-2px); }

  /* ===== 葬儀の流れ タイムライン (追加) ===== */
  .flow-section {
    margin-top: 24px;
    padding: 0 4px;
  }
  .flow-section-title {
    text-align: center;
    font-size: 1.05rem;
    font-weight: 800;
    color: var(--clr-primary-d);
    margin-bottom: 20px;
    padding: 12px 16px;
    background: linear-gradient(135deg, var(--clr-primary-bg), #fff);
    border-radius: 10px;
    border-left: 4px solid var(--clr-primary);
    letter-spacing: 0.05em;
  }
  .flow-phase-label {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 16px 0 12px -4px;
  }
  .flow-phase-badge {
    background: var(--clr-primary-d);
    color: #fff;
    font-size: 0.72rem;
    font-weight: 700;
    padding: 3px 12px;
    border-radius: 12px;
    letter-spacing: 0.08em;
    white-space: nowrap;
  }
  .flow-phase-line {
    flex: 1;
    height: 1px;
    background: var(--clr-primary-lt);
  }
  .flow-timeline {
    position: relative;
    padding-left: 52px;
  }
  .flow-timeline::before {
    content: '';
    position: absolute;
    left: 18px;
    top: 0;
    bottom: 0;
    width: 3px;
    background: linear-gradient(to bottom, var(--clr-primary-d), var(--clr-primary), var(--clr-primary-l));
    border-radius: 2px;
  }
  .flow-item {
    position: relative;
    margin-bottom: 16px;
  }
  .flow-item:last-child { margin-bottom: 0; }
  .flow-badge {
    position: absolute;
    left: -44px;
    top: 8px;
    width: 34px;
    height: 34px;
    background: var(--clr-primary-d);
    color: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.62rem;
    font-weight: 800;
    border: 3px solid #fff;
    box-shadow: 0 2px 8px rgba(85,139,47,0.3);
    z-index: 1;
    flex-direction: column;
    line-height: 1;
  }
  .flow-badge .badge-num { font-size: 0.6rem; opacity: 0.85; }
  .flow-card {
    background: #fff;
    border-radius: 10px;
    padding: 11px 13px;
    border: 1px solid var(--clr-primary-lt);
    box-shadow: 0 2px 6px rgba(124,179,66,0.08);
  }
  .flow-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 5px;
    flex-wrap: wrap;
  }
  .flow-icon { font-size: 1.2rem; }
  .flow-title {
    font-size: 0.92rem;
    font-weight: 700;
    color: var(--clr-primary-d);
    flex: 1;
  }
  .flow-timing {
    font-size: 0.68rem;
    background: var(--clr-primary);
    color: #fff;
    padding: 2px 8px;
    border-radius: 10px;
    white-space: nowrap;
    font-weight: 600;
  }
  .flow-desc {
    font-size: 0.79rem;
    color: #444;
    line-height: 1.6;
  }
  .flow-note {
    margin-top: 5px;
    padding: 5px 9px;
    background: var(--clr-primary-bg);
    border-radius: 6px;
    font-size: 0.74rem;
    color: var(--clr-primary-d);
    font-weight: 600;
  }
  .flow-after-section {
    margin-top: 14px;
    padding: 13px;
    background: linear-gradient(135deg, var(--clr-primary-d), #3d6b1c);
    border-radius: 12px;
    color: #fff;
    text-align: center;
  }
  .flow-after-section .after-title {
    font-size: 0.88rem;
    font-weight: 700;
    margin-bottom: 8px;
    color: #d4f0a0;
  }
  .flow-after-items {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    justify-content: center;
  }
  .flow-after-tag {
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(255,255,255,0.3);
    color: #fff;
    font-size: 0.72rem;
    padding: 3px 9px;
    border-radius: 10px;
  }
  .flow-phone-cta {
    margin-top: 18px;
    background: linear-gradient(135deg, var(--clr-primary), var(--clr-primary-d));
    border-radius: 13px;
    padding: 14px;
    text-align: center;
    box-shadow: 0 4px 14px rgba(124,179,66,0.3);
  }
  .flow-phone-cta .cta-text {
    font-size: 0.8rem;
    color: rgba(255,255,255,0.9);
    margin-bottom: 6px;
    font-weight: 600;
  }
  .flow-phone-cta a {
    display: inline-block;
    font-size: 1.25rem;
    font-weight: 800;
    color: #fff;
    text-decoration: none;
    letter-spacing: 0.05em;
  }
  .flow-phone-cta .cta-sub {
    font-size: 0.7rem;
    color: rgba(255,255,255,0.75);
    margin-top: 3px;
  }

/* ===== Brand: no logo header ===== */
.top-brand-name{margin:0;font-size:22px;letter-spacing:.02em;font-weight:900;}
.top-brand-sub{margin-top:4px;font-size:14px;font-weight:800;opacity:.95;}
@media (max-width:480px){.top-brand-name{font-size:20px}.top-brand-sub{font-size:13px}}

</style>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <!-- Google Analytics GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-XXXXXXXXXX', {
      send_page_view: true,
      page_title: '{{COMPANY_NAME}} ご葬儀サポート',
      page_path: '/funeral-support'
    });

    // ============================================================
    // GA4 カスタムイベント送信ヘルパー
    // ============================================================
    const STEP_LABELS = {
      1: '基本情報入力',
      2: '人数・葬儀形式',
      3: 'プラン選択',
      4: '式場選択',
      5: 'コース選択',
      6: 'AIチャット相談',
      7: '見積もり確認',
      8: '送信完了'
    };

    function gaTrack(eventName, params = {}) {
      if (typeof gtag === 'undefined') return;
      gtag('event', eventName, {
        app_name: 'saiki_funeral_support',
        ...params
      });
    }

    // ステップ表示イベント（仮想ページビュー）
    function gaStepView(stepNum) {
      const label = STEP_LABELS[stepNum] || 'ステップ' + stepNum;
      gaTrack('step_view', {
        step_number: stepNum,
        step_label: label,
        page_path: '/funeral-support/step' + stepNum,
        page_title: 'STEP' + stepNum + ': ' + label
      });
      // GA4 の仮想ページビューとしても送信
      gtag('config', 'G-XXXXXXXXXX', {
        page_path: '/funeral-support/step' + stepNum,
        page_title: 'STEP' + stepNum + ': ' + label
      });
    }

    // 離脱イベント（visibilitychange + beforeunload）
    let _gaExitSent = false;
    function gaSendExit() {
      if (_gaExitSent) return;
      _gaExitSent = true;
      if (typeof state === 'undefined') return;
      const step = state.currentStep || 1;
      const label = STEP_LABELS[step] || 'ステップ' + step;
      // sendBeacon で確実に送信
      if (navigator.sendBeacon) {
        const body = JSON.stringify({
          event: 'step_exit',
          step_number: step,
          step_label: label
        });
        // GA4 Measurement Protocol へ送信（スタンドアロン）
        gaTrack('step_exit', {
          step_number: step,
          step_label: label,
          engagement_time_msec: Date.now() - _gaPageStart
        });
      }
    }
    const _gaPageStart = Date.now();
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') gaSendExit();
    });
    window.addEventListener('pagehide', gaSendExit);
    window.addEventListener('beforeunload', gaSendExit);
  </script>
</head>
<body>


<!-- ===== 送信中オーバーレイ ===== -->
<div class="submit-overlay" id="submitOverlay">
  <div class="submit-spinner"></div>
  <div class="submit-overlay-text">送信中です。しばらくお待ちください…</div>
</div>
<div class="app-header">
  <h1 class="top-brand-name">Aifitさいき葬祭</h1>
  <div class="top-brand-sub">ご葬儀サポート</div>
  <p>本打ち合わせ前から安心をお届けさせていただきます</p>
</div>
  <p>
    ご依頼後、親族控室に入られた直後〜本打ち合わせ開始までに、希望や不安を整理するための入力画面です。<br>
    正式見積ではありませんがご協力のほどお願いいたします。
  </p>
</div>

<!-- 音声入力案内バナー -->
<div class="voice-notice">
  <div class="icon">🎙️</div>
  <div class="text">
    音声入力をご利用の方へ：<br>
    少々の誤字・変換ミスがあっても大丈夫です。<br>
    担当者がご確認の上、丁寧にご対応いたします。
  </div>
</div>

<!-- 途中保存バナー -->
<div id="autoSaveBanner" style="display:none; background:linear-gradient(135deg,#e8f5e9,#c8e6c9); border-bottom:2px solid #4caf50; padding:8px 18px; font-size:0.88rem; color:#2e7d32; display:flex; align-items:center; justify-content:space-between; gap:8px;">
  <span id="autoSaveMsg">💾 入力内容を自動保存しました</span>
  <button onclick="clearSavedData()" style="background:none; border:1px solid #4caf50; color:#2e7d32; border-radius:6px; padding:3px 10px; font-size:0.8rem; cursor:pointer;">クリア</button>
</div>

<!-- プログレスバー -->
<div class="progress-bar" id="progressBar">
  <div class="step-dot active" id="dot1">1</div>
  <div class="step-connector" id="con1"></div>
  <div class="step-dot" id="dot2">2</div>
  <div class="step-connector" id="con2"></div>
  <div class="step-dot" id="dot3">3</div>
  <div class="step-connector" id="con3"></div>
  <div class="step-dot" id="dot4">4</div>
  <div class="step-connector" id="con4"></div>
  <div class="step-dot" id="dot5">5</div>
  <div class="step-connector" id="con5"></div>
  <div class="step-dot" id="dot6">6</div>
  <div class="step-connector" id="con6"></div>
  <div class="step-dot" id="dot7">7</div>
  <div class="step-connector" id="con7"></div>
  <div class="step-dot" id="dot8">8</div>
</div>

<!-- ===== STEP 1: 基本情報 ===== -->
<div class="step active" id="step1">
  <div class="step-title"><span class="step-title-text"><span class="step-num">1</span>基本情報をお聞かせください</span><button class="btn-restart-topright no-print" onclick="restartApp()">🔄 最初に戻る</button></div>
  
  <div class="form-group">
    <label class="form-label">喪主名<span class="required">*</span></label>
    <input type="text" class="form-input" id="moshuName" placeholder="例：山田 太郎">
    <div class="error-msg" id="moshuNameError">喪主名をご入力ください</div>
  </div>
  
  <div class="form-group">
    <label class="form-label">亡くなられた方のお名前<span class="required">*</span></label>
    <input type="text" class="form-input" id="deceasedName" placeholder="例：山田 花子" required autocomplete="name">
    <div class="error-msg" id="deceasedNameError">亡くなられた方のお名前をご入力ください</div>
  </div>
  <div class="form-group">
    <label class="form-label">故人様とのご関係<span class="required">*</span></label>
    <select class="form-select" id="relation">
      <option value="">--- お選びください ---</option>
      <option value="spouse">配偶者（夫・妻）</option>
      <option value="parent">親（父・母）</option>
      <option value="child">子ども</option>
      <option value="sibling">兄弟・姉妹</option>
      <option value="grandparent">祖父・祖母</option>
      <option value="inlaw">義理の親</option>
      <option value="relative">その他親族</option>
      <option value="other">その他</option>
    </select>
    <div class="error-msg" id="relationError">ご関係をお選びください</div>
  </div>
  
  <div class="form-group">
    <label class="form-label">お電話番号（必須）</label>
    <input type="tel" class="form-input" id="phone" placeholder="例：090-1234-5678" required autocomplete="tel" inputmode="tel" pattern="^[0-9-]+$" maxlength="13">
    <div class="error-msg" id="phoneError">お電話番号をご入力ください（数字・ハイフン）</div>
  </div>
  
  <div class="info-box">
    📋 ご入力いただいた情報はお見積もりの作成にのみ使用いたします。<br>
    個人情報は厳重に管理いたします。
  </div>
  
  <div class="nav-buttons">
    <button class="btn-next" onclick="goToStep(2)">次へ → 人数・葬儀形式</button>
  </div>
</div>

<!-- ===== STEP 2: 参列人数・葬儀形式 ===== -->
<div class="step" id="step2">
  <div class="step-title"><span class="step-title-text"><span class="step-num">2</span>参列人数・葬儀形式</span><button class="btn-restart-topright no-print" onclick="restartApp()">🔄 最初に戻る</button></div>
  
  <div class="form-group">
    <label class="form-label">参列予定人数をお教えください<span class="required">*</span></label>
    <div class="btn-group" id="attendanceGroup">
      <button class="btn-choice" onclick="selectAttendance(this,'under5')" data-value="under5">
        <span class="choice-icon">👤</span>
        <span class="choice-text">
          <strong>5名以下</strong>
          <div class="choice-desc">ごく身近なご家族のみ（直葬・密葬向き）</div>
        </span>
        <span class="check-mark">✔</span>
      </button>
      <button class="btn-choice" onclick="selectAttendance(this,'under15')" data-value="under15">
        <span class="choice-icon">👥</span>
        <span class="choice-text">
          <strong>15名以下</strong>
          <div class="choice-desc">近親者中心の小規模家族葬</div>
        </span>
        <span class="check-mark">✔</span>
      </button>
      <button class="btn-choice" onclick="selectAttendance(this,'15to30')" data-value="15to30">
        <span class="choice-icon">👨‍👩‍👧‍👦</span>
        <span class="choice-text">
          <strong>15名から30名</strong>
          <div class="choice-desc">親族・近しい友人を含む家族葬</div>
        </span>
        <span class="check-mark">✔</span>
      </button>
      <button class="btn-choice" onclick="selectAttendance(this,'30to50')" data-value="30to50">
        <span class="choice-icon">🏢</span>
        <span class="choice-text">
          <strong>30名から50名</strong>
          <div class="choice-desc">一般葬・知人・仕事関係を含む</div>
        </span>
        <span class="check-mark">✔</span>
      </button>
      <button class="btn-choice" onclick="selectAttendance(this,'over50')" data-value="over50">
        <span class="choice-icon">🏛️</span>
        <span class="choice-text">
          <strong>50名以上</strong>
          <div class="choice-desc">大規模一般葬・会社・団体関係多数</div>
        </span>
        <span class="check-mark">✔</span>
      </button>
    </div>
    <div class="error-msg" id="attendanceError">参列予定人数をお選びください</div>
  </div>
  
  <div class="form-group" style="margin-top:20px">
    <label class="form-label">ご希望の葬儀形式<span class="required">*</span></label>
    <div class="btn-group" id="funeralTypeGroup">
      <button class="btn-choice" onclick="selectFuneralType(this,'family')" data-value="family">
        <span class="choice-icon">🌸</span>
        <span class="choice-text">
          <strong>家族葬</strong>
          <div class="choice-desc">ご遺族・近親者のみで静かにお見送り</div>
        </span>
        <span class="check-mark">✔</span>
      </button>
      <button class="btn-choice" onclick="selectFuneralType(this,'family_friends')" data-value="family_friends">
        <span class="choice-icon">🌼</span>
        <span class="choice-text">
          <strong>家族葬だが少し友人が来る</strong>
          <div class="choice-desc">主に家族中心だが、友人・知人も数名参列</div>
        </span>
        <span class="check-mark">✔</span>
      </button>
      <button class="btn-choice" onclick="selectFuneralType(this,'general')" data-value="general">
        <span class="choice-icon">🌿</span>
        <span class="choice-text">
          <strong>一般葬（親族・知人・仕事関係など）</strong>
          <div class="choice-desc">広く参列者をお迎えする一般的なお葬式</div>
        </span>
        <span class="check-mark">✔</span>
      </button>
      <button class="btn-choice" onclick="selectFuneralType(this,'general_company')" data-value="general_company">
        <span class="choice-icon">🏢</span>
        <span class="choice-text">
          <strong>一般葬かつ会社・団体関係も呼ぶ</strong>
          <div class="choice-desc">会社・団体・組合など多数参列の大規模葬儀</div>
        </span>
        <span class="check-mark">✔</span>
      </button>
      <button class="btn-choice" onclick="selectFuneralType(this,'chokuso')" data-value="chokuso">
        <span class="choice-icon">🕊️</span>
        <span class="choice-text">
          <strong>直葬・火葬式</strong>
          <div class="choice-desc">通夜・告別式なし。火葬のみ、または最小限のお別れ</div>
        </span>
        <span class="check-mark">✔</span>
      </button>
      <button class="btn-choice" onclick="selectFuneralType(this,'kasouonly')" data-value="kasouonly">
        <span class="choice-icon">⛩️</span>
        <span class="choice-text">
          <strong>火葬のみ（最もシンプル）</strong>
          <div class="choice-desc">ご遺体の搬送と火葬のみ。最低限の費用でのお見送り</div>
        </span>
        <span class="check-mark">✔</span>
      </button>
    </div>
    <div class="error-msg" id="funeralTypeError">葬儀形式をお選びください</div>
  </div>
  
  <div class="nav-buttons">
    <button class="btn-back" onclick="goToStep(1)">← 戻る</button>
    <button class="btn-next" onclick="goToStep(3)">次へ → プラン提案</button>
  </div>
</div>

<!-- ===== STEP 3: プラン提案（3種類） ===== -->
<div class="step" id="step3">
  <div class="step-title"><span class="step-title-text"><span class="step-num">3</span>お勧めプランをお選びください</span><button class="btn-restart-topright no-print" onclick="restartApp()">🔄 最初に戻る</button></div>
  <div class="selection-summary" id="step3Summary"></div>
  
  <div class="plan-cards" id="planCards">
    <!-- JavaScriptで動的生成 -->
  </div>
  
  <div class="error-msg" id="planError" style="display:block">プランをお選びください</div>
  
  <div class="nav-buttons">
    <button class="btn-back" onclick="goToStep(2)">← 戻る</button>
    <button class="btn-next" onclick="goToStep(4)">次へ → ホール選択</button>
  </div>
</div>

<!-- ===== STEP 4: ホール選択 ===== -->
<div class="step" id="step4">
  <div class="step-title"><span class="step-title-text"><span class="step-num">4</span>式場（ホール）をお選びください</span><button class="btn-restart-topright no-print" onclick="restartApp()">🔄 最初に戻る</button></div>
  <div class="selection-summary" id="step4Summary"></div>
  
  <div class="hall-cards" id="hallCards">
    <!-- JavaScriptで動的生成 -->
  </div>
  
  <button class="hall-all-btn" id="showAllHallsBtn" onclick="showAllHalls()" style="display:none">
    ▽ その他のホールもすべて表示する
  </button>
  
  <div class="error-msg" id="hallError" style="display:block">ホールをお選びください</div>
  
  <div class="nav-buttons">
    <button class="btn-back" onclick="goToStep(3)">← 戻る</button>
    <button class="btn-next" onclick="goToStep(5)">次へ → 祭壇コース選択</button>
  </div>
</div>

<!-- ===== STEP 5: コース選択 ===== -->
<div class="step" id="step5">
  <div class="step-title"><span class="step-title-text"><span class="step-num">5</span>祭壇コースをお選びください</span><button class="btn-restart-topright no-print" onclick="restartApp()">🔄 最初に戻る</button></div>
  <div class="selection-summary" id="step5Summary"></div>
  
  <!-- 写真イメージ注記 -->
  <div class="image-notice">📷 掲載している祭壇の写真はあくまでもイメージです。実際の祭壇の詳細はお気軽に担当者へご確認ください。</div>
  
  <div class="course-cards" id="courseCards">
    <!-- JavaScriptで動的生成 -->
  </div>
  
  <div class="info-box">
    ✨ <strong>明朗会計</strong>のお約束：事前お見積り以外の追加請求は一切ございません。<br>
    人数超過等が生じた場合は、必ず喪主様にご確認の上でご対応いたします。
  </div>
  
  <div class="error-msg" id="courseError" style="display:block">コースをお選びください</div>
  
  <div class="nav-buttons">
    <button class="btn-back" onclick="goToStep(4)">← 戻る</button>
    <button class="btn-next" onclick="goToStep(6)">次へ → ご希望・ご不安</button>
  </div>
</div>

<!-- ===== STEP 6: ご希望・ご不安（チャットボット） ===== -->
<div class="step" id="step6">
  <div class="step-title"><span class="step-title-text"><span class="step-num">6</span>ご希望・ご不安をお聞かせください</span><button class="btn-restart-topright no-print" onclick="restartApp()">🔄 最初に戻る</button></div>

  <div class="info-box" style="margin-top:12px;">
    ※「会員/割引」などの適用可否は本打ち合わせで最終確認します（ここでは方向性の整理が目的です）。
  </div>
  
  <!-- よくある質問 FAQパネル -->
  <div class="faq-panel" id="faqPanel">
    <div class="faq-panel-header" onclick="toggleFaq()">
      <div class="faq-panel-header-left">
        <span>💡</span>
        <span>よくある質問一覧（タップするとチャットで質問できます）</span>
        <span id="faqUsedCount" style="font-size:0.72rem; background:#4caf50; color:#fff; padding:1px 7px; border-radius:10px; display:none;">0件発言済</span>
      </div>
      <span class="faq-toggle-icon" id="faqToggleIcon">▼</span>
    </div>
    <div class="faq-body" id="faqBody">

      <div class="faq-category">
        <span class="faq-category-label">💰 費用・お支払い</span>
        <div class="faq-items">
          <button class="faq-btn" onclick="faqClick(this,'費用について教えてください')"><span class="faq-icon">❓</span>費用について教えてください</button>
          <button class="faq-btn" onclick="faqClick(this,'追加費用はかかりますか？')"><span class="faq-icon">❓</span>追加費用はかかりますか？</button>
          <button class="faq-btn" onclick="faqClick(this,'分割払いは可能ですか？')"><span class="faq-icon">❓</span>分割払いは可能ですか？</button>
          <button class="faq-btn" onclick="faqClick(this,'会員割引の詳細を教えてください')"><span class="faq-icon">❓</span>会員割引の詳細を教えてください</button>
          <button class="faq-btn" onclick="faqClick(this,'葬祭費補助金・香典返しについて')"><span class="faq-icon">❓</span>葬祭費補助金・香典返しについて</button>
        </div>
      </div>

      <div class="faq-category">
        <span class="faq-category-label">📋 手続き・流れ</span>
        <div class="faq-items">
          <button class="faq-btn" onclick="faqClick(this,'葬式の流れを教えてください')"><span class="faq-icon">❓</span>葬式の流れを教えてください</button>
          <button class="faq-btn" onclick="faqClick(this,'死亡後の役所手続きは？')"><span class="faq-icon">❓</span>死亡後の役所手続きは？</button>
          <button class="faq-btn" onclick="faqClick(this,'死亡診断書について教えてください')"><span class="faq-icon">❓</span>死亡診断書について教えてください</button>
          <button class="faq-btn" onclick="faqClick(this,'連絡する範囲は？')"><span class="faq-icon">❓</span>連絡する範囲は？</button>
          <button class="faq-btn" onclick="faqClick(this,'通夜・告別式の違いを教えてください')"><span class="faq-icon">❓</span>通夜・告別式の違いを教えてください</button>
        </div>
      </div>

      <div class="faq-category">
        <span class="faq-category-label">🏷️ 宗教・お布施</span>
        <div class="faq-items">
          <button class="faq-btn" onclick="faqClick(this,'お布施の目安は？')"><span class="faq-icon">❓</span>お布施の目安は？</button>
          <button class="faq-btn" onclick="faqClick(this,'無宗教・無宗派でもできますか？')"><span class="faq-icon">❓</span>無宗教・無宗派でもできますか？</button>
          <button class="faq-btn" onclick="faqClick(this,'他宗派でも対応できますか？')"><span class="faq-icon">❓</span>他宗派でも対応できますか？</button>
          <button class="faq-btn" onclick="faqClick(this,'はな筒・秘匣の違いは？')"><span class="faq-icon">❓</span>はな筒・秘匣の違いは？</button>
        </div>
      </div>

      <div class="faq-category">
        <span class="faq-category-label">👶 お子様・子どものために</span>
        <div class="faq-items">
          <button class="faq-btn" onclick="faqClick(this,'小さな子どもも参列できますか？')"><span class="faq-icon">❓</span>小さな子どもも参列できますか？</button>
          <button class="faq-btn" onclick="faqClick(this,'キッズスペースはありますか？')"><span class="faq-icon">❓</span>キッズスペースはありますか？</button>
          <button class="faq-btn" onclick="faqClick(this,'授乳室・おむつ交換はできますか？')"><span class="faq-icon">❓</span>授乳室・おむつ交換はできますか？</button>
        </div>
      </div>

      <div class="faq-category">
        <span class="faq-category-label">🌸 お別れ・演出</span>
        <div class="faq-items">
          <button class="faq-btn" onclick="faqClick(this,'お花をたくさん飾りたいです')"><span class="faq-icon">❓</span>お花をたくさん飾りたい</button>
          <button class="faq-btn" onclick="faqClick(this,'音楽や映像を流したいです')"><span class="faq-icon">❓</span>音楽・映像を流したい</button>
          <button class="faq-btn" onclick="faqClick(this,'ペットも一緒にお別れしたいです')"><span class="faq-icon">❓</span>ペットも一緒にお別れしたい</button>
          <button class="faq-btn" onclick="faqClick(this,'写真入りの位牌を作りたいです')"><span class="faq-icon">❓</span>写真入りの位牌を作りたい</button>
        </div>
      </div>

      <div class="faq-category">
        <span class="faq-category-label">😷 感染症・健康対応</span>
        <div class="faq-items">
          <button class="faq-btn" onclick="faqClick(this,'感染症で亡くなった場合の対応は？')"><span class="faq-icon">❓</span>感染症で亡くなった場合の対応は？</button>
          <button class="faq-btn" onclick="faqClick(this,'参列者数を制限したい場合は？')"><span class="faq-icon">❓</span>参列者数を制限したい場合は？</button>
        </div>
      </div>

    </div><!-- /faq-body -->
  </div><!-- /faq-panel -->

  <!-- チャットボットUI -->
  <div class="chat-window" id="chatWindow">
    <div class="chat-header">
      <div class="bot-avatar">案</div>
      <div>
        <div>ミニQ&A（簡易チャット）</div>
        <div style="font-size:0.72rem; opacity:0.85;">打ち合わせ前のQ&A（固定回答）</div>
      </div>
    </div>
    <div class="chat-messages" id="chatMessages">
      <!-- メッセージはJSで追加 -->
    </div>
    <div class="typing-dots" id="typingIndicator" style="display:none; padding:8px 14px; background:#fff; border-radius:16px; margin:4px 12px; align-self:flex-start;">
      <span></span><span></span><span></span>
    </div>
    <div class="quick-replies" id="quickReplies" style="display:none;">
      <!-- クイックリプライはJSで追加 -->
    </div>
    <div class="chat-input-area">
      <textarea class="chat-input" id="chatInput" rows="1" placeholder="メッセージを入力… ※音声入力の誤字も大丈夫です" onkeydown="chatKeyDown(event)"></textarea>
      <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()" title="送信">➤</button>
    </div>
  </div>
  
  <!-- チャット完了バナー -->
  <div class="chat-done-banner" id="chatDoneBanner">
    ✅ ご入力ありがとうございました。担当者が内容を確認の上、丁寧にご対応いたします。
  </div>
  
  <!-- 宗教・菩提寺情報 -->
  <div class="religion-section" style="margin-top: 24px; padding: 16px; background: linear-gradient(135deg, #f3f8ff, #e8f4f8); border: 2px solid #81c784; border-radius: 12px;">
    <div class="religion-header" style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px;">
      <span style="font-size: 1.5rem;">🙏</span>
      <h3 style="font-size: 1rem; font-weight: bold; color: var(--clr-primary-d); margin: 0;">宗教・菩提寺について（任意）</h3>
    </div>
    <div style="font-size: 0.85rem; color: #666; margin-bottom: 16px; line-height: 1.6;">
      当日の打ち合わせをスムーズに進めるため、お分かりの範囲で教えてください。<br>
      <strong>※入力は任意です。分からない場合は空白のままで構いません。</strong>
    </div>
    
    <div class="form-group">
      <label class="form-label" style="font-size: 0.9rem;">ご宗教・宗派</label>
      <select class="form-select" id="religion" onchange="updateReligionState()">
        <option value="">--- お選びください（任意）---</option>
        <option value="仏教（宗派不明）">仏教（宗派不明）</option>
        <option value="真宗大谷派（東本願寺）">真宗大谷派（東本願寺）</option>
        <option value="浄土真宗本願寺派（西本願寺）">浄土真宗本願寺派（西本願寺）</option>
        <option value="真言宗">真言宗</option>
        <option value="天台宗">天台宗</option>
        <option value="浄土宗">浄土宗</option>
        <option value="曹洞宗">曹洞宗</option>
        <option value="臨済宗">臨済宗</option>
        <option value="日蓮宗">日蓮宗</option>
        <option value="日蓮正宗">日蓮正宗</option>
        <option value="神道">神道</option>
        <option value="キリスト教">キリスト教</option>
        <option value="無宗教">無宗教</option>
        <option value="その他">その他</option>
      </select>
    </div>
    
    <div class="form-group">
      <label class="form-label" style="font-size: 0.9rem;">菩提寺・お寺の情報</label>
      <textarea class="form-textarea" id="templeInfo" rows="3" placeholder="例：○○寺（住職：山田様、電話：0120-XXX-XXX）&#10;例：檀家ではありません&#10;例：お寺との付き合いはありません&#10;&#10;※お寺の名前、住所、電話番号、住職名など、分かる範囲で" style="resize: vertical; min-height: 80px;" onchange="updateTempleState()"></textarea>
      <div style="font-size: 0.75rem; color: #888; margin-top: 4px;">
        お寺との関係、住職のお名前、連絡先など、分かる範囲で結構です
      </div>
    </div>
  </div>
  
  <!-- 会員確認 -->
  <div class="form-group" style="margin-top:4px;">
    <label class="form-label">やすらぎ会員様ですか？</label>
    <div class="btn-group" id="memberGroup">
      <button class="btn-choice" onclick="selectMember(this,'yes')">
        <span class="choice-icon">💳</span>
        <span class="choice-text">
          <strong>会員です</strong>
          <div class="choice-desc">35%割引の会員価格が適用されます</div>
        </span>
        <span class="check-mark">✔</span>
      </button>
      <button class="btn-choice" onclick="selectMember(this,'join')">
        <span class="choice-icon">🎉</span>
        <span class="choice-text">
          <strong>当日会員入会したい <span class="join-badge">30%割引</span></strong>
          <div class="choice-desc">当日ご入会でも30%割引が適用されます</div>
        </span>
        <span class="check-mark">✔</span>
      </button>
      <button class="btn-choice" onclick="selectMember(this,'no')">
        <span class="choice-icon">📝</span>
        <span class="choice-text">
          <strong>会員ではありません</strong>
          <div class="choice-desc">一般価格でのご案内となります</div>
        </span>
        <span class="check-mark">✔</span>
      </button>
      <button class="btn-choice" onclick="selectMember(this,'unknown')">
        <span class="choice-icon">❓</span>
        <span class="choice-text">
          <strong>わかりません</strong>
          <div class="choice-desc">担当者がご確認いたします</div>
        </span>
        <span class="check-mark">✔</span>
      </button>
    </div>
  </div>
  
  <div class="nav-buttons">
    <button class="btn-back" onclick="goToStep(5)">← 戻る</button>
    <button class="btn-next" onclick="goToStep(7)">次へ → お見積もり確認</button>
  </div>
</div>

<!-- ===== STEP 7: お見積もり確認 ===== -->
<div class="step" id="step7">
  <div class="step-title"><span class="step-title-text"><span class="step-num">7</span>お見積もりの確認</span><button class="btn-restart-topright no-print" onclick="restartApp()">🔄 最初に戻る</button></div>
  
  <div class="estimate-card" id="estimateCard">
    <!-- JavaScriptで動的生成 -->
  </div>
  
  <!-- 強調警告：正式見積もりではない -->
  <div class="warning-box-strong">
    <div class="warning-icon">⚠️</div>
    <div class="warning-title">正式見積ではありません</div>
    <div class="warning-content">
      <strong>正式見積ではありません：</strong><br>
      本打ち合わせで内容を確定後、正式なお見積りをご案内します。<br>
      ここでの合計は「安心のための目安」です。<br>
      <span class="warning-emphasis">📞 詳細は担当者に必ずご確認ください</span>
    </div>
  </div>
  
  <!-- PDF・LINE・メール 共有ボタン（改善版） -->
  <div class="estimate-action-buttons">
    <button type="button" class="btn-estimate-action btn-pdf" onclick="gaTrack('pdf_download',{step:state.currentStep}); downloadEstimatePDF()">
      <span class="btn-icon">📄</span>
      <span class="btn-label">
        <span class="btn-label-main">PDF保存</span>
        <span class="btn-label-sub">見積もりをPDFファイルで保存する</span>
      </span>
    </button>
    <button type="button" class="btn-estimate-action btn-line" onclick="gaTrack('line_share',{step:state.currentStep}); shareToLINE()">
      <span class="btn-icon">💬</span>
      <span class="btn-label">
        <span class="btn-label-main">LINEで共有</span>
        <span class="btn-label-sub">詳細な見積もり内容をLINEに送る</span>
      </span>
    </button>

    <button type="button" class="btn-estimate-action btn-copy" onclick="try{gaTrack('summary_copy',{step:state.currentStep});}catch(e){}; copySummaryToClipboard()">
      <span class="btn-icon">📋</span>
      <span class="btn-label">
        <span class="btn-label-main">要約コピー</span>
        <span class="btn-label-sub">打ち合わせ用の要点をコピーする</span>
      </span>
    </button>
    <button type="button" id="sendEstimateEmailBtn" class="btn-estimate-action btn-email" onclick="gaTrack('email_send_click',{step:state.currentStep}); sendEstimateEmail()">
      <span class="btn-icon">✉️</span>
      <span class="btn-label">
        <span class="btn-label-main">メール送信</span>
        <span class="btn-label-sub">担当者へ見積もりをメールで送信する</span>
      </span>
    </button>
    <button type="button" class="btn-estimate-action btn-sms" onclick="smsShare()">
      <span class="btn-icon">📱</span>
      <span class="btn-label">
        <span class="btn-label-main">SMSで送信</span>
        <span class="btn-label-sub">ショートメッセージで内容を送信する</span>
      </span>
    </button>
  </div>

  <!-- メール送信結果バナー（step7用） -->
  <div id="estimateEmailBanner" style="display:none; margin-top:12px; padding:12px 16px; border-radius:10px; font-size:0.92rem; font-weight:bold; line-height:1.6;"></div>

  <div class="nav-buttons">
    <button class="btn-back" onclick="goToStep(6)">← 戻る</button>
    <button class="btn-finish" id="submitBtn" onclick="submitAndComplete()">✔ 送信して完了</button>
  </div>
</div>

<!-- ===== STEP 8: 完了 ===== -->
<div class="step" id="step8">

  <!-- 紙吹雪 -->
  <div class="confetti-wrap no-print" id="confettiWrap"></div>

  <!-- 感謝メッセージカード -->
  <div class="complete-card">
    <div class="complete-icon">🌸</div>
    <div class="complete-badge">✨ 入力完了 ✨</div>
    <div class="complete-title">
      ご入力ありがとうございます！<br>
      心よりお礼申し上げます
    </div>
    <div class="complete-subtitle">⚘ {{COMPANY_NAME}}スタッフ一同より</div>
    <div class="complete-divider"></div>
    <div class="complete-text">
      お約束のお時間に担当者が参ります。<br>
      心を込めてお打ち合わせの内容を確認させていただきます。<br><br>
      お急ぎの場合はお電話ください。<br>
      24時間365日、いつでもお受けします。
      <br><br>
      <a class="complete-phone no-print" href="tel:{{SUPPORT_PHONE_TEL}}">
        📞 {{SUPPORT_PHONE_DISPLAY}}
      </a>
      <div class="complete-hours">24時間 365日 年中無休</div>
    </div>
  </div>

  <!-- 印刷専用ヘッダー -->
  <div class="print-header" id="printHeader">
    <h2>⚘ {{COMPANY_NAME}} ご葬儀サポート お見積もり＆ご相談記録</h2>
    <p id="printDate"></p>
  </div>

  <div class="submit-result-banner" id="submitResultBanner"></div>

  <div id="finalSummary" class="print-summary" style="background:#fff; border-radius:12px; border:2px solid var(--clr-border); padding:16px; margin-bottom:16px; font-size:0.87rem; line-height:1.9;"></div>

  <!-- チャット会話履歴（PDF印刷用） -->
  <div class="print-chat-log" id="printChatLog">
    <div class="print-chat-log-title">💬 ご希望・ご不安 チャット会話履歴</div>
    <div id="printChatMessages"></div>
  </div>

  <!-- アクションボタン -->
  <div class="step8-actions no-print">
    <div class="step8-actions-title">💚 見積もりを保存・共有する</div>

    <button type="button" class="btn-s8 btn-s8-line" onclick="shareToLINE()">
      <span class="s8-icon">💬</span>
      <span class="s8-label">
        <span class="s8-main">LINEで共有</span>
        <span class="s8-sub">見積もり詳細をLINEに送る</span>
      </span>
    </button>

    <button type="button" class="btn-s8 btn-s8-sms" onclick="smsShare()">
      <span class="s8-icon">📱</span>
      <span class="s8-label">
        <span class="s8-main">SMSで共有</span>
        <span class="s8-sub">ショートメッセージで送る</span>
      </span>
    </button>

    <button class="btn-s8 btn-s8-pdf" onclick="printPage()">
      <span class="s8-icon">🖨️</span>
      <span class="s8-label">
        <span class="s8-main">印刷・PDF保存</span>
        <span class="s8-sub">見積もりをPDFとして保存</span>
      </span>
    </button>

    <div class="step8-actions-title" style="margin-top:8px;">🔄 やり直す</div>
    <button class="btn-s8 btn-s8-restart" onclick="restartApp()">
      <span class="s8-icon">🔄</span>
      <span class="s8-label">
        <span class="s8-main">最初に戻る</span>
        <span class="s8-sub">⚘ {{COMPANY_NAME}} ご葬儀サポートのトップへ</span>
      </span>
    </button>
  </div>

  <!-- ===== 葬儀の流れ タイムライン ===== -->
  <div class="flow-section no-print">
    <div class="flow-section-title">📋 ご葬儀の流れ（一般的な家族葬の場合）</div>

    <!-- フェーズ1: 申込・準備 -->
    <div class="flow-phase-label">
      <span class="flow-phase-badge">📞 申込・準備</span>
      <span class="flow-phase-line"></span>
    </div>
    <div class="flow-timeline">

      <div class="flow-item">
        <div class="flow-badge"><span>STEP</span><span class="badge-num">1</span></div>
        <div class="flow-card">
          <div class="flow-header">
            <span class="flow-icon">📞</span>
            <span class="flow-title">お電話・ご連絡</span>
            <span class="flow-timing">ご逝去直後</span>
          </div>
          <div class="flow-desc">
            まず{{COMPANY_NAME}}へお電話ください。24時間365日、専門スタッフが対応。最短30分で寝台車がお迎えに伺います。
            <div class="flow-note">📱 {{SUPPORT_PHONE_DISPLAY}}（24時間・無料）<br>お伝えいただくこと：故人様のお名前 / お迎え場所 / お送り先</div>
          </div>
        </div>
      </div>

      <div class="flow-item">
        <div class="flow-badge"><span>STEP</span><span class="badge-num">2</span></div>
        <div class="flow-card">
          <div class="flow-header">
            <span class="flow-icon">🚐</span>
            <span class="flow-title">ご搬送・ご安置</span>
            <span class="flow-timing">当日〜翌日</span>
          </div>
          <div class="flow-desc">
            病院等のご逝去場所から、自宅または安置所へ搬送。医師より死亡診断書を受け取ります。枕飾り・ドライアイスは{{COMPANY_NAME}}でご用意します。
          </div>
        </div>
      </div>

      <div class="flow-item">
        <div class="flow-badge"><span>STEP</span><span class="badge-num">3</span></div>
        <div class="flow-card">
          <div class="flow-header">
            <span class="flow-icon">📋</span>
            <span class="flow-title">打ち合わせ・ご準備・ご納棺</span>
            <span class="flow-timing">1日目</span>
          </div>
          <div class="flow-desc">
            スタッフと日程・場所・内容・費用を打ち合わせ。ご予算に応じたプランをご提案します。ご家族参加型の納棺を推奨しています。
            <div class="flow-note">📄 ご準備いただくもの：死亡診断書 / お写真 / 印鑑（認印）<br>※火葬許可申請は{{COMPANY_NAME}}が無料で代行します</div>
          </div>
        </div>
      </div>

    </div><!-- /flow-timeline 申込準備 -->

    <!-- フェーズ2: お通夜 -->
    <div class="flow-phase-label">
      <span class="flow-phase-badge">🕯️ お通夜</span>
      <span class="flow-phase-line"></span>
    </div>
    <div class="flow-timeline">

      <div class="flow-item">
        <div class="flow-badge"><span>STEP</span><span class="badge-num">4</span></div>
        <div class="flow-card">
          <div class="flow-header">
            <span class="flow-icon">🕯️</span>
            <span class="flow-title">お通夜</span>
            <span class="flow-timing">1〜2日目 夕方（18:00〜）</span>
          </div>
          <div class="flow-desc">
            僧侶のご読経のもと、遺族→親族→弔問者の順でご焼香。受付・接待方法など事前に丁寧にアドバイスします。<br>※ご逝去当日〜翌日の夕方に行います。搬送・打合せのタイミングにより1日目・2日目どちらになる場合もあります。
            <div class="flow-note">
              🕐 <strong>開式目安：18:00〜</strong>（受付は30分前 17:30〜）<br>
              🕡 <strong>終式目安：18:30〜19:00</strong><br>
              ⏱️ 通夜式：<strong>約30〜60分</strong><br>
              🌙 その後、ご遺族は故人様とともに夜を過ごします（通夜振る舞い）
            </div>
          </div>
        </div>
      </div>

    </div><!-- /flow-timeline お通夜 -->

    <!-- フェーズ3: 葬儀当日 -->
    <div class="flow-phase-label">
      <span class="flow-phase-badge">⛩️ 葬儀当日</span>
      <span class="flow-phase-line"></span>
    </div>
    <div class="flow-timeline">

      <div class="flow-item">
        <div class="flow-badge"><span>STEP</span><span class="badge-num">5</span></div>
        <div class="flow-card">
          <div class="flow-header">
            <span class="flow-icon">⛩️</span>
            <span class="flow-title">葬儀・告別式・火葬</span>
            <span class="flow-timing">お通夜翌日</span>
          </div>
          <div class="flow-desc">
            告別式（約1時間）→ お別れの儀 → 出棺 → 火葬場へ。スタッフが火葬場まで同行します。火葬後はお骨上げ。
            <div class="flow-note">⏱️ 告別式：約1時間 / 火葬：約1時間15〜30分</div>
          </div>
        </div>
      </div>

      <div class="flow-item">
        <div class="flow-badge"><span>STEP</span><span class="badge-num">6</span></div>
        <div class="flow-card">
          <div class="flow-header">
            <span class="flow-icon">🙏</span>
            <span class="flow-title">初七日法要・精進落とし</span>
            <span class="flow-timing">葬儀当日 午後</span>
          </div>
          <div class="flow-desc">
            ご帰宅後、初七日法要を執り行い、精進落とし（会席）でご散会。お礼のご挨拶と労いの場となります。
          </div>
        </div>
      </div>

    </div><!-- /flow-timeline 葬儀当日（告別式・火葬） -->

    <!-- フェーズ4: 葬儀後サポート -->
    <div class="flow-phase-label">
      <span class="flow-phase-badge">🤝 葬儀後サポート</span>
      <span class="flow-phase-line"></span>
    </div>
    <div class="flow-timeline">
      <div class="flow-item">
        <div class="flow-badge"><span>STEP</span><span class="badge-num">7</span></div>
        <div class="flow-card">
          <div class="flow-header">
            <span class="flow-icon">🤝</span>
            <span class="flow-title">葬儀後サポート</span>
            <span class="flow-timing">葬儀後〜</span>
          </div>
          <div class="flow-desc">
            専任スタッフが無料でアドバイス。四十九日・年忌法要まで継続してサポートします。
          </div>
        </div>
      </div>
    </div>

    <!-- 葬儀後に必要なこと -->
    <div class="flow-after-section">
      <div class="after-title">📝 葬儀後に必要なこと（全て無料サポート）</div>
      <div class="flow-after-items">
        <span class="flow-after-tag">お寺様へのお礼</span>
        <span class="flow-after-tag">香典返しの手配</span>
        <span class="flow-after-tag">お位牌・仏壇の準備</span>
        <span class="flow-after-tag">納骨・お墓の準備</span>
        <span class="flow-after-tag">役所への各種届出</span>
        <span class="flow-after-tag">四十九日法要のご案内</span>
        <span class="flow-after-tag">年忌法要のご相談</span>
      </div>
    </div>

    <!-- CTA電話 -->
    <div class="flow-phone-cta">
      <div class="cta-text">🕐 24時間365日・ご相談・ご依頼はいつでも</div>
      <a href="tel:{{SUPPORT_PHONE_TEL}}">📞 {{SUPPORT_PHONE_DISPLAY}}</a>
      <div class="cta-sub">⚘ {{COMPANY_NAME}}スタッフ一同</div>
    </div>

  </div>
  <!-- ===== /葬儀の流れ タイムライン ===== -->

<script>

// ========== 連絡先電話（1箇所管理） ==========
// 表示用（ハイフンあり）と、telリンク用（数字のみ）をここだけ直せば全体に反映されます。
const SUPPORT_PHONE_DISPLAY = '0120-315-312';
const SUPPORT_PHONE_TEL     = '0120315312';


// 会社情報（1箇所管理）
const COMPANY_NAME = 'Aifitさいき葬祭';
const COMPANY_URL  = 'https://saiki-sousai.com/';
// 派生（自動計算：ここは触らなくてOK）
const COMPANY_URL_NOSLASH = COMPANY_URL.replace(/\/+$/, '');
const COMPANY_DOMAIN = COMPANY_URL_NOSLASH.replace(/^https?:\/\//, '');

// ブランドロゴ（1箇所管理）
const BRAND_LOGO_URL = 'https://www.genspark.ai/api/files/s/TIOkYOVg?cache_control=3600';
const BRAND_LOGO_ALT = 'Aifit';

function resolveBrandPlaceholders(str) {
  if (str == null) return str;
  return String(str)
    .replaceAll('{{COMPANY_NAME}}', COMPANY_NAME)
    .replaceAll('{{COMPANY_URL}}', COMPANY_URL)
    .replaceAll('{{COMPANY_URL_NOSLASH}}', COMPANY_URL_NOSLASH)
    .replaceAll('{{COMPANY_DOMAIN}}', COMPANY_DOMAIN)
    .replaceAll('{{BRAND_LOGO_URL}}', BRAND_LOGO_URL)
    .replaceAll('{{BRAND_LOGO_ALT}}', BRAND_LOGO_ALT)
    .replaceAll('{{SUPPORT_PHONE_DISPLAY}}', SUPPORT_PHONE_DISPLAY)
    .replaceAll('{{SUPPORT_PHONE_TEL}}', SUPPORT_PHONE_TEL);
}

// 互換（旧名が呼ばれても動くように）
function resolveSupportPhonePlaceholders(str) {
  return resolveBrandPlaceholders(str);
}


function applyBrandToDom(root=document) {
  try {
    const rootNode = root.documentElement || root; // head も含めて置換

    // 1) テキストノードの置換
    const tw = document.createTreeWalker(rootNode, NodeFilter.SHOW_TEXT);
    let node;
    while ((node = tw.nextNode())) {
      const v = node.nodeValue;
      if (!v) continue;
      if (v.includes('{{') && v.includes('}}')) {
        node.nodeValue = resolveBrandPlaceholders(v);
      }
    }

    // 2) 属性値の置換（href など）
    const els = rootNode.querySelectorAll ? rootNode.querySelectorAll('*') : [];
    for (const el of els) {
      if (!el.attributes) continue;
      for (const attr of Array.from(el.attributes)) {
        const av = attr.value;
        if (!av) continue;
        if (av.includes('{{') && av.includes('}}')) {
          el.setAttribute(attr.name, resolveBrandPlaceholders(av));
        }
      }
    }

    // 3) タイトルも反映（念のため）
    if (root.title && root.title.includes('{{')) {
      root.title = resolveBrandPlaceholders(root.title);
    }
  } catch(e) {
    console.warn('applyBrandToDom failed:', e);
  }
}


document.addEventListener('DOMContentLoaded', () => {
  // 初回描画（静的HTML）
  applyBrandToDom(document);
});

// ========== データ定義 ==========

const IMG = {
  ai:   'https://sspark.genspark.ai/cfimages?u1=nT5quTOKQ7O6dN7%2FNZqDTumLphmArsXpAg%2FidVQwm9xnCQhDF9nD0K5Vj%2B3Ic9IiPSrjpsjx5xXkgq4y7DwnkHLTh%2Ba6HyQEHwJEx25n0YltONjDzioxzvWXdJ6ZCtqrTZRiCeC0F%2BrZHUMHJA2F9LMQWEXKwTA7ig%3D%3D&u2=GPKZhykKgNRdFIQs&width=1024',
  hana: 'https://sspark.genspark.ai/cfimages?u1=FWRGlMdJPTl3PkI6X3H4m9beWqR1IwPAuodXFneVtcj77uRI1lhaGtGnjkW60XPe%2B50mc6%2B2l%2F8QCfmWlTTO6oGZq%2B%2BIRz9XcYLwpk2aH7tTksxRmwNH2RZqTOFP%2FBIs6675Ze1Wg4ofi%2BGsbq9GQsi1Q8MI02Pl2jnd&u2=UR%2Bcdja2fICIA7bS&width=1024',
  kaori:'https://sspark.genspark.ai/cfimages?u1=8S5IE1Ne3ZILlI47bWm6xsbrfU4k54OwY7DeUh57bak1y4x4uiVhjYgl4oU6NVAYfK53x4d6K4aoLL2OeJyXli1wT%2Bj7OZ8Y0Gh9yCDdZJD%2F1lL65odcpj1IB%2BPf4wCFI5ewgDC5%2BVU3oRgMKtvf27wgSB0R1wkpRDdgRg%3D%3D&u2=p0bJTs%2FGuJ5EKbF%2B&width=1024',
  kaga: 'https://sspark.genspark.ai/cfimages?u1=eLpG%2FgY9JBLEumdLrEdSh26WP5dQREM%2FhDIjvZj9XQcar2XLClGcgSrEoQDPOTNlQwfMWS594Z5XHefZjloMLGCPSG3FPAxsSTKMCYzvfQAs1ExspKqYbTqBBsb8SCr%2FuvUvIsxfixxGMmwpWDG7oW0V%2Bo9juresvwScK%2BDl5Q%3D%3D&u2=T6urtJBYLpuVuwF8&width=1024',
  // リビングコース専用祭壇
  living_ai:   'https://sspark.genspark.ai/cfimages?u1=pQpKKeEit3T9d7xBH4%2FbkbxeT%2Bwy9%2BUb0jw%2BCfOiUELGvqH%2FTHjd7IpASiGd9m83Yuc34Z3VKf021c6SMgRkAMU5dC08CnBU5ZdDrNrfwyRryR6flCHsN9qjTULqPAGXIHCY5mSFQzy3QHEWy%2FRjBepfsCSlfpZGX95SOukidbNnkQ%3D%3D&u2=iFIWuiLz%2Bzm21Ze9&width=1024',
  living_hana: 'https://sspark.genspark.ai/cfimages?u1=cU2vptQ%2FUqgCGxAKelTq72ns9gQVLQrr7wLhjskjn6vEOR641G7HRRDjdmy4XgnZVlWDmckp6F6pqE2G8V185ViXlNLPjAieO%2B8BEHeVhefCBgKtQo65nKzKWEQLRNCxMXWzTYHDb3q7KJdI0Vkl9zqEanElyc2i1RpqcWroUOB%2B%2BhYP&u2=xCwpakZRKWanbsIT&width=1024',
  living_kaori:'https://sspark.genspark.ai/cfimages?u1=KUY6g73bfffIgq6C1jLH%2BNXDFuxm659dFSL8N%2Fzwu2PkpOT93sV9ne0x8iUh%2BxUsgtF8c3EW6%2BKo8cD6xfN1%2Bqj%2BnZhqeqdFL1gnnGU%2BgICZvbo5Z5Sv75Q6pdXVo%2FvJP9RRHzwzgLTECBF9X8Yb378VC5qho5JSFC%2BZvkcFJpjT46Rauw%3D%3D&u2=Ve6n9dmTfkAK1ghM&width=1024',
  living_kaga: 'https://sspark.genspark.ai/cfimages?u1=AMAkgqbTLhc7%2FogDXeBRWO1e78FQWv7SBbnyBKZkl%2BYbvezlMwzmWA8QvM506lg%2FoE7tPal9S1SP43kpOy%2FNcz7q8UigB3GNcFd%2BnHEZmIpa2Dfs6jZ%2BSCqj0dFfZGQhq7tAdPuUZ56qIgKSjLkuC4mzSzPmngZOzlcS3r7ciVLqCBl2wqzrmQ%3D%3D&u2=YJiuuTwO0gdaMBeM&width=1024',
  // ふつうのお葬式（一般葬・社葬）用祭壇コース画像
  normal_ai:   'https://sspark.genspark.ai/cfimages?u1=uMRcdm1xpP9GYchwtMAz%2BRAbf51Y3kI8JgeTOwoBpd9koXXX7hPqLXqDgQE1%2F3PaVAg4YncJ8k8G72PUiKzE9HaKZ5BlhsWBiECb7MhB%2FVxtfAWyveRLqdqbhYiBTvwGo0uM9iDewHUXWGqdjElStx74Ndg5Tcg%2Flg%3D%3D&u2=ISZiChn%2FHVtCqTYG&width=1024',
  normal_hana: 'https://sspark.genspark.ai/cfimages?u1=etYilXsc3vfgPm%2B8f7fiKpLNqHZwwgJKvLOOD7QdCRDLymkDTKhBF0PgdTlcBPjLOBNGebzg6d0J4DeoW4mYwIq8mcUDV8IYNgnlFg88TrTIAQwkHc3aPmETDdEhvpXAWNuka4kcwp2TFFEEu9eyWHyW6qlbTj8HBWBO&u2=4l0f%2FXeCgDBIMUk2&width=1024',
  normal_kaori:'https://sspark.genspark.ai/cfimages?u1=jOfhCOa1OBQ4eWdSgOliHfIikh99Tr9D9PWHof1pWOWAqVUYokBp0nkTCL8DB3r4gJmKY3%2BFp0mwHTTIPL%2F7KTbqf2Wwuy7Lgtfi9%2BLcgiYU6MJVz%2Bxqecy%2FBhIbMSKtmeMuiiuVFLGldiCaSPMXPigprq1WpKGJskmbzg%3D%3D&u2=UXKKjApTHPoFU0Aw&width=1024',
  normal_kaga: 'https://sspark.genspark.ai/cfimages?u1=qBuQPaqQAofp%2BODq2Bae%2BCP%2BZhhDJ2ogcLNjXxH%2FI67HNSCmJFKWnDN%2BYONmbXMves8QF8JWcbcAJaX1O6q%2B1214%2BXd9VLILrqvp%2BAh%2Fx8Ap70MMHAyIjdcz%2B8m69gqylvfOvHJ45gFoUY8l8oOSajZZnVIwfKKGyCmMfnvzdA%3D%3D&u2=mLMLU1UrxzAkoGkL&width=1024',
  // ホール外観
  hall_forest:  'https://sspark.genspark.ai/cfimages?u1=ZxNYfsT0wXO2oedmP7dwJF6PmvAgl7isNVyCT41opAVERCNiFv0VRue21cC280CRvzmH4UASNkAi2zopOpI%2FcLmbcJ%2FitYNdQbWqx0xCLSdljxTsLdpN0uE%2FvwUwv1iiDlKHPbHYAJULpklqq3nGIT%2F3gZtyBhiU&u2=IFTFT7L6ttpDl6kq&width=1024',
  hall_yasuragi:'https://sspark.genspark.ai/cfimages?u1=JD3sdHwCd9UguUNbtp83krdMZtBaCLQtAfw9S7P3EiwqC6W1Tw5swfUwQLlSJLO3iyqd8g5qY1Nqto15akUMjHfikrZzXs5uX4IjHMZ7UJ3Rx%2BoklWi%2FQqio0ZCscMydTANKjbqMemP6vgShBwrZpp%2Ff4wpeNbOrmJI%3D&u2=0QUHL4SigXbXR1nY&width=1024',
  hall_tsutsuji:'https://sspark.genspark.ai/cfimages?u1=7rrDkyC3hIroxC2fluFwHEeksJ0bUNtUcN4C%2Fsg2zXlQ0K9nImnPv%2F0M37bIIXoUPJoNL0OdAoTzljUC6fBdMRkhF3Xe8uTq1u46I%2F6sNDVXpHh03akakvF1JJshqzXwAvUlxD%2BlZL9wdwNU%2BJ%2Bb18cyoYIDaJi6ZbJu3Ns3qNowtw%3D%3D&u2=Y1v%2B37q6FHQe%2Fial&width=1024',
  hall_yasuura: 'https://sspark.genspark.ai/cfimages?u1=CafYEXSmhhbBOLttGKfJ4vF5JW0t6qd5VAxckRtblge0jogyp8%2BwLD6RlFm4%2FGCZhfJ7OMQ%2FyHjC7OUGt%2BJ9qZjIQddTCdZ4cahjsugE%2FL36XjkCAtGwpVxZlvZSGc62lyceTJrh7piUj38ooHFX6EMiSDfIC3x1J3gMaNRQS88Fb%2B0%3D&u2=Twb2gJDsaPErZw3A&width=1024',
  hall_shion:   'https://sspark.genspark.ai/cfimages?u1=PXRKn%2BQzvKjS03FE5kPb5tMyTxdDU9zeSeuyCeMczzxWaDghQv%2BtjUxgCzytV5YZiegOcjOw%2FfO3ZIce5U267jm5kkrwRnxdAaYY0YYHPWR4f0j4%2FU1Nv6mJfoP%2FRvLHGP0nrSaK92WZMkjiAdGo0IOuLJa0ELebSEjbsXZIAA%3D%3D&u2=oaG1F%2FmyUvzfUzOP&width=1024',
  hall_living:  'https://sspark.genspark.ai/cfimages?u1=pQpKKeEit3T9d7xBH4%2FbkbxeT%2Bwy9%2BUb0jw%2BCfOiUELGvqH%2FTHjd7IpASiGd9m83Yuc34Z3VKf021c6SMgRkAMU5dC08CnBU5ZdDrNrfwyRryR6flCHsN9qjTULqPAGXIHCY5mSFQzy3QHEWy%2FRjBepfsCSlfpZGX95SOukidbNnkQ%3D%3D&u2=iFIWuiLz%2Bzm21Ze9&width=1024',
  hall_ai_chokuso: '{{COMPANY_URL}}wp-content/themes/tsuqrea-child/assets/img/plan/ai-kaso/lead_pic.jpg',
};

// プライシング（会員価格・一般価格）
const PRICING = {
  compact: { ai:[393800,573800], hana:[471800,651800], kaori:[602800,782800], kaga:[767800,947800] },
  living:  { ai:[547800,727800], hana:[625800,805800], kaori:[756800,936800], kaga:[921800,1101800] },
  family:  { ai:[712800,992800], hana:[800800,1080800], kaori:[931800,1211800], kaga:[1096800,1376800] },
  normal:  { ai:[877800,1157800], hana:[987800,1267800], kaori:[1140800,1420800], kaga:[1327800,1607800] },
  chokuso: { single:[198000,248000] },  // 直葬・火葬式（コース選択なし）
  kasou:   { single:[148000,198000] }   // 火葬のみ（最小限）
};

// ホールデータ
const HALLS = {
  tsutsuji: {
    id:'tsutsuji', name:'アイフィットホールつつじ', short:'つつじ',
    address:'〒739-0006 東広島市西条上市町10-11',
    access:'JR西条駅からタクシー4分', capacity:'家族葬専用ホール（〜15名）',
    image: IMG.hall_tsutsuji, pricingType:'compact',
    url:'{{COMPANY_URL}}plan/premium-compact-funeral/access#itfit-tsutsuji',
    maxPeople:15, planLabel:'プレミアムコンパクト家族葬',
    badge:'小規模向き', special:''
  },
  yasuura: {
    id:'yasuura', name:'ファミリーホール安浦', short:'安浦',
    address:'〒737-2516 呉市安浦町中央5丁目3-5',
    access:'JR安浦駅からタクシー2分（徒歩3分）', capacity:'家族葬専用ホール（〜10名）',
    image: IMG.hall_yasuura, pricingType:'compact',
    url:'{{COMPANY_URL}}plan/premium-compact-funeral/access#family-yasuura',
    maxPeople:10, planLabel:'プレミアムコンパクト家族葬',
    badge:'', special:''
  },
  living: {
    id:'living', name:'やすらぎリビング', short:'リビング',
    address:'〒739-0041 東広島市西条町寺家6282（やすらぎ会館内）',
    access:'JR西条駅からタクシー3分', capacity:'1組限定・最大20名',
    image: IMG.hall_living, pricingType:'living',
    url:'{{COMPANY_URL}}yasuragi-living',
    maxPeople:20, planLabel:'やすらぎリビング葬',
    badge:'1日1組限定', special:'living'
  },
  yasuragi: {
    id:'yasuragi', name:'やすらぎ会館', short:'やすらぎ',
    address:'〒739-0041 東広島市西条町寺家6282',
    access:'JR西条駅からタクシー3分', capacity:'中・大ホール（〜300名）、小ホール（〜50名）',
    image: IMG.hall_yasuragi, pricingType:'family',
    url:'{{COMPANY_URL}}yasuragi',
    maxPeople:300, planLabel:'家族葬的なお葬式／普通のお葬式',
    badge:'大規模対応可', special:''
  },
  forest: {
    id:'forest', name:'フォレストホール', short:'フォレスト',
    address:'〒739-0042 東広島市西条町西条東1050',
    access:'JR西条駅から徒歩10分', capacity:'大ホール（200名以上）、中ホール（〜150名）、小ホール（〜50名）',
    image: IMG.hall_forest, pricingType:'family',
    url:'{{COMPANY_URL}}forest-hall',
    maxPeople:300, planLabel:'家族葬的なお葬式／普通のお葬式',
    badge:'大規模対応可', special:''
  },
  shion: {
    id:'shion', name:'Aifitセレモニーホール紫苑', short:'紫苑',
    address:'〒723-0052 広島県三原市皆実2丁目1-16',
    access:'JR三原駅からタクシー6分', capacity:'中ホール（〜80名）家族葬可',
    image: IMG.hall_shion, pricingType:'normal',
    url:'{{COMPANY_URL}}plan/normal/access#ifit-shion',
    maxPeople:80, planLabel:'普通のお葬式／親族葬',
    badge:'三原エリア', special:''
  },
  ai_chokuso: {
    id:'ai_chokuso', name:'あい直葬ホール', short:'あい直葬',
    address:'〒739-0041 広島県東広島市西条町寺家6288',
    access:'📞 {{SUPPORT_PHONE_DISPLAY}}（無料）', capacity:'直葬・火葬式専用（〜10名）',
    image: IMG.hall_ai_chokuso, pricingType:'chokuso',
    url:'{{COMPANY_URL}}plan/ai-kaso/',
    maxPeople:10, planLabel:'直葬・火葬式専用ホール',
    badge:'直葬専用', special:'chokuso'
  }
};

// コース情報
const COURSES = {
  ai:    { name:'愛コース', kanji:'愛', desc:'シンプルで温かみのある祭壇。落ち着いた雰囲気でお見送り。', color:'#e8f4f8' },
  hana:  { name:'花コース', kanji:'花', desc:'美しい花をふんだんに使った、華やかで明るい祭壇。', color:'#fce8f0' },
  kaori: { name:'香コース', kanji:'香', desc:'品格ある佇まいの祭壇。故人の尊厳を表現したグレードアッププラン。', color:'#f0f4e8' },
  kaga:  { name:'輝コース', kanji:'輝', desc:'最高グレードの豪華な祭壇。大切な方への最上のお別れを。', color:'#f8f4e0' }
};

// プラン定義（3プラン）
function getPlans(attendance, funeralType) {
  const plans = [];
  
  if(attendance === 'under5') {
    plans.push({
      id:'nano', label:'small', name:'スマートプラン', icon:'🌿',
      desc:'ごく身近なご家族5名以下のシンプルなお見送り。最小限の費用で心のこもったお葬式。',
      halls:['yasuura','tsutsuji'], priceType:'compact', sizeTag:'コンパクト'
    });
    plans.push({
      id:'compact', label:'rec', name:'プレミアムコンパクト家族葬', icon:'🌸',
      desc:'少人数でも充実した内容の家族葬。1日1組のプライベートな式もご用意。',
      halls:['tsutsuji','living'], priceType:'compact', sizeTag:'推奨'
    });
    plans.push({
      id:'living', label:'large', name:'やすらぎリビング葬', icon:'🏡',
      desc:'ホームライクな空間で最大20名までお見送り。1日1組の完全プライベート空間。',
      halls:['living'], priceType:'living', sizeTag:'ゆとり'
    });
  } else if(attendance === 'under15') {
    plans.push({
      id:'compact', label:'small', name:'プレミアムコンパクト家族葬', icon:'🌸',
      desc:'家族葬専用ホールで15名以下のご葬儀。手頃な費用で充実した内容。',
      halls:['tsutsuji','yasuura'], priceType:'compact', sizeTag:'コンパクト'
    });
    plans.push({
      id:'living', label:'rec', name:'やすらぎリビング葬', icon:'🏡',
      desc:'1日1組・最大20名。ホームライクなリビング空間でゆったりお見送り。',
      halls:['living'], priceType:'living', sizeTag:'推奨'
    });
    plans.push({
      id:'family', label:'large', name:'家族葬的なお葬式', icon:'🌿',
      desc:'大型ホールの小ホールを使用。将来の人数増加にも対応可能なゆとりのプラン。',
      halls:['yasuragi','forest'], priceType:'family', sizeTag:'ゆとり'
    });
  } else if(attendance === '15to30') {
    plans.push({
      id:'living', label:'small', name:'やすらぎリビング葬', icon:'🏡',
      desc:'最大20名のリビング葬。20名を超える場合は他ホールへの変更をご検討ください。',
      halls:['living'], priceType:'living', sizeTag:'小規模'
    });
    plans.push({
      id:'family', label:'rec', name:'家族葬的なお葬式', icon:'🌸',
      desc:'30名程度まで対応の家族葬的な式。やすらぎ会館・フォレストホールで承ります。',
      halls:['yasuragi','forest'], priceType:'family', sizeTag:'推奨'
    });
    plans.push({
      id:'normal', label:'large', name:'ふつうのお葬式', icon:'🌿',
      desc:'一般葬スタイル。知人・友人の方々も広くお招きできる充実の内容。',
      halls:['yasuragi','forest','shion'], priceType:'normal', sizeTag:'ゆとり'
    });
  } else if(attendance === '30to50') {
    plans.push({
      id:'family', label:'small', name:'家族葬的なお葬式', icon:'🌸',
      desc:'費用を抑えながらも30〜50名に対応。アットホームな雰囲気でお見送り。',
      halls:['yasuragi','forest','shion'], priceType:'family', sizeTag:'コンパクト'
    });
    plans.push({
      id:'normal', label:'rec', name:'ふつうのお葬式', icon:'🌿',
      desc:'50名規模に最適な一般葬。通夜・告別式をしっかり執り行います。',
      halls:['yasuragi','forest','shion'], priceType:'normal', sizeTag:'推奨'
    });
    plans.push({
      id:'grand', label:'large', name:'社葬・大型葬', icon:'🏛️',
      desc:'会社・団体関係も多い大規模葬儀。専任スタッフが万全の体制でサポート。',
      halls:['yasuragi','forest'], priceType:'normal', sizeTag:'大規模'
    });
  } else { // over50
    plans.push({
      id:'normal', label:'small', name:'ふつうのお葬式', icon:'🌿',
      desc:'50〜100名規模の一般葬。大型ホールで広くお招きできます。',
      halls:['yasuragi','forest','shion'], priceType:'normal', sizeTag:'標準'
    });
    plans.push({
      id:'large', label:'rec', name:'大型一般葬', icon:'🏛️',
      desc:'100名以上の大規模葬儀。地域の方々・会社関係者も含めた大規模葬。',
      halls:['yasuragi','forest'], priceType:'normal', sizeTag:'推奨'
    });
    plans.push({
      id:'corp', label:'large', name:'社葬・団体葬', icon:'🏢',
      desc:'会社・団体主催の葬儀。専任チームが企画から運営まで全面サポート。',
      halls:['yasuragi','forest'], priceType:'normal', sizeTag:'大規模'
    });
  }
  // 直葬・火葬式の場合は専用プランを差し込む
  if(funeralType === 'chokuso') {
    return [
      {
        id:'chokuso_standard', label:'rec', name:'直葬・火葬式プラン', icon:'🕊️',
        desc:'通夜・告別式を行わず、火葬場でのお別れのみ。シンプルながら心のこもったお見送り。',
        halls:['ai_chokuso','tsutsuji','yasuura'], priceType:'chokuso', sizeTag:'直葬',
        isSimplePlan: true
      },
      {
        id:'chokuso_with_farewell', label:'large', name:'直葬＋お別れの時間あり', icon:'🌸',
        desc:'火葬前に少しだけお別れの時間を設けるプラン。ご家族がゆっくりお見送りできます。',
        halls:['ai_chokuso','tsutsuji','living'], priceType:'chokuso', sizeTag:'直葬+お別れ',
        isSimplePlan: true
      }
    ];
  }
  if(funeralType === 'kasouonly') {
    return [
      {
        id:'kasou_only', label:'rec', name:'火葬のみプラン', icon:'⛩️',
        desc:'最もシンプルな形式。ご遺体の搬送・安置・火葬のみを行います。費用を最小限に抑えたい方に。',
        halls:['ai_chokuso','tsutsuji','yasuura'], priceType:'kasou', sizeTag:'火葬のみ',
        isSimplePlan: true
      }
    ];
  }
  return plans;
}

// ホールフィルタリング
function getRecommendedHalls(attendance, funeralType, selectedPlan) {
  const allHallIds = ['tsutsuji','yasuura','living','yasuragi','forest','shion'];
  
  if(!selectedPlan) return allHallIds;
  
  // 選択したプランの対応ホールを優先
  const planHalls = selectedPlan.halls || allHallIds;
  
  // 追加で表示する可能性のあるホール
  let recommended = [...planHalls];
  let others = allHallIds.filter(h => !recommended.includes(h));
  
  return { recommended, others };
}

// ========== 状態管理 ==========
let state = {
  currentStep: 1,
  moshuName: '', deceasedName: '', relation: '', phone: '',
  attendance: '', funeralType: '',
  selectedPlan: null, selectedHall: null, selectedCourse: null,
  wishes: '', concerns: '', chatLog: [], isMember: null,
  showingAllHalls: false,
  // 宗教・菩提寺関連
  religion: '', templeInfo: ''
};

// ========== FAQ よくある質問 ==========

// FAQ回答データベース
const FAQ_ANSWERS = {
  '費用について教えてください': {
    badge: '💰 費用',
    text: `{{COMPANY_NAME}}では、葬儀費用は大きく3つに分かれます。\n\n① <strong>基本葬儀セット</strong>（祭壇・棺・搬送・遺影など）\n② <strong>おもてなし費用</strong>（会葬御礼品・食事・会館使用料など）\n③ <strong>よくあるオプション</strong>（生花・料理・市等のご希望）\n\n<strong>明朗会計</strong>のお約束として、事前お見積もり以外の追加請求は一切ございません。`
  },
  '追加費用はかかりますか？': {
    badge: '💰 費用',
    text: `事前にお見積もりした金額以外の追加請求は一切ございません 🙏\n\n人数増減など変更が生じた場合は、必ずご喪主様にご確認の上で対応いたします。ご安心ください。`
  },
  '分割払いは可能ですか？': {
    badge: '💰 お支払い',
    text: `はい、各種お支払い方法をご用意しております。\n\n・現金払い\n・クレジットカード払い\n・ローン・分割払い（ご相談ください）\n\n詳細は担当者にお気軽にご相談ください 😊`
  },
  '会員割引の詳細を教えてください': {
    badge: '💳 会員',
    text: `やすらぎ会員にご入会いただくと、葬儀費用が<strong>35%割引</strong>となります。\n\n当日ご入会の場合でも<strong>30%割引</strong>が適用されます。\n\n詳細は担当者までお問い合わせください。\n📞 {{SUPPORT_PHONE_DISPLAY}}`
  },
  '葬祭費補助金・香典返しについて': {
    badge: '💰 補助金',
    text: `国民健康保険・後期高齢者医療保険の被保険者が亡くなられた場合、<strong>葬祭費（補助金）</strong>が市区町村から支給される場合があります（目安：3〜7万円）。\n\n手続きは担当者がサポートいたします。香典返しのご相談も承っております。`
  },
  '葬式の流れを教えてください': {
    badge: '📋 流れ',
    text: `一般的な葬儀の流れです：\n\n1️⃣ ご逝去・ご連絡（24時間受付）\n2️⃣ 搬送・安置\n3️⃣ 打ち合わせ・お見積もり\n4️⃣ 通夜式\n5️⃣ 告別式・出棺\n6️⃣ 火葬・骨上げ\n7️⃣ 初七日法要\n\n担当者が全ての流れをサポートいたします 🙏`
  },
  '死亡後の役所手続きは？': {
    badge: '📋 手続き',
    text: `主な役所手続きは以下の通りです：\n\n・<strong>死亡届の提出</strong>（7日以内）\n・火葬許可証の取得\n・健康保険・年金の資格喪失届\n・世帯主変更届（必要な場合）\n\n{{COMPANY_NAME}}では<strong>役所手続き代行</strong>も承っております。お気軽にご相談ください。`
  },
  '死亡診断書について教えてください': {
    badge: '📋 書類',
    text: `死亡診断書は、医師が発行する公式書類です。\n\n・病院で亡くなった場合：担当医が発行\n・自宅で亡くなった場合：かかりつけ医または救急医が発行\n\n死亡届の提出に必要となります。担当者がご案内いたします。`
  },
  '連絡する範囲は？': {
    badge: '📋 連絡',
    text: `ご逝去後の連絡順序の目安です：\n\n1️⃣ 直系家族・近親者\n2️⃣ 親族・兄弟姉妹\n3️⃣ 故人の友人・知人（家族葬の場合は任意）\n4️⃣ 職場・会社関係（必要に応じて）\n\n家族葬の場合は、葬儀後にご連絡するケースも多くございます。`
  },
  '通夜・告別式の違いを教えてください': {
    badge: '📋 式次第',
    text: `<strong>通夜</strong>：ご逝去翌日の夕方に行う儀式。故人と最後の夜をともにする時間です。\n\n<strong>告別式（葬儀）</strong>：翌日の午前中に行う本式。参列者が最後のお別れをする式典です。\n\n家族葬では通夜を省略した「一日葬」も人気があります。`
  },
  'お布施の目安は？': {
    badge: '🏷️ お布施',
    text: `お布施は宗旨・宗派・地域によって異なります。一般的な目安は以下の通りです：\n\n・仏式：10〜30万円程度\n・神式：10〜30万円程度\n・キリスト教：5〜20万円程度\n\n※お布施は「お気持ち」ですので、詳しくは菩提寺や担当者にご相談ください。`
  },
  '無宗教・無宗派でもできますか？': {
    badge: '🏷️ 宗教',
    text: `はい、もちろん対応しております 😊\n\n無宗教の「自由葬」や「音楽葬」なども承っております。故人様の生前のご意向や、ご家族様のご希望に合わせてオリジナルのお別れの式をご提案いたします。`
  },
  '他宗派でも対応できますか？': {
    badge: '🏷️ 宗派',
    text: `はい、各宗派・宗教に対応しております。\n\n・仏式（浄土宗・浄土真宗・臨済宗・曹洞宗など）\n・神式\n・キリスト教（カトリック・プロテスタント）\n・その他宗教\n\n菩提寺がない場合も、提携の寺院をご紹介することができます。`
  },
  'はな筒・秘匣の違いは？': {
    badge: '🏷️ 骨壷',
    text: `<strong>はな筒</strong>：花をモチーフにしたデザインの骨壷。華やかで温かみのある印象です。\n\n<strong>秘匣（ひご）</strong>：伝統的なデザインの骨壷。格式があり落ち着いた印象です。\n\nどちらも故人を偲ぶ大切な器です。担当者がご説明いたします。`
  },
  '小さな子どもも参列できますか？': {
    badge: '👶 お子様',
    text: `はい、もちろんです 😊\n\n小さなお子様でも安心してご参列いただけます。各ホールには<strong>キッズスペース</strong>を完備しており、お子様が安心して過ごせる環境を整えております。`
  },
  'キッズスペースはありますか？': {
    badge: '👶 設備',
    text: `はい、以下のホールにキッズスペースを完備しております：\n\n🏛️ やすらぎ会館\n🌲 フォレストホール\n🌺 アイフィットホールつつじ\n\nお子様連れのご家族も安心してご参列いただけます。`
  },
  '授乳室・おむつ交換はできますか？': {
    badge: '👶 授乳室',
    text: `授乳スペースやおむつ交換台をご用意しております。\n\n事前にお申し付けいただければ、スタッフが対応いたします。お気軽にお申し付けください 😊`
  },
  'お花をたくさん飾りたいです': {
    badge: '🌸 演出',
    text: `もちろんご対応できます 🌸\n\n「花コース」「香コース」「輝コース」ではお花を豪華にあしらった祭壇をご用意しております。\n\nまた、フラワーアレンジメントの追加や棺の中にお花をいっぱい入れる「花いっぱい葬」も承っております。担当者にご相談ください。`
  },
  '音楽や映像を流したいです': {
    badge: '🎵 演出',
    text: `はい、承っております 🎵\n\n・故人様のお気に入りの音楽を式中に流す\n・思い出の写真・映像をスライドショーで上映する\n・メモリアルDVDの制作\n\nいずれも対応可能です。詳細は担当者にご相談ください。`
  },
  'ペットも一緒にお別れしたいです': {
    badge: '🐾 ペット',
    text: `故人様と愛するペットのお別れについても承っております 🐾\n\nペットを連れての参列や、棺にペットの写真や首輪を入れることも可能です。ご希望の内容をお気軽にご相談ください。`
  },
  '写真入りの位牌を作りたいです': {
    badge: '🎋 位牌',
    text: `はい、対応しております 📸\n\n故人様のお写真入りの位牌や、メモリアルパネルのご用意も承っております。\n\n「香コース」「輝コース」にはメモリアルパネルが標準で含まれています。`
  },
  '感染症で亡くなった場合の対応は？': {
    badge: '😷 感染症',
    text: `感染症でお亡くなりになった場合も、安心してご相談ください。\n\n・専門スタッフによる適切な処置\n・感染対策を施した安置・搬送\n・参列者への感染対策（消毒・マスク・換気等）\n\nご遺族の安全を最優先に、丁寧に対応いたします。📞 {{SUPPORT_PHONE_DISPLAY}}`
  },
  '参列者数を制限したい場合は？': {
    badge: '😷 制限',
    text: `参列者を限定したい場合も対応しております。\n\n・<strong>家族葬・1日葬</strong>で少人数のお見送り\n・入場人数の制限・時間分散\n・オンライン参列（リモート葬）のご案内\n\nご希望に合わせて柔軟に対応いたします。`
  }
};

// FAQ使用済みセット
const faqUsedSet = new Set();

// FAQパネル開閉
function toggleFaq() {
  const body = document.getElementById('faqBody');
  const icon = document.getElementById('faqToggleIcon');
  const isOpen = body.classList.contains('open');
  if (isOpen) {
    body.classList.remove('open');
    icon.classList.remove('open');
  } else {
    body.classList.add('open');
    icon.classList.add('open');
  }
}

// FAQボタンクリック
function faqClick(btn, question) {
  if (btn.classList.contains('used')) return; // 既に使用済み

  // 使用済みにする
  btn.classList.add('used');
  btn.innerHTML = '<span class="faq-icon">✅</span>' + btn.textContent.trim();
  faqUsedSet.add(question);

  // 使用件数バッジ更新
  const badge = document.getElementById('faqUsedCount');
  badge.style.display = 'inline-block';
  badge.textContent = faqUsedSet.size + '件発言済';

  // チャット画面が開いていない場合もチャットに送る
  // FAQパネルを一度閉じる
  const body = document.getElementById('faqBody');
  const icon = document.getElementById('faqToggleIcon');
  body.classList.remove('open');
  icon.classList.remove('open');

  // チャットにユーザーメッセージとして送る
  sendFaqToChat(question);
}

// FAQをチャットに送信
function sendFaqToChat(question) {
  if (chatState.isDone) {
    // チャット完了後でも追記
    addUserMsg(question);
    chatState.log.push({ role: 'user', msg: question });
    state.chatLog = chatState.log.slice();
    // FAQ回答を表示
    setTimeout(() => showFaqAnswer(question), 700);
    return;
  }

  // チャット入力中断してFAQ送信
  const input = document.getElementById('chatInput');
  if(input) input.value = '';
  document.getElementById('quickReplies').style.display = 'none';
  document.getElementById('quickReplies').innerHTML = '';

  addUserMsg(question);
  chatState.log.push({ role: 'user', msg: question });
  state.chatLog = chatState.log.slice();

  // FAQ専用回答を返す
  setTimeout(() => showFaqAnswer(question), 700);
}

// FAQ専用回答バブルを表示
function showFaqAnswer(question) {
  const msgs = document.getElementById('chatMessages');
  const answer = FAQ_ANSWERS[question];

  // タイピング表示
  const typing = document.createElement('div');
  typing.className = 'chat-msg bot';
  typing.id = 'faqTypingMsg';
  typing.innerHTML = `<div class="msg-avatar">🤝</div><div class="msg-bubble" style="background:#eee; color:#999;"><span class="typing-dots"><span></span><span></span><span></span></span> 回答を準備中...</div>`;
  msgs.appendChild(typing);
  msgs.scrollTop = msgs.scrollHeight;

  setTimeout(() => {
    const old = document.getElementById('faqTypingMsg');
    if(old) old.remove();

    if (answer) {
      // FAQ専用バブル
      const div = document.createElement('div');
      div.className = 'chat-msg bot';
      div.innerHTML = `<div class="msg-avatar">🤝</div>
        <div class="faq-answer-bubble">
          <div class="faq-answer-badge">${answer.badge}</div>
          <div>${answer.text.replace(/\n/g,'<br>')}</div>
          <div style="margin-top:8px; font-size:0.75rem; color:#558B2F; border-top:1px solid #C5E1A5; padding-top:6px;">
            💬 他にもご質問がございましたらお気軽にどうぞ
          </div>
        </div>`;
      msgs.appendChild(div);

      // botログにも追加
      chatState.log.push({ role: 'bot', msg: answer.badge + ' ' + answer.text.replace(/<[^>]+>/g,'') });
    } else {
      addBotMsg('ありがとうございます。\n担当者が詳しくご説明いたします。お気軽に追加でご質問ください 🙏');
    }

    msgs.scrollTop = msgs.scrollHeight;

    // チャットが完了していない場合、次のフローへの誘導を表示
    if (!chatState.isDone) {
      setTimeout(() => {
        showChatFaqSuggest();
      }, 800);
    }
  }, 900);
}

// FAQ後の関連質問サジェスト
function showChatFaqSuggest() {
  const msgs = document.getElementById('chatMessages');
  const qr = document.getElementById('quickReplies');

  // 未使用のFAQを最大3件提案
  const allFaqs = Object.keys(FAQ_ANSWERS);
  const unused = allFaqs.filter(q => !faqUsedSet.has(q));
  const suggests = unused.slice(0, 3);

  if (suggests.length === 0) return;

  qr.innerHTML = '';
  qr.style.display = 'flex';

  // 「他の質問を見る」ボタン
  const moreBtn = document.createElement('button');
  moreBtn.className = 'quick-reply-btn';
  moreBtn.textContent = '📋 他の質問を見る';
  moreBtn.onclick = () => {
    const body = document.getElementById('faqBody');
    const icon = document.getElementById('faqToggleIcon');
    body.classList.add('open');
    icon.classList.add('open');
    qr.style.display = 'none';
    // スクロールしてFAQパネルへ
    document.getElementById('faqPanel').scrollIntoView({ behavior: 'smooth', block: 'start' });
  };
  qr.appendChild(moreBtn);

  // 関連質問サジェスト
  suggests.forEach(q => {
    const btn = document.createElement('button');
    btn.className = 'quick-reply-btn';
    btn.textContent = q.length > 18 ? q.substring(0,16) + '…' : q;
    btn.title = q;
    btn.onclick = () => {
      qr.style.display = 'none';
      qr.innerHTML = '';
      // FAQパネルのボタンも使用済みに
      document.querySelectorAll('.faq-btn').forEach(fb => {
        if(fb.getAttribute('onclick') && fb.getAttribute('onclick').includes(q.replace(/'/g,"\'"))) {
          if(!fb.classList.contains('used')) {
            fb.classList.add('used');
            faqUsedSet.add(q);
            const badge = document.getElementById('faqUsedCount');
            badge.style.display = 'inline-block';
            badge.textContent = faqUsedSet.size + '件発言済';
          }
        }
      });
      sendFaqToChat(q);
    };
    qr.appendChild(btn);
  });

  // 完了ボタン
  const doneBtn = document.createElement('button');
  doneBtn.className = 'quick-reply-btn';
  doneBtn.textContent = '✅ 完了する';
  doneBtn.onclick = () => {
    qr.style.display = 'none';
    processUserInput('完了する');
  };
  qr.appendChild(doneBtn);
}


// ========== チャットボット ==========
const CHAT_FLOW = [
  {
    id: 'greeting',
    botMsg: 'こんにちは 🙏\nご葬儀に関するご希望やご不安を、どうぞお気軽にお聞かせください。\n\nまず、故人様のお見送りについて、何かご希望はございますか？',
    quickReplies: ['お花を多く飾りたい','音楽を流したい','費用をできるだけ抑えたい','宗教的なことを相談したい','特に希望はない','その他'],
    nextId: 'concerns'
  },
  {
    id: 'concerns',
    botMsg: 'ありがとうございます 🌸\n次に、ご不安な点やご質問はございますか？\nどんな些細なことでも、遠慮なくお聞かせください。',
    quickReplies: ['費用・お支払いについて','宗教・宗派について','手続き・書類について','初めてで何もわからない','参列者への対応','特に不安はない'],
    nextId: 'free'
  },
  {
    id: 'free',
    botMsg: 'かしこまりました。担当者が心を込めてご対応いたします 🕊️\n\n他に何かご要望・ご質問はございますか？\n（なければ「完了」ボタンを押してください）',
    quickReplies: ['他にもある','完了する'],
    nextId: 'done'
  }
];

let chatState = {
  flowIndex: 0,
  isWaiting: false,
  isDone: false,
  log: []
};

function initChat() {
  const msgs = document.getElementById('chatMessages');
  if(!msgs) return;
  msgs.innerHTML = '';
  chatState = { flowIndex: 0, isWaiting: false, isDone: false, log: [] };
  document.getElementById('chatDoneBanner').classList.remove('show');
  document.getElementById('chatInput').disabled = false;
  document.getElementById('chatSendBtn').disabled = false;
  showTypingThenBot(CHAT_FLOW[0].botMsg, CHAT_FLOW[0].quickReplies);
}

function showTypingThenBot(message, quickReplies) {
  const msgs = document.getElementById('chatMessages');
  const qr = document.getElementById('quickReplies');
  qr.style.display = 'none';
  qr.innerHTML = '';

  // タイピングインジケーター
  const typing = document.createElement('div');
  typing.className = 'chat-msg bot';
  typing.id = 'typingMsg';
  typing.innerHTML = `<div class="msg-avatar">🤝</div><div class="msg-bubble" style="background:#eee; color:#999; font-style:italic;"><span class="typing-dots"><span></span><span></span><span></span></span> 入力中...</div>`;
  msgs.appendChild(typing);
  msgs.scrollTop = msgs.scrollHeight;

  setTimeout(() => {
    // タイピング削除、メッセージ表示
    const old = document.getElementById('typingMsg');
    if(old) old.remove();
    addBotMsg(message);
    // クイックリプライ表示
    if(quickReplies && quickReplies.length > 0) {
      qr.style.display = 'flex';
      quickReplies.forEach(r => {
        const btn = document.createElement('button');
        btn.className = 'quick-reply-btn';
        btn.textContent = r;
        btn.onclick = () => onQuickReply(r);
        qr.appendChild(btn);
      });
    }
  }, 800);
}

function addBotMsg(text) {
  const msgs = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'chat-msg bot';
  div.innerHTML = `<div class="msg-avatar">🤝</div><div class="msg-bubble">${text.replace(/\n/g,'<br>')}</div>`;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function addUserMsg(text) {
  const msgs = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'chat-msg user';
  div.innerHTML = `<div class="msg-bubble">${escHtml(text)}</div><div class="msg-avatar user-av">👤</div>`;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function onQuickReply(text) {
  document.getElementById('quickReplies').style.display = 'none';
  document.getElementById('quickReplies').innerHTML = '';
  processUserInput(text);
}

function chatKeyDown(e) {
  if(e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendChatMessage();
  }
}

function sendChatMessage() {
  if(chatState.isDone) return;
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if(!text) return;
  input.value = '';
  document.getElementById('quickReplies').style.display = 'none';
  document.getElementById('quickReplies').innerHTML = '';
  processUserInput(text);
}

function processUserInput(text) {
  addUserMsg(text);
  chatState.log.push({ role: 'user', msg: text });
  state.chatLog = chatState.log.slice();

  const flow = CHAT_FLOW;
  const fi = chatState.flowIndex;

  // 「完了する」を選択
  if(text === '完了する' || (fi >= flow.length)) {
    finishChat();
    return;
  }

  // 次のフローへ
  const nextId = flow[fi]?.nextId;
  const nextFlow = flow.find(f => f.id === nextId);
  chatState.flowIndex = flow.indexOf(nextFlow);

  if(nextFlow) {
    if(nextFlow.id === 'done') {
      finishChat();
    } else if(text === '他にもある') {
      // フリー入力を続ける
      setTimeout(() => {
        addBotMsg('もちろんです。他にもご自由にお聞かせください 😊');
      }, 600);
    } else {
      showTypingThenBot(nextFlow.botMsg, nextFlow.quickReplies);
    }
  } else {
    finishChat();
  }
}

function finishChat() {
  chatState.isDone = true;
  setTimeout(() => {
    addBotMsg('ご入力ありがとうございました 🙏\n担当者が内容を確認し、心を込めてご対応いたします。');
    document.getElementById('chatDoneBanner').classList.add('show');
    document.getElementById('chatInput').disabled = true;
    document.getElementById('chatSendBtn').disabled = true;
    document.getElementById('quickReplies').style.display = 'none';
    // stateに保存
    state.chatLog = chatState.log.slice();
    state.wishes = chatState.log.filter(l=>l.role==='user').map(l=>l.msg).join(' / ');
  }, 700);
}

// ========== ステップ遷移 ==========
function goToStep(n) {
  // バリデーション
  if(n > state.currentStep) {
    if(!validate(state.currentStep)) {
      gaTrack('validation_error', {
        step_number: state.currentStep,
        step_label: (typeof STEP_LABELS !== 'undefined' ? STEP_LABELS[state.currentStep] : 'step'+state.currentStep)
      });
      return;
    }
  }
  
  // 現在のステップを非表示
  document.getElementById('step' + state.currentStep).classList.remove('active');
  document.getElementById('dot' + state.currentStep).classList.remove('active');
  document.getElementById('dot' + state.currentStep).classList.add('done');
  if(state.currentStep > 1) {
    document.getElementById('con' + (state.currentStep-1)).classList.add('done');
  }
  
  state.currentStep = n;
  
  // 新しいステップを表示
  document.getElementById('step' + n).classList.add('active');
  document.getElementById('dot' + n).classList.add('active');
  document.getElementById('dot' + n).classList.remove('done');
  
  // ステップ固有の初期化
  if(n === 3) renderPlans();
  if(n === 4) renderHalls();
  if(n === 5) renderCourses();
  if(n === 6) { setTimeout(initChat, 100); }
  if(n === 7) renderEstimate();
  if(n === 8) {
    renderFinalSummary();
    gaTrack('form_complete', {
      form_name: 'funeral_support',
      funeral_type: state.funeralType || '',
      plan_name: (state.selectedPlan && state.selectedPlan.name) || '',
      hall_name: (state.selectedHall && state.selectedHall.name) || '',
      attendance: state.attendance || '',
      is_member: state.isMember ? 'member' : 'general'
    });
  }
  
  // 電話番号プレースホルダを解決（動的描画にも反映）
  applyBrandToDom(document);

  window.scrollTo(0, 0);
  autoSaveDebounced(); // 自動保存

  // GA4: ステップ表示イベント
  gaStepView(n);
  // STEP1 初回入力開始
  if(n === 1) gaTrack('form_start', { form_name: 'funeral_support' });
}

// ========== バリデーション ==========
function validate(step) {
  if(step === 1) {
    let ok = true;
    const moshuName = document.getElementById('moshuName').value.trim();
    const deceasedName = document.getElementById('deceasedName').value.trim();
    const relation = document.getElementById('relation').value;
    const phone = document.getElementById('phone').value.trim();

    if(!moshuName) { document.getElementById('moshuNameError').style.display='block'; ok=false; }
    else { document.getElementById('moshuNameError').style.display='none'; }

    if(!deceasedName) { document.getElementById('deceasedNameError').style.display='block'; ok=false; }
    else { document.getElementById('deceasedNameError').style.display='none'; }

    if(!relation) { document.getElementById('relationError').style.display='block'; ok=false; }
    else { document.getElementById('relationError').style.display='none'; }

    // 電話番号は必須（簡易フォーマットチェック）
    const phoneErrEl = document.getElementById('phoneError');
    const phoneDigits = phone.replace(/-/g, '');
    let phoneErr = '';

    if(!phone) {
      phoneErr = 'お電話番号をご入力ください';
    } else if(!/^[0-9-]+$/.test(phone)) {
      phoneErr = '電話番号は「数字・ハイフンのみ」で入力してください';
    } else if(!phone.startsWith('0')) {
      phoneErr = '電話番号は「0から始まる番号」で入力してください';
    } else if(phoneDigits.length < 10 || phoneDigits.length > 11) {
      phoneErr = '電話番号は「10〜11桁」（ハイフン除く）で入力してください';
    } else if(!/^[0-9]+$/.test(phoneDigits)) {
      phoneErr = '電話番号の形式が正しくありません';
    }

    if(phoneErr) {
      if(phoneErrEl) { phoneErrEl.textContent = phoneErr; phoneErrEl.style.display = 'block'; }
      ok = false;
    } else {
      if(phoneErrEl) { phoneErrEl.style.display = 'none'; }
    }

    if(ok) {
      state.moshuName = moshuName;
      state.deceasedName = deceasedName;
      state.relation = relation;
      state.phone = phone;
    }
    return ok;
  }
  if(step === 2) {
    let ok = true;
    if(!state.attendance) { document.getElementById('attendanceError').style.display='block'; ok=false; }
    else document.getElementById('attendanceError').style.display='none';
    if(!state.funeralType) { document.getElementById('funeralTypeError').style.display='block'; ok=false; }
    else document.getElementById('funeralTypeError').style.display='none';
    return ok;
  }
  if(step === 3) {
    if(!state.selectedPlan) { document.getElementById('planError').style.display='block'; return false; }
    document.getElementById('planError').style.display='none'; return true;
  }
  if(step === 4) {
    if(!state.selectedHall) { document.getElementById('hallError').style.display='block'; return false; }
    document.getElementById('hallError').style.display='none'; return true;
  }
  if(step === 5) {
    if(!state.selectedCourse) { document.getElementById('courseError').style.display='block'; return false; }
    document.getElementById('courseError').style.display='none'; return true;
  }
  return true;
}

// ========== 選択ハンドラー ==========
function selectAttendance(btn, val) {
  document.querySelectorAll('#attendanceGroup .btn-choice').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  state.attendance = val;
  state.selectedPlan = null; state.selectedHall = null; state.selectedCourse = null;
  document.getElementById('attendanceError').style.display='none';
}

function selectFuneralType(btn, val) {
  document.querySelectorAll('#funeralTypeGroup .btn-choice').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  state.funeralType = val;
  state.selectedPlan = null; state.selectedHall = null; state.selectedCourse = null;
  document.getElementById('funeralTypeError').style.display='none';
}

function selectPlan(planId) {
  state.selectedPlan = currentPlans.find(p => p.id === planId) || null;
  if (state.selectedPlan) gaTrack('plan_select', { plan_id: planId, plan_name: state.selectedPlan.name || planId });
  document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('selected'));
  const card = document.getElementById('plan_'+planId);
  if(card) card.classList.add('selected');
  state.selectedHall = null; state.selectedCourse = null;
  document.getElementById('planError').style.display='none';
  // ホールをリセット
}

function selectHall(hallId) {
  state.selectedHall = HALLS[hallId] || null;
  if (state.selectedHall) gaTrack('hall_select', { hall_id: hallId, hall_name: state.selectedHall.name || hallId });
  document.querySelectorAll('.hall-card').forEach(c => c.classList.remove('selected'));
  const card = document.getElementById('hall_'+hallId);
  if(card) card.classList.add('selected');
  state.selectedCourse = null;
  document.getElementById('hallError').style.display='none';
}

function selectCourse(courseId) {
  state.selectedCourse = courseId;
  gaTrack('course_select', { course_id: courseId, course_name: (COURSES[courseId] && COURSES[courseId].name) || courseId });
  document.querySelectorAll('.course-card').forEach(c => c.classList.remove('selected'));
  const card = document.getElementById('course_'+courseId);
  if(card) card.classList.add('selected');
  document.getElementById('courseError').style.display='none';
}

function selectMember(btn, val) {
  document.querySelectorAll('#memberGroup .btn-choice').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  state.isMember = val;
}

// ========== プラン描画 ==========
let currentPlans = [];

function renderPlans() {
  const summary = document.getElementById('step3Summary');
  summary.textContent = `参列予定：${getAttendanceLabel(state.attendance)}　葬儀形式：${getFuneralTypeLabel(state.funeralType)}`;
  
  currentPlans = getPlans(state.attendance, state.funeralType);
  const container = document.getElementById('planCards');
  container.innerHTML = '';
  
  currentPlans.forEach(plan => {
    const badgeClass = plan.label === 'small' ? 'badge-small' : (plan.label === 'rec' ? 'badge-rec' : 'badge-large');
    const badgeText = plan.label === 'small' ? '🔵 小規模' : (plan.label === 'rec' ? '⭐ おすすめ' : '🔴 大規模');
    
    const card = document.createElement('div');
    card.className = 'plan-card' + (state.selectedPlan && state.selectedPlan.id === plan.id ? ' selected' : '');
    card.id = 'plan_' + plan.id;
    card.onclick = () => selectPlan(plan.id);
    card.innerHTML = `
      <div class="plan-card-badge ${badgeClass}">${badgeText} <span class="plan-type-tag tag-${plan.priceType}">${plan.sizeTag}</span></div>
      <div class="plan-card-body">
        <div class="plan-card-title">${plan.icon} ${plan.name}</div>
        <div class="plan-card-sub">対応ホール：${plan.halls.map(h=>HALLS[h]?.short||h).join('・')}</div>
        <div class="plan-card-desc">${plan.desc}</div>
        <div style="margin-top:8px; font-size:0.8rem; color:#558B2F;">
          目安価格（会員）：${formatPrice(getMinPrice(plan.priceType))}〜
        </div>
      </div>
    `;
    container.appendChild(card);
  });
  
  if(!state.selectedPlan) document.getElementById('planError').style.display='none';
}

function getMinPrice(priceType) {
  // 直葬・火葬式は single キーのみ
  if(priceType === 'chokuso' || priceType === 'kasou') {
    const pc = PRICING[priceType];
    return pc ? pc.single[0] : 148000;
  }
  const pc = PRICING[priceType] || PRICING.compact;
  return pc.ai[0];
}

// ========== ホール描画 ==========
function renderHalls() {
  const summary = document.getElementById('step4Summary');
  const planName = state.selectedPlan ? state.selectedPlan.name : '';
  summary.textContent = `選択プラン：${planName}`;
  
  const { recommended, others } = getRecommendedHalls(state.attendance, state.funeralType, state.selectedPlan);
  state.showingAllHalls = false;
  
  const container = document.getElementById('hallCards');
  container.innerHTML = '';
  
  renderHallCards(recommended, container, true);
  
  const showAllBtn = document.getElementById('showAllHallsBtn');
  if(others.length > 0) {
    showAllBtn.style.display = 'block';
    showAllBtn._othersToAdd = others;
  } else {
    showAllBtn.style.display = 'none';
  }
  
  if(!state.selectedHall) document.getElementById('hallError').style.display='none';
}

function renderHallCards(hallIds, container, isRecommended) {
  hallIds.forEach(hallId => {
    const hall = HALLS[hallId];
    if(!hall) return;
    
    const card = document.createElement('div');
    card.className = 'hall-card hall-card-wrapper' + (state.selectedHall && state.selectedHall.id === hallId ? ' selected' : '');
    card.id = 'hall_' + hallId;
    card.onclick = () => selectHall(hallId);
    
    const badge = hall.badge ? `<span class="hall-recommended-badge">${hall.badge}</span>` : '';
    const livingBadge = hall.special === 'living' ? `<div class="living-badge">🏡 1日1組プライベート</div>` : '';
    
    card.innerHTML = `
      <span class="hall-selected-check">✔</span>
      <img class="hall-card-img" src="${hall.image}" alt="${hall.name}" loading="lazy" onerror="this.style.background='#e0d5c8';this.style.height='110px';">
      ${badge}
      <div class="hall-card-body">
        <div class="hall-card-name">${hall.name}</div>
        ${livingBadge}
        <div class="hall-card-cap">${hall.capacity}</div>
        <div class="hall-card-addr">${hall.address}</div>
        <div class="hall-card-addr" style="color:#558B2F; margin-top:2px;">${hall.special === 'chokuso' ? '' : '🚃 '}${hall.access}</div>
        ${hall.url && hall.url !== '{{COMPANY_URL}}' ? `<div style="margin-top:6px;"><a href="${hall.url}" target="_blank" onclick="event.stopPropagation();" style="font-size:0.78rem;color:#558B2F;text-decoration:underline;">🔗 詳細・プランを見る</a></div>` : ''}
      </div>
    `;
    container.appendChild(card);
  });
}

function showAllHalls() {
  const btn = document.getElementById('showAllHallsBtn');
  const others = btn._othersToAdd;
  const container = document.getElementById('hallCards');
  renderHallCards(others, container, false);
  btn.style.display = 'none';
}

// ========== コース描画 ==========
function renderCourses() {
  const plan = state.selectedPlan;
  const hall = state.selectedHall;

  // 直葬・火葬式はコース選択不要
  if(plan && plan.isSimplePlan) {
    // ★修正: DOMに依存せず先にstateをセット（validate通過のため）
    state.selectedCourse = 'single';
    const coursesContainer = document.getElementById('courseCards');
    if(coursesContainer) {
      coursesContainer.innerHTML = `
        <div style="background:#f0f8f0;border:2px solid #a8d8a8;border-radius:12px;padding:20px;text-align:center;">
          <div style="font-size:2rem;margin-bottom:8px;">🕊️</div>
          <div style="font-weight:bold;color:#4a7c59;font-size:1.05rem;margin:8px 0;">祭壇コースの選択は不要です</div>
          <div style="font-size:0.85rem;color:#666;line-height:1.6;">直葬・火葬式プランは祭壇コースがございません。<br>そのまま「次へ」ボタンでお進みください。</div>
        </div>`;
    }
    // step5タイトルも更新
    const step5Title = document.querySelector('#step5 .step-title');
    if(step5Title) step5Title.innerHTML = '<span class="step-num">5</span>プラン確認（コース選択不要）';
    // courseErrorを非表示にする
    const errEl = document.getElementById('courseError');
    if(errEl) errEl.style.display = 'none';
    return;
  }
  // hall/plan 未選択チェック（旧コードと同等）
  if(!hall || !plan) return;
  
  // ★修正v6: priceType を先に確定（TDZエラー回避）
  // リビング専用ホールは living 固定、それ以外はプランの priceType を優先
  const isLiving = hall.special === 'living';
  const priceType = isLiving ? 'living' : (plan.priceType || hall.pricingType);
  const pricing = PRICING[priceType] || PRICING.compact;
  
  const summary = document.getElementById('step5Summary');
  const priceTypeLabel = {'compact':'コンパクト家族葬','living':'リビング葬','family':'家族葬的なお葬式','normal':'一般葬／ふつうのお葬式'};
  summary.textContent = `ホール：${hall.name}　プラン：${plan.name}　【${priceTypeLabel[priceType] || priceType}】`;
  
  const courseIds = ['ai','hana','kaori','kaga'];
  const priceKeys = ['ai','hana','kaori','kaga'];
  
  const container = document.getElementById('courseCards');
  container.innerHTML = '';
  
  courseIds.forEach((cId, i) => {
    const course = COURSES[cId];
    const prices = pricing[priceKeys[i]];
    const memberPrice = prices[0];
    const normalPrice = prices[1];
    
    // 画像選択：一般葬は normal_ 画像、リビング葬は living_ 画像、それ以外は共通画像
    let imgSrc;
    if(isLiving) {
      imgSrc = IMG['living_'+cId] || IMG[cId];
    } else if(priceType === 'normal') {
      imgSrc = IMG['normal_'+cId] || IMG[cId];
    } else {
      imgSrc = IMG[cId];
    }
    
    const card = document.createElement('div');
    card.className = 'course-card' + (state.selectedCourse === cId ? ' selected' : '');
    card.id = 'course_' + cId;
    card.onclick = () => selectCourse(cId);
    card.innerHTML = `
      <img class="course-card-img" src="${imgSrc}" alt="${course.name}祭壇" loading="lazy" onerror="this.style.background='#f5e6d0';this.style.height='130px';">
      <div class="course-card-body" style="background:${course.color};">
        <div class="course-card-name">⚘ ${course.name}</div>
        <div class="course-card-price">
          会員 <span class="member-price">${formatPrice(memberPrice)}</span><br>
          <span style="font-size:0.75rem;">一般 ${formatPrice(normalPrice)}</span>
        </div>
        <div class="course-card-desc">${course.desc}</div>
      </div>
      <div class="course-selected-mark">✔ 選択中</div>
    `;
    container.appendChild(card);
  });
  
  if(!state.selectedCourse) document.getElementById('courseError').style.display='none';
}

// ========== 見積もり描画 ==========
function renderEstimate() {
  const hall = state.selectedHall;
  const plan = state.selectedPlan;
  const course = state.selectedCourse;
  
  if(!hall || !plan || !course) return;
  
  // ★修正: リビング専用ホールは living 固定、それ以外はプランの priceType を優先
  const priceType = (hall.special === 'living') ? 'living' : (plan.priceType || hall.pricingType);
  const pricing = PRICING[priceType] || PRICING.compact;
  
  // ★直葬・火葬式プラン（isSimplePlan）の場合は single キーで価格取得
  let prices;
  if(plan.isSimplePlan || course === 'single') {
    const simplePricing = PRICING[priceType] || PRICING.chokuso;
    prices = simplePricing ? simplePricing.single : [198000, 248000];
  } else {
    const priceKey = course;
    if(!pricing[priceKey]) {
      console.error('[v8] renderEstimate: pricing not found for course=', priceKey, 'priceType=', priceType);
      document.getElementById('estimateCard').innerHTML = '<div style="color:red;padding:12px;">⚠️ 価格データ読み込みエラー。お手数ですが最初からやり直してください。</div>';
      return;
    }
    prices = pricing[priceKey];
  }
  const isMember = state.isMember === 'yes' || state.isMember === 'join';
  const basePrice = isMember ? prices[0] : prices[1];
  
  // ★v10修正: おもてなし費・オプション費は「コース料金に加算」する別費用
  // 参列者数に応じたおもてなし目安を設定
  // 直葬・火葬式の場合はおもてなし費なし、搬送費のみ
  const isSimple = plan.isSimplePlan || course === 'single';
  // ★30%減（2026/02 調整）
  const attendanceHospitality = {
    'under5':    35000,   // 元10万→50%
    'under15':   52500,   // 元15万→50%
    '15to30':    87500,   // 元25万→50%
    '30to50':   140000,   // 元40万→50%
    'over50':   210000    // 元60万→50%
  };
  const hospitalityEstimate = isSimple ? 30000 : (attendanceHospitality[state.attendance] || 35000);
  const optionEstimate = isSimple ? 0 : 200000; // 直葬は追加オプションなし
  const totalEstimate = basePrice + hospitalityEstimate;
  
  const courseInfo = COURSES[course];
  const relationLabel = getRelationLabel(state.relation);
  const memberNote = state.isMember === 'yes' ? '（会員価格適用）' : state.isMember === 'join' ? '（当日会員入会・30%割引予定）' : state.isMember === 'unknown' ? '（会員確認要）' : '（一般価格）';
  
  const card = document.getElementById('estimateCard');
  card.innerHTML = `
    <div class="estimate-section-title">📋 お客様情報</div>
    <div class="estimate-row"><span class="estimate-label">喪主名</span><span class="estimate-value">${escHtml(state.moshuName)} 様</span></div>
    <div class="estimate-row"><span class="estimate-label">亡くなられた方のお名前</span><span class="estimate-value">${escHtml(state.deceasedName)} 様</span></div>
    <div class="estimate-row"><span class="estimate-label">故人との関係</span><span class="estimate-value">${relationLabel}</span></div>
    <div class="estimate-row"><span class="estimate-label">参列予定人数</span><span class="estimate-value">${getAttendanceLabel(state.attendance)}</span></div>
    <div class="estimate-row"><span class="estimate-label">葬儀形式</span><span class="estimate-value">${getFuneralTypeLabel(state.funeralType)}</span></div>
    ${state.religion ? `<div class="estimate-row"><span class="estimate-label">ご宗教・宗派</span><span class="estimate-value">${escHtml(state.religion)}</span></div>` : ''}
    ${state.templeInfo ? `<div class="estimate-row"><span class="estimate-label">菩提寺・お寺</span><span class="estimate-value" style="font-size:0.78rem; line-height:1.4;">${escHtml(state.templeInfo).replace(/\n/g, '<br>')}</span></div>` : ''}
    
    <div class="estimate-section-title" style="margin-top:14px">🏛️ 選択内容</div>
    <div class="estimate-row"><span class="estimate-label">プラン</span><span class="estimate-value">${escHtml(plan.name)}</span></div>
    <div class="estimate-row"><span class="estimate-label">ホール</span><span class="estimate-value">${escHtml(hall.name)}</span></div>
    <div class="estimate-row"><span class="estimate-label">祭壇コース</span><span class="estimate-value">⚘ ${courseInfo.name}</span></div>
    <div class="estimate-row"><span class="estimate-label" style="color:#888;font-size:0.78rem;">価格種別</span><span class="estimate-value" style="font-size:0.78rem;color:#558B2F;">${{'compact':'コンパクト家族葬','living':'リビング葬','family':'家族葬的なお葬式','normal':'一般葬／ふつうのお葬式'}[priceType] || priceType}</span></div>
    <div class="estimate-row"><span class="estimate-label">ホール住所</span><span class="estimate-value" style="font-size:0.78rem;">${hall.address}</span></div>
    <div class="estimate-row"><span class="estimate-label">アクセス</span><span class="estimate-value" style="font-size:0.78rem;">${hall.access}</span></div>
    
    <div class="estimate-section-title" style="margin-top:14px">💰 費用目安</div>
    <div class="estimate-row">
      <span class="estimate-label">${isSimple ? '直葬・火葬費用' : '葬儀基本セット'}</span>
      <span class="estimate-value">${formatPrice(basePrice)}</span>
    </div>
    <div class="estimate-row" style="font-size:0.8rem;color:#888;">
      <span class="estimate-label">${isSimple ? '└ 搬送・安置・火葬立会等' : '└ 祭壇・棺・搬送・遺影等'}</span>
      <span class="estimate-value">（${isSimple ? 'プラン料金' : 'コース料金'}）</span>
    </div>
    <div class="estimate-row">
      <span class="estimate-label">${isSimple ? '搬送費目安' : 'おもてなし費用（目安）'}</span>
      <span class="estimate-value">${formatPrice(hospitalityEstimate)}</span>
    </div>
    <div class="estimate-row" style="font-size:0.8rem;color:#888;">
      <span class="estimate-label">${isSimple ? '└ ご遺体搬送・ドライアイス等' : '└ 返礼品・食事・会館使用料等'}</span>
      <span class="estimate-value">${isSimple ? '' : '（参列者数により変動）'}</span>
    </div>
    <div class="estimate-total">
      <div class="estimate-total-label">総合計（目安）${memberNote}</div>
      <div class="estimate-total-price">${formatPrice(totalEstimate)}</div>
      <div class="estimate-total-note">※おもてなし費用は参列者数により変動します。詳細は担当者にご確認ください</div>
      <div class="estimate-total-warning">
        <div class="estimate-total-warning-title">⚠️ これは正式見積もりではありません</div>
        <div class="estimate-total-warning-text">
          上記は概算の目安です。実際の費用は参列者数や選択内容により変動します。<br>
          <strong>正式なお見積もりは担当者との打ち合わせ後に作成いたします。</strong>
        </div>
      </div>
    </div>
    
    <div style="margin-top:16px;padding:14px 16px;background:#fff5f5;border:2.5px solid #e53935;border-radius:10px;position:relative;">      <div style="position:absolute;top:-11px;left:14px;background:#e53935;color:#fff;font-size:0.72rem;font-weight:bold;padding:2px 10px;border-radius:20px;letter-spacing:0.05em;">⚠️ ご確認ください</div>      <p style="margin:6px 0 0 0;font-size:0.88rem;font-weight:bold;color:#c62828;line-height:1.7;">        あくまでこちらの金額は<u>目安</u>で、しっかり「お見送り予算」を加えた場合の数字です。<br>        選ぶのはお客様ですので<strong>不要なオプションは削除可能</strong>です。<br>        <span style="font-size:0.85rem;color:#e53935;">ご安心ください！</span>      </p>    </div>
    
    ${!isSimple ? `
    <div style="margin-top:12px; padding:10px 12px; background:#fdf6ec; border:1px dashed #d4a76a; border-radius:8px;">
      <div style="font-size:0.82rem; font-weight:bold; color:#558B2F; margin-bottom:4px;">💡 よくあるオプション目安（参考）</div>
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span style="font-size:0.82rem; color:#666;">└ 生花・料理・バスタクシー等</span>
        <span style="font-size:0.88rem; font-weight:bold; color:#558B2F;">${formatPrice(optionEstimate)} 前後</span>
      </div>
      <div style="font-size:0.75rem; color:#aaa; margin-top:4px;">※ご希望の内容により変動します。上記合計には含まれていません。</div>
    </div>` : ''}
  `;
}

// ========== 完了画面 ==========
function renderFinalSummary() {
  // chatLogから要望・不安をまとめる
  if(chatState.log.length > 0) {
    state.wishes = chatState.log.filter(l=>l.role==='user').map(l=>l.msg).join(' ／ ');
  }
  
  const summary = document.getElementById('finalSummary');
  const hall = state.selectedHall;
  const plan = state.selectedPlan;
  const course = state.selectedCourse;
  const courseInfo = COURSES[course] || {};

  // 見積もり価格再計算 (v10: 直葬・火葬式対応)
  const priceType = hall ? ((hall.special === 'living') ? 'living' : (plan?.priceType || hall.pricingType)) : 'compact';
  const pricing = PRICING[priceType] || PRICING.compact;
  // 直葬・火葬式は single キー
  let prices;
  if(priceType === 'chokuso' || priceType === 'kasou') {
    prices = PRICING[priceType] ? PRICING[priceType].single : [198000, 248000];
  } else {
    prices = course ? (pricing[course] || (() => { console.error('[v10] コースキー未発見:', course, 'priceType:', priceType); return pricing.kaga || pricing.ai; })()) : pricing.ai;
  }
  const isMember = state.isMember === 'yes' || state.isMember === 'join';
  const basePrice = isMember ? prices[0] : prices[1];
  const memberNote = state.isMember === 'yes' ? '（会員価格 35%割引）'
    : state.isMember === 'join' ? '（当日入会 30%割引）'
    : state.isMember === 'unknown' ? '（会員確認要）' : '（一般価格）';
  
  summary.innerHTML = `
    <strong style="color:#33691E; display:block; margin-bottom:10px; font-size:0.95rem; border-bottom:2px solid #d4a76a; padding-bottom:6px;">📋 ご葬儀 確認内容サマリー</strong>
    <table style="width:100%; border-collapse:collapse; font-size:0.86rem; line-height:1.9;">
      <tr><td style="color:#888; width:42%; padding:3px 0;">👤 喪主名</td><td><strong>${escHtml(state.moshuName)}</strong> 様</td></tr>
      <tr><td style="color:#888; width:42%; padding:3px 0;">🕊️ 亡くなられた方</td><td><strong>${escHtml(state.deceasedName)}</strong> 様</td></tr>
      <tr><td style="color:#888;">🔗 故人との関係</td><td>${getRelationLabel(state.relation)}</td></tr>
      <tr><td style="color:#888;">📞 お電話番号</td><td>${escHtml(state.phone) || '未入力'}</td></tr>
      <tr><td style="color:#888;">👥 参列予定人数</td><td><strong>${getAttendanceLabel(state.attendance)}</strong></td></tr>
      <tr><td style="color:#888;">⚘ 葬儀形式</td><td><strong>${getFuneralTypeLabel(state.funeralType)}</strong></td></tr>
      <tr><td colspan="2" style="padding-top:8px; border-top:1px solid #e0d5c8;"></td></tr>
      <tr><td style="color:#888;">📋 選択プラン</td><td><strong>${escHtml(plan?.name||'')}</strong></td></tr>
      <tr><td style="color:#888;">🏛️ 式場ホール</td><td><strong>${escHtml(hall?.name||'')}</strong></td></tr>
      <tr><td style="color:#888;">📍 住所</td><td style="font-size:0.78rem;">${hall?.address||''}</td></tr>
      <tr><td style="color:#888;">🚃 アクセス</td><td style="font-size:0.78rem;">${hall?.access||''}</td></tr>
      <tr><td style="color:#888;">🎋 祭壇コース</td><td><strong>${courseInfo.name||''}</strong></td></tr>
      <tr><td colspan="2" style="padding-top:8px; border-top:1px solid #e0d5c8;"></td></tr>
      <tr><td style="color:#888;">💳 会員区分</td><td>${getMemberLabel(state.isMember)}</td></tr>
      <tr><td style="color:#888;">💰 費用目安</td><td><strong style="color:#33691E; font-size:1rem;">${formatPrice(basePrice)}</strong> ${memberNote}</td></tr>
    </table>
  `;

  // チャット履歴をPDF用に描画
  renderPrintChatLog();
}

  // STEP8紙吹雪
  function launchConfetti() {
    var wrap = document.getElementById('confettiWrap');
    if (!wrap) return;
    wrap.innerHTML = '';
    var colors = ['#7CB342','#9CCC65','#F48FB1','#F8BBD0','#DCEDC8','#FFF9C4','#FFE0B2','#E1BEE7'];
    for (var ci = 0; ci < 22; ci++) {
      var p = document.createElement('div');
      p.className = 'confetti-piece';
      p.style.left = (Math.random() * 100) + '%';
      p.style.background = colors[Math.floor(Math.random() * colors.length)];
      p.style.animationDuration = (1.2 + Math.random() * 1.2) + 's';
      p.style.animationDelay = (Math.random() * 1.0) + 's';
      p.style.width = (6 + Math.random() * 6) + 'px';
      p.style.height = (6 + Math.random() * 6) + 'px';
      p.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
      wrap.appendChild(p);
    }
    // 2秒後に再度起動
    setTimeout(launchConfetti, 2600);
  }


function renderPrintChatLog() {
  const log = chatState.log;
  const container = document.getElementById('printChatMessages');
  const section = document.getElementById('printChatLog');
  if(!container) return;
  container.innerHTML = '';

  if(!log || log.length === 0) {
    section.style.display = 'none';
    return;
  }

  // ボットの最初の発言を先頭に追加
  const firstBot = { role: 'bot', msg: 'こんにちは 🙏\nご葬儀に関するご希望やご不安を、どうぞお気軽にお聞かせください。\nまず、故人様のお見送りについて、何かご希望はございますか？' };
  const fullLog = [firstBot, ...log];

  fullLog.forEach((entry, idx) => {
    const isBot = entry.role === 'bot';
    const row = document.createElement('div');
    row.className = 'pdf-chat-row' + (isBot ? '' : ' user-row');

    const label = document.createElement('div');
    label.className = 'pdf-chat-label';
    label.textContent = isBot ? '🤝 担当' : '👤 お客様';

    const bubbleWrap = document.createElement('div');
    bubbleWrap.style.display = 'flex'; bubbleWrap.style.flexDirection = 'column';
    bubbleWrap.style.maxWidth = '82%';

    const bubble = document.createElement('div');
    bubble.className = isBot ? 'pdf-chat-bubble-bot' : 'pdf-chat-bubble-user';
    bubble.innerHTML = escHtml(entry.msg).replace(/\n/g, '<br>');

    bubbleWrap.appendChild(bubble);
    if(isBot) { row.appendChild(label); row.appendChild(bubbleWrap); }
    else       { row.appendChild(bubbleWrap); row.appendChild(label); }
    container.appendChild(row);
  });

  // ボットの結びメッセージ
  const closingRow = document.createElement('div');
  closingRow.className = 'pdf-chat-row';
  const closingLabel = document.createElement('div');
  closingLabel.className = 'pdf-chat-label'; closingLabel.textContent = '🤝 担当';
  const closingBubble = document.createElement('div');
  closingBubble.className = 'pdf-chat-bubble-bot';
  closingBubble.innerHTML = 'ご入力ありがとうございました 🙏<br>担当者が内容を確認し、心を込めてご対応いたします。';
  closingRow.appendChild(closingLabel); closingRow.appendChild(closingBubble);
  container.appendChild(closingRow);

  section.style.display = 'block';
}

// ========== ユーティリティ ==========
function formatPrice(n) {
  return '￥' + n.toLocaleString('ja-JP');
}

function escHtml(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function getAttendanceLabel(v) {
  const m = {under5:'5名以下',under15:'15名以下','15to30':'15〜30名','30to50':'30〜50名',over50:'50名以上'};
  return m[v] || v;
}

function getFuneralTypeLabel(v) {
  const m = {family:'家族葬',family_friends:'家族葬（友人少数参加）',general:'一般葬',general_company:'一般葬（会社・団体）',chokuso:'直葬・火葬式',kasouonly:'火葬のみ'};
  return m[v] || v;
}

function getRelationLabel(v) {
  const m = {spouse:'配偶者',parent:'親（父・母）',child:'子ども',sibling:'兄弟・姉妹',grandparent:'祖父・祖母',inlaw:'義理の親',relative:'その他親族',other:'その他'};
  return m[v] || v;
}

function getMemberLabel(v) {
  const m = {yes:'会員（35%割引適用）',join:'当日会員入会希望（30%割引）',no:'非会員（一般価格）',unknown:'不明（要確認）'};
  return m[v] || '未回答';
}


// ============================================================
// ===== 送信処理（EmailJS + Google Apps Script）=====
// ============================================================

// ▼▼▼ 設定箇所 ▼▼▼ -----------------------------------------------
// 【EmailJS設定手順】
// 1. https://www.emailjs.com/ でアカウント作成（無料プランあり）
// 2. 「Add New Service」でGmail等を連携 → Service IDをコピー
// 3. 「Email Templates」でテンプレート作成 → Template IDをコピー
// 4. 「Account > API Keys」でPublic Keyをコピー
// 5. 下記3行に貼り付けるだけでメール送信が有効になります！
const EMAILJS_SERVICE_ID  = 'YOUR_SERVICE_ID';   // ← 手順2のService ID
const EMAILJS_TEMPLATE_ID = 'YOUR_TEMPLATE_ID';  // ← 手順3のTemplate ID
const EMAILJS_PUBLIC_KEY  = 'YOUR_PUBLIC_KEY';   // ← 手順4のPublic Key
const EMAILJS_TO_EMAIL    = 'info@{{COMPANY_DOMAIN}}'; // ← 送信先メール（設定済）

// 【GAS設定：スプレッドシートに記録したい場合のみ（省略可）】
// 1. Googleスプレッドシートを作成
// 2. 拡張機能 > Apps Script でGASスクリプトを作成・デプロイ
// 3. デプロイで取得したURLを下記に貼り付け
const GAS_WEBHOOK_URL = 'YOUR_GAS_WEBHOOK_URL';  // ← GAS WebアプリのURL（省略可）
// ▲▲▲ 設定箇所ここまで ▲▲▲ ----------------------------------------

function submitAndComplete() {
  // バリデーション（STEP 7 通過チェック）
  if(!state.selectedHall || !state.selectedCourse) {
    alert('式場・祭壇コースが選択されていません。前の手順をご確認ください。');
    return;
  }

  // 送信ボタン無効化
  const btn = document.getElementById('submitBtn');
  if(btn) btn.disabled = true;

  // オーバーレイ表示
  document.getElementById('submitOverlay').classList.add('show');

  // 送信データ作成
  const hall = state.selectedHall;
  const plan = state.selectedPlan;
  const course = state.selectedCourse;
  const courseInfo = COURSES[course] || {};
  const priceType = hall ? ((hall.special === 'living') ? 'living' : (plan?.priceType || hall.pricingType)) : 'compact';
  const pricing   = PRICING[priceType] || PRICING.compact;
  // ★v10修正: 直葬・火葬式対応。選択コースキーで正確に参照
  let prices;
  if(priceType === 'chokuso' || priceType === 'kasou') {
    prices = PRICING[priceType] ? PRICING[priceType].single : [198000, 248000];
  } else {
    prices = course ? (pricing[course] || (() => { console.error('[v10] submitAndComplete コースキー未発見:', course); return pricing.kaga || pricing.ai; })()) : pricing.ai;
  }
  const isMember  = state.isMember === 'yes' || state.isMember === 'join';
  const basePrice = isMember ? prices[0] : prices[1];

  const chatLog = chatState.log
    .map(l => (l.role === 'bot' ? '[担当AI] ' : '[お客様] ') + l.msg)
    .join('\n');

  const now = new Date();
  const dateStr = now.getFullYear() + '/' +
    String(now.getMonth()+1).padStart(2,'0') + '/' +
    String(now.getDate()).padStart(2,'0') + ' ' +
    String(now.getHours()).padStart(2,'0') + ':' +
    String(now.getMinutes()).padStart(2,'0');

  const payload = {
    submitted_at:    dateStr,
    moshuName:       state.moshuName,
    deceasedName:    state.deceasedName,
    relation:        getRelationLabel(state.relation),
    phone:           state.phone || '未入力',
    attendance:      getAttendanceLabel(state.attendance),
    funeral_type:    getFuneralTypeLabel(state.funeralType),
    plan_name:       plan?.name || '',
    hall_name:       hall?.name || '',
    hall_address:    hall?.address || '',
    hall_access:     hall?.access || '',
    course_name:     courseInfo.name || '',
    member_status:   getMemberLabel(state.isMember),
    price_estimate:  formatPrice(basePrice),
    price_type:      priceType,
    wishes:          state.wishes || '（なし）',
    chat_log:        chatLog || '（なし）',
    to_email:        EMAILJS_TO_EMAIL
  };

  // 並行送信（EmailJS + GAS）
  const emailPromise = sendViaEmailJS(payload);
  const gasPromise   = sendViaGAS(payload);

  Promise.allSettled([emailPromise, gasPromise]).then(results => {
    // オーバーレイ非表示
    document.getElementById('submitOverlay').classList.remove('show');

    const emailOk = results[0].status === 'fulfilled';
    const gasOk   = results[1].status === 'fulfilled';

    // STEP 8 に遷移
    goToStep(8);

    // 結果バナー表示
    setTimeout(() => {
      const banner = document.getElementById('submitResultBanner');
      if(!banner) return;
      if(emailOk && gasOk) {
        banner.className = 'submit-result-banner success';
        banner.innerHTML = '✅ 送信完了！<br>担当者へのメール通知とスプレッドシートへの記録が完了しました。<br>お約束のお時間に担当者が参ります。心を込めてお打ち合わせの内容を確認させていただきます。';
      } else if(emailOk || gasOk) {
        banner.className = 'submit-result-banner success';
        const detail = emailOk ? 'メール通知は送信済みです。' : 'スプレッドシートへの記録は完了しました。';
        banner.innerHTML = '✅ 送信完了（一部）<br>' + detail;
      } else {
        banner.className = 'submit-result-banner error';
        banner.innerHTML = '⚠️ 送信に失敗しました。<br>お手数ですが <strong>📞 {{SUPPORT_PHONE_DISPLAY}}</strong> までお電話いただくか、ページを再読み込みして再送信してください。';
        if(btn) btn.disabled = false;
      }
    }, 400);

    console.log('Email:', results[0].status, results[0].reason || '');
    console.log('GAS:',   results[1].status, results[1].reason || '');
  });
}

// ---------- EmailJS 送信 ----------
function sendViaEmailJS(payload) {
  return new Promise((resolve, reject) => {
    // EmailJS未設定チェック
    if(EMAILJS_PUBLIC_KEY === 'YOUR_PUBLIC_KEY') {
      console.warn('EmailJS: 未設定のためスキップします');
      return reject('EmailJS not configured');
    }
    emailjs.init(EMAILJS_PUBLIC_KEY);
    const templateParams = {
      to_email:         payload.to_email,
      submitted_at:     payload.submitted_at,
      name:             payload.name,
      relation:         payload.relation,
      phone:            payload.phone,
      attendance:       payload.attendance,
      funeral_type:     payload.funeral_type,
      plan_name:        payload.plan_name,
      hall_name:        payload.hall_name,
      hall_address:     payload.hall_address,
      hall_access:      payload.hall_access,
      course_name:      payload.course_name,
      member_status:    payload.member_status,
      price_estimate:   payload.price_estimate,
      wishes:           payload.wishes,
      chat_log:         payload.chat_log,
      estimate_detail:  payload.estimate_detail || ''
    };
    emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams)
      .then(() => resolve('email_ok'))
      .catch(err => reject(err));
  });
}

// ---------- Google Apps Script 送信 ----------
function sendViaGAS(payload) {
  return new Promise((resolve, reject) => {
    // GAS未設定チェック
    if(GAS_WEBHOOK_URL === 'YOUR_GAS_WEBHOOK_URL') {
      console.warn('GAS: 未設定のためスキップします');
      return reject('GAS not configured');
    }
    fetch(GAS_WEBHOOK_URL, {
      method: 'POST',
      mode: 'no-cors', // GASはno-corsで送信
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(() => resolve('gas_ok'))
    .catch(err => reject(err));
  });
}

function printPage() {
  // 印刷日時をヘッダーにセット（短め）
  const now = new Date();
  const dateStr = now.getFullYear() + '年'
    + String(now.getMonth()+1).padStart(2,'0') + '月'
    + String(now.getDate()).padStart(2,'0') + '日 '
    + String(now.getHours()).padStart(2,'0') + ':'
    + String(now.getMinutes()).padStart(2,'0')
    + ' 作成';
  const pd = document.getElementById('printDate');
  if(pd) pd.textContent = dateStr;
  window.print();
}


// ========== 見積もりメール自動送信 ==========
async function sendEstimateEmail() {
  const hall = state.selectedHall;
  const plan = state.selectedPlan;
  const course = state.selectedCourse;

  // EmailJS未設定チェック
  if(EMAILJS_PUBLIC_KEY === 'YOUR_PUBLIC_KEY') {
    showEstimateEmailBanner('warning',
      '⚠️ EmailJSが未設定です。<br>' +
      'HTMLファイル内の <code>EMAILJS_SERVICE_ID</code>・<code>EMAILJS_TEMPLATE_ID</code>・<code>EMAILJS_PUBLIC_KEY</code> を設定してください。<br>' +
      '<a href="https://www.emailjs.com/" target="_blank" style="color:#1565c0;">▶ EmailJS設定ページへ</a>'
    );
    return;
  }
  if(!hall || !plan || !course) {
    gaTrack('email_send_error', { error_type: 'send_failed' });
    showEstimateEmailBanner('error', '⚠️ 見積もりが完成していません。各ステップを完了してください。');
    return;
  }

  const btn = document.getElementById('sendEstimateEmailBtn');
  if(btn) { btn.disabled = true; btn.textContent = '⏳ 送信中...'; }

  // ペイロード組み立て（submitAndCompleteと同じロジック）
  const courseInfo = COURSES[course] || {};
  const priceType  = (hall.special === 'living') ? 'living' : (plan.priceType || hall.pricingType);
  const pricing    = PRICING[priceType] || PRICING.compact;
  const isSimple   = plan.isSimplePlan || course === 'single';
  let prices;
  if(isSimple) {
    const sp = PRICING[priceType] || PRICING.chokuso;
    prices = sp ? sp.single : [198000, 248000];
  } else {
    prices = pricing[course] || pricing.ai || [0,0];
  }
  const isMember  = state.isMember === 'yes' || state.isMember === 'join';
  const basePrice = isMember ? prices[0] : prices[1];
  // ★30%減（2026/02 調整）
  const attendHosp = { under5:35000, under15:52500, '15to30':87500, '30to50':140000, over50:210000 };
  const hospEst   = isSimple ? 30000 : (attendHosp[state.attendance] || 70000);
  const totalEst  = basePrice + hospEst;
  const memberTag = isMember ? '会員価格' : '一般価格';

  const chatLog = chatState.log.length > 0
    ? chatState.log.map(l => (l.role==='bot'?'[担当AI] ':'[お客様] ') + l.msg).join('\n')
    : '（なし）';

  const now = new Date();
  const dateStr = now.getFullYear() + '/' +
    String(now.getMonth()+1).padStart(2,'0') + '/' +
    String(now.getDate()).padStart(2,'0') + ' ' +
    String(now.getHours()).padStart(2,'0') + ':' +
    String(now.getMinutes()).padStart(2,'0');

  // 見積もり詳細テキスト（メール本文用）
  const estimateDetail = [
    '━━━━━━━━━━━━━━━━━━━━',
    '⚘ {{COMPANY_NAME}}　お見積もり',
    '━━━━━━━━━━━━━━━━━━━━',
    '',
    '【お客様情報】',
    '　喪主名　　　: ' + (state.moshuName || '未入力') + '　様',
    '　故人様名　　: ' + (state.deceasedName || '未入力') + '　様',
    '　故人との関係: ' + getRelationLabel(state.relation),
    '　電話番号　　: ' + (state.phone || '未入力'),
    '　参列予定人数: ' + getAttendanceLabel(state.attendance),
    '　葬儀形式　　: ' + getFuneralTypeLabel(state.funeralType),
    ...(state.religion ? ['　ご宗教・宗派: ' + state.religion] : []),
    ...(state.templeInfo ? ['　菩提寺情報　: ' + state.templeInfo.replace(/\n/g, '\n　　　　　　　　　')] : []),
    '',
    '【選択プラン・会場】',
    '　プラン　 : ' + (plan.name || ''),
    '　会　場　 : ' + (hall.name || ''),
    '　住　所　 : ' + (hall.address || ''),
    '　祭壇コース: ' + (isSimple ? '（直葬・火葬式のためコースなし）' : (courseInfo.name || course)),
    '　会員区分 : ' + getMemberLabel(state.isMember),
    '',
    '【費用目安（' + memberTag + '）】',
    '　' + (isSimple ? '直葬・火葬費用' : '葬儀基本セット') + ': ' + formatPrice(basePrice),
    '　' + (isSimple ? '搬送費目安' : 'おもてなし費用目安') + ': ' + formatPrice(hospEst),
    '　─────────────────',
    '　合計目安　　　: ' + formatPrice(totalEst),
    '',
    '━━━━━━━━━━━━━━━━━━━━━━━━━',
    '【重要】これは正式見積もりではありません',
    '━━━━━━━━━━━━━━━━━━━━━━━━━',
    '',
    '⚠️ 上記の金額は概算の目安です',
    '',
    '実際の費用は以下により変動します：',
    '• おもてなし費用（参列者数による）',
    '• オプションサービスの選択内容',
    '• 式場の使用状況や日程',
    '• その他ご要望による追加項目',
    '',
    '正式なお見積もりは、担当者との打ち合わせ後に',
    '作成いたします。詳細は必ず担当者にご確認ください。',
    '',
    '━━━━━━━━━━━━━━━━━━━━━━━━━',
    '',
    '【ご希望・備考】',
    (state.wishes ? state.wishes.trim() : '（なし）'),
    '',
    '【チャット履歴】',
    chatLog,
    '',
    '📞 {{SUPPORT_PHONE_DISPLAY}}（24時間受付）',
    '🌐 {{COMPANY_URL}}'
  ].join('\n')
  const payload = {
    submitted_at:     dateStr,
    moshuName:        state.moshuName || '未入力',
    deceasedName:     state.deceasedName || '未入力',
    relation:         getRelationLabel(state.relation),
    phone:            state.phone || '未入力',
    attendance:       getAttendanceLabel(state.attendance),
    funeral_type:     getFuneralTypeLabel(state.funeralType),
    plan_name:        plan.name || '',
    hall_name:        hall.name || '',
    hall_address:     hall.address || '',
    hall_access:      hall.access || '',
    course_name:      isSimple ? '（直葬・火葬式）' : (courseInfo.name || ''),
    member_status:    getMemberLabel(state.isMember),
    price_estimate:   formatPrice(totalEst) + '（目安）',
    wishes:           state.wishes || '（なし）',
    chat_log:         chatLog,
    to_email:         EMAILJS_TO_EMAIL,
    estimate_detail:  estimateDetail
  };

  try {
    await sendViaEmailJS(payload);
    gaTrack('email_send_success', { hall_name: (state.selectedHall && state.selectedHall.name) || '' });
    showEstimateEmailBanner('success',
      '✅ メール送信完了！<br>' +
      '<strong>' + EMAILJS_TO_EMAIL + '</strong> に見積もり内容を送信しました。<br>' +
      '担当者よりご連絡をお待ちください。'
    );
    // 送信済みフラグ
    if(btn) { btn.textContent = '✅ 送信済み'; btn.style.background = '#4caf50'; }
  } catch(err) {
    console.error('見積もりメール送信エラー:', err);
    let msg = '❌ メール送信に失敗しました。<br>';
    if(err === 'EmailJS not configured') {
      msg += 'EmailJSが設定されていません。SERVICE_ID・TEMPLATE_ID・PUBLIC_KEYを確認してください。';
    } else if(err && err.status === 400) {
      msg += 'テンプレート変数名が一致しない可能性があります。EmailJSダッシュボードのテンプレートを確認してください。';
    } else if(err && err.status === 401) {
      msg += 'PUBLIC_KEYが正しくありません。EmailJSダッシュボードで確認してください。';
    } else {
      msg += 'お手数ですが <strong>📞 {{SUPPORT_PHONE_DISPLAY}}</strong> までお電話ください。<br>';
      msg += '<small style="color:#999;">' + JSON.stringify(err) + '</small>';
    }
    showEstimateEmailBanner('error', msg);
    if(btn) { btn.disabled = false; btn.textContent = '✉️ メール送信'; }
  }
}

function showEstimateEmailBanner(type, html) {
  const el = document.getElementById('estimateEmailBanner');
  if(!el) return;
  const styles = {
    success: 'background:#e8f5e9; border:2px solid #4caf50; color:#1b5e20;',
    error:   'background:#ffebee; border:2px solid #f44336; color:#b71c1c;',
    warning: 'background:#fff8e1; border:2px solid #ffa000; color:#e65100;'
  };
  el.style.cssText = 'display:block; margin-top:12px; padding:14px 16px; border-radius:10px; font-size:0.9rem; font-weight:bold; line-height:1.8; ' + (styles[type] || styles.warning);
  el.innerHTML = html;
  el.scrollIntoView({ behavior:'smooth', block:'nearest' });
}

// ========== PDF保存（html2canvas + jsPDF） ==========
function downloadEstimatePDF() {
  // A4要約PDF：基本は1枚。長文メモの時のみ2枚目（メモ詳細）を追加。
  // 注意文（正式見積ではない）は1回だけ（1枚目のみ）。

  const hall   = state.selectedHall;
  const plan   = state.selectedPlan;
  const course = state.selectedCourse;
  if (!hall || !plan) { alert('先に内容を完成させてください。'); return; }

  const now2 = new Date();
  const dateStr = now2.getFullYear() + '年'
    + String(now2.getMonth()+1).padStart(2,'0') + '月'
    + String(now2.getDate()).padStart(2,'0') + '日 '
    + String(now2.getHours()).padStart(2,'0') + ':'
    + String(now2.getMinutes()).padStart(2,'0');

  // 祭壇（別枠表示：要相談）
  const courseInfo = (course && typeof COURSES !== 'undefined') ? (COURSES[course] || {}) : {};
  const courseName = courseInfo.name || (course || '未選択');

  // 希望・不安（state.chatLog を優先）
  const wishesRaw = (state && Array.isArray(state.chatLog) && state.chatLog.length)
    ? state.chatLog.filter(l => l.role === 'user').map(l => l.msg).join(' ／ ')
    : (state.wishes || '（なし）');

  // 長文判定（ヒューリスティック）
  const isLong = (wishesRaw || '').length > 240;
  const wishes1 = isLong
    ? (String(wishesRaw).slice(0, 220) + '…（続きは2ページ目「メモ詳細」）')
    : wishesRaw;
  const wishes2 = isLong ? wishesRaw : '';

  // 費用目安（renderFinalSummary と同等の最低限）
  const priceType = hall ? ((hall.special === 'living') ? 'living' : (plan?.priceType || hall.pricingType)) : 'compact';
  const pricing = PRICING[priceType] || PRICING.compact;
  let prices;
  if(priceType === 'chokuso' || priceType === 'kasou') {
    prices = PRICING[priceType] ? PRICING[priceType].single : [198000, 248000];
  } else {
    prices = course ? (pricing[course] || (pricing.ai || [0,0])) : (pricing.ai || [0,0]);
  }
  const isMember = state.isMember === 'yes' || state.isMember === 'join';
  const basePrice = isMember ? (prices[0]||0) : (prices[1]||0);

  const warning = '※本資料は、控室での「整理・安心」のための目安です（正式見積ではありません）。';

  const printCSS = `
    @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
    @page { size: A4; margin: 12mm; }
    body { font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif; margin:0; padding:0; font-size:11px; color:#333; line-height:1.55; }
    .wrap { border: 2px solid #7CB342; border-radius: 10px; padding: 12px; }
    .hdr { text-align:center; border-bottom:2px solid #7CB342; padding-bottom:8px; margin-bottom:10px; }
    .hdr h1 { margin:0; font-size:15px; color:#33691E; letter-spacing:1px; }
    .hdr .date { margin-top:3px; font-size:10px; color:#666; }
    .warn { margin:10px 0; padding:8px 10px; background:#fff8e1; border:1.5px solid #ffb300; border-radius:10px; font-weight:800; color:#6d4c41; }
    table { width:100%; border-collapse: collapse; }
    td { padding:2px 0; vertical-align:top; }
    .k { width:40%; color:#666; }
    .v strong { font-weight:900; }
    .sec { margin-top:8px; font-weight:900; color:#33691E; border-left:4px solid #7CB342; padding-left:8px; }
    .memo { margin-top:4px; padding:8px 10px; border:1px dashed #c5e1a5; border-radius:10px; background:#f7fbf4; }
    .memo .t { font-weight:900; color:#33691E; margin-bottom:3px; }
    .footer { margin-top:10px; padding-top:8px; border-top:1px solid #ddd; display:flex; justify-content:space-between; gap:10px; font-size:10px; color:#555; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#F1F8E9; border:1px solid #C5E1A5; color:#33691E; font-weight:900; }

    /* 2ページ目（メモ詳細） */
    .page-break { break-before: page; page-break-before: always; }
    .detail-hdr { text-align:center; margin: 2px 0 8px; }
    .detail-hdr .title { font-weight:900; color:#33691E; font-size:13px; }
    .detail-hdr .sub { font-size:10px; color:#777; }
    .detail-box { border: 1.5px solid #c5e1a5; border-radius: 10px; padding: 10px; background:#fff; white-space: pre-wrap; word-break: break-word; }
  `;

  const esc = (s) => (s==null?'':String(s)).replace(/[&<>"']/g, m=>({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));

  const page2 = isLong ? `
    <div class="page-break"></div>
    <div class="wrap">
      <div class="detail-hdr">
        <div class="title">ご希望・ご不安（メモ詳細）</div>
        <div class="sub">喪主名：${esc(state.moshuName || '')}　／　作成：${esc(dateStr)}</div>
        <div class="sub">※このページには注意文を再掲しません（1枚目のみ表示）</div>
      </div>
      <div class="detail-box">${esc(wishes2 || '')}</div>
      <div class="footer">
        <div>📞 {{SUPPORT_PHONE_DISPLAY}}（24時間受付）</div>
        <div>{{COMPANY_URL}}</div>
      </div>
    </div>
  ` : '';

  const html = `<!doctype html><html lang="ja"><head><meta charset="utf-8"><title>要約PDF</title><style>${printCSS}</style></head>
  <body>
    <div class="wrap">
      <div class="hdr">
        <h1>⚘ {{COMPANY_NAME}}　控室サポート（要約）</h1>
        <div class="date">${esc(dateStr)}　<span class="badge">目安</span></div>
      </div>

      <div class="warn">${esc(warning)}</div>

      <div class="sec">基本情報</div>
      <table>
        <tr><td class="k">喪主名</td><td class="v"><strong>${esc(state.moshuName||'')}</strong></td></tr>
        <tr><td class="k">故人名</td><td class="v">${esc(state.deceasedName||'')}</td></tr>
        <tr><td class="k">関係</td><td class="v">${esc(getRelationLabel(state.relation)||'')}</td></tr>
        <tr><td class="k">電話番号</td><td class="v">${esc(state.phone||'')}</td></tr>
        <tr><td class="k">参列予定</td><td class="v"><strong>${esc(getAttendanceLabel(state.attendance)||'')}</strong></td></tr>
        <tr><td class="k">形式</td><td class="v"><strong>${esc(getFuneralTypeLabel(state.funeralType)||'')}</strong></td></tr>
      </table>

      <div class="sec">選択内容</div>
      <table>
        <tr><td class="k">式場</td><td class="v"><strong>${esc(hall?.name||'')}</strong></td></tr>
        <tr><td class="k">プラン</td><td class="v"><strong>${esc(plan?.name||'')}</strong></td></tr>
        <tr><td class="k">祭壇（別枠）</td><td class="v"><strong>${esc(courseName)}</strong>（要相談）</td></tr>
        <tr><td class="k">会員区分</td><td class="v">${esc(getMemberLabel(state.isMember)||'')}</td></tr>
        <tr><td class="k">費用目安</td><td class="v"><strong style="color:#33691E;font-size:13px;">${esc(formatPrice(basePrice))}</strong></td></tr>
      </table>

      <div class="memo">
        <div class="t">ご希望・ご不安（要点）</div>
        <div>${esc(wishes1||'（なし）')}</div>
      </div>

      <div class="footer">
        <div>📞 {{SUPPORT_PHONE_DISPLAY}}（24時間受付）</div>
        <div>{{COMPANY_URL}}</div>
      </div>
    </div>

    ${page2}

    <script>window.onload=function(){window.print();};<\/script>
  </body></html>`;

  const finalHtml = resolveBrandPlaceholders(html);

  const blob = new Blob([finalHtml], { type: 'text/html;charset=utf-8' });
  const url  = URL.createObjectURL(blob);
  const win  = window.open(url, '_blank');
  if (!win) {
    alert('ポップアップがブロックされています。ブラウザの設定で許可してから再度お試しください。');
    URL.revokeObjectURL(url);
    return;
  }
  setTimeout(function(){ URL.revokeObjectURL(url); }, 30000);
}



function loadScript(src) {
  return new Promise((resolve, reject) => {
    if(document.querySelector(`script[src="${src}"]`)) { resolve(); return; }
    const s = document.createElement('script');
    s.src = src; s.onload = resolve; s.onerror = reject;
    document.head.appendChild(s);
  });
}

// ========== LINE共有 ==========
function copySummaryToClipboard() {
  try {
    // 共有用の文章（要約）を組み立て
    const hall   = state.selectedHall;
    const plan   = state.selectedPlan;
    const course = state.selectedCourse;

    const now = new Date();
    const dateStr = now.getFullYear() + '年'
      + String(now.getMonth()+1).padStart(2,'0') + '月'
      + String(now.getDate()).padStart(2,'0') + '日 '
      + String(now.getHours()).padStart(2,'0') + ':'
      + String(now.getMinutes()).padStart(2,'0');

    // 祭壇コース名
    const courseInfo = (course && typeof COURSES !== 'undefined') ? (COURSES[course] || {}) : {};
    const courseName = courseInfo.name || (course || '未選択');

    // ユーザー入力（要望・不安）
    // ※環境によっては chatState がグローバル参照できないケースがあるため、state.chatLog を優先して参照
    const wishes = (state && Array.isArray(state.chatLog) && state.chatLog.length)
      ? state.chatLog.filter(l=>l.role==='user').map(l=>l.msg).join(' ／ ')
      : (state.wishes || '（なし）');

    const lines = [];
    lines.push('【重要】これは正式見積ではありません');
    lines.push('ご依頼後〜本打ち合わせまでに、希望や不安を整理するための入力内容です。');
    lines.push('本打ち合わせで内容を確定後、正式なお見積りをご案内します。');
    lines.push('');
    lines.push('【入力内容 要約】' + dateStr);
    lines.push(`${state.moshuName || '（喪主名未入力）'} 様`);
    if(state.deceasedName) lines.push(`故人名: ${state.deceasedName} 様`);
    if(state.relation) lines.push(`関係: ${getRelationLabel(state.relation)}`);
    if(state.phone) lines.push(`電話: ${state.phone}`);
    if(state.attendance) lines.push(`参列予定: ${getAttendanceLabel(state.attendance)}`);
    if(state.funeralType) lines.push(`形式: ${getFuneralTypeLabel(state.funeralType)}`);
    lines.push('');
    lines.push('【選択内容】');
    lines.push(`式場: ${(hall && hall.name) ? hall.name : '未選択'}`);
    lines.push(`プラン: ${(plan && plan.name) ? plan.name : '未選択'}`);
    lines.push(`祭壇: ${courseName}（※要相談・別枠）`);
    if(state.religion) lines.push(`宗教: ${state.religion}`);
    if(state.templeInfo) lines.push(`お寺情報: ${state.templeInfo}`);
    lines.push('');
    lines.push('【ご希望・ご不安】');
    lines.push(wishes || '（なし）');
    lines.push('');
    lines.push('📞 {{SUPPORT_PHONE_DISPLAY}}（24時間受付）');
    lines.push('🌐 {{COMPANY_URL}}');

    const text = resolveBrandPlaceholders(lines.join('\n'));

    const doCopy = (t) => {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        return navigator.clipboard.writeText(t);
      }
      // 旧ブラウザフォールバック
      return new Promise((resolve, reject) => {
        const ta = document.createElement('textarea');
        ta.value = t;
        ta.setAttribute('readonly','');
        ta.style.position = 'fixed';
        ta.style.top = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        try {
          const ok = document.execCommand('copy');
          document.body.removeChild(ta);
          ok ? resolve() : reject(new Error('execCommand copy failed'));
        } catch(e) {
          document.body.removeChild(ta);
          reject(e);
        }
      });
    };

    doCopy(text).then(() => {
      alert('✅ 要約をクリップボードにコピーしました。\nLINEやメモ、担当者への共有に貼り付けてお使いください。');
    }).catch(() => {
      // どうしてもコピーできない場合はモーダルで提示
      if (typeof showShareFallbackModal === 'function') {
        showShareFallbackModal('コピーできませんでした', text, '', '');
      } else {
        alert('⚠️ コピーに失敗しました。もう一度お試しください。');
      }
    });

  } catch (e) {
    console.error('copySummaryToClipboard error:', e);
    alert('⚠️ 要約の生成に失敗しました。');
  }
}

function shareToLINE() {
  const hall   = state.selectedHall;
  const plan   = state.selectedPlan;
  const course = state.selectedCourse;
  if (!hall || !plan) { alert('先に見積もりを完成させてください。'); return; }

  /* ── 価格計算（renderEstimate と同じロジック） ── */
  const priceType  = (hall.special === 'living') ? 'living' : (plan.priceType || hall.pricingType);
  const pricing    = PRICING[priceType] || PRICING.compact;
  const isSimple   = plan.isSimplePlan || course === 'single';
  let prices;
  if (isSimple) {
    const sp = PRICING[priceType] || PRICING.chokuso;
    prices   = sp ? sp.single : [198000, 248000];
  } else {
    prices = pricing[course] || [0, 0];
  }
  const isMember  = state.isMember === 'yes' || state.isMember === 'join';
  const basePrice = isMember ? prices[0] : prices[1];
  const hospMap   = { under5:35000, under15:52500, '15to30':87500, '30to50':140000, over50:210000 };
  const hospEst   = isSimple ? 30000 : (hospMap[state.attendance] || 70000);
  const optEst    = isSimple ? 0 : 200000;
  const total     = basePrice + hospEst + (isSimple ? 0 : optEst);

  const courseName  = isSimple
    ? '（直葬・火葬式 / コース選択なし）'
    : (COURSES[course] ? COURSES[course].name : course);
  const memberTag   = isMember ? '【会員価格】' : '【一般価格】';
  const memberNote  = state.isMember === 'join' ? '\n　　※当日会員入会で30%割引予定' : '';

  /* ── 送信テキスト組み立て ── */
  const SEP  = '━━━━━━━━━━━━━━━━━━━━';
  const SEP2 = '┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄';
  const lines = [
    SEP,
    '　🌿 {{COMPANY_NAME}}｜お見積もり内容',
    SEP,
    '',
    '📋 お客様情報',
    `　喪主名　　　: ${state.moshuName || '未入力'} 様`,
    `　故人様名　　: ${state.deceasedName || '未入力'} 様`,
    `　故人との関係 : ${getRelationLabel(state.relation)}`,
    `　参列予定人数 : ${getAttendanceLabel(state.attendance)}`,
    `　葬儀の形式　: ${getFuneralTypeLabel(state.funeralType)}`,
    '',
    '🏛 選択内容',
    `　プラン　　: ${plan.name}`,
    `　会　場　　: ${hall.name}`,
    `　〒住　所　: ${hall.address}`,
    `　祭壇コース : ${courseName}`,
    `　会員区分　: ${getMemberLabel(state.isMember)}${memberNote}`,
    '',
    '💴 費用目安（税込）',
    `　▶ ${isSimple ? '直葬・火葬費用' : '葬儀基本セット'}`,
    `　　 ${formatPrice(basePrice)}　${memberTag}`,
    `　▶ ${isSimple ? '搬送費目安' : 'おもてなし費（返礼品・食事等）'}`,
    `　　 ${formatPrice(hospEst)}${isSimple ? '' : '　※参列者数により変動'}`,
  ];
  if (!isSimple) {
    lines.push('　▶ オプション目安（生花・料理・バス等）');
    lines.push(`　　 ${formatPrice(optEst)}　※内容により変動`);
  }
  lines.push(SEP2);
  lines.push('　💰 合計目安');
  lines.push(`　　 ${formatPrice(total)}　${memberTag}`);
  lines.push('　　 （消費税10%込み）');
  lines.push('');
  lines.push(SEP);
  lines.push('⚠️ この金額はあくまで【目安】です。');
  lines.push('　 不要なオプションは削除できます。');
  if (state.wishes && state.wishes.trim()) {
    lines.push('');
    lines.push('📝 ご希望・備考');
    lines.push(state.wishes.trim());
  }
  lines.push('');
  lines.push('📞 {{SUPPORT_PHONE_DISPLAY}}（24時間365日）');
  lines.push('🌐 {{COMPANY_URL}}');
  lines.push(SEP);

  const text = resolveBrandPlaceholders(lines.join('\n'));

  /* ── URL組み立て・起動 ── */
  const encoded = encodeURIComponent(text);
  const url     = 'https://line.me/R/msg/text/?text=' + encoded;

  const opened = tryOpenUrl(url);
  if(!opened) {
    showShareFallbackModal('LINEで共有できませんでした', text, url, 'LINE用リンクを開く');
  }

  /* フォールバック: LINEが開けない場合クリップボードにコピー */
  setTimeout(() => {
    if (document.hidden) return; // LINEが開いたと判断
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(() => {
        alert('LINEアプリが開きます。開かない場合はクリップボードにコピーしました。\nLINEのトークにペーストしてお使いください。');
      }).catch(() => {});
    }
  }, 2500);

  if (typeof gaTrack === 'function') gaTrack('line_share', { step: state.currentStep });
}

function saveFormData() {
  try {
    const draft = {
      state: {
        moshuName: state.moshuName, deceasedName: state.deceasedName, relation: state.relation,
        attendance: state.attendance, funeralType: state.funeralType,
        isMember: state.isMember, wishes: state.wishes,
        selectedPlan: state.selectedPlan ? state.selectedPlan.id : null,
        selectedHall: state.selectedHall ? state.selectedHall.id : null,
        selectedCourse: state.selectedCourse,
        currentStep: state.currentStep
      },
      savedAt: new Date().toISOString()
    };
    localStorage.setItem(SAVE_KEY, JSON.stringify(draft));
    showAutoSaveBanner('💾 入力内容を自動保存しました');
  } catch(e) { console.warn('自動保存失敗:', e); }
}

function loadFormData() {
  try {
    const raw = localStorage.getItem(SAVE_KEY);
    if(!raw) return false;
    const draft = JSON.parse(raw);
    if(!draft || !draft.state) return false;
    const saved = draft.state;
    const savedAt = draft.savedAt ? new Date(draft.savedAt) : null;
    const now = new Date();
    if(savedAt && (now - savedAt) > 48 * 60 * 60 * 1000) {
      localStorage.removeItem(SAVE_KEY); return false;
    }
    // 確認ダイアログ
    const dateStr = savedAt ? (savedAt.getMonth()+1)+'月'+savedAt.getDate()+'日 '+String(savedAt.getHours()).padStart(2,'0')+':'+String(savedAt.getMinutes()).padStart(2,'0') : '';
    const msg = `前回の入力データが見つかりました（${dateStr}保存）。\n続きから再開しますか？`;
    if(!confirm(msg)) { localStorage.removeItem(SAVE_KEY); return false; }
    // stateを復元
    state.moshuName = saved.moshuName || '';
    state.deceasedName = saved.deceasedName || '';
    state.relation = saved.relation || '';
    state.attendance = saved.attendance || '';
    state.funeralType = saved.funeralType || '';
    state.isMember = saved.isMember || '';
    state.wishes = saved.wishes || '';
    if(saved.selectedPlan) {
      // planオブジェクトを再取得（PLANS内を検索）
      for(const k in PLANS){ if(PLANS[k].id === saved.selectedPlan){ state.selectedPlan = PLANS[k]; break; } }
    }
    if(saved.selectedHall) {
      state.selectedHall = HALLS[saved.selectedHall] || null;
    }
    state.selectedCourse = saved.selectedCourse || null;
    const step = Math.max(1, Math.min(saved.currentStep || 1, 7));
    showAutoSaveBanner('✅ 前回の入力内容を復元しました');
    return step;
  } catch(e) { console.warn('復元失敗:', e); return false; }
}

function clearSavedData() {
  localStorage.removeItem(SAVE_KEY);
  showAutoSaveBanner('🗑 保存データを削除しました');
  setTimeout(() => {
    const b = document.getElementById('autoSaveBanner');
    if(b) b.style.display = 'none';
  }, 2000);
}

let _saveTimer = null;
function autoSaveDebounced() {
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(() => saveFormData(), 1500);
}

function showAutoSaveBanner(msg) {
  const b = document.getElementById('autoSaveBanner');
  const m = document.getElementById('autoSaveMsg');
  if(b && m) {
    m.textContent = msg;
    b.style.display = 'flex';
    clearTimeout(b._hideTimer);
    b._hideTimer = setTimeout(() => { b.style.display = 'none'; }, 3000);
  }
}

// ========== 起動時：途中保存データの復元 ==========
(function initApp() {
  const savedStep = loadFormData();
  if(savedStep && savedStep > 1) {
    // 現在のstep1をhideして保存済みstepへ遷移
    document.getElementById('step1').classList.remove('active');
    document.getElementById('dot1').classList.remove('active');
    // 1〜savedStep-1 を done にする
    for(let i = 1; i < savedStep; i++) {
      const dot = document.getElementById('dot'+i);
      if(dot) { dot.classList.remove('active'); dot.classList.add('done'); }
      const con = document.getElementById('con'+i);
      if(con) con.classList.add('done');
    }
    state.currentStep = savedStep;
    const stepEl = document.getElementById('step'+savedStep);
    if(stepEl) stepEl.classList.add('active');
    const dotEl = document.getElementById('dot'+savedStep);
    if(dotEl) { dotEl.classList.add('active'); dotEl.classList.remove('done'); }
    // ステップ固有の描画
    if(savedStep === 3) renderPlans();
    if(savedStep === 4) renderHalls();
    if(savedStep === 5) renderCourses();
    if(savedStep === 7) renderEstimate();
  }
})();
  // ===== 最初に戻る関数（全ステップ共通） =====
  function restartApp() {
    // STEP3以降は入力済みデータがあるため強めの警告
    const warningMsg = state.currentStep >= 3
      ? '最初の画面に戻ります。\nここまでの入力内容（プラン・ホール・コース選択など）はすべてクリアされます。よろしいですか？'
      : '最初の画面に戻ります。入力内容はクリアされますがよろしいですか？';

    if (!confirm(warningMsg)) return;

    // state を完全初期化
    state.moshuName      = '';
    state.deceasedName   = '';
    state.relation       = '';
    state.phone          = '';
    state.attendance     = '';
    state.funeralType    = '';
    state.selectedPlan   = null;
    state.selectedHall   = null;
    state.selectedCourse = null;
    state.wishes         = '';
    state.concerns       = '';
    state.chatLog        = [];
    state.isMember       = '';
    state.religion       = '';
    state.templeInfo     = '';

    // フォーム入力欄をクリア
    ['clientName','clientRelation','clientPhone'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });

    // 選択済みハイライトをリセット
    document.querySelectorAll('.btn-choice.selected').forEach(b => b.classList.remove('selected'));

    // localStorage のオートセーブをクリア
    try { localStorage.removeItem('saikiFormData'); } catch(e) {}

    // STEP1へ遷移してトップへスクロール
    goToStep(1);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }


// ===== SMS 共有 =====
function smsShare() {
  const hall   = state.selectedHall;
  const plan   = state.selectedPlan;
  const course = state.selectedCourse;

  /* 費用計算 */
  let totalStr = '';
  if (hall && plan && course) {
    const priceType = (hall.special === 'living') ? 'living' : (plan.priceType || hall.pricingType);
    const pricing   = PRICING[priceType] || PRICING.compact;
    const isSimple  = plan.isSimplePlan || course === 'single';
    let prices;
    if (isSimple) {
      const sp = PRICING[priceType] || PRICING.chokuso;
      prices   = sp ? sp.single : [198000, 248000];
    } else {
      prices = pricing[course] || [0, 0];
    }
    const isMember  = state.isMember === 'yes' || state.isMember === 'join';
    const basePrice = isMember ? prices[0] : prices[1];
    const hospMap   = { under5:35000, under15:52500, '15to30':87500, '30to50':140000, over50:210000 };
    const hospEst   = isSimple ? 30000 : (hospMap[state.attendance] || 70000);
    const optEst    = isSimple ? 0 : 200000;
    const total     = basePrice + hospEst + (isSimple ? 0 : optEst);
    totalStr        = '\n合計目安: ' + formatPrice(total) + (isMember ? '【会員】' : '【一般】');
  }

  const hallName   = (hall && hall.name)      || '未選択';
  const planName   = (plan && plan.name)      || '未選択';
  const courseName = course
    ? (COURSES[course] ? COURSES[course].name : course)
    : '未選択';

  const body = [
    '【重要】これは正式見積もりではありません',
    '',
    '【{{COMPANY_NAME}} 概算お見積もり】',
    `${state.moshuName || 'お客様'} 様`,
    '',
    '▼ ご選択内容',
    `式場: ${hallName}`,
    `プラン: ${planName}`,
    `祭壇: ${courseName}`,
    ...(state.religion ? [`宗教: ${state.religion}`] : []),
    totalStr,
    '',
    '📞 {{SUPPORT_PHONE_DISPLAY}}',
    '（24時間365日受付）',
  ].join('\n');
  const body2 = resolveBrandPlaceholders(body);

  const encoded = encodeURIComponent(body2);
  const ua  = navigator.userAgent;
  const url = /iPhone|iPad|iPod/.test(ua)
    ? 'sms:&body='  + encoded
    : 'sms:?body='  + encoded;

  // iOS/SNS内ブラウザ対策：プログラムクリックより location.href の方が成功率が高い
  try {
    window.location.href = url;
  } catch(e) {
    console.warn('SMS: location.href failed', e);
  }

  if (typeof gaTrack === 'function') gaTrack('sms_share', { step: state.currentStep });
}


// ========== 宗教・菩提寺関連の関数 ==========
function updateReligionState() {
  state.religion = document.getElementById('religion').value;
  saveToLocalStorage();
}

function updateTempleState() {
  state.templeInfo = document.getElementById('templeInfo').value.trim();
  saveToLocalStorage();
}



// ================================
// 共有/出力が開けない環境向けフォールバック
// ================================
function showShareFallbackModal(title, text, actionUrl, actionLabel) {
  const old = document.getElementById('shareFallbackModal');
  if (old) old.remove();

  const overlay = document.createElement('div');
  overlay.id = 'shareFallbackModal';
  overlay.style.cssText = [
    'position:fixed','inset:0','z-index:99999',
    'background:rgba(0,0,0,0.55)','display:flex',
    'align-items:center','justify-content:center','padding:18px'
  ].join(';');

  const card = document.createElement('div');
  card.style.cssText = [
    'width:100%','max-width:560px','background:#fff','border-radius:14px',
    'border:3px solid #ff6f00','box-shadow:0 10px 30px rgba(0,0,0,0.25)',
    'padding:16px 14px','font-family:"Noto Sans JP",sans-serif'
  ].join(';');

  const h = document.createElement('div');
  h.textContent = title || '共有に失敗しました（コピーしてお使いください）';
  h.style.cssText = 'font-weight:900;font-size:1.05rem;color:#d84315;text-align:center;margin-bottom:10px;';

  const note = document.createElement('div');
  note.innerHTML = 'お使いの環境（アプリ内ブラウザ/ポップアップ制限等）により、共有画面が開けない場合があります。<br><strong>下の内容をコピーして</strong> LINE/SMS に貼り付けてください。';
  note.style.cssText = 'font-size:0.88rem;line-height:1.7;color:#5d4037;background:#fff3e0;padding:10px;border-radius:10px;margin-bottom:10px;';

  const ta = document.createElement('textarea');
  ta.value = text || '';
  ta.readOnly = true;
  ta.style.cssText = 'width:100%;height:210px;resize:vertical;border:2px solid #ffe0b2;border-radius:10px;padding:10px;font-size:0.86rem;line-height:1.55;';

  const btnRow = document.createElement('div');
  btnRow.style.cssText = 'display:flex;gap:10px;margin-top:12px;flex-wrap:wrap;';

  const copyBtn = document.createElement('button');
  copyBtn.type = 'button';
  copyBtn.textContent = '📋 コピー';
  copyBtn.style.cssText = 'flex:1;min-width:140px;padding:12px;border:none;border-radius:12px;background:linear-gradient(135deg,#ff6f00,#e65100);color:#fff;font-weight:900;';
  copyBtn.onclick = async () => {
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(ta.value);
      } else {
        ta.focus(); ta.select();
        document.execCommand('copy');
      }
      copyBtn.textContent = '✅ コピーしました';
      setTimeout(()=>copyBtn.textContent='📋 コピー', 1400);
    } catch(e) {
      alert('コピーに失敗しました。テキストを長押し/選択してコピーしてください。');
    }
  };

  let openLink = null;
  if (actionUrl) {
    openLink = document.createElement('a');
    openLink.href = actionUrl;
    openLink.target = '_blank';
    openLink.rel = 'noopener noreferrer';
    openLink.textContent = actionLabel || '🔗 リンクを開く';
    openLink.style.cssText = 'flex:1;min-width:160px;padding:12px;border:2px solid #ff6f00;border-radius:12px;background:#fff;color:#e65100;font-weight:900;text-align:center;text-decoration:none;display:inline-block;';
  }

  const closeBtn = document.createElement('button');
  closeBtn.type = 'button';
  closeBtn.textContent = '閉じる';
  closeBtn.style.cssText = 'min-width:120px;padding:12px;border:2px solid #ddd;border-radius:12px;background:#fff;color:#555;font-weight:800;';
  closeBtn.onclick = () => overlay.remove();

  btnRow.appendChild(copyBtn);
  if (openLink) btnRow.appendChild(openLink);
  btnRow.appendChild(closeBtn);

  card.appendChild(h);
  card.appendChild(note);
  card.appendChild(ta);
  card.appendChild(btnRow);

  overlay.appendChild(card);
  overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
  document.body.appendChild(overlay);
}

function tryOpenUrl(url) {
  // window.open が使えない環境もあるため複数手段
  let win = null;
  try { win = window.open(url, '_blank'); } catch(e) {}
  if (win) return true;
  try {
    window.location.href = url;
    return true;
  } catch(e) {}
  return false;
}
</script>
</body>
</html>                             