<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã•ã„ãè‘¬ç¥­ ã”è‘¬å„€ã‚µãƒãƒ¼ãƒˆ</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Noto Sans JP', 'Hiragino Kaku Gothic Pro', Meiryo, sans-serif; background: #f5f0ea; color: #333; font-size: 16px; -webkit-text-size-adjust: 100%; }
  
  .app-header {
    background: linear-gradient(135deg, #2c2c2c 0%, #1a1a2e 100%);
    color: #fff; padding: 16px 20px; text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  }
  .app-header h1 { font-size: 1.3rem; letter-spacing: 2px; }
  .app-header p { font-size: 0.8rem; opacity: 0.8; margin-top: 4px; }

  /* éŸ³å£°å…¥åŠ›æ¡ˆå†…ãƒãƒŠãƒ¼ */
  .voice-notice {
    background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
    border: 2px solid #4caf50;
    border-radius: 10px;
    padding: 12px 16px;
    margin: 12px 16px;
    display: flex; align-items: center; gap: 10px;
  }
  .voice-notice .icon { font-size: 1.8rem; }
  .voice-notice .text { font-size: 0.85rem; color: #2e7d32; font-weight: bold; line-height: 1.5; }

  /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
  .progress-bar {
    background: #e0d5c8; padding: 12px 16px;
    display: flex; gap: 6px; justify-content: center; align-items: center;
    overflow-x: auto;
  }
  .step-dot {
    width: 28px; height: 28px; border-radius: 50%;
    background: #c5b99a; color: #fff; font-size: 0.7rem;
    display: flex; align-items: center; justify-content: center;
    font-weight: bold; flex-shrink: 0; transition: all 0.3s;
  }
  .step-dot.active { background: #8b6f47; transform: scale(1.15); }
  .step-dot.done { background: #4caf50; }
  .step-connector { width: 20px; height: 2px; background: #c5b99a; flex-shrink: 0; }
  .step-connector.done { background: #4caf50; }

  /* ã‚¹ãƒ†ãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
  .step { display: none; padding: 20px 18px; }
  .step.active { display: block; }
  
  .step-title {
    font-size: 1.1rem; font-weight: bold; color: #5c3d2e;
    margin-bottom: 16px; padding-bottom: 8px;
    border-bottom: 2px solid #d4a76a;
    display: flex; align-items: center; gap: 8px;
  }
  .step-title .step-num {
    background: #8b6f47; color: #fff; width: 28px; height: 28px;
    border-radius: 50%; display: flex; align-items: center;
    justify-content: center; font-size: 0.85rem; flex-shrink: 0;
  }

  /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
  .form-group { margin-bottom: 18px; }
  .form-label { font-size: 0.9rem; font-weight: bold; color: #5c3d2e; margin-bottom: 8px; display: block; }
  .form-input {
    width: 100%; padding: 12px; border: 2px solid #d4c4a8;
    border-radius: 8px; font-size: 0.95rem;
    background: #fff; transition: border-color 0.2s;
  }
  .form-input:focus { outline: none; border-color: #8b6f47; }
  .form-select {
    width: 100%; padding: 12px; border: 2px solid #d4c4a8;
    border-radius: 8px; font-size: 0.95rem;
    background: #fff; appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M0 0l6 8 6-8z' fill='%238b6f47'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 12px center;
    cursor: pointer;
  }
  .form-select:focus { outline: none; border-color: #8b6f47; }

  /* é¸æŠãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— */
  .btn-group { display: flex; flex-direction: column; gap: 8px; }
  .btn-choice {
    width: 100%; padding: 14px 16px; border: 2px solid #d4c4a8;
    border-radius: 10px; background: #fff; cursor: pointer;
    text-align: left; font-size: 0.95rem; color: #333;
    transition: all 0.2s; display: flex; align-items: center; gap: 10px;
  }
  .btn-choice:hover { border-color: #8b6f47; background: #faf5ee; }
  .btn-choice.selected { border-color: #8b6f47; background: #f3e9d8; color: #5c3d2e; font-weight: bold; }
  .btn-choice .choice-icon { font-size: 1.4rem; flex-shrink: 0; }
  .btn-choice .choice-text { flex: 1; }
  .btn-choice .choice-desc { font-size: 0.78rem; color: #888; margin-top: 2px; }
  .btn-choice.selected .choice-desc { color: #8b6f47; }
  .btn-choice .check-mark { display: none; color: #8b6f47; font-size: 1.2rem; }
  .btn-choice.selected .check-mark { display: block; }

  /* ãƒ—ãƒ©ãƒ³ææ¡ˆã‚«ãƒ¼ãƒ‰ */
  .plan-cards { display: flex; flex-direction: column; gap: 12px; margin-bottom: 16px; }
  .plan-card {
    border-radius: 12px; overflow: hidden;
    border: 2px solid #d4c4a8; background: #fff;
    transition: all 0.2s; cursor: pointer;
  }
  .plan-card:hover { border-color: #8b6f47; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
  .plan-card.selected { border-color: #8b6f47; box-shadow: 0 4px 16px rgba(139,111,71,0.3); }
  .plan-card-badge {
    padding: 6px 14px; font-size: 0.78rem; font-weight: bold;
    display: flex; align-items: center; gap: 6px;
  }
  .badge-small { background: #e3f2fd; color: #1565c0; }
  .badge-rec { background: linear-gradient(135deg, #ffd700, #ffb300); color: #5c3d00; }
  .badge-large { background: #fce4ec; color: #880e4f; }
  .plan-card-body { padding: 14px; }
  .plan-card-title { font-size: 1.05rem; font-weight: bold; color: #333; margin-bottom: 4px; }
  .plan-card-sub { font-size: 0.82rem; color: #888; margin-bottom: 8px; }
  .plan-card-desc { font-size: 0.85rem; color: #555; line-height: 1.6; }

  /* ãƒ›ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ */
  .hall-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
  @media (max-width: 400px) { .hall-cards { grid-template-columns: 1fr; } }
  .hall-card {
    border-radius: 12px; overflow: hidden;
    border: 2px solid #d4c4a8; background: #fff;
    cursor: pointer; transition: all 0.2s;
  }
  .hall-card:hover { border-color: #8b6f47; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
  .hall-card.selected { border-color: #8b6f47; box-shadow: 0 4px 16px rgba(139,111,71,0.3); }
  .hall-card-img { width: 100%; height: 110px; object-fit: cover; }
  .hall-card-body { padding: 10px; }
  .hall-card-name { font-size: 0.85rem; font-weight: bold; color: #333; margin-bottom: 4px; }
  .hall-card-cap { font-size: 0.73rem; color: #888; margin-bottom: 3px; }
  .hall-card-addr { font-size: 0.7rem; color: #aaa; }
  .hall-recommended-badge {
    position: absolute; top: 6px; right: 6px;
    background: #ffd700; color: #333; font-size: 0.65rem;
    padding: 2px 6px; border-radius: 10px; font-weight: bold;
  }
  .hall-card-wrapper { position: relative; }
  .hall-selected-check {
    position: absolute; top: 6px; left: 6px; display: none;
    background: #4caf50; color: #fff; width: 24px; height: 24px;
    border-radius: 50%; align-items: center; justify-content: center; font-size: 0.9rem;
  }
  .hall-card.selected .hall-selected-check { display: flex; }

  /* ã‚³ãƒ¼ã‚¹ã‚«ãƒ¼ãƒ‰ */
  .course-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
  @media (max-width: 400px) { .course-cards { grid-template-columns: 1fr; } }
  .course-card {
    border-radius: 12px; overflow: hidden;
    border: 2px solid #d4c4a8; background: #fff;
    cursor: pointer; transition: all 0.2s;
  }
  .course-card:hover { border-color: #8b6f47; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
  .course-card.selected { border-color: #d4a76a; box-shadow: 0 4px 16px rgba(212,167,106,0.4); }
  .course-card-img { width: 100%; height: 130px; object-fit: cover; }
  .course-card-body { padding: 12px; }
  .course-card-name { font-size: 1rem; font-weight: bold; color: #5c3d2e; margin-bottom: 4px; }
  .course-card-price { font-size: 0.82rem; color: #888; }
  .course-card-price .member-price { font-size: 1rem; font-weight: bold; color: #8b6f47; }
  .course-card-desc { font-size: 0.75rem; color: #888; margin-top: 4px; line-height: 1.5; }
  .course-selected-mark { display: none; text-align: center; padding: 4px; background: #f3e9d8; font-size: 0.8rem; color: #8b6f47; font-weight: bold; }
  .course-card.selected .course-selected-mark { display: block; }

  /* ãƒŠãƒ“ãƒœã‚¿ãƒ³ */
  .nav-buttons { display: flex; gap: 10px; margin-top: 20px; }
  .btn-back {
    flex: 1; padding: 14px; border: 2px solid #c5b99a;
    border-radius: 10px; background: #fff; color: #8b6f47;
    font-size: 1rem; cursor: pointer; font-weight: bold;
    transition: all 0.2s;
  }
  .btn-back:hover { background: #f5f0ea; }
  .btn-next {
    flex: 2; padding: 14px; border: none;
    border-radius: 10px; background: linear-gradient(135deg, #8b6f47, #6b4f2f);
    color: #fff; font-size: 1rem; cursor: pointer;
    font-weight: bold; transition: all 0.2s;
    box-shadow: 0 3px 8px rgba(139,111,71,0.4);
  }
  .btn-next:hover { background: linear-gradient(135deg, #9b7f57, #7b5f3f); transform: translateY(-1px); }
  .btn-next:disabled { background: #c5b99a; cursor: not-allowed; transform: none; box-shadow: none; }
  .btn-finish {
    flex: 2; padding: 14px; border: none;
    border-radius: 10px; background: linear-gradient(135deg, #4caf50, #388e3c);
    color: #fff; font-size: 1rem; cursor: pointer;
    font-weight: bold; transition: all 0.2s;
    box-shadow: 0 3px 8px rgba(76,175,80,0.4);
  }

  /* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ */
  .form-textarea {
    width: 100%; padding: 12px; border: 2px solid #d4c4a8;
    border-radius: 8px; font-size: 0.95rem; background: #fff;
    resize: vertical; min-height: 100px; font-family: inherit;
  }
  .form-textarea:focus { outline: none; border-color: #8b6f47; }

  /* è¦‹ç©ã‚‚ã‚Š */
  .estimate-card {
    background: #fff; border-radius: 14px;
    border: 2px solid #d4c4a8; padding: 20px 18px;
    margin-bottom: 16px;
  }
  .estimate-section-title {
    font-size: 1.05rem; font-weight: bold; color: #8b6f47;
    margin-bottom: 12px; padding-bottom: 8px;
    border-bottom: 1px solid #e0d5c8;
  }
  .estimate-row {
    display: flex; justify-content: space-between;
    align-items: flex-start; padding: 10px 0;
    border-bottom: 1px solid #f5f0ea; font-size: 1rem;
  }
  .estimate-row:last-child { border-bottom: none; }
  .estimate-label { color: #666; flex: 1; }
  .estimate-value { color: #333; font-weight: bold; text-align: right; flex-shrink: 0; }
  .estimate-total {
    background: linear-gradient(135deg, #f3e9d8, #e8dcc4);
    border-radius: 10px; padding: 14px; margin-top: 12px;
    text-align: center;
  }
  .estimate-total-label { font-size: 0.85rem; color: #8b6f47; margin-bottom: 4px; }
  .estimate-total-price { font-size: 1.9rem; font-weight: bold; color: #5c3d2e; }
  .estimate-total-note { font-size: 0.73rem; color: #888; margin-top: 4px; }

  /* å®Œäº†ç”»é¢ */
  .complete-card {
    background: #fff; border-radius: 12px;
    border: 2px solid #4caf50; padding: 24px;
    text-align: center; margin-bottom: 16px;
  }
  .complete-icon { font-size: 3rem; margin-bottom: 12px; }
  .complete-title { font-size: 1.2rem; font-weight: bold; color: #333; margin-bottom: 8px; }
  .complete-text { font-size: 0.88rem; color: #666; line-height: 1.8; }

  /* æƒ…å ±ãƒœãƒƒã‚¯ã‚¹ */
  .info-box {
    background: #fff9e6; border: 1px solid #ffe082;
    border-radius: 8px; padding: 14px; margin-top: 12px;
    font-size: 0.92rem; color: #666; line-height: 1.8;
  }

  /* ãƒ›ãƒ¼ãƒ«è©³ç´° */
  .selected-hall-detail {
    background: #f9f5ef; border-radius: 8px;
    padding: 12px; margin-top: 12px;
    border: 1px solid #e0d5c8; font-size: 0.83rem;
    color: #666; line-height: 1.7;
  }

  /* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */
  .error-msg { color: #e53935; font-size: 0.8rem; margin-top: 4px; display: none; }
  
  /* ãƒšãƒ¼ã‚¸å†…ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ */
  .overflow-hidden { overflow: hidden; }
  
  /* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¿…é ˆãƒãƒ¼ã‚¯ */
  .required { color: #e53935; margin-left: 4px; }

  /* ã‚¹ãƒ†ãƒƒãƒ—ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ± */
  .selection-summary {
    background: #f3e9d8; border-radius: 8px; padding: 10px 14px;
    margin-bottom: 14px; font-size: 0.82rem; color: #5c3d2e;
    border-left: 3px solid #8b6f47;
  }

  /* ã‚„ã™ã‚‰ããƒªãƒ“ãƒ³ã‚°ç‰¹åˆ¥ãƒãƒƒã‚¸ */
  .living-badge {
    display: inline-block; background: #e8f5e9; color: #388e3c;
    font-size: 0.7rem; padding: 2px 8px; border-radius: 10px;
    font-weight: bold; margin-top: 4px;
  }

  .hall-all-btn {
    width: 100%; padding: 12px; border: 2px dashed #c5b99a;
    border-radius: 10px; background: #fafafa; cursor: pointer;
    text-align: center; font-size: 0.9rem; color: #8b6f47;
    transition: all 0.2s; margin-top: 8px; font-weight: bold;
  }
  .hall-all-btn:hover { background: #f3e9d8; border-color: #8b6f47; }

  /* ãƒ—ãƒ©ãƒ³ã‚¿ã‚¤ãƒ—ãƒ©ãƒ™ãƒ« */
  .plan-type-tag {
    display: inline-block; font-size: 0.7rem; padding: 2px 8px;
    border-radius: 10px; font-weight: bold; margin-left: 6px;
  }
  .tag-compact { background: #e3f2fd; color: #1565c0; }
  .tag-living { background: #e8f5e9; color: #2e7d32; }
  .tag-family { background: #fff3e0; color: #e65100; }
  .tag-normal { background: #fce4ec; color: #880e4f; }

  /* ===== ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ ===== */
  .chat-window {
    background: #f0ece6; border-radius: 14px; overflow: hidden;
    border: 2px solid #d4c4a8; margin-bottom: 14px;
    display: flex; flex-direction: column; height: 380px;
  }
  .chat-header {
    background: linear-gradient(135deg, #8b6f47, #6b4f2f);
    color: #fff; padding: 10px 14px;
    display: flex; align-items: center; gap: 8px;
    font-size: 0.88rem; font-weight: bold; flex-shrink: 0;
  }
  .chat-header .bot-avatar {
    width: 30px; height: 30px; border-radius: 50%;
    background: #fff; display: flex; align-items: center;
    justify-content: center; font-size: 1rem;
  }
  .chat-messages {
    flex: 1; overflow-y: auto; padding: 12px;
    display: flex; flex-direction: column; gap: 10px;
  }
  .chat-msg { display: flex; gap: 8px; align-items: flex-end; max-width: 88%; }
  .chat-msg.bot { align-self: flex-start; }
  .chat-msg.user { align-self: flex-end; flex-direction: row-reverse; }
  .msg-avatar {
    width: 28px; height: 28px; border-radius: 50%;
    background: #8b6f47; color: #fff; font-size: 0.8rem;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }
  .msg-avatar.user-av { background: #5c3d2e; }
  .msg-bubble {
    padding: 10px 13px; border-radius: 16px;
    font-size: 0.88rem; line-height: 1.6; max-width: 100%;
  }
  .bot .msg-bubble {
    background: #fff; color: #333;
    border-bottom-left-radius: 4px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  }
  .user .msg-bubble {
    background: linear-gradient(135deg, #8b6f47, #6b4f2f);
    color: #fff; border-bottom-right-radius: 4px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  }
  .chat-typing {
    display: none; align-self: flex-start;
    padding: 8px 14px; background: #fff; border-radius: 16px;
    border-bottom-left-radius: 4px; font-size: 0.82rem; color: #999;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  }
  .chat-typing.show { display: block; }
  .typing-dots { display: inline-flex; gap: 3px; }
  .typing-dots span {
    width: 6px; height: 6px; background: #bbb; border-radius: 50%;
    animation: typingBounce 1.2s infinite;
  }
  .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
  .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes typingBounce {
    0%,60%,100% { transform: translateY(0); }
    30% { transform: translateY(-5px); }
  }
  /* ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤ */
  .quick-replies {
    padding: 8px 12px; display: flex; flex-wrap: wrap;
    gap: 6px; background: #f8f4ee; border-top: 1px solid #e8dcc8;
    flex-shrink: 0;
  }
  .quick-reply-btn {
    padding: 6px 12px; border: 1.5px solid #d4a76a;
    border-radius: 20px; background: #fff; color: #8b6f47;
    font-size: 0.78rem; cursor: pointer; font-weight: bold;
    transition: all 0.2s; white-space: nowrap;
  }
  .quick-reply-btn:hover { background: #f3e9d8; border-color: #8b6f47; }
  /* ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ */
  .chat-input-area {
    display: flex; gap: 6px; padding: 8px 12px;
    background: #fff; border-top: 2px solid #e8dcc8;
    flex-shrink: 0; align-items: center;
  }
  .chat-input {
    flex: 1; padding: 8px 12px; border: 2px solid #d4c4a8;
    border-radius: 20px; font-size: 0.9rem;
    outline: none; font-family: inherit; resize: none;
    max-height: 80px; line-height: 1.4;
  }
  .chat-input:focus { border-color: #8b6f47; }
  .chat-send-btn {
    width: 36px; height: 36px; border: none;
    border-radius: 50%; background: linear-gradient(135deg, #8b6f47, #6b4f2f);
    color: #fff; font-size: 1rem; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; transition: all 0.2s;
  }
  .chat-send-btn:hover { transform: scale(1.08); }
  .chat-send-btn:disabled { background: #c5b99a; cursor: not-allowed; }
  /* ãƒãƒ£ãƒƒãƒˆå®Œäº†ãƒãƒŠãƒ¼ */
  .chat-done-banner {
    display: none; background: #e8f5e9; border: 2px solid #4caf50;
    border-radius: 10px; padding: 10px 14px; margin-bottom: 10px;
    font-size: 0.85rem; color: #2e7d32; font-weight: bold;
  }
  .chat-done-banner.show { display: block; }

  /* å†™çœŸã‚¤ãƒ¡ãƒ¼ã‚¸æ³¨è¨˜ */
  .image-notice {
    background: #fff8e1; border: 1px solid #ffe082;
    border-radius: 8px; padding: 8px 12px;
    font-size: 0.78rem; color: #795548;
    margin-bottom: 10px; text-align: center;
    font-weight: bold;
  }

  /* å½“æ—¥å…¥ä¼šãƒãƒƒã‚¸ */
  .join-badge {
    display: inline-block; background: #fff3e0; color: #e65100;
    font-size: 0.68rem; padding: 1px 6px; border-radius: 8px;
    font-weight: bold; margin-left: 4px; border: 1px solid #ffcc02;
  }

  /* ===== å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ« ===== */
  @media print {
    body { background: #fff !important; }
    .app-header, .voice-notice, .progress-bar, .nav-buttons,
    .btn-finish, .step:not(#step8), .chat-window,
    .chat-input-area, .quick-replies, #autoSaveBanner { display: none !important; }
    #step8 { display: block !important; }
    .print-header { display: block !important; }
    .print-chat-log { display: block !important; }
    .print-summary { display: block !important; }
    .no-print { display: none !important; }
    .complete-card { border: 1px solid #ccc !important; box-shadow: none !important; }
    .pdf-chat-bubble-bot { background: #f5f5f5 !important; }
    .pdf-chat-bubble-user { background: #d9c9b0 !important; }
    @page { margin: 15mm; size: A4; }
  }

  /* å°åˆ·å°‚ç”¨ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆé€šå¸¸æ™‚ã¯éè¡¨ç¤ºï¼‰ */
  .print-header {
    display: none;
    text-align: center; padding: 16px 0 10px;
    border-bottom: 2px solid #8b6f47; margin-bottom: 14px;
  }
  .print-header h2 { font-size: 1.2rem; color: #5c3d2e; letter-spacing: 2px; }
  .print-header p  { font-size: 0.78rem; color: #888; margin-top: 4px; }

  /* ãƒãƒ£ãƒƒãƒˆå±¥æ­´PDFç”¨ã‚³ãƒ³ãƒ†ãƒŠ */
  .print-chat-log {
    display: none; /* é€šå¸¸æ™‚éè¡¨ç¤ºãƒ»å°åˆ·æ™‚ã«è¡¨ç¤º */
    background: #faf7f3; border: 2px solid #d4c4a8;
    border-radius: 12px; padding: 16px; margin-bottom: 14px;
  }
  .print-chat-log-title {
    font-size: 0.95rem; font-weight: bold; color: #5c3d2e;
    margin-bottom: 12px; padding-bottom: 6px;
    border-bottom: 2px solid #d4a76a;
    display: flex; align-items: center; gap: 6px;
  }
  .pdf-chat-row {
    display: flex; gap: 8px; margin-bottom: 8px; align-items: flex-start;
  }
  .pdf-chat-row.user-row { flex-direction: row-reverse; }
  .pdf-chat-label {
    font-size: 0.72rem; font-weight: bold; white-space: nowrap;
    padding-top: 3px; color: #888; flex-shrink: 0;
  }
  .pdf-chat-row.user-row .pdf-chat-label { color: #5c3d2e; }
  .pdf-chat-bubble-bot {
    background: #fff; border: 1px solid #e0d5c8;
    border-radius: 12px; border-bottom-left-radius: 3px;
    padding: 8px 12px; font-size: 0.85rem; line-height: 1.65;
    color: #333; max-width: 82%;
  }
  .pdf-chat-bubble-user {
    background: #f3e9d8; border: 1px solid #d4a76a;
    border-radius: 12px; border-bottom-right-radius: 3px;
    padding: 8px 12px; font-size: 0.85rem; line-height: 1.65;
    color: #5c3d2e; font-weight: bold; max-width: 82%;
  }
  .pdf-chat-time {
    font-size: 0.68rem; color: #bbb; margin-top: 2px; text-align: right;
  }
  .pdf-chat-row.user-row .pdf-chat-time { text-align: left; }

  /* ===== ã‚ˆãã‚ã‚‹è³ªå•ãƒ‘ãƒãƒ« ===== */
  .faq-panel {
    background: #fff; border: 2px solid #d4c4a8;
    border-radius: 14px; margin-bottom: 12px; overflow: hidden;
  }
  .faq-panel-header {
    background: linear-gradient(135deg, #f3e9d8, #e8dcc4);
    padding: 10px 14px; display: flex; align-items: center;
    justify-content: space-between; cursor: pointer;
    user-select: none;
  }
  .faq-panel-header-left {
    display: flex; align-items: center; gap: 8px;
    font-size: 0.88rem; font-weight: bold; color: #5c3d2e;
  }
  .faq-toggle-icon {
    font-size: 0.75rem; color: #8b6f47;
    transition: transform 0.3s;
  }
  .faq-toggle-icon.open { transform: rotate(180deg); }
  .faq-body {
    display: none; padding: 10px 12px 12px;
  }
  .faq-body.open { display: block; }
  .faq-category {
    margin-bottom: 10px;
  }
  .faq-category-label {
    font-size: 0.75rem; font-weight: bold; color: #8b6f47;
    margin-bottom: 6px; padding: 3px 8px;
    background: #f9f3eb; border-radius: 6px;
    display: inline-block;
  }
  .faq-items { display: flex; flex-wrap: wrap; gap: 6px; }
  .faq-btn {
    padding: 7px 12px; border: 1.5px solid #d4a76a;
    border-radius: 20px; background: #fff; color: #5c3d2e;
    font-size: 0.78rem; cursor: pointer; font-weight: bold;
    transition: all 0.2s; display: flex; align-items: center; gap: 4px;
  }
  .faq-btn:hover { background: #f3e9d8; border-color: #8b6f47; transform: translateY(-1px); box-shadow: 0 2px 6px rgba(139,111,71,0.2); }
  .faq-btn .faq-icon { font-size: 0.9rem; }
  /* é¸æŠæ¸ˆã¿FAQã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
  .faq-btn.used {
    background: #e8f5e9; border-color: #81c784; color: #388e3c;
    cursor: default;
  }
  .faq-btn.used:hover { transform: none; box-shadow: none; }

  /* FAQææ¡ˆãƒãƒŠãƒ¼ï¼ˆãƒãƒ£ãƒƒãƒˆå†…ã®è‡ªå‹•ææ¡ˆï¼‰ */
  .chat-faq-suggest {
    background: linear-gradient(135deg, #fff8f0, #fef3e2);
    border: 1.5px solid #f0c070;
    border-radius: 10px; padding: 8px 10px;
    margin: 6px 0 2px; font-size: 0.78rem;
    color: #8b6f47;
  }
  .chat-faq-suggest-title {
    font-weight: bold; margin-bottom: 5px;
    display: flex; align-items: center; gap: 4px;
  }
  .chat-faq-suggest-btns { display: flex; flex-wrap: wrap; gap: 5px; }
  .chat-faq-suggest-btn {
    padding: 5px 10px; border: 1.5px solid #d4a76a;
    border-radius: 16px; background: #fff; color: #5c3d2e;
    font-size: 0.75rem; cursor: pointer; font-weight: bold;
    transition: all 0.18s;
  }
  .chat-faq-suggest-btn:hover { background: #f3e9d8; border-color: #8b6f47; }

  /* FAQå›ç­”ãƒãƒ–ãƒ« */
  .faq-answer-bubble {
    background: #fffbf5; border: 1px solid #e8d9c0;
    border-radius: 12px; border-bottom-left-radius: 3px;
    padding: 10px 13px; font-size: 0.85rem; line-height: 1.7;
    color: #333; max-width: 100%;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  }
  .faq-answer-bubble strong { color: #5c3d2e; }
  .faq-answer-badge {
    display: inline-block; font-size: 0.68rem; background: #fff3e0;
    color: #e65100; border: 1px solid #ffcc80; border-radius: 8px;
    padding: 1px 6px; margin-bottom: 4px; font-weight: bold;
  }

  /* ===== é€ä¿¡å‡¦ç†UI ===== */
  .submit-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.55); z-index: 9999;
    align-items: center; justify-content: center;
    flex-direction: column; gap: 14px;
  }
  .submit-overlay.show { display: flex; }
  .submit-spinner {
    width: 52px; height: 52px; border: 5px solid #f5e6d0;
    border-top-color: #c8914a; border-radius: 50%;
    animation: spin 0.9s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .submit-overlay-text { color: #fff; font-size: 1.05rem; font-weight: bold; }
  .submit-result-banner {
    display: none; margin: 12px 0; padding: 14px 16px;
    border-radius: 10px; font-size: 0.9rem; line-height: 1.7; text-align: center;
  }
  .submit-result-banner.success {
    display: block; background: #e8f5e9; border: 2px solid #66bb6a; color: #2e7d32;
  }
  .submit-result-banner.error {
    display: block; background: #fce4ec; border: 2px solid #ef9a9a; color: #b71c1c;
  }
</style>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>
<body>


<!-- ===== é€ä¿¡ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ===== -->
<div class="submit-overlay" id="submitOverlay">
  <div class="submit-spinner"></div>
  <div class="submit-overlay-text">é€ä¿¡ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„â€¦</div>
</div>
<div class="app-header">
  <h1>âš˜ ã•ã„ãè‘¬ç¥­ ã”è‘¬å„€ã‚µãƒãƒ¼ãƒˆ</h1>
  <p>å¤§åˆ‡ãªãŠåˆ¥ã‚Œã‚’ã€å¿ƒã‚’è¾¼ã‚ã¦ãŠæ‰‹ä¼ã„ã—ã¾ã™</p>
</div>

<!-- éŸ³å£°å…¥åŠ›æ¡ˆå†…ãƒãƒŠãƒ¼ -->
<div class="voice-notice">
  <div class="icon">ğŸ™ï¸</div>
  <div class="text">
    éŸ³å£°å…¥åŠ›ã‚’ã”åˆ©ç”¨ã®æ–¹ã¸ï¼š<br>
    å°‘ã€…ã®èª¤å­—ãƒ»å¤‰æ›ãƒŸã‚¹ãŒã‚ã£ã¦ã‚‚å¤§ä¸ˆå¤«ã§ã™ã€‚<br>
    æ‹…å½“è€…ãŒã”ç¢ºèªã®ä¸Šã€ä¸å¯§ã«ã”å¯¾å¿œã„ãŸã—ã¾ã™ã€‚
  </div>
</div>

<!-- é€”ä¸­ä¿å­˜ãƒãƒŠãƒ¼ -->
<div id="autoSaveBanner" style="display:none; background:linear-gradient(135deg,#e8f5e9,#c8e6c9); border-bottom:2px solid #4caf50; padding:8px 18px; font-size:0.88rem; color:#2e7d32; display:flex; align-items:center; justify-content:space-between; gap:8px;">
  <span id="autoSaveMsg">ğŸ’¾ å…¥åŠ›å†…å®¹ã‚’è‡ªå‹•ä¿å­˜ã—ã¾ã—ãŸ</span>
  <button onclick="clearSavedData()" style="background:none; border:1px solid #4caf50; color:#2e7d32; border-radius:6px; padding:3px 10px; font-size:0.8rem; cursor:pointer;">ã‚¯ãƒªã‚¢</button>
</div>

<!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
<div class="progress-bar" id="progressBar">
  <div class="step-dot active" id="dot1">1</div>
  <div class="step-connector" id="con1"></div>
  <div class="step-dot" id="dot2">2</div>
  <div class="step-connector" id="con2"></div>
  <div class="step-dot" id="dot3">3</div>
  <div class="step-connector" id="con3"></div>
  <div class="step-dot" id="dot4">4</div>
  <div class="step-connector" id="con4"></div>
  <div class="step-dot" id="dot5">5</div>
  <div class="step-connector" id="con5"></div>
  <div class="step-dot" id="dot6">6</div>
  <div class="step-connector" id="con6"></div>
  <div class="step-dot" id="dot7">7</div>
  <div class="step-connector" id="con7"></div>
  <div class="step-dot" id="dot8">8</div>
</div>

<!-- ===== STEP 1: åŸºæœ¬æƒ…å ± ===== -->
<div class="step active" id="step1">
  <div class="step-title"><span class="step-num">1</span>åŸºæœ¬æƒ…å ±ã‚’ãŠèã‹ã›ãã ã•ã„</div>
  
  <div class="form-group">
    <label class="form-label">ãŠå®¢æ§˜ã®ãŠåå‰<span class="required">*</span></label>
    <input type="text" class="form-input" id="name" placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ">
    <div class="error-msg" id="nameError">ãŠåå‰ã‚’ã”å…¥åŠ›ãã ã•ã„</div>
  </div>
  
  <div class="form-group">
    <label class="form-label">æ•…äººæ§˜ã¨ã®ã”é–¢ä¿‚<span class="required">*</span></label>
    <select class="form-select" id="relation">
      <option value="">--- ãŠé¸ã³ãã ã•ã„ ---</option>
      <option value="spouse">é…å¶è€…ï¼ˆå¤«ãƒ»å¦»ï¼‰</option>
      <option value="parent">è¦ªï¼ˆçˆ¶ãƒ»æ¯ï¼‰</option>
      <option value="child">å­ã©ã‚‚</option>
      <option value="sibling">å…„å¼Ÿãƒ»å§‰å¦¹</option>
      <option value="grandparent">ç¥–çˆ¶ãƒ»ç¥–æ¯</option>
      <option value="inlaw">ç¾©ç†ã®è¦ª</option>
      <option value="relative">ãã®ä»–è¦ªæ—</option>
      <option value="other">ãã®ä»–</option>
    </select>
    <div class="error-msg" id="relationError">ã”é–¢ä¿‚ã‚’ãŠé¸ã³ãã ã•ã„</div>
  </div>
  
  <div class="form-group">
    <label class="form-label">ãŠé›»è©±ç•ªå·ï¼ˆä»»æ„ï¼‰</label>
    <input type="tel" class="form-input" id="phone" placeholder="ä¾‹ï¼š0120-315-312">
  </div>
  
  <div class="info-box">
    ğŸ“‹ ã”å…¥åŠ›ã„ãŸã ã„ãŸæƒ…å ±ã¯ãŠè¦‹ç©ã‚‚ã‚Šã®ä½œæˆã«ã®ã¿ä½¿ç”¨ã„ãŸã—ã¾ã™ã€‚<br>
    å€‹äººæƒ…å ±ã¯å³é‡ã«ç®¡ç†ã„ãŸã—ã¾ã™ã€‚
  </div>
  
  <div class="nav-buttons">
    <button class="btn-next" onclick="goToStep(2)">æ¬¡ã¸ â†’ äººæ•°ãƒ»è‘¬å„€å½¢å¼</button>
  </div>
</div>

<!-- ===== STEP 2: å‚åˆ—äººæ•°ãƒ»è‘¬å„€å½¢å¼ ===== -->
<div class="step" id="step2">
  <div class="step-title"><span class="step-num">2</span>å‚åˆ—äººæ•°ãƒ»è‘¬å„€å½¢å¼</div>
  
  <div class="form-group">
    <label class="form-label">å‚åˆ—äºˆå®šäººæ•°ã‚’ãŠæ•™ãˆãã ã•ã„<span class="required">*</span></label>
    <div class="btn-group" id="attendanceGroup">
      <button class="btn-choice" onclick="selectAttendance(this,'under5')" data-value="under5">
        <span class="choice-icon">ğŸ‘¤</span>
        <span class="choice-text">
          <strong>5åä»¥ä¸‹</strong>
          <div class="choice-desc">ã”ãèº«è¿‘ãªã”å®¶æ—ã®ã¿ï¼ˆç›´è‘¬ãƒ»å¯†è‘¬å‘ãï¼‰</div>
        </span>
        <span class="check-mark">âœ”</span>
      </button>
      <button class="btn-choice" onclick="selectAttendance(this,'under15')" data-value="under15">
        <span class="choice-icon">ğŸ‘¥</span>
        <span class="choice-text">
          <strong>15åä»¥ä¸‹</strong>
          <div class="choice-desc">è¿‘è¦ªè€…ä¸­å¿ƒã®å°è¦æ¨¡å®¶æ—è‘¬</div>
        </span>
        <span class="check-mark">âœ”</span>
      </button>
      <button class="btn-choice" onclick="selectAttendance(this,'15to30')" data-value="15to30">
        <span class="choice-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span>
        <span class="choice-text">
          <strong>15åã‹ã‚‰30å</strong>
          <div class="choice-desc">è¦ªæ—ãƒ»è¿‘ã—ã„å‹äººã‚’å«ã‚€å®¶æ—è‘¬</div>
        </span>
        <span class="check-mark">âœ”</span>
      </button>
      <button class="btn-choice" onclick="selectAttendance(this,'30to50')" data-value="30to50">
        <span class="choice-icon">ğŸ¢</span>
        <span class="choice-text">
          <strong>30åã‹ã‚‰50å</strong>
          <div class="choice-desc">ä¸€èˆ¬è‘¬ãƒ»çŸ¥äººãƒ»ä»•äº‹é–¢ä¿‚ã‚’å«ã‚€</div>
        </span>
        <span class="check-mark">âœ”</span>
      </button>
      <button class="btn-choice" onclick="selectAttendance(this,'over50')" data-value="over50">
        <span class="choice-icon">ğŸ›ï¸</span>
        <span class="choice-text">
          <strong>50åä»¥ä¸Š</strong>
          <div class="choice-desc">å¤§è¦æ¨¡ä¸€èˆ¬è‘¬ãƒ»ä¼šç¤¾ãƒ»å›£ä½“é–¢ä¿‚å¤šæ•°</div>
        </span>
        <span class="check-mark">âœ”</span>
      </button>
    </div>
    <div class="error-msg" id="attendanceError">å‚åˆ—äºˆå®šäººæ•°ã‚’ãŠé¸ã³ãã ã•ã„</div>
  </div>
  
  <div class="form-group" style="margin-top:20px">
    <label class="form-label">ã”å¸Œæœ›ã®è‘¬å„€å½¢å¼<span class="required">*</span></label>
    <div class="btn-group" id="funeralTypeGroup">
      <button class="btn-choice" onclick="selectFuneralType(this,'family')" data-value="family">
        <span class="choice-icon">ğŸŒ¸</span>
        <span class="choice-text">
          <strong>å®¶æ—è‘¬</strong>
          <div class="choice-desc">ã”éºæ—ãƒ»è¿‘è¦ªè€…ã®ã¿ã§é™ã‹ã«ãŠè¦‹é€ã‚Š</div>
        </span>
        <span class="check-mark">âœ”</span>
      </button>
      <button class="btn-choice" onclick="selectFuneralType(this,'family_friends')" data-value="family_friends">
        <span class="choice-icon">ğŸŒ¼</span>
        <span class="choice-text">
          <strong>å®¶æ—è‘¬ã ãŒå°‘ã—å‹äººãŒæ¥ã‚‹</strong>
          <div class="choice-desc">ä¸»ã«å®¶æ—ä¸­å¿ƒã ãŒã€å‹äººãƒ»çŸ¥äººã‚‚æ•°åå‚åˆ—</div>
        </span>
        <span class="check-mark">âœ”</span>
      </button>
      <button class="btn-choice" onclick="selectFuneralType(this,'general')" data-value="general">
        <span class="choice-icon">ğŸŒ¿</span>
        <span class="choice-text">
          <strong>ä¸€èˆ¬è‘¬ï¼ˆè¦ªæ—ãƒ»çŸ¥äººãƒ»ä»•äº‹é–¢ä¿‚ãªã©ï¼‰</strong>
          <div class="choice-desc">åºƒãå‚åˆ—è€…ã‚’ãŠè¿ãˆã™ã‚‹ä¸€èˆ¬çš„ãªãŠè‘¬å¼</div>
        </span>
        <span class="check-mark">âœ”</span>
      </button>
      <button class="btn-choice" onclick="selectFuneralType(this,'general_company')" data-value="general_company">
        <span class="choice-icon">ğŸ¢</span>
        <span class="choice-text">
          <strong>ä¸€èˆ¬è‘¬ã‹ã¤ä¼šç¤¾ãƒ»å›£ä½“é–¢ä¿‚ã‚‚å‘¼ã¶</strong>
          <div class="choice-desc">ä¼šç¤¾ãƒ»å›£ä½“ãƒ»çµ„åˆãªã©å¤šæ•°å‚åˆ—ã®å¤§è¦æ¨¡è‘¬å„€</div>
        </span>
        <span class="check-mark">âœ”</span>
      </button>
      <button class="btn-choice" onclick="selectFuneralType(this,'chokuso')" data-value="chokuso">
        <span class="choice-icon">ğŸ•Šï¸</span>
        <span class="choice-text">
          <strong>ç›´è‘¬ãƒ»ç«è‘¬å¼</strong>
          <div class="choice-desc">é€šå¤œãƒ»å‘Šåˆ¥å¼ãªã—ã€‚ç«è‘¬ã®ã¿ã€ã¾ãŸã¯æœ€å°é™ã®ãŠåˆ¥ã‚Œ</div>
        </span>
        <span class="check-mark">âœ”</span>
      </button>
      <button class="btn-choice" onclick="selectFuneralType(this,'kasouonly')" data-value="kasouonly">
        <span class="choice-icon">â›©ï¸</span>
        <span class="choice-text">
          <strong>ç«è‘¬ã®ã¿ï¼ˆæœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ï¼‰</strong>
          <div class="choice-desc">ã”éºä½“ã®æ¬é€ã¨ç«è‘¬ã®ã¿ã€‚æœ€ä½é™ã®è²»ç”¨ã§ã®ãŠè¦‹é€ã‚Š</div>
        </span>
        <span class="check-mark">âœ”</span>
      </button>
    </div>
    <div class="error-msg" id="funeralTypeError">è‘¬å„€å½¢å¼ã‚’ãŠé¸ã³ãã ã•ã„</div>
  </div>
  
  <div class="nav-buttons">
    <button class="btn-back" onclick="goToStep(1)">â† æˆ»ã‚‹</button>
    <button class="btn-next" onclick="goToStep(3)">æ¬¡ã¸ â†’ ãƒ—ãƒ©ãƒ³ææ¡ˆ</button>
  </div>
</div>

<!-- ===== STEP 3: ãƒ—ãƒ©ãƒ³ææ¡ˆï¼ˆ3ç¨®é¡ï¼‰ ===== -->
<div class="step" id="step3">
  <div class="step-title"><span class="step-num">3</span>ãŠå‹§ã‚ãƒ—ãƒ©ãƒ³ã‚’ãŠé¸ã³ãã ã•ã„</div>
  <div class="selection-summary" id="step3Summary"></div>
  
  <div class="plan-cards" id="planCards">
    <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
  </div>
  
  <div class="error-msg" id="planError" style="display:block">ãƒ—ãƒ©ãƒ³ã‚’ãŠé¸ã³ãã ã•ã„</div>
  
  <div class="nav-buttons">
    <button class="btn-back" onclick="goToStep(2)">â† æˆ»ã‚‹</button>
    <button class="btn-next" onclick="goToStep(4)">æ¬¡ã¸ â†’ ãƒ›ãƒ¼ãƒ«é¸æŠ</button>
  </div>
</div>

<!-- ===== STEP 4: ãƒ›ãƒ¼ãƒ«é¸æŠ ===== -->
<div class="step" id="step4">
  <div class="step-title"><span class="step-num">4</span>å¼å ´ï¼ˆãƒ›ãƒ¼ãƒ«ï¼‰ã‚’ãŠé¸ã³ãã ã•ã„</div>
  <div class="selection-summary" id="step4Summary"></div>
  
  <div class="hall-cards" id="hallCards">
    <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
  </div>
  
  <button class="hall-all-btn" id="showAllHallsBtn" onclick="showAllHalls()" style="display:none">
    â–½ ãã®ä»–ã®ãƒ›ãƒ¼ãƒ«ã‚‚ã™ã¹ã¦è¡¨ç¤ºã™ã‚‹
  </button>
  
  <div class="error-msg" id="hallError" style="display:block">ãƒ›ãƒ¼ãƒ«ã‚’ãŠé¸ã³ãã ã•ã„</div>
  
  <div class="nav-buttons">
    <button class="btn-back" onclick="goToStep(3)">â† æˆ»ã‚‹</button>
    <button class="btn-next" onclick="goToStep(5)">æ¬¡ã¸ â†’ ç¥­å£‡ã‚³ãƒ¼ã‚¹é¸æŠ</button>
  </div>
</div>

<!-- ===== STEP 5: ã‚³ãƒ¼ã‚¹é¸æŠ ===== -->
<div class="step" id="step5">
  <div class="step-title"><span class="step-num">5</span>ç¥­å£‡ã‚³ãƒ¼ã‚¹ã‚’ãŠé¸ã³ãã ã•ã„</div>
  <div class="selection-summary" id="step5Summary"></div>
  
  <!-- å†™çœŸã‚¤ãƒ¡ãƒ¼ã‚¸æ³¨è¨˜ -->
  <div class="image-notice">ğŸ“· æ²è¼‰ã—ã¦ã„ã‚‹ç¥­å£‡ã®å†™çœŸã¯ã‚ãã¾ã§ã‚‚ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚å®Ÿéš›ã®ç¥­å£‡ã®è©³ç´°ã¯ãŠæ°—è»½ã«æ‹…å½“è€…ã¸ã”ç¢ºèªãã ã•ã„ã€‚</div>
  
  <div class="course-cards" id="courseCards">
    <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
  </div>
  
  <div class="info-box">
    âœ¨ <strong>æ˜æœ—ä¼šè¨ˆ</strong>ã®ãŠç´„æŸï¼šäº‹å‰ãŠè¦‹ç©ã‚Šä»¥å¤–ã®è¿½åŠ è«‹æ±‚ã¯ä¸€åˆ‡ã”ã–ã„ã¾ã›ã‚“ã€‚<br>
    äººæ•°è¶…éç­‰ãŒç”Ÿã˜ãŸå ´åˆã¯ã€å¿…ãšå–ªä¸»æ§˜ã«ã”ç¢ºèªã®ä¸Šã§ã”å¯¾å¿œã„ãŸã—ã¾ã™ã€‚
  </div>
  
  <div class="error-msg" id="courseError" style="display:block">ã‚³ãƒ¼ã‚¹ã‚’ãŠé¸ã³ãã ã•ã„</div>
  
  <div class="nav-buttons">
    <button class="btn-back" onclick="goToStep(4)">â† æˆ»ã‚‹</button>
    <button class="btn-next" onclick="goToStep(6)">æ¬¡ã¸ â†’ ã”å¸Œæœ›ãƒ»ã”ä¸å®‰</button>
  </div>
</div>

<!-- ===== STEP 6: ã”å¸Œæœ›ãƒ»ã”ä¸å®‰ï¼ˆãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆï¼‰ ===== -->
<div class="step" id="step6">
  <div class="step-title"><span class="step-num">6</span>ã”å¸Œæœ›ãƒ»ã”ä¸å®‰ã‚’ãŠèã‹ã›ãã ã•ã„</div>
  
  <!-- ã‚ˆãã‚ã‚‹è³ªå• FAQãƒ‘ãƒãƒ« -->
  <div class="faq-panel" id="faqPanel">
    <div class="faq-panel-header" onclick="toggleFaq()">
      <div class="faq-panel-header-left">
        <span>ğŸ’¡</span>
        <span>ã‚ˆãã‚ã‚‹è³ªå•ä¸€è¦§ï¼ˆã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ãƒãƒ£ãƒƒãƒˆã§è³ªå•ã§ãã¾ã™ï¼‰</span>
        <span id="faqUsedCount" style="font-size:0.72rem; background:#4caf50; color:#fff; padding:1px 7px; border-radius:10px; display:none;">0ä»¶ç™ºè¨€æ¸ˆ</span>
      </div>
      <span class="faq-toggle-icon" id="faqToggleIcon">â–¼</span>
    </div>
    <div class="faq-body" id="faqBody">

      <div class="faq-category">
        <span class="faq-category-label">ğŸ’° è²»ç”¨ãƒ»ãŠæ”¯æ‰•ã„</span>
        <div class="faq-items">
          <button class="faq-btn" onclick="faqClick(this,'è²»ç”¨ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„')"><span class="faq-icon">â“</span>è²»ç”¨ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„</button>
          <button class="faq-btn" onclick="faqClick(this,'è¿½åŠ è²»ç”¨ã¯ã‹ã‹ã‚Šã¾ã™ã‹ï¼Ÿ')"><span class="faq-icon">â“</span>è¿½åŠ è²»ç”¨ã¯ã‹ã‹ã‚Šã¾ã™ã‹ï¼Ÿ</button>
          <button class="faq-btn" onclick="faqClick(this,'åˆ†å‰²æ‰•ã„ã¯å¯èƒ½ã§ã™ã‹ï¼Ÿ')"><span class="faq-icon">â“</span>åˆ†å‰²æ‰•ã„ã¯å¯èƒ½ã§ã™ã‹ï¼Ÿ</button>
          <button class="faq-btn" onclick="faqClick(this,'ä¼šå“¡å‰²å¼•ã®è©³ç´°ã‚’æ•™ãˆã¦ãã ã•ã„')"><span class="faq-icon">â“</span>ä¼šå“¡å‰²å¼•ã®è©³ç´°ã‚’æ•™ãˆã¦ãã ã•ã„</button>
          <button class="faq-btn" onclick="faqClick(this,'è‘¬ç¥­è²»è£œåŠ©é‡‘ãƒ»é¦™å…¸è¿”ã—ã«ã¤ã„ã¦')"><span class="faq-icon">â“</span>è‘¬ç¥­è²»è£œåŠ©é‡‘ãƒ»é¦™å…¸è¿”ã—ã«ã¤ã„ã¦</button>
        </div>
      </div>

      <div class="faq-category">
        <span class="faq-category-label">ğŸ“‹ æ‰‹ç¶šããƒ»æµã‚Œ</span>
        <div class="faq-items">
          <button class="faq-btn" onclick="faqClick(this,'è‘¬å¼ã®æµã‚Œã‚’æ•™ãˆã¦ãã ã•ã„')"><span class="faq-icon">â“</span>è‘¬å¼ã®æµã‚Œã‚’æ•™ãˆã¦ãã ã•ã„</button>
          <button class="faq-btn" onclick="faqClick(this,'æ­»äº¡å¾Œã®å½¹æ‰€æ‰‹ç¶šãã¯ï¼Ÿ')"><span class="faq-icon">â“</span>æ­»äº¡å¾Œã®å½¹æ‰€æ‰‹ç¶šãã¯ï¼Ÿ</button>
          <button class="faq-btn" onclick="faqClick(this,'æ­»äº¡è¨ºæ–­æ›¸ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„')"><span class="faq-icon">â“</span>æ­»äº¡è¨ºæ–­æ›¸ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„</button>
          <button class="faq-btn" onclick="faqClick(this,'é€£çµ¡ã™ã‚‹ç¯„å›²ã¯ï¼Ÿ')"><span class="faq-icon">â“</span>é€£çµ¡ã™ã‚‹ç¯„å›²ã¯ï¼Ÿ</button>
          <button class="faq-btn" onclick="faqClick(this,'é€šå¤œãƒ»å‘Šåˆ¥å¼ã®é•ã„ã‚’æ•™ãˆã¦ãã ã•ã„')"><span class="faq-icon">â“</span>é€šå¤œãƒ»å‘Šåˆ¥å¼ã®é•ã„ã‚’æ•™ãˆã¦ãã ã•ã„</button>
        </div>
      </div>

      <div class="faq-category">
        <span class="faq-category-label">ğŸ·ï¸ å®—æ•™ãƒ»ãŠå¸ƒæ–½</span>
        <div class="faq-items">
          <button class="faq-btn" onclick="faqClick(this,'ãŠå¸ƒæ–½ã®ç›®å®‰ã¯ï¼Ÿ')"><span class="faq-icon">â“</span>ãŠå¸ƒæ–½ã®ç›®å®‰ã¯ï¼Ÿ</button>
          <button class="faq-btn" onclick="faqClick(this,'ç„¡å®—æ•™ãƒ»ç„¡å®—æ´¾ã§ã‚‚ã§ãã¾ã™ã‹ï¼Ÿ')"><span class="faq-icon">â“</span>ç„¡å®—æ•™ãƒ»ç„¡å®—æ´¾ã§ã‚‚ã§ãã¾ã™ã‹ï¼Ÿ</button>
          <button class="faq-btn" onclick="faqClick(this,'ä»–å®—æ´¾ã§ã‚‚å¯¾å¿œã§ãã¾ã™ã‹ï¼Ÿ')"><span class="faq-icon">â“</span>ä»–å®—æ´¾ã§ã‚‚å¯¾å¿œã§ãã¾ã™ã‹ï¼Ÿ</button>
          <button class="faq-btn" onclick="faqClick(this,'ã¯ãªç­’ãƒ»ç§˜åŒ£ã®é•ã„ã¯ï¼Ÿ')"><span class="faq-icon">â“</span>ã¯ãªç­’ãƒ»ç§˜åŒ£ã®é•ã„ã¯ï¼Ÿ</button>
        </div>
      </div>

      <div class="faq-category">
        <span class="faq-category-label">ğŸ‘¶ ãŠå­æ§˜ãƒ»å­ã©ã‚‚ã®ãŸã‚ã«</span>
        <div class="faq-items">
          <button class="faq-btn" onclick="faqClick(this,'å°ã•ãªå­ã©ã‚‚ã‚‚å‚åˆ—ã§ãã¾ã™ã‹ï¼Ÿ')"><span class="faq-icon">â“</span>å°ã•ãªå­ã©ã‚‚ã‚‚å‚åˆ—ã§ãã¾ã™ã‹ï¼Ÿ</button>
          <button class="faq-btn" onclick="faqClick(this,'ã‚­ãƒƒã‚ºã‚¹ãƒšãƒ¼ã‚¹ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ')"><span class="faq-icon">â“</span>ã‚­ãƒƒã‚ºã‚¹ãƒšãƒ¼ã‚¹ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ</button>
          <button class="faq-btn" onclick="faqClick(this,'æˆä¹³å®¤ãƒ»ãŠã‚€ã¤äº¤æ›ã¯ã§ãã¾ã™ã‹ï¼Ÿ')"><span class="faq-icon">â“</span>æˆä¹³å®¤ãƒ»ãŠã‚€ã¤äº¤æ›ã¯ã§ãã¾ã™ã‹ï¼Ÿ</button>
        </div>
      </div>

      <div class="faq-category">
        <span class="faq-category-label">ğŸŒ¸ ãŠåˆ¥ã‚Œãƒ»æ¼”å‡º</span>
        <div class="faq-items">
          <button class="faq-btn" onclick="faqClick(this,'ãŠèŠ±ã‚’ãŸãã•ã‚“é£¾ã‚ŠãŸã„ã§ã™')"><span class="faq-icon">â“</span>ãŠèŠ±ã‚’ãŸãã•ã‚“é£¾ã‚ŠãŸã„</button>
          <button class="faq-btn" onclick="faqClick(this,'éŸ³æ¥½ã‚„æ˜ åƒã‚’æµã—ãŸã„ã§ã™')"><span class="faq-icon">â“</span>éŸ³æ¥½ãƒ»æ˜ åƒã‚’æµã—ãŸã„</button>
          <button class="faq-btn" onclick="faqClick(this,'ãƒšãƒƒãƒˆã‚‚ä¸€ç·’ã«ãŠåˆ¥ã‚Œã—ãŸã„ã§ã™')"><span class="faq-icon">â“</span>ãƒšãƒƒãƒˆã‚‚ä¸€ç·’ã«ãŠåˆ¥ã‚Œã—ãŸã„</button>
          <button class="faq-btn" onclick="faqClick(this,'å†™çœŸå…¥ã‚Šã®ä½ç‰Œã‚’ä½œã‚ŠãŸã„ã§ã™')"><span class="faq-icon">â“</span>å†™çœŸå…¥ã‚Šã®ä½ç‰Œã‚’ä½œã‚ŠãŸã„</button>
        </div>
      </div>

      <div class="faq-category">
        <span class="faq-category-label">ğŸ˜· æ„ŸæŸ“ç—‡ãƒ»å¥åº·å¯¾å¿œ</span>
        <div class="faq-items">
          <button class="faq-btn" onclick="faqClick(this,'æ„ŸæŸ“ç—‡ã§äº¡ããªã£ãŸå ´åˆã®å¯¾å¿œã¯ï¼Ÿ')"><span class="faq-icon">â“</span>æ„ŸæŸ“ç—‡ã§äº¡ããªã£ãŸå ´åˆã®å¯¾å¿œã¯ï¼Ÿ</button>
          <button class="faq-btn" onclick="faqClick(this,'å‚åˆ—è€…æ•°ã‚’åˆ¶é™ã—ãŸã„å ´åˆã¯ï¼Ÿ')"><span class="faq-icon">â“</span>å‚åˆ—è€…æ•°ã‚’åˆ¶é™ã—ãŸã„å ´åˆã¯ï¼Ÿ</button>
        </div>
      </div>

    </div><!-- /faq-body -->
  </div><!-- /faq-panel -->

  <!-- ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆUI -->
  <div class="chat-window" id="chatWindow">
    <div class="chat-header">
      <div class="bot-avatar">ğŸ¤</div>
      <div>
        <div>ã•ã„ãè‘¬ç¥­ ç›¸è«‡ã‚µãƒãƒ¼ãƒˆ</div>
        <div style="font-size:0.72rem; opacity:0.85;">ã”å¸Œæœ›ãƒ»ã”ä¸å®‰ã‚’ä½•ã§ã‚‚ãŠæ°—è»½ã«</div>
      </div>
    </div>
    <div class="chat-messages" id="chatMessages">
      <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯JSã§è¿½åŠ  -->
    </div>
    <div class="typing-dots" id="typingIndicator" style="display:none; padding:8px 14px; background:#fff; border-radius:16px; margin:4px 12px; align-self:flex-start;">
      <span></span><span></span><span></span>
    </div>
    <div class="quick-replies" id="quickReplies" style="display:none;">
      <!-- ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤ã¯JSã§è¿½åŠ  -->
    </div>
    <div class="chat-input-area">
      <textarea class="chat-input" id="chatInput" rows="1" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›â€¦ â€»éŸ³å£°å…¥åŠ›ã®èª¤å­—ã‚‚å¤§ä¸ˆå¤«ã§ã™" onkeydown="chatKeyDown(event)"></textarea>
      <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()" title="é€ä¿¡">â¤</button>
    </div>
  </div>
  
  <!-- ãƒãƒ£ãƒƒãƒˆå®Œäº†ãƒãƒŠãƒ¼ -->
  <div class="chat-done-banner" id="chatDoneBanner">
    âœ… ã”å…¥åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚æ‹…å½“è€…ãŒå†…å®¹ã‚’ç¢ºèªã®ä¸Šã€ä¸å¯§ã«ã”å¯¾å¿œã„ãŸã—ã¾ã™ã€‚
  </div>
  
  <!-- ä¼šå“¡ç¢ºèª -->
  <div class="form-group" style="margin-top:4px;">
    <label class="form-label">ã‚„ã™ã‚‰ãä¼šå“¡æ§˜ã§ã™ã‹ï¼Ÿ</label>
    <div class="btn-group" id="memberGroup">
      <button class="btn-choice" onclick="selectMember(this,'yes')">
        <span class="choice-icon">ğŸ’³</span>
        <span class="choice-text">
          <strong>ä¼šå“¡ã§ã™</strong>
          <div class="choice-desc">35%å‰²å¼•ã®ä¼šå“¡ä¾¡æ ¼ãŒé©ç”¨ã•ã‚Œã¾ã™</div>
        </span>
        <span class="check-mark">âœ”</span>
      </button>
      <button class="btn-choice" onclick="selectMember(this,'join')">
        <span class="choice-icon">ğŸ‰</span>
        <span class="choice-text">
          <strong>å½“æ—¥ä¼šå“¡å…¥ä¼šã—ãŸã„ <span class="join-badge">30%å‰²å¼•</span></strong>
          <div class="choice-desc">å½“æ—¥ã”å…¥ä¼šã§ã‚‚30%å‰²å¼•ãŒé©ç”¨ã•ã‚Œã¾ã™</div>
        </span>
        <span class="check-mark">âœ”</span>
      </button>
      <button class="btn-choice" onclick="selectMember(this,'no')">
        <span class="choice-icon">ğŸ“</span>
        <span class="choice-text">
          <strong>ä¼šå“¡ã§ã¯ã‚ã‚Šã¾ã›ã‚“</strong>
          <div class="choice-desc">ä¸€èˆ¬ä¾¡æ ¼ã§ã®ã”æ¡ˆå†…ã¨ãªã‚Šã¾ã™</div>
        </span>
        <span class="check-mark">âœ”</span>
      </button>
      <button class="btn-choice" onclick="selectMember(this,'unknown')">
        <span class="choice-icon">â“</span>
        <span class="choice-text">
          <strong>ã‚ã‹ã‚Šã¾ã›ã‚“</strong>
          <div class="choice-desc">æ‹…å½“è€…ãŒã”ç¢ºèªã„ãŸã—ã¾ã™</div>
        </span>
        <span class="check-mark">âœ”</span>
      </button>
    </div>
  </div>
  
  <div class="nav-buttons">
    <button class="btn-back" onclick="goToStep(5)">â† æˆ»ã‚‹</button>
    <button class="btn-next" onclick="goToStep(7)">æ¬¡ã¸ â†’ ãŠè¦‹ç©ã‚‚ã‚Šç¢ºèª</button>
  </div>
</div>

<!-- ===== STEP 7: ãŠè¦‹ç©ã‚‚ã‚Šç¢ºèª ===== -->
<div class="step" id="step7">
  <div class="step-title"><span class="step-num">7</span>ãŠè¦‹ç©ã‚‚ã‚Šã®ç¢ºèª</div>
  
  <div class="estimate-card" id="estimateCard">
    <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
  </div>
  
  <div class="info-box">
    âš ï¸ ä¸Šè¨˜ã¯ãŠè¦‹ç©ã‚‚ã‚Šã®ç›®å®‰ã§ã™ã€‚ãŠã‚‚ã¦ãªã—è²»ç”¨ãƒ»ã‚ªãƒ—ã‚·ãƒ§ãƒ³è²»ç”¨ãªã©ã¯å‚åˆ—è€…æ•°ã‚„å†…å®¹ã«ã‚ˆã‚Šå¤‰å‹•ã—ã¾ã™ã€‚<br>
    è©³ç´°ã¯æ‹…å½“è€…ã«ã”ç¢ºèªãã ã•ã„ã€‚
  </div>
  
  <!-- PDFãƒ»LINEãƒ»ãƒ¡ãƒ¼ãƒ« å…±æœ‰ãƒœã‚¿ãƒ³ -->
  <div style="display:flex; gap:10px; margin-top:16px; flex-wrap:wrap;">
    <button onclick="downloadEstimatePDF()" style="flex:1; min-width:130px; padding:14px 8px; background:linear-gradient(135deg,#d32f2f,#b71c1c); color:#fff; border:none; border-radius:12px; font-size:0.95rem; font-weight:bold; cursor:pointer; box-shadow:0 3px 8px rgba(211,47,47,0.4); display:flex; align-items:center; justify-content:center; gap:5px;">
      ğŸ“„ PDFä¿å­˜
    </button>
    <button onclick="shareToLINE()" style="flex:1; min-width:130px; padding:14px 8px; background:linear-gradient(135deg,#00b900,#009900); color:#fff; border:none; border-radius:12px; font-size:0.95rem; font-weight:bold; cursor:pointer; box-shadow:0 3px 8px rgba(0,185,0,0.4); display:flex; align-items:center; justify-content:center; gap:5px;">
      ğŸ’¬ LINEã§å…±æœ‰
    </button>
    <button id="sendEstimateEmailBtn" onclick="sendEstimateEmail()" style="flex:1; min-width:130px; padding:14px 8px; background:linear-gradient(135deg,#1565c0,#0d47a1); color:#fff; border:none; border-radius:12px; font-size:0.95rem; font-weight:bold; cursor:pointer; box-shadow:0 3px 8px rgba(21,101,192,0.4); display:flex; align-items:center; justify-content:center; gap:5px;">
      âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«é€ä¿¡
    </button>
  </div>

  <!-- ãƒ¡ãƒ¼ãƒ«é€ä¿¡çµæœãƒãƒŠãƒ¼ï¼ˆstep7ç”¨ï¼‰ -->
  <div id="estimateEmailBanner" style="display:none; margin-top:12px; padding:12px 16px; border-radius:10px; font-size:0.92rem; font-weight:bold; line-height:1.6;"></div>

  <div class="nav-buttons">
    <button class="btn-back" onclick="goToStep(6)">â† æˆ»ã‚‹</button>
    <button class="btn-finish" id="submitBtn" onclick="submitAndComplete()">âœ” é€ä¿¡ã—ã¦å®Œäº†</button>
  </div>
</div>

<!-- ===== STEP 8: å®Œäº† ===== -->
<div class="step" id="step8">
  <div class="complete-card">
    <div class="complete-icon">ğŸ•Šï¸</div>
    <div class="complete-title">ã”å…¥åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ</div>
    <div class="complete-text">
      ãŠç´„æŸã®ãŠæ™‚é–“ã«ãªã‚Šã¾ã—ãŸã‚‰å¼Šç¤¾ã®æ‹…å½“è€…ãŒãŠæ‰“ã¡åˆã‚ã›ã«å‚ã‚Šã¾ã™ã€‚<br>
      ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚<br>
      ãŠæ€¥ãã®å ´åˆã¯ãŠé›»è©±ã«ã¦ã”é€£çµ¡ãã ã•ã„ã¾ã›ã€‚<br><br>
      <strong>ğŸ“ 0120-315-312</strong><br>
      24æ™‚é–“365æ—¥å—ä»˜
    </div>
  </div>
  
  <!-- å°åˆ·å°‚ç”¨ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="print-header" id="printHeader">
    <h2>âš˜ ã•ã„ãè‘¬ç¥­ ã”è‘¬å„€ã‚µãƒãƒ¼ãƒˆ ãŠè¦‹ç©ã‚‚ã‚Šï¼†ã”ç›¸è«‡è¨˜éŒ²</h2>
    <p id="printDate"></p>
  </div>

    <div class="submit-result-banner" id="submitResultBanner"></div>

  <div id="finalSummary" style="background:#fff; border-radius:12px; border:2px solid #d4c4a8; padding:16px; margin-bottom:16px; font-size:0.87rem; line-height:1.9;"></div>

  <!-- ãƒãƒ£ãƒƒãƒˆä¼šè©±å±¥æ­´ï¼ˆPDFå°åˆ·ç”¨ï¼‰ -->
  <div class="print-chat-log" id="printChatLog">
    <div class="print-chat-log-title">ğŸ’¬ ã”å¸Œæœ›ãƒ»ã”ä¸å®‰ ãƒãƒ£ãƒƒãƒˆä¼šè©±å±¥æ­´</div>
    <div id="printChatMessages"></div>
  </div>
  
  <button class="btn-finish no-print" style="width:100%; padding:14px; border:none; border-radius:10px; cursor:pointer; font-size:1rem;" onclick="printPage()">
    ğŸ–¨ï¸ å°åˆ·ãƒ»PDFä¿å­˜
  </button>
</div>

<script>
// ========== ãƒ‡ãƒ¼ã‚¿å®šç¾© ==========

const IMG = {
  ai:   'https://sspark.genspark.ai/cfimages?u1=nT5quTOKQ7O6dN7%2FNZqDTumLphmArsXpAg%2FidVQwm9xnCQhDF9nD0K5Vj%2B3Ic9IiPSrjpsjx5xXkgq4y7DwnkHLTh%2Ba6HyQEHwJEx25n0YltONjDzioxzvWXdJ6ZCtqrTZRiCeC0F%2BrZHUMHJA2F9LMQWEXKwTA7ig%3D%3D&u2=GPKZhykKgNRdFIQs&width=1024',
  hana: 'https://sspark.genspark.ai/cfimages?u1=FWRGlMdJPTl3PkI6X3H4m9beWqR1IwPAuodXFneVtcj77uRI1lhaGtGnjkW60XPe%2B50mc6%2B2l%2F8QCfmWlTTO6oGZq%2B%2BIRz9XcYLwpk2aH7tTksxRmwNH2RZqTOFP%2FBIs6675Ze1Wg4ofi%2BGsbq9GQsi1Q8MI02Pl2jnd&u2=UR%2Bcdja2fICIA7bS&width=1024',
  kaori:'https://sspark.genspark.ai/cfimages?u1=8S5IE1Ne3ZILlI47bWm6xsbrfU4k54OwY7DeUh57bak1y4x4uiVhjYgl4oU6NVAYfK53x4d6K4aoLL2OeJyXli1wT%2Bj7OZ8Y0Gh9yCDdZJD%2F1lL65odcpj1IB%2BPf4wCFI5ewgDC5%2BVU3oRgMKtvf27wgSB0R1wkpRDdgRg%3D%3D&u2=p0bJTs%2FGuJ5EKbF%2B&width=1024',
  kaga: 'https://sspark.genspark.ai/cfimages?u1=eLpG%2FgY9JBLEumdLrEdSh26WP5dQREM%2FhDIjvZj9XQcar2XLClGcgSrEoQDPOTNlQwfMWS594Z5XHefZjloMLGCPSG3FPAxsSTKMCYzvfQAs1ExspKqYbTqBBsb8SCr%2FuvUvIsxfixxGMmwpWDG7oW0V%2Bo9juresvwScK%2BDl5Q%3D%3D&u2=T6urtJBYLpuVuwF8&width=1024',
  // ãƒªãƒ“ãƒ³ã‚°ã‚³ãƒ¼ã‚¹å°‚ç”¨ç¥­å£‡
  living_ai:   'https://sspark.genspark.ai/cfimages?u1=pQpKKeEit3T9d7xBH4%2FbkbxeT%2Bwy9%2BUb0jw%2BCfOiUELGvqH%2FTHjd7IpASiGd9m83Yuc34Z3VKf021c6SMgRkAMU5dC08CnBU5ZdDrNrfwyRryR6flCHsN9qjTULqPAGXIHCY5mSFQzy3QHEWy%2FRjBepfsCSlfpZGX95SOukidbNnkQ%3D%3D&u2=iFIWuiLz%2Bzm21Ze9&width=1024',
  living_hana: 'https://sspark.genspark.ai/cfimages?u1=cU2vptQ%2FUqgCGxAKelTq72ns9gQVLQrr7wLhjskjn6vEOR641G7HRRDjdmy4XgnZVlWDmckp6F6pqE2G8V185ViXlNLPjAieO%2B8BEHeVhefCBgKtQo65nKzKWEQLRNCxMXWzTYHDb3q7KJdI0Vkl9zqEanElyc2i1RpqcWroUOB%2B%2BhYP&u2=xCwpakZRKWanbsIT&width=1024',
  living_kaori:'https://sspark.genspark.ai/cfimages?u1=KUY6g73bfffIgq6C1jLH%2BNXDFuxm659dFSL8N%2Fzwu2PkpOT93sV9ne0x8iUh%2BxUsgtF8c3EW6%2BKo8cD6xfN1%2Bqj%2BnZhqeqdFL1gnnGU%2BgICZvbo5Z5Sv75Q6pdXVo%2FvJP9RRHzwzgLTECBF9X8Yb378VC5qho5JSFC%2BZvkcFJpjT46Rauw%3D%3D&u2=Ve6n9dmTfkAK1ghM&width=1024',
  living_kaga: 'https://sspark.genspark.ai/cfimages?u1=AMAkgqbTLhc7%2FogDXeBRWO1e78FQWv7SBbnyBKZkl%2BYbvezlMwzmWA8QvM506lg%2FoE7tPal9S1SP43kpOy%2FNcz7q8UigB3GNcFd%2BnHEZmIpa2Dfs6jZ%2BSCqj0dFfZGQhq7tAdPuUZ56qIgKSjLkuC4mzSzPmngZOzlcS3r7ciVLqCBl2wqzrmQ%3D%3D&u2=YJiuuTwO0gdaMBeM&width=1024',
  // ãµã¤ã†ã®ãŠè‘¬å¼ï¼ˆä¸€èˆ¬è‘¬ãƒ»ç¤¾è‘¬ï¼‰ç”¨ç¥­å£‡ã‚³ãƒ¼ã‚¹ç”»åƒ
  normal_ai:   'https://sspark.genspark.ai/cfimages?u1=uMRcdm1xpP9GYchwtMAz%2BRAbf51Y3kI8JgeTOwoBpd9koXXX7hPqLXqDgQE1%2F3PaVAg4YncJ8k8G72PUiKzE9HaKZ5BlhsWBiECb7MhB%2FVxtfAWyveRLqdqbhYiBTvwGo0uM9iDewHUXWGqdjElStx74Ndg5Tcg%2Flg%3D%3D&u2=ISZiChn%2FHVtCqTYG&width=1024',
  normal_hana: 'https://sspark.genspark.ai/cfimages?u1=etYilXsc3vfgPm%2B8f7fiKpLNqHZwwgJKvLOOD7QdCRDLymkDTKhBF0PgdTlcBPjLOBNGebzg6d0J4DeoW4mYwIq8mcUDV8IYNgnlFg88TrTIAQwkHc3aPmETDdEhvpXAWNuka4kcwp2TFFEEu9eyWHyW6qlbTj8HBWBO&u2=4l0f%2FXeCgDBIMUk2&width=1024',
  normal_kaori:'https://sspark.genspark.ai/cfimages?u1=jOfhCOa1OBQ4eWdSgOliHfIikh99Tr9D9PWHof1pWOWAqVUYokBp0nkTCL8DB3r4gJmKY3%2BFp0mwHTTIPL%2F7KTbqf2Wwuy7Lgtfi9%2BLcgiYU6MJVz%2Bxqecy%2FBhIbMSKtmeMuiiuVFLGldiCaSPMXPigprq1WpKGJskmbzg%3D%3D&u2=UXKKjApTHPoFU0Aw&width=1024',
  normal_kaga: 'https://sspark.genspark.ai/cfimages?u1=qBuQPaqQAofp%2BODq2Bae%2BCP%2BZhhDJ2ogcLNjXxH%2FI67HNSCmJFKWnDN%2BYONmbXMves8QF8JWcbcAJaX1O6q%2B1214%2BXd9VLILrqvp%2BAh%2Fx8Ap70MMHAyIjdcz%2B8m69gqylvfOvHJ45gFoUY8l8oOSajZZnVIwfKKGyCmMfnvzdA%3D%3D&u2=mLMLU1UrxzAkoGkL&width=1024',
  // ãƒ›ãƒ¼ãƒ«å¤–è¦³
  hall_forest:  'https://sspark.genspark.ai/cfimages?u1=ZxNYfsT0wXO2oedmP7dwJF6PmvAgl7isNVyCT41opAVERCNiFv0VRue21cC280CRvzmH4UASNkAi2zopOpI%2FcLmbcJ%2FitYNdQbWqx0xCLSdljxTsLdpN0uE%2FvwUwv1iiDlKHPbHYAJULpklqq3nGIT%2F3gZtyBhiU&u2=IFTFT7L6ttpDl6kq&width=1024',
  hall_yasuragi:'https://sspark.genspark.ai/cfimages?u1=JD3sdHwCd9UguUNbtp83krdMZtBaCLQtAfw9S7P3EiwqC6W1Tw5swfUwQLlSJLO3iyqd8g5qY1Nqto15akUMjHfikrZzXs5uX4IjHMZ7UJ3Rx%2BoklWi%2FQqio0ZCscMydTANKjbqMemP6vgShBwrZpp%2Ff4wpeNbOrmJI%3D&u2=0QUHL4SigXbXR1nY&width=1024',
  hall_tsutsuji:'https://sspark.genspark.ai/cfimages?u1=7rrDkyC3hIroxC2fluFwHEeksJ0bUNtUcN4C%2Fsg2zXlQ0K9nImnPv%2F0M37bIIXoUPJoNL0OdAoTzljUC6fBdMRkhF3Xe8uTq1u46I%2F6sNDVXpHh03akakvF1JJshqzXwAvUlxD%2BlZL9wdwNU%2BJ%2Bb18cyoYIDaJi6ZbJu3Ns3qNowtw%3D%3D&u2=Y1v%2B37q6FHQe%2Fial&width=1024',
  hall_yasuura: 'https://sspark.genspark.ai/cfimages?u1=CafYEXSmhhbBOLttGKfJ4vF5JW0t6qd5VAxckRtblge0jogyp8%2BwLD6RlFm4%2FGCZhfJ7OMQ%2FyHjC7OUGt%2BJ9qZjIQddTCdZ4cahjsugE%2FL36XjkCAtGwpVxZlvZSGc62lyceTJrh7piUj38ooHFX6EMiSDfIC3x1J3gMaNRQS88Fb%2B0%3D&u2=Twb2gJDsaPErZw3A&width=1024',
  hall_shion:   'https://sspark.genspark.ai/cfimages?u1=PXRKn%2BQzvKjS03FE5kPb5tMyTxdDU9zeSeuyCeMczzxWaDghQv%2BtjUxgCzytV5YZiegOcjOw%2FfO3ZIce5U267jm5kkrwRnxdAaYY0YYHPWR4f0j4%2FU1Nv6mJfoP%2FRvLHGP0nrSaK92WZMkjiAdGo0IOuLJa0ELebSEjbsXZIAA%3D%3D&u2=oaG1F%2FmyUvzfUzOP&width=1024',
  hall_living:  'https://sspark.genspark.ai/cfimages?u1=pQpKKeEit3T9d7xBH4%2FbkbxeT%2Bwy9%2BUb0jw%2BCfOiUELGvqH%2FTHjd7IpASiGd9m83Yuc34Z3VKf021c6SMgRkAMU5dC08CnBU5ZdDrNrfwyRryR6flCHsN9qjTULqPAGXIHCY5mSFQzy3QHEWy%2FRjBepfsCSlfpZGX95SOukidbNnkQ%3D%3D&u2=iFIWuiLz%2Bzm21Ze9&width=1024',
};

// ãƒ—ãƒ©ã‚¤ã‚·ãƒ³ã‚°ï¼ˆä¼šå“¡ä¾¡æ ¼ãƒ»ä¸€èˆ¬ä¾¡æ ¼ï¼‰
const PRICING = {
  compact: { ai:[393800,573800], hana:[471800,651800], kaori:[602800,782800], kaga:[767800,947800] },
  living:  { ai:[547800,727800], hana:[625800,805800], kaori:[756800,936800], kaga:[921800,1101800] },
  family:  { ai:[712800,992800], hana:[800800,1080800], kaori:[931800,1211800], kaga:[1096800,1376800] },
  normal:  { ai:[877800,1157800], hana:[987800,1267800], kaori:[1140800,1420800], kaga:[1327800,1607800] },
  chokuso: { single:[198000,248000] },  // ç›´è‘¬ãƒ»ç«è‘¬å¼ï¼ˆã‚³ãƒ¼ã‚¹é¸æŠãªã—ï¼‰
  kasou:   { single:[148000,198000] }   // ç«è‘¬ã®ã¿ï¼ˆæœ€å°é™ï¼‰
};

// ãƒ›ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿
const HALLS = {
  tsutsuji: {
    id:'tsutsuji', name:'ã‚¢ã‚¤ãƒ•ã‚£ãƒƒãƒˆãƒ›ãƒ¼ãƒ«ã¤ã¤ã˜', short:'ã¤ã¤ã˜',
    address:'ã€’739-0006 æ±åºƒå³¶å¸‚è¥¿æ¡ä¸Šå¸‚ç”º10-11',
    access:'JRè¥¿æ¡é§…ã‹ã‚‰ã‚¿ã‚¯ã‚·ãƒ¼4åˆ†', capacity:'å®¶æ—è‘¬å°‚ç”¨ãƒ›ãƒ¼ãƒ«ï¼ˆã€œ15åï¼‰',
    image: IMG.hall_tsutsuji, pricingType:'compact',
    url:'https://saiki-sousai.com/plan/premium-compact-funeral/access#itfit-tsutsuji',
    maxPeople:15, planLabel:'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆå®¶æ—è‘¬',
    badge:'å°è¦æ¨¡å‘ã', special:''
  },
  yasuura: {
    id:'yasuura', name:'ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒ›ãƒ¼ãƒ«å®‰æµ¦', short:'å®‰æµ¦',
    address:'ã€’737-2516 å‘‰å¸‚å®‰æµ¦ç”ºä¸­å¤®5ä¸ç›®3-5',
    access:'JRå®‰æµ¦é§…ã‹ã‚‰ã‚¿ã‚¯ã‚·ãƒ¼2åˆ†ï¼ˆå¾’æ­©3åˆ†ï¼‰', capacity:'å®¶æ—è‘¬å°‚ç”¨ãƒ›ãƒ¼ãƒ«ï¼ˆã€œ10åï¼‰',
    image: IMG.hall_yasuura, pricingType:'compact',
    url:'https://saiki-sousai.com/plan/premium-compact-funeral/access#family-yasuura',
    maxPeople:10, planLabel:'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆå®¶æ—è‘¬',
    badge:'', special:''
  },
  living: {
    id:'living', name:'ã‚„ã™ã‚‰ããƒªãƒ“ãƒ³ã‚°', short:'ãƒªãƒ“ãƒ³ã‚°',
    address:'ã€’739-0042 æ±åºƒå³¶å¸‚è¥¿æ¡ç”ºè¥¿æ¡æ±1050ï¼ˆã‚„ã™ã‚‰ãä¼šé¤¨å†…ï¼‰',
    access:'JRè¥¿æ¡é§…ã‹ã‚‰ã‚¿ã‚¯ã‚·ãƒ¼3åˆ†', capacity:'1çµ„é™å®šãƒ»æœ€å¤§20å',
    image: IMG.hall_living, pricingType:'living',
    url:'https://saiki-sousai.com/yasuragi-living',
    maxPeople:20, planLabel:'ã‚„ã™ã‚‰ããƒªãƒ“ãƒ³ã‚°è‘¬',
    badge:'1æ—¥1çµ„é™å®š', special:'living'
  },
  yasuragi: {
    id:'yasuragi', name:'ã‚„ã™ã‚‰ãä¼šé¤¨', short:'ã‚„ã™ã‚‰ã',
    address:'ã€’739-0042 æ±åºƒå³¶å¸‚è¥¿æ¡ç”ºè¥¿æ¡æ±1050',
    access:'JRè¥¿æ¡é§…ã‹ã‚‰ã‚¿ã‚¯ã‚·ãƒ¼3åˆ†', capacity:'ä¸­ãƒ»å¤§ãƒ›ãƒ¼ãƒ«ï¼ˆã€œ300åï¼‰ã€å°ãƒ›ãƒ¼ãƒ«ï¼ˆã€œ50åï¼‰',
    image: IMG.hall_yasuragi, pricingType:'family',
    url:'https://saiki-sousai.com/yasuragi',
    maxPeople:300, planLabel:'å®¶æ—è‘¬çš„ãªãŠè‘¬å¼ï¼æ™®é€šã®ãŠè‘¬å¼',
    badge:'å¤§è¦æ¨¡å¯¾å¿œå¯', special:''
  },
  forest: {
    id:'forest', name:'ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆãƒ›ãƒ¼ãƒ«', short:'ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆ',
    address:'ã€’739-0041 åºƒå³¶çœŒæ±åºƒå³¶å¸‚è¥¿æ¡ç”ºå¯ºå®¶6282',
    access:'JRè¥¿æ¡é§…ã‹ã‚‰å¾’æ­©10åˆ†', capacity:'å¤§ãƒ›ãƒ¼ãƒ«ï¼ˆ200åä»¥ä¸Šï¼‰ã€ä¸­ãƒ›ãƒ¼ãƒ«ï¼ˆã€œ150åï¼‰ã€å°ãƒ›ãƒ¼ãƒ«ï¼ˆã€œ50åï¼‰',
    image: IMG.hall_forest, pricingType:'family',
    url:'https://saiki-sousai.com/forest-hall',
    maxPeople:300, planLabel:'å®¶æ—è‘¬çš„ãªãŠè‘¬å¼ï¼æ™®é€šã®ãŠè‘¬å¼',
    badge:'å¤§è¦æ¨¡å¯¾å¿œå¯', special:''
  },
  shion: {
    id:'shion', name:'Aifitã‚»ãƒ¬ãƒ¢ãƒ‹ãƒ¼ãƒ›ãƒ¼ãƒ«ç´«è‹‘', short:'ç´«è‹‘',
    address:'ã€’723-0052 åºƒå³¶çœŒä¸‰åŸå¸‚çš†å®Ÿ2ä¸ç›®1-16',
    access:'JRä¸‰åŸé§…ã‹ã‚‰ã‚¿ã‚¯ã‚·ãƒ¼6åˆ†', capacity:'ä¸­ãƒ›ãƒ¼ãƒ«ï¼ˆã€œ80åï¼‰å®¶æ—è‘¬å¯',
    image: IMG.hall_shion, pricingType:'normal',
    url:'https://saiki-sousai.com/plan/normal/access#ifit-shion',
    maxPeople:80, planLabel:'æ™®é€šã®ãŠè‘¬å¼ï¼è¦ªæ—è‘¬',
    badge:'ä¸‰åŸã‚¨ãƒªã‚¢', special:''
  },
  ai_chokuso: {
    id:'ai_chokuso', name:'ã‚ã„ç›´è‘¬ãƒ›ãƒ¼ãƒ«', short:'ã‚ã„ç›´è‘¬',
    address:'ã€’739-0041 åºƒå³¶çœŒæ±åºƒå³¶å¸‚è¥¿æ¡ç”ºå¯ºå®¶6288',
    access:'ğŸ“ 0120-315-312ï¼ˆç„¡æ–™ï¼‰', capacity:'ç›´è‘¬ãƒ»ç«è‘¬å¼å°‚ç”¨ï¼ˆã€œ10åï¼‰',
    image: IMG.hall_tsutsuji, pricingType:'chokuso',
    url:'https://saiki-sousai.com/plan/ai-kaso/',
    maxPeople:10, planLabel:'ç›´è‘¬ãƒ»ç«è‘¬å¼å°‚ç”¨ãƒ›ãƒ¼ãƒ«',
    badge:'ç›´è‘¬å°‚ç”¨', special:'chokuso'
  }
};

// ã‚³ãƒ¼ã‚¹æƒ…å ±
const COURSES = {
  ai:    { name:'æ„›ã‚³ãƒ¼ã‚¹', kanji:'æ„›', desc:'ã‚·ãƒ³ãƒ—ãƒ«ã§æ¸©ã‹ã¿ã®ã‚ã‚‹ç¥­å£‡ã€‚è½ã¡ç€ã„ãŸé›°å›²æ°—ã§ãŠè¦‹é€ã‚Šã€‚', color:'#e8f4f8' },
  hana:  { name:'èŠ±ã‚³ãƒ¼ã‚¹', kanji:'èŠ±', desc:'ç¾ã—ã„èŠ±ã‚’ãµã‚“ã ã‚“ã«ä½¿ã£ãŸã€è¯ã‚„ã‹ã§æ˜ã‚‹ã„ç¥­å£‡ã€‚', color:'#fce8f0' },
  kaori: { name:'é¦™ã‚³ãƒ¼ã‚¹', kanji:'é¦™', desc:'å“æ ¼ã‚ã‚‹ä½‡ã¾ã„ã®ç¥­å£‡ã€‚æ•…äººã®å°Šå³ã‚’è¡¨ç¾ã—ãŸã‚°ãƒ¬ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—ãƒ—ãƒ©ãƒ³ã€‚', color:'#f0f4e8' },
  kaga:  { name:'è¼ã‚³ãƒ¼ã‚¹', kanji:'è¼', desc:'æœ€é«˜ã‚°ãƒ¬ãƒ¼ãƒ‰ã®è±ªè¯ãªç¥­å£‡ã€‚å¤§åˆ‡ãªæ–¹ã¸ã®æœ€ä¸Šã®ãŠåˆ¥ã‚Œã‚’ã€‚', color:'#f8f4e0' }
};

// ãƒ—ãƒ©ãƒ³å®šç¾©ï¼ˆ3ãƒ—ãƒ©ãƒ³ï¼‰
function getPlans(attendance, funeralType) {
  const plans = [];
  
  if(attendance === 'under5') {
    plans.push({
      id:'nano', label:'small', name:'ã‚¹ãƒãƒ¼ãƒˆãƒ—ãƒ©ãƒ³', icon:'ğŸŒ¿',
      desc:'ã”ãèº«è¿‘ãªã”å®¶æ—5åä»¥ä¸‹ã®ã‚·ãƒ³ãƒ—ãƒ«ãªãŠè¦‹é€ã‚Šã€‚æœ€å°é™ã®è²»ç”¨ã§å¿ƒã®ã“ã‚‚ã£ãŸãŠè‘¬å¼ã€‚',
      halls:['yasuura','tsutsuji'], priceType:'compact', sizeTag:'ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ'
    });
    plans.push({
      id:'compact', label:'rec', name:'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆå®¶æ—è‘¬', icon:'ğŸŒ¸',
      desc:'å°‘äººæ•°ã§ã‚‚å……å®Ÿã—ãŸå†…å®¹ã®å®¶æ—è‘¬ã€‚1æ—¥1çµ„ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãªå¼ã‚‚ã”ç”¨æ„ã€‚',
      halls:['tsutsuji','living'], priceType:'compact', sizeTag:'æ¨å¥¨'
    });
    plans.push({
      id:'living', label:'large', name:'ã‚„ã™ã‚‰ããƒªãƒ“ãƒ³ã‚°è‘¬', icon:'ğŸ¡',
      desc:'ãƒ›ãƒ¼ãƒ ãƒ©ã‚¤ã‚¯ãªç©ºé–“ã§æœ€å¤§20åã¾ã§ãŠè¦‹é€ã‚Šã€‚1æ—¥1çµ„ã®å®Œå…¨ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆç©ºé–“ã€‚',
      halls:['living'], priceType:'living', sizeTag:'ã‚†ã¨ã‚Š'
    });
  } else if(attendance === 'under15') {
    plans.push({
      id:'compact', label:'small', name:'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆå®¶æ—è‘¬', icon:'ğŸŒ¸',
      desc:'å®¶æ—è‘¬å°‚ç”¨ãƒ›ãƒ¼ãƒ«ã§15åä»¥ä¸‹ã®ã”è‘¬å„€ã€‚æ‰‹é ƒãªè²»ç”¨ã§å……å®Ÿã—ãŸå†…å®¹ã€‚',
      halls:['tsutsuji','yasuura'], priceType:'compact', sizeTag:'ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ'
    });
    plans.push({
      id:'living', label:'rec', name:'ã‚„ã™ã‚‰ããƒªãƒ“ãƒ³ã‚°è‘¬', icon:'ğŸ¡',
      desc:'1æ—¥1çµ„ãƒ»æœ€å¤§20åã€‚ãƒ›ãƒ¼ãƒ ãƒ©ã‚¤ã‚¯ãªãƒªãƒ“ãƒ³ã‚°ç©ºé–“ã§ã‚†ã£ãŸã‚ŠãŠè¦‹é€ã‚Šã€‚',
      halls:['living'], priceType:'living', sizeTag:'æ¨å¥¨'
    });
    plans.push({
      id:'family', label:'large', name:'å®¶æ—è‘¬çš„ãªãŠè‘¬å¼', icon:'ğŸŒ¿',
      desc:'å¤§å‹ãƒ›ãƒ¼ãƒ«ã®å°ãƒ›ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã€‚å°†æ¥ã®äººæ•°å¢—åŠ ã«ã‚‚å¯¾å¿œå¯èƒ½ãªã‚†ã¨ã‚Šã®ãƒ—ãƒ©ãƒ³ã€‚',
      halls:['yasuragi','forest'], priceType:'family', sizeTag:'ã‚†ã¨ã‚Š'
    });
  } else if(attendance === '15to30') {
    plans.push({
      id:'living', label:'small', name:'ã‚„ã™ã‚‰ããƒªãƒ“ãƒ³ã‚°è‘¬', icon:'ğŸ¡',
      desc:'æœ€å¤§20åã®ãƒªãƒ“ãƒ³ã‚°è‘¬ã€‚20åã‚’è¶…ãˆã‚‹å ´åˆã¯ä»–ãƒ›ãƒ¼ãƒ«ã¸ã®å¤‰æ›´ã‚’ã”æ¤œè¨ãã ã•ã„ã€‚',
      halls:['living'], priceType:'living', sizeTag:'å°è¦æ¨¡'
    });
    plans.push({
      id:'family', label:'rec', name:'å®¶æ—è‘¬çš„ãªãŠè‘¬å¼', icon:'ğŸŒ¸',
      desc:'30åç¨‹åº¦ã¾ã§å¯¾å¿œã®å®¶æ—è‘¬çš„ãªå¼ã€‚ã‚„ã™ã‚‰ãä¼šé¤¨ãƒ»ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆãƒ›ãƒ¼ãƒ«ã§æ‰¿ã‚Šã¾ã™ã€‚',
      halls:['yasuragi','forest'], priceType:'family', sizeTag:'æ¨å¥¨'
    });
    plans.push({
      id:'normal', label:'large', name:'ãµã¤ã†ã®ãŠè‘¬å¼', icon:'ğŸŒ¿',
      desc:'ä¸€èˆ¬è‘¬ã‚¹ã‚¿ã‚¤ãƒ«ã€‚çŸ¥äººãƒ»å‹äººã®æ–¹ã€…ã‚‚åºƒããŠæ‹›ãã§ãã‚‹å……å®Ÿã®å†…å®¹ã€‚',
      halls:['yasuragi','forest','shion'], priceType:'normal', sizeTag:'ã‚†ã¨ã‚Š'
    });
  } else if(attendance === '30to50') {
    plans.push({
      id:'family', label:'small', name:'å®¶æ—è‘¬çš„ãªãŠè‘¬å¼', icon:'ğŸŒ¸',
      desc:'è²»ç”¨ã‚’æŠ‘ãˆãªãŒã‚‰ã‚‚30ã€œ50åã«å¯¾å¿œã€‚ã‚¢ãƒƒãƒˆãƒ›ãƒ¼ãƒ ãªé›°å›²æ°—ã§ãŠè¦‹é€ã‚Šã€‚',
      halls:['yasuragi','forest','shion'], priceType:'family', sizeTag:'ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ'
    });
    plans.push({
      id:'normal', label:'rec', name:'ãµã¤ã†ã®ãŠè‘¬å¼', icon:'ğŸŒ¿',
      desc:'50åè¦æ¨¡ã«æœ€é©ãªä¸€èˆ¬è‘¬ã€‚é€šå¤œãƒ»å‘Šåˆ¥å¼ã‚’ã—ã£ã‹ã‚ŠåŸ·ã‚Šè¡Œã„ã¾ã™ã€‚',
      halls:['yasuragi','forest','shion'], priceType:'normal', sizeTag:'æ¨å¥¨'
    });
    plans.push({
      id:'grand', label:'large', name:'ç¤¾è‘¬ãƒ»å¤§å‹è‘¬', icon:'ğŸ›ï¸',
      desc:'ä¼šç¤¾ãƒ»å›£ä½“é–¢ä¿‚ã‚‚å¤šã„å¤§è¦æ¨¡è‘¬å„€ã€‚å°‚ä»»ã‚¹ã‚¿ãƒƒãƒ•ãŒä¸‡å…¨ã®ä½“åˆ¶ã§ã‚µãƒãƒ¼ãƒˆã€‚',
      halls:['yasuragi','forest'], priceType:'normal', sizeTag:'å¤§è¦æ¨¡'
    });
  } else { // over50
    plans.push({
      id:'normal', label:'small', name:'ãµã¤ã†ã®ãŠè‘¬å¼', icon:'ğŸŒ¿',
      desc:'50ã€œ100åè¦æ¨¡ã®ä¸€èˆ¬è‘¬ã€‚å¤§å‹ãƒ›ãƒ¼ãƒ«ã§åºƒããŠæ‹›ãã§ãã¾ã™ã€‚',
      halls:['yasuragi','forest','shion'], priceType:'normal', sizeTag:'æ¨™æº–'
    });
    plans.push({
      id:'large', label:'rec', name:'å¤§å‹ä¸€èˆ¬è‘¬', icon:'ğŸ›ï¸',
      desc:'100åä»¥ä¸Šã®å¤§è¦æ¨¡è‘¬å„€ã€‚åœ°åŸŸã®æ–¹ã€…ãƒ»ä¼šç¤¾é–¢ä¿‚è€…ã‚‚å«ã‚ãŸå¤§è¦æ¨¡è‘¬ã€‚',
      halls:['yasuragi','forest'], priceType:'normal', sizeTag:'æ¨å¥¨'
    });
    plans.push({
      id:'corp', label:'large', name:'ç¤¾è‘¬ãƒ»å›£ä½“è‘¬', icon:'ğŸ¢',
      desc:'ä¼šç¤¾ãƒ»å›£ä½“ä¸»å‚¬ã®è‘¬å„€ã€‚å°‚ä»»ãƒãƒ¼ãƒ ãŒä¼ç”»ã‹ã‚‰é‹å–¶ã¾ã§å…¨é¢ã‚µãƒãƒ¼ãƒˆã€‚',
      halls:['yasuragi','forest'], priceType:'normal', sizeTag:'å¤§è¦æ¨¡'
    });
  }
  // ç›´è‘¬ãƒ»ç«è‘¬å¼ã®å ´åˆã¯å°‚ç”¨ãƒ—ãƒ©ãƒ³ã‚’å·®ã—è¾¼ã‚€
  if(funeralType === 'chokuso') {
    return [
      {
        id:'chokuso_standard', label:'rec', name:'ç›´è‘¬ãƒ»ç«è‘¬å¼ãƒ—ãƒ©ãƒ³', icon:'ğŸ•Šï¸',
        desc:'é€šå¤œãƒ»å‘Šåˆ¥å¼ã‚’è¡Œã‚ãšã€ç«è‘¬å ´ã§ã®ãŠåˆ¥ã‚Œã®ã¿ã€‚ã‚·ãƒ³ãƒ—ãƒ«ãªãŒã‚‰å¿ƒã®ã“ã‚‚ã£ãŸãŠè¦‹é€ã‚Šã€‚',
        halls:['ai_chokuso','tsutsuji','yasuura'], priceType:'chokuso', sizeTag:'ç›´è‘¬',
        isSimplePlan: true
      },
      {
        id:'chokuso_with_farewell', label:'large', name:'ç›´è‘¬ï¼‹ãŠåˆ¥ã‚Œã®æ™‚é–“ã‚ã‚Š', icon:'ğŸŒ¸',
        desc:'ç«è‘¬å‰ã«å°‘ã—ã ã‘ãŠåˆ¥ã‚Œã®æ™‚é–“ã‚’è¨­ã‘ã‚‹ãƒ—ãƒ©ãƒ³ã€‚ã”å®¶æ—ãŒã‚†ã£ãã‚ŠãŠè¦‹é€ã‚Šã§ãã¾ã™ã€‚',
        halls:['ai_chokuso','tsutsuji','living'], priceType:'chokuso', sizeTag:'ç›´è‘¬+ãŠåˆ¥ã‚Œ',
        isSimplePlan: true
      }
    ];
  }
  if(funeralType === 'kasouonly') {
    return [
      {
        id:'kasou_only', label:'rec', name:'ç«è‘¬ã®ã¿ãƒ—ãƒ©ãƒ³', icon:'â›©ï¸',
        desc:'æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªå½¢å¼ã€‚ã”éºä½“ã®æ¬é€ãƒ»å®‰ç½®ãƒ»ç«è‘¬ã®ã¿ã‚’è¡Œã„ã¾ã™ã€‚è²»ç”¨ã‚’æœ€å°é™ã«æŠ‘ãˆãŸã„æ–¹ã«ã€‚',
        halls:['ai_chokuso','tsutsuji','yasuura'], priceType:'kasou', sizeTag:'ç«è‘¬ã®ã¿',
        isSimplePlan: true
      }
    ];
  }
  return plans;
}

// ãƒ›ãƒ¼ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
function getRecommendedHalls(attendance, funeralType, selectedPlan) {
  const allHallIds = ['tsutsuji','yasuura','living','yasuragi','forest','shion'];
  
  if(!selectedPlan) return allHallIds;
  
  // é¸æŠã—ãŸãƒ—ãƒ©ãƒ³ã®å¯¾å¿œãƒ›ãƒ¼ãƒ«ã‚’å„ªå…ˆ
  const planHalls = selectedPlan.halls || allHallIds;
  
  // è¿½åŠ ã§è¡¨ç¤ºã™ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹ãƒ›ãƒ¼ãƒ«
  let recommended = [...planHalls];
  let others = allHallIds.filter(h => !recommended.includes(h));
  
  return { recommended, others };
}

// ========== çŠ¶æ…‹ç®¡ç† ==========
let state = {
  currentStep: 1,
  name: '', relation: '', phone: '',
  attendance: '', funeralType: '',
  selectedPlan: null, selectedHall: null, selectedCourse: null,
  wishes: '', concerns: '', chatLog: [], isMember: null,
  showingAllHalls: false
};

// ========== FAQ ã‚ˆãã‚ã‚‹è³ªå• ==========

// FAQå›ç­”ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
const FAQ_ANSWERS = {
  'è²»ç”¨ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„': {
    badge: 'ğŸ’° è²»ç”¨',
    text: `ã•ã„ãè‘¬ç¥­ã§ã¯ã€è‘¬å„€è²»ç”¨ã¯å¤§ãã3ã¤ã«åˆ†ã‹ã‚Œã¾ã™ã€‚\n\nâ‘  <strong>åŸºæœ¬è‘¬å„€ã‚»ãƒƒãƒˆ</strong>ï¼ˆç¥­å£‡ãƒ»æ£ºãƒ»æ¬é€ãƒ»éºå½±ãªã©ï¼‰\nâ‘¡ <strong>ãŠã‚‚ã¦ãªã—è²»ç”¨</strong>ï¼ˆä¼šè‘¬å¾¡ç¤¼å“ãƒ»é£Ÿäº‹ãƒ»ä¼šé¤¨ä½¿ç”¨æ–™ãªã©ï¼‰\nâ‘¢ <strong>ã‚ˆãã‚ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³</strong>ï¼ˆç”ŸèŠ±ãƒ»æ–™ç†ãƒ»å¸‚ç­‰ã®ã”å¸Œæœ›ï¼‰\n\n<strong>æ˜æœ—ä¼šè¨ˆ</strong>ã®ãŠç´„æŸã¨ã—ã¦ã€äº‹å‰ãŠè¦‹ç©ã‚‚ã‚Šä»¥å¤–ã®è¿½åŠ è«‹æ±‚ã¯ä¸€åˆ‡ã”ã–ã„ã¾ã›ã‚“ã€‚`
  },
  'è¿½åŠ è²»ç”¨ã¯ã‹ã‹ã‚Šã¾ã™ã‹ï¼Ÿ': {
    badge: 'ğŸ’° è²»ç”¨',
    text: `äº‹å‰ã«ãŠè¦‹ç©ã‚‚ã‚Šã—ãŸé‡‘é¡ä»¥å¤–ã®è¿½åŠ è«‹æ±‚ã¯ä¸€åˆ‡ã”ã–ã„ã¾ã›ã‚“ ğŸ™\n\näººæ•°å¢—æ¸›ãªã©å¤‰æ›´ãŒç”Ÿã˜ãŸå ´åˆã¯ã€å¿…ãšã”å–ªä¸»æ§˜ã«ã”ç¢ºèªã®ä¸Šã§å¯¾å¿œã„ãŸã—ã¾ã™ã€‚ã”å®‰å¿ƒãã ã•ã„ã€‚`
  },
  'åˆ†å‰²æ‰•ã„ã¯å¯èƒ½ã§ã™ã‹ï¼Ÿ': {
    badge: 'ğŸ’° ãŠæ”¯æ‰•ã„',
    text: `ã¯ã„ã€å„ç¨®ãŠæ”¯æ‰•ã„æ–¹æ³•ã‚’ã”ç”¨æ„ã—ã¦ãŠã‚Šã¾ã™ã€‚\n\nãƒ»ç¾é‡‘æ‰•ã„\nãƒ»ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰æ‰•ã„\nãƒ»ãƒ­ãƒ¼ãƒ³ãƒ»åˆ†å‰²æ‰•ã„ï¼ˆã”ç›¸è«‡ãã ã•ã„ï¼‰\n\nè©³ç´°ã¯æ‹…å½“è€…ã«ãŠæ°—è»½ã«ã”ç›¸è«‡ãã ã•ã„ ğŸ˜Š`
  },
  'ä¼šå“¡å‰²å¼•ã®è©³ç´°ã‚’æ•™ãˆã¦ãã ã•ã„': {
    badge: 'ğŸ’³ ä¼šå“¡',
    text: `ã‚„ã™ã‚‰ãä¼šå“¡ã«ã”å…¥ä¼šã„ãŸã ãã¨ã€è‘¬å„€è²»ç”¨ãŒ<strong>35%å‰²å¼•</strong>ã¨ãªã‚Šã¾ã™ã€‚\n\nå½“æ—¥ã”å…¥ä¼šã®å ´åˆã§ã‚‚<strong>30%å‰²å¼•</strong>ãŒé©ç”¨ã•ã‚Œã¾ã™ã€‚\n\nè©³ç´°ã¯æ‹…å½“è€…ã¾ã§ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚\nğŸ“ 0120-315-312`
  },
  'è‘¬ç¥­è²»è£œåŠ©é‡‘ãƒ»é¦™å…¸è¿”ã—ã«ã¤ã„ã¦': {
    badge: 'ğŸ’° è£œåŠ©é‡‘',
    text: `å›½æ°‘å¥åº·ä¿é™ºãƒ»å¾ŒæœŸé«˜é½¢è€…åŒ»ç™‚ä¿é™ºã®è¢«ä¿é™ºè€…ãŒäº¡ããªã‚‰ã‚ŒãŸå ´åˆã€<strong>è‘¬ç¥­è²»ï¼ˆè£œåŠ©é‡‘ï¼‰</strong>ãŒå¸‚åŒºç”ºæ‘ã‹ã‚‰æ”¯çµ¦ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼ˆç›®å®‰ï¼š3ã€œ7ä¸‡å††ï¼‰ã€‚\n\næ‰‹ç¶šãã¯æ‹…å½“è€…ãŒã‚µãƒãƒ¼ãƒˆã„ãŸã—ã¾ã™ã€‚é¦™å…¸è¿”ã—ã®ã”ç›¸è«‡ã‚‚æ‰¿ã£ã¦ãŠã‚Šã¾ã™ã€‚`
  },
  'è‘¬å¼ã®æµã‚Œã‚’æ•™ãˆã¦ãã ã•ã„': {
    badge: 'ğŸ“‹ æµã‚Œ',
    text: `ä¸€èˆ¬çš„ãªè‘¬å„€ã®æµã‚Œã§ã™ï¼š\n\n1ï¸âƒ£ ã”é€å»ãƒ»ã”é€£çµ¡ï¼ˆ24æ™‚é–“å—ä»˜ï¼‰\n2ï¸âƒ£ æ¬é€ãƒ»å®‰ç½®\n3ï¸âƒ£ æ‰“ã¡åˆã‚ã›ãƒ»ãŠè¦‹ç©ã‚‚ã‚Š\n4ï¸âƒ£ é€šå¤œå¼\n5ï¸âƒ£ å‘Šåˆ¥å¼ãƒ»å‡ºæ£º\n6ï¸âƒ£ ç«è‘¬ãƒ»éª¨ä¸Šã’\n7ï¸âƒ£ åˆä¸ƒæ—¥æ³•è¦\n\næ‹…å½“è€…ãŒå…¨ã¦ã®æµã‚Œã‚’ã‚µãƒãƒ¼ãƒˆã„ãŸã—ã¾ã™ ğŸ™`
  },
  'æ­»äº¡å¾Œã®å½¹æ‰€æ‰‹ç¶šãã¯ï¼Ÿ': {
    badge: 'ğŸ“‹ æ‰‹ç¶šã',
    text: `ä¸»ãªå½¹æ‰€æ‰‹ç¶šãã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š\n\nãƒ»<strong>æ­»äº¡å±Šã®æå‡º</strong>ï¼ˆ7æ—¥ä»¥å†…ï¼‰\nãƒ»ç«è‘¬è¨±å¯è¨¼ã®å–å¾—\nãƒ»å¥åº·ä¿é™ºãƒ»å¹´é‡‘ã®è³‡æ ¼å–ªå¤±å±Š\nãƒ»ä¸–å¸¯ä¸»å¤‰æ›´å±Šï¼ˆå¿…è¦ãªå ´åˆï¼‰\n\nã•ã„ãè‘¬ç¥­ã§ã¯<strong>å½¹æ‰€æ‰‹ç¶šãä»£è¡Œ</strong>ã‚‚æ‰¿ã£ã¦ãŠã‚Šã¾ã™ã€‚ãŠæ°—è»½ã«ã”ç›¸è«‡ãã ã•ã„ã€‚`
  },
  'æ­»äº¡è¨ºæ–­æ›¸ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„': {
    badge: 'ğŸ“‹ æ›¸é¡',
    text: `æ­»äº¡è¨ºæ–­æ›¸ã¯ã€åŒ»å¸«ãŒç™ºè¡Œã™ã‚‹å…¬å¼æ›¸é¡ã§ã™ã€‚\n\nãƒ»ç—…é™¢ã§äº¡ããªã£ãŸå ´åˆï¼šæ‹…å½“åŒ»ãŒç™ºè¡Œ\nãƒ»è‡ªå®…ã§äº¡ããªã£ãŸå ´åˆï¼šã‹ã‹ã‚Šã¤ã‘åŒ»ã¾ãŸã¯æ•‘æ€¥åŒ»ãŒç™ºè¡Œ\n\næ­»äº¡å±Šã®æå‡ºã«å¿…è¦ã¨ãªã‚Šã¾ã™ã€‚æ‹…å½“è€…ãŒã”æ¡ˆå†…ã„ãŸã—ã¾ã™ã€‚`
  },
  'é€£çµ¡ã™ã‚‹ç¯„å›²ã¯ï¼Ÿ': {
    badge: 'ğŸ“‹ é€£çµ¡',
    text: `ã”é€å»å¾Œã®é€£çµ¡é †åºã®ç›®å®‰ã§ã™ï¼š\n\n1ï¸âƒ£ ç›´ç³»å®¶æ—ãƒ»è¿‘è¦ªè€…\n2ï¸âƒ£ è¦ªæ—ãƒ»å…„å¼Ÿå§‰å¦¹\n3ï¸âƒ£ æ•…äººã®å‹äººãƒ»çŸ¥äººï¼ˆå®¶æ—è‘¬ã®å ´åˆã¯ä»»æ„ï¼‰\n4ï¸âƒ£ è·å ´ãƒ»ä¼šç¤¾é–¢ä¿‚ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰\n\nå®¶æ—è‘¬ã®å ´åˆã¯ã€è‘¬å„€å¾Œã«ã”é€£çµ¡ã™ã‚‹ã‚±ãƒ¼ã‚¹ã‚‚å¤šãã”ã–ã„ã¾ã™ã€‚`
  },
  'é€šå¤œãƒ»å‘Šåˆ¥å¼ã®é•ã„ã‚’æ•™ãˆã¦ãã ã•ã„': {
    badge: 'ğŸ“‹ å¼æ¬¡ç¬¬',
    text: `<strong>é€šå¤œ</strong>ï¼šã”é€å»ç¿Œæ—¥ã®å¤•æ–¹ã«è¡Œã†å„€å¼ã€‚æ•…äººã¨æœ€å¾Œã®å¤œã‚’ã¨ã‚‚ã«ã™ã‚‹æ™‚é–“ã§ã™ã€‚\n\n<strong>å‘Šåˆ¥å¼ï¼ˆè‘¬å„€ï¼‰</strong>ï¼šç¿Œæ—¥ã®åˆå‰ä¸­ã«è¡Œã†æœ¬å¼ã€‚å‚åˆ—è€…ãŒæœ€å¾Œã®ãŠåˆ¥ã‚Œã‚’ã™ã‚‹å¼å…¸ã§ã™ã€‚\n\nå®¶æ—è‘¬ã§ã¯é€šå¤œã‚’çœç•¥ã—ãŸã€Œä¸€æ—¥è‘¬ã€ã‚‚äººæ°—ãŒã‚ã‚Šã¾ã™ã€‚`
  },
  'ãŠå¸ƒæ–½ã®ç›®å®‰ã¯ï¼Ÿ': {
    badge: 'ğŸ·ï¸ ãŠå¸ƒæ–½',
    text: `ãŠå¸ƒæ–½ã¯å®—æ—¨ãƒ»å®—æ´¾ãƒ»åœ°åŸŸã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ã€‚ä¸€èˆ¬çš„ãªç›®å®‰ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š\n\nãƒ»ä»å¼ï¼š10ã€œ30ä¸‡å††ç¨‹åº¦\nãƒ»ç¥å¼ï¼š10ã€œ30ä¸‡å††ç¨‹åº¦\nãƒ»ã‚­ãƒªã‚¹ãƒˆæ•™ï¼š5ã€œ20ä¸‡å††ç¨‹åº¦\n\nâ€»ãŠå¸ƒæ–½ã¯ã€ŒãŠæ°—æŒã¡ã€ã§ã™ã®ã§ã€è©³ã—ãã¯è©æå¯ºã‚„æ‹…å½“è€…ã«ã”ç›¸è«‡ãã ã•ã„ã€‚`
  },
  'ç„¡å®—æ•™ãƒ»ç„¡å®—æ´¾ã§ã‚‚ã§ãã¾ã™ã‹ï¼Ÿ': {
    badge: 'ğŸ·ï¸ å®—æ•™',
    text: `ã¯ã„ã€ã‚‚ã¡ã‚ã‚“å¯¾å¿œã—ã¦ãŠã‚Šã¾ã™ ğŸ˜Š\n\nç„¡å®—æ•™ã®ã€Œè‡ªç”±è‘¬ã€ã‚„ã€ŒéŸ³æ¥½è‘¬ã€ãªã©ã‚‚æ‰¿ã£ã¦ãŠã‚Šã¾ã™ã€‚æ•…äººæ§˜ã®ç”Ÿå‰ã®ã”æ„å‘ã‚„ã€ã”å®¶æ—æ§˜ã®ã”å¸Œæœ›ã«åˆã‚ã›ã¦ã‚ªãƒªã‚¸ãƒŠãƒ«ã®ãŠåˆ¥ã‚Œã®å¼ã‚’ã”ææ¡ˆã„ãŸã—ã¾ã™ã€‚`
  },
  'ä»–å®—æ´¾ã§ã‚‚å¯¾å¿œã§ãã¾ã™ã‹ï¼Ÿ': {
    badge: 'ğŸ·ï¸ å®—æ´¾',
    text: `ã¯ã„ã€å„å®—æ´¾ãƒ»å®—æ•™ã«å¯¾å¿œã—ã¦ãŠã‚Šã¾ã™ã€‚\n\nãƒ»ä»å¼ï¼ˆæµ„åœŸå®—ãƒ»æµ„åœŸçœŸå®—ãƒ»è‡¨æ¸ˆå®—ãƒ»æ›¹æ´å®—ãªã©ï¼‰\nãƒ»ç¥å¼\nãƒ»ã‚­ãƒªã‚¹ãƒˆæ•™ï¼ˆã‚«ãƒˆãƒªãƒƒã‚¯ãƒ»ãƒ—ãƒ­ãƒ†ã‚¹ã‚¿ãƒ³ãƒˆï¼‰\nãƒ»ãã®ä»–å®—æ•™\n\nè©æå¯ºãŒãªã„å ´åˆã‚‚ã€ææºã®å¯ºé™¢ã‚’ã”ç´¹ä»‹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚`
  },
  'ã¯ãªç­’ãƒ»ç§˜åŒ£ã®é•ã„ã¯ï¼Ÿ': {
    badge: 'ğŸ·ï¸ éª¨å£·',
    text: `<strong>ã¯ãªç­’</strong>ï¼šèŠ±ã‚’ãƒ¢ãƒãƒ¼ãƒ•ã«ã—ãŸãƒ‡ã‚¶ã‚¤ãƒ³ã®éª¨å£·ã€‚è¯ã‚„ã‹ã§æ¸©ã‹ã¿ã®ã‚ã‚‹å°è±¡ã§ã™ã€‚\n\n<strong>ç§˜åŒ£ï¼ˆã²ã”ï¼‰</strong>ï¼šä¼çµ±çš„ãªãƒ‡ã‚¶ã‚¤ãƒ³ã®éª¨å£·ã€‚æ ¼å¼ãŒã‚ã‚Šè½ã¡ç€ã„ãŸå°è±¡ã§ã™ã€‚\n\nã©ã¡ã‚‰ã‚‚æ•…äººã‚’å²ã¶å¤§åˆ‡ãªå™¨ã§ã™ã€‚æ‹…å½“è€…ãŒã”èª¬æ˜ã„ãŸã—ã¾ã™ã€‚`
  },
  'å°ã•ãªå­ã©ã‚‚ã‚‚å‚åˆ—ã§ãã¾ã™ã‹ï¼Ÿ': {
    badge: 'ğŸ‘¶ ãŠå­æ§˜',
    text: `ã¯ã„ã€ã‚‚ã¡ã‚ã‚“ã§ã™ ğŸ˜Š\n\nå°ã•ãªãŠå­æ§˜ã§ã‚‚å®‰å¿ƒã—ã¦ã”å‚åˆ—ã„ãŸã ã‘ã¾ã™ã€‚å„ãƒ›ãƒ¼ãƒ«ã«ã¯<strong>ã‚­ãƒƒã‚ºã‚¹ãƒšãƒ¼ã‚¹</strong>ã‚’å®Œå‚™ã—ã¦ãŠã‚Šã€ãŠå­æ§˜ãŒå®‰å¿ƒã—ã¦éã”ã›ã‚‹ç’°å¢ƒã‚’æ•´ãˆã¦ãŠã‚Šã¾ã™ã€‚`
  },
  'ã‚­ãƒƒã‚ºã‚¹ãƒšãƒ¼ã‚¹ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ': {
    badge: 'ğŸ‘¶ è¨­å‚™',
    text: `ã¯ã„ã€ä»¥ä¸‹ã®ãƒ›ãƒ¼ãƒ«ã«ã‚­ãƒƒã‚ºã‚¹ãƒšãƒ¼ã‚¹ã‚’å®Œå‚™ã—ã¦ãŠã‚Šã¾ã™ï¼š\n\nğŸ›ï¸ ã‚„ã™ã‚‰ãä¼šé¤¨\nğŸŒ² ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆãƒ›ãƒ¼ãƒ«\nğŸŒº ã‚¢ã‚¤ãƒ•ã‚£ãƒƒãƒˆãƒ›ãƒ¼ãƒ«ã¤ã¤ã˜\n\nãŠå­æ§˜é€£ã‚Œã®ã”å®¶æ—ã‚‚å®‰å¿ƒã—ã¦ã”å‚åˆ—ã„ãŸã ã‘ã¾ã™ã€‚`
  },
  'æˆä¹³å®¤ãƒ»ãŠã‚€ã¤äº¤æ›ã¯ã§ãã¾ã™ã‹ï¼Ÿ': {
    badge: 'ğŸ‘¶ æˆä¹³å®¤',
    text: `æˆä¹³ã‚¹ãƒšãƒ¼ã‚¹ã‚„ãŠã‚€ã¤äº¤æ›å°ã‚’ã”ç”¨æ„ã—ã¦ãŠã‚Šã¾ã™ã€‚\n\näº‹å‰ã«ãŠç”³ã—ä»˜ã‘ã„ãŸã ã‘ã‚Œã°ã€ã‚¹ã‚¿ãƒƒãƒ•ãŒå¯¾å¿œã„ãŸã—ã¾ã™ã€‚ãŠæ°—è»½ã«ãŠç”³ã—ä»˜ã‘ãã ã•ã„ ğŸ˜Š`
  },
  'ãŠèŠ±ã‚’ãŸãã•ã‚“é£¾ã‚ŠãŸã„ã§ã™': {
    badge: 'ğŸŒ¸ æ¼”å‡º',
    text: `ã‚‚ã¡ã‚ã‚“ã”å¯¾å¿œã§ãã¾ã™ ğŸŒ¸\n\nã€ŒèŠ±ã‚³ãƒ¼ã‚¹ã€ã€Œé¦™ã‚³ãƒ¼ã‚¹ã€ã€Œè¼ã‚³ãƒ¼ã‚¹ã€ã§ã¯ãŠèŠ±ã‚’è±ªè¯ã«ã‚ã—ã‚‰ã£ãŸç¥­å£‡ã‚’ã”ç”¨æ„ã—ã¦ãŠã‚Šã¾ã™ã€‚\n\nã¾ãŸã€ãƒ•ãƒ©ãƒ¯ãƒ¼ã‚¢ãƒ¬ãƒ³ã‚¸ãƒ¡ãƒ³ãƒˆã®è¿½åŠ ã‚„æ£ºã®ä¸­ã«ãŠèŠ±ã‚’ã„ã£ã±ã„å…¥ã‚Œã‚‹ã€ŒèŠ±ã„ã£ã±ã„è‘¬ã€ã‚‚æ‰¿ã£ã¦ãŠã‚Šã¾ã™ã€‚æ‹…å½“è€…ã«ã”ç›¸è«‡ãã ã•ã„ã€‚`
  },
  'éŸ³æ¥½ã‚„æ˜ åƒã‚’æµã—ãŸã„ã§ã™': {
    badge: 'ğŸµ æ¼”å‡º',
    text: `ã¯ã„ã€æ‰¿ã£ã¦ãŠã‚Šã¾ã™ ğŸµ\n\nãƒ»æ•…äººæ§˜ã®ãŠæ°—ã«å…¥ã‚Šã®éŸ³æ¥½ã‚’å¼ä¸­ã«æµã™\nãƒ»æ€ã„å‡ºã®å†™çœŸãƒ»æ˜ åƒã‚’ã‚¹ãƒ©ã‚¤ãƒ‰ã‚·ãƒ§ãƒ¼ã§ä¸Šæ˜ ã™ã‚‹\nãƒ»ãƒ¡ãƒ¢ãƒªã‚¢ãƒ«DVDã®åˆ¶ä½œ\n\nã„ãšã‚Œã‚‚å¯¾å¿œå¯èƒ½ã§ã™ã€‚è©³ç´°ã¯æ‹…å½“è€…ã«ã”ç›¸è«‡ãã ã•ã„ã€‚`
  },
  'ãƒšãƒƒãƒˆã‚‚ä¸€ç·’ã«ãŠåˆ¥ã‚Œã—ãŸã„ã§ã™': {
    badge: 'ğŸ¾ ãƒšãƒƒãƒˆ',
    text: `æ•…äººæ§˜ã¨æ„›ã™ã‚‹ãƒšãƒƒãƒˆã®ãŠåˆ¥ã‚Œã«ã¤ã„ã¦ã‚‚æ‰¿ã£ã¦ãŠã‚Šã¾ã™ ğŸ¾\n\nãƒšãƒƒãƒˆã‚’é€£ã‚Œã¦ã®å‚åˆ—ã‚„ã€æ£ºã«ãƒšãƒƒãƒˆã®å†™çœŸã‚„é¦–è¼ªã‚’å…¥ã‚Œã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚ã”å¸Œæœ›ã®å†…å®¹ã‚’ãŠæ°—è»½ã«ã”ç›¸è«‡ãã ã•ã„ã€‚`
  },
  'å†™çœŸå…¥ã‚Šã®ä½ç‰Œã‚’ä½œã‚ŠãŸã„ã§ã™': {
    badge: 'ğŸ‹ ä½ç‰Œ',
    text: `ã¯ã„ã€å¯¾å¿œã—ã¦ãŠã‚Šã¾ã™ ğŸ“¸\n\næ•…äººæ§˜ã®ãŠå†™çœŸå…¥ã‚Šã®ä½ç‰Œã‚„ã€ãƒ¡ãƒ¢ãƒªã‚¢ãƒ«ãƒ‘ãƒãƒ«ã®ã”ç”¨æ„ã‚‚æ‰¿ã£ã¦ãŠã‚Šã¾ã™ã€‚\n\nã€Œé¦™ã‚³ãƒ¼ã‚¹ã€ã€Œè¼ã‚³ãƒ¼ã‚¹ã€ã«ã¯ãƒ¡ãƒ¢ãƒªã‚¢ãƒ«ãƒ‘ãƒãƒ«ãŒæ¨™æº–ã§å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚`
  },
  'æ„ŸæŸ“ç—‡ã§äº¡ããªã£ãŸå ´åˆã®å¯¾å¿œã¯ï¼Ÿ': {
    badge: 'ğŸ˜· æ„ŸæŸ“ç—‡',
    text: `æ„ŸæŸ“ç—‡ã§ãŠäº¡ããªã‚Šã«ãªã£ãŸå ´åˆã‚‚ã€å®‰å¿ƒã—ã¦ã”ç›¸è«‡ãã ã•ã„ã€‚\n\nãƒ»å°‚é–€ã‚¹ã‚¿ãƒƒãƒ•ã«ã‚ˆã‚‹é©åˆ‡ãªå‡¦ç½®\nãƒ»æ„ŸæŸ“å¯¾ç­–ã‚’æ–½ã—ãŸå®‰ç½®ãƒ»æ¬é€\nãƒ»å‚åˆ—è€…ã¸ã®æ„ŸæŸ“å¯¾ç­–ï¼ˆæ¶ˆæ¯’ãƒ»ãƒã‚¹ã‚¯ãƒ»æ›æ°—ç­‰ï¼‰\n\nã”éºæ—ã®å®‰å…¨ã‚’æœ€å„ªå…ˆã«ã€ä¸å¯§ã«å¯¾å¿œã„ãŸã—ã¾ã™ã€‚ğŸ“ 0120-315-312`
  },
  'å‚åˆ—è€…æ•°ã‚’åˆ¶é™ã—ãŸã„å ´åˆã¯ï¼Ÿ': {
    badge: 'ğŸ˜· åˆ¶é™',
    text: `å‚åˆ—è€…ã‚’é™å®šã—ãŸã„å ´åˆã‚‚å¯¾å¿œã—ã¦ãŠã‚Šã¾ã™ã€‚\n\nãƒ»<strong>å®¶æ—è‘¬ãƒ»1æ—¥è‘¬</strong>ã§å°‘äººæ•°ã®ãŠè¦‹é€ã‚Š\nãƒ»å…¥å ´äººæ•°ã®åˆ¶é™ãƒ»æ™‚é–“åˆ†æ•£\nãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å‚åˆ—ï¼ˆãƒªãƒ¢ãƒ¼ãƒˆè‘¬ï¼‰ã®ã”æ¡ˆå†…\n\nã”å¸Œæœ›ã«åˆã‚ã›ã¦æŸ”è»Ÿã«å¯¾å¿œã„ãŸã—ã¾ã™ã€‚`
  }
};

// FAQä½¿ç”¨æ¸ˆã¿ã‚»ãƒƒãƒˆ
const faqUsedSet = new Set();

// FAQãƒ‘ãƒãƒ«é–‹é–‰
function toggleFaq() {
  const body = document.getElementById('faqBody');
  const icon = document.getElementById('faqToggleIcon');
  const isOpen = body.classList.contains('open');
  if (isOpen) {
    body.classList.remove('open');
    icon.classList.remove('open');
  } else {
    body.classList.add('open');
    icon.classList.add('open');
  }
}

// FAQãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
function faqClick(btn, question) {
  if (btn.classList.contains('used')) return; // æ—¢ã«ä½¿ç”¨æ¸ˆã¿

  // ä½¿ç”¨æ¸ˆã¿ã«ã™ã‚‹
  btn.classList.add('used');
  btn.innerHTML = '<span class="faq-icon">âœ…</span>' + btn.textContent.trim();
  faqUsedSet.add(question);

  // ä½¿ç”¨ä»¶æ•°ãƒãƒƒã‚¸æ›´æ–°
  const badge = document.getElementById('faqUsedCount');
  badge.style.display = 'inline-block';
  badge.textContent = faqUsedSet.size + 'ä»¶ç™ºè¨€æ¸ˆ';

  // ãƒãƒ£ãƒƒãƒˆç”»é¢ãŒé–‹ã„ã¦ã„ãªã„å ´åˆã‚‚ãƒãƒ£ãƒƒãƒˆã«é€ã‚‹
  // FAQãƒ‘ãƒãƒ«ã‚’ä¸€åº¦é–‰ã˜ã‚‹
  const body = document.getElementById('faqBody');
  const icon = document.getElementById('faqToggleIcon');
  body.classList.remove('open');
  icon.classList.remove('open');

  // ãƒãƒ£ãƒƒãƒˆã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦é€ã‚‹
  sendFaqToChat(question);
}

// FAQã‚’ãƒãƒ£ãƒƒãƒˆã«é€ä¿¡
function sendFaqToChat(question) {
  if (chatState.isDone) {
    // ãƒãƒ£ãƒƒãƒˆå®Œäº†å¾Œã§ã‚‚è¿½è¨˜
    addUserMsg(question);
    chatState.log.push({ role: 'user', msg: question });
    state.chatLog = chatState.log.slice();
    // FAQå›ç­”ã‚’è¡¨ç¤º
    setTimeout(() => showFaqAnswer(question), 700);
    return;
  }

  // ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ä¸­æ–­ã—ã¦FAQé€ä¿¡
  const input = document.getElementById('chatInput');
  if(input) input.value = '';
  document.getElementById('quickReplies').style.display = 'none';
  document.getElementById('quickReplies').innerHTML = '';

  addUserMsg(question);
  chatState.log.push({ role: 'user', msg: question });
  state.chatLog = chatState.log.slice();

  // FAQå°‚ç”¨å›ç­”ã‚’è¿”ã™
  setTimeout(() => showFaqAnswer(question), 700);
}

// FAQå°‚ç”¨å›ç­”ãƒãƒ–ãƒ«ã‚’è¡¨ç¤º
function showFaqAnswer(question) {
  const msgs = document.getElementById('chatMessages');
  const answer = FAQ_ANSWERS[question];

  // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°è¡¨ç¤º
  const typing = document.createElement('div');
  typing.className = 'chat-msg bot';
  typing.id = 'faqTypingMsg';
  typing.innerHTML = `<div class="msg-avatar">ğŸ¤</div><div class="msg-bubble" style="background:#eee; color:#999;"><span class="typing-dots"><span></span><span></span><span></span></span> å›ç­”ã‚’æº–å‚™ä¸­...</div>`;
  msgs.appendChild(typing);
  msgs.scrollTop = msgs.scrollHeight;

  setTimeout(() => {
    const old = document.getElementById('faqTypingMsg');
    if(old) old.remove();

    if (answer) {
      // FAQå°‚ç”¨ãƒãƒ–ãƒ«
      const div = document.createElement('div');
      div.className = 'chat-msg bot';
      div.innerHTML = `<div class="msg-avatar">ğŸ¤</div>
        <div class="faq-answer-bubble">
          <div class="faq-answer-badge">${answer.badge}</div>
          <div>${answer.text.replace(/\n/g,'<br>')}</div>
          <div style="margin-top:8px; font-size:0.75rem; color:#8b6f47; border-top:1px solid #e8d9c0; padding-top:6px;">
            ğŸ’¬ ä»–ã«ã‚‚ã”è³ªå•ãŒã”ã–ã„ã¾ã—ãŸã‚‰ãŠæ°—è»½ã«ã©ã†ã
          </div>
        </div>`;
      msgs.appendChild(div);

      // botãƒ­ã‚°ã«ã‚‚è¿½åŠ 
      chatState.log.push({ role: 'bot', msg: answer.badge + ' ' + answer.text.replace(/<[^>]+>/g,'') });
    } else {
      addBotMsg('ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚\næ‹…å½“è€…ãŒè©³ã—ãã”èª¬æ˜ã„ãŸã—ã¾ã™ã€‚ãŠæ°—è»½ã«è¿½åŠ ã§ã”è³ªå•ãã ã•ã„ ğŸ™');
    }

    msgs.scrollTop = msgs.scrollHeight;

    // ãƒãƒ£ãƒƒãƒˆãŒå®Œäº†ã—ã¦ã„ãªã„å ´åˆã€æ¬¡ã®ãƒ•ãƒ­ãƒ¼ã¸ã®èª˜å°ã‚’è¡¨ç¤º
    if (!chatState.isDone) {
      setTimeout(() => {
        showChatFaqSuggest();
      }, 800);
    }
  }, 900);
}

// FAQå¾Œã®é–¢é€£è³ªå•ã‚µã‚¸ã‚§ã‚¹ãƒˆ
function showChatFaqSuggest() {
  const msgs = document.getElementById('chatMessages');
  const qr = document.getElementById('quickReplies');

  // æœªä½¿ç”¨ã®FAQã‚’æœ€å¤§3ä»¶ææ¡ˆ
  const allFaqs = Object.keys(FAQ_ANSWERS);
  const unused = allFaqs.filter(q => !faqUsedSet.has(q));
  const suggests = unused.slice(0, 3);

  if (suggests.length === 0) return;

  qr.innerHTML = '';
  qr.style.display = 'flex';

  // ã€Œä»–ã®è³ªå•ã‚’è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³
  const moreBtn = document.createElement('button');
  moreBtn.className = 'quick-reply-btn';
  moreBtn.textContent = 'ğŸ“‹ ä»–ã®è³ªå•ã‚’è¦‹ã‚‹';
  moreBtn.onclick = () => {
    const body = document.getElementById('faqBody');
    const icon = document.getElementById('faqToggleIcon');
    body.classList.add('open');
    icon.classList.add('open');
    qr.style.display = 'none';
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦FAQãƒ‘ãƒãƒ«ã¸
    document.getElementById('faqPanel').scrollIntoView({ behavior: 'smooth', block: 'start' });
  };
  qr.appendChild(moreBtn);

  // é–¢é€£è³ªå•ã‚µã‚¸ã‚§ã‚¹ãƒˆ
  suggests.forEach(q => {
    const btn = document.createElement('button');
    btn.className = 'quick-reply-btn';
    btn.textContent = q.length > 18 ? q.substring(0,16) + 'â€¦' : q;
    btn.title = q;
    btn.onclick = () => {
      qr.style.display = 'none';
      qr.innerHTML = '';
      // FAQãƒ‘ãƒãƒ«ã®ãƒœã‚¿ãƒ³ã‚‚ä½¿ç”¨æ¸ˆã¿ã«
      document.querySelectorAll('.faq-btn').forEach(fb => {
        if(fb.getAttribute('onclick') && fb.getAttribute('onclick').includes(q.replace(/'/g,"\'"))) {
          if(!fb.classList.contains('used')) {
            fb.classList.add('used');
            faqUsedSet.add(q);
            const badge = document.getElementById('faqUsedCount');
            badge.style.display = 'inline-block';
            badge.textContent = faqUsedSet.size + 'ä»¶ç™ºè¨€æ¸ˆ';
          }
        }
      });
      sendFaqToChat(q);
    };
    qr.appendChild(btn);
  });

  // å®Œäº†ãƒœã‚¿ãƒ³
  const doneBtn = document.createElement('button');
  doneBtn.className = 'quick-reply-btn';
  doneBtn.textContent = 'âœ… å®Œäº†ã™ã‚‹';
  doneBtn.onclick = () => {
    qr.style.display = 'none';
    processUserInput('å®Œäº†ã™ã‚‹');
  };
  qr.appendChild(doneBtn);
}


// ========== ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ ==========
const CHAT_FLOW = [
  {
    id: 'greeting',
    botMsg: 'ã“ã‚“ã«ã¡ã¯ ğŸ™\nã”è‘¬å„€ã«é–¢ã™ã‚‹ã”å¸Œæœ›ã‚„ã”ä¸å®‰ã‚’ã€ã©ã†ããŠæ°—è»½ã«ãŠèã‹ã›ãã ã•ã„ã€‚\n\nã¾ãšã€æ•…äººæ§˜ã®ãŠè¦‹é€ã‚Šã«ã¤ã„ã¦ã€ä½•ã‹ã”å¸Œæœ›ã¯ã”ã–ã„ã¾ã™ã‹ï¼Ÿ',
    quickReplies: ['ãŠèŠ±ã‚’å¤šãé£¾ã‚ŠãŸã„','éŸ³æ¥½ã‚’æµã—ãŸã„','è²»ç”¨ã‚’ã§ãã‚‹ã ã‘æŠ‘ãˆãŸã„','å®—æ•™çš„ãªã“ã¨ã‚’ç›¸è«‡ã—ãŸã„','ç‰¹ã«å¸Œæœ›ã¯ãªã„','ãã®ä»–'],
    nextId: 'concerns'
  },
  {
    id: 'concerns',
    botMsg: 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ ğŸŒ¸\næ¬¡ã«ã€ã”ä¸å®‰ãªç‚¹ã‚„ã”è³ªå•ã¯ã”ã–ã„ã¾ã™ã‹ï¼Ÿ\nã©ã‚“ãªäº›ç´°ãªã“ã¨ã§ã‚‚ã€é æ…®ãªããŠèã‹ã›ãã ã•ã„ã€‚',
    quickReplies: ['è²»ç”¨ãƒ»ãŠæ”¯æ‰•ã„ã«ã¤ã„ã¦','å®—æ•™ãƒ»å®—æ´¾ã«ã¤ã„ã¦','æ‰‹ç¶šããƒ»æ›¸é¡ã«ã¤ã„ã¦','åˆã‚ã¦ã§ä½•ã‚‚ã‚ã‹ã‚‰ãªã„','å‚åˆ—è€…ã¸ã®å¯¾å¿œ','ç‰¹ã«ä¸å®‰ã¯ãªã„'],
    nextId: 'free'
  },
  {
    id: 'free',
    botMsg: 'ã‹ã—ã“ã¾ã‚Šã¾ã—ãŸã€‚æ‹…å½“è€…ãŒå¿ƒã‚’è¾¼ã‚ã¦ã”å¯¾å¿œã„ãŸã—ã¾ã™ ğŸ•Šï¸\n\nä»–ã«ä½•ã‹ã”è¦æœ›ãƒ»ã”è³ªå•ã¯ã”ã–ã„ã¾ã™ã‹ï¼Ÿ\nï¼ˆãªã‘ã‚Œã°ã€Œå®Œäº†ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼‰',
    quickReplies: ['ä»–ã«ã‚‚ã‚ã‚‹','å®Œäº†ã™ã‚‹'],
    nextId: 'done'
  }
];

let chatState = {
  flowIndex: 0,
  isWaiting: false,
  isDone: false,
  log: []
};

function initChat() {
  const msgs = document.getElementById('chatMessages');
  if(!msgs) return;
  msgs.innerHTML = '';
  chatState = { flowIndex: 0, isWaiting: false, isDone: false, log: [] };
  document.getElementById('chatDoneBanner').classList.remove('show');
  document.getElementById('chatInput').disabled = false;
  document.getElementById('chatSendBtn').disabled = false;
  showTypingThenBot(CHAT_FLOW[0].botMsg, CHAT_FLOW[0].quickReplies);
}

function showTypingThenBot(message, quickReplies) {
  const msgs = document.getElementById('chatMessages');
  const qr = document.getElementById('quickReplies');
  qr.style.display = 'none';
  qr.innerHTML = '';

  // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
  const typing = document.createElement('div');
  typing.className = 'chat-msg bot';
  typing.id = 'typingMsg';
  typing.innerHTML = `<div class="msg-avatar">ğŸ¤</div><div class="msg-bubble" style="background:#eee; color:#999; font-style:italic;"><span class="typing-dots"><span></span><span></span><span></span></span> å…¥åŠ›ä¸­...</div>`;
  msgs.appendChild(typing);
  msgs.scrollTop = msgs.scrollHeight;

  setTimeout(() => {
    // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°å‰Šé™¤ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    const old = document.getElementById('typingMsg');
    if(old) old.remove();
    addBotMsg(message);
    // ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤è¡¨ç¤º
    if(quickReplies && quickReplies.length > 0) {
      qr.style.display = 'flex';
      quickReplies.forEach(r => {
        const btn = document.createElement('button');
        btn.className = 'quick-reply-btn';
        btn.textContent = r;
        btn.onclick = () => onQuickReply(r);
        qr.appendChild(btn);
      });
    }
  }, 800);
}

function addBotMsg(text) {
  const msgs = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'chat-msg bot';
  div.innerHTML = `<div class="msg-avatar">ğŸ¤</div><div class="msg-bubble">${text.replace(/\n/g,'<br>')}</div>`;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function addUserMsg(text) {
  const msgs = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'chat-msg user';
  div.innerHTML = `<div class="msg-bubble">${escHtml(text)}</div><div class="msg-avatar user-av">ğŸ‘¤</div>`;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function onQuickReply(text) {
  document.getElementById('quickReplies').style.display = 'none';
  document.getElementById('quickReplies').innerHTML = '';
  processUserInput(text);
}

function chatKeyDown(e) {
  if(e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendChatMessage();
  }
}

function sendChatMessage() {
  if(chatState.isDone) return;
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if(!text) return;
  input.value = '';
  document.getElementById('quickReplies').style.display = 'none';
  document.getElementById('quickReplies').innerHTML = '';
  processUserInput(text);
}

function processUserInput(text) {
  addUserMsg(text);
  chatState.log.push({ role: 'user', msg: text });
  state.chatLog = chatState.log.slice();

  const flow = CHAT_FLOW;
  const fi = chatState.flowIndex;

  // ã€Œå®Œäº†ã™ã‚‹ã€ã‚’é¸æŠ
  if(text === 'å®Œäº†ã™ã‚‹' || (fi >= flow.length)) {
    finishChat();
    return;
  }

  // æ¬¡ã®ãƒ•ãƒ­ãƒ¼ã¸
  const nextId = flow[fi]?.nextId;
  const nextFlow = flow.find(f => f.id === nextId);
  chatState.flowIndex = flow.indexOf(nextFlow);

  if(nextFlow) {
    if(nextFlow.id === 'done') {
      finishChat();
    } else if(text === 'ä»–ã«ã‚‚ã‚ã‚‹') {
      // ãƒ•ãƒªãƒ¼å…¥åŠ›ã‚’ç¶šã‘ã‚‹
      setTimeout(() => {
        addBotMsg('ã‚‚ã¡ã‚ã‚“ã§ã™ã€‚ä»–ã«ã‚‚ã”è‡ªç”±ã«ãŠèã‹ã›ãã ã•ã„ ğŸ˜Š');
      }, 600);
    } else {
      showTypingThenBot(nextFlow.botMsg, nextFlow.quickReplies);
    }
  } else {
    finishChat();
  }
}

function finishChat() {
  chatState.isDone = true;
  setTimeout(() => {
    addBotMsg('ã”å…¥åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ ğŸ™\næ‹…å½“è€…ãŒå†…å®¹ã‚’ç¢ºèªã—ã€å¿ƒã‚’è¾¼ã‚ã¦ã”å¯¾å¿œã„ãŸã—ã¾ã™ã€‚');
    document.getElementById('chatDoneBanner').classList.add('show');
    document.getElementById('chatInput').disabled = true;
    document.getElementById('chatSendBtn').disabled = true;
    document.getElementById('quickReplies').style.display = 'none';
    // stateã«ä¿å­˜
    state.chatLog = chatState.log.slice();
    state.wishes = chatState.log.filter(l=>l.role==='user').map(l=>l.msg).join(' / ');
  }, 700);
}

// ========== ã‚¹ãƒ†ãƒƒãƒ—é·ç§» ==========
function goToStep(n) {
  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  if(n > state.currentStep) {
    if(!validate(state.currentStep)) return;
  }
  
  // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’éè¡¨ç¤º
  document.getElementById('step' + state.currentStep).classList.remove('active');
  document.getElementById('dot' + state.currentStep).classList.remove('active');
  document.getElementById('dot' + state.currentStep).classList.add('done');
  if(state.currentStep > 1) {
    document.getElementById('con' + (state.currentStep-1)).classList.add('done');
  }
  
  state.currentStep = n;
  
  // æ–°ã—ã„ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡¨ç¤º
  document.getElementById('step' + n).classList.add('active');
  document.getElementById('dot' + n).classList.add('active');
  document.getElementById('dot' + n).classList.remove('done');
  
  // ã‚¹ãƒ†ãƒƒãƒ—å›ºæœ‰ã®åˆæœŸåŒ–
  if(n === 3) renderPlans();
  if(n === 4) renderHalls();
  if(n === 5) renderCourses();
  if(n === 6) { setTimeout(initChat, 100); }
  if(n === 7) renderEstimate();
  if(n === 8) renderFinalSummary();
  
  window.scrollTo(0, 0);
  autoSaveDebounced(); // è‡ªå‹•ä¿å­˜
}

// ========== ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ ==========
function validate(step) {
  if(step === 1) {
    let ok = true;
    const name = document.getElementById('name').value.trim();
    const relation = document.getElementById('relation').value;
    if(!name) { document.getElementById('nameError').style.display='block'; ok=false; }
    else { document.getElementById('nameError').style.display='none'; }
    if(!relation) { document.getElementById('relationError').style.display='block'; ok=false; }
    else { document.getElementById('relationError').style.display='none'; }
    if(ok) { state.name = name; state.relation = relation; state.phone = document.getElementById('phone').value.trim(); }
    return ok;
  }
  if(step === 2) {
    let ok = true;
    if(!state.attendance) { document.getElementById('attendanceError').style.display='block'; ok=false; }
    else document.getElementById('attendanceError').style.display='none';
    if(!state.funeralType) { document.getElementById('funeralTypeError').style.display='block'; ok=false; }
    else document.getElementById('funeralTypeError').style.display='none';
    return ok;
  }
  if(step === 3) {
    if(!state.selectedPlan) { document.getElementById('planError').style.display='block'; return false; }
    document.getElementById('planError').style.display='none'; return true;
  }
  if(step === 4) {
    if(!state.selectedHall) { document.getElementById('hallError').style.display='block'; return false; }
    document.getElementById('hallError').style.display='none'; return true;
  }
  if(step === 5) {
    if(!state.selectedCourse) { document.getElementById('courseError').style.display='block'; return false; }
    document.getElementById('courseError').style.display='none'; return true;
  }
  return true;
}

// ========== é¸æŠãƒãƒ³ãƒ‰ãƒ©ãƒ¼ ==========
function selectAttendance(btn, val) {
  document.querySelectorAll('#attendanceGroup .btn-choice').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  state.attendance = val;
  state.selectedPlan = null; state.selectedHall = null; state.selectedCourse = null;
  document.getElementById('attendanceError').style.display='none';
}

function selectFuneralType(btn, val) {
  document.querySelectorAll('#funeralTypeGroup .btn-choice').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  state.funeralType = val;
  state.selectedPlan = null; state.selectedHall = null; state.selectedCourse = null;
  document.getElementById('funeralTypeError').style.display='none';
}

function selectPlan(planId) {
  state.selectedPlan = currentPlans.find(p => p.id === planId) || null;
  document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('selected'));
  const card = document.getElementById('plan_'+planId);
  if(card) card.classList.add('selected');
  state.selectedHall = null; state.selectedCourse = null;
  document.getElementById('planError').style.display='none';
  // ãƒ›ãƒ¼ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
}

function selectHall(hallId) {
  state.selectedHall = HALLS[hallId] || null;
  document.querySelectorAll('.hall-card').forEach(c => c.classList.remove('selected'));
  const card = document.getElementById('hall_'+hallId);
  if(card) card.classList.add('selected');
  state.selectedCourse = null;
  document.getElementById('hallError').style.display='none';
}

function selectCourse(courseId) {
  state.selectedCourse = courseId;
  document.querySelectorAll('.course-card').forEach(c => c.classList.remove('selected'));
  const card = document.getElementById('course_'+courseId);
  if(card) card.classList.add('selected');
  document.getElementById('courseError').style.display='none';
}

function selectMember(btn, val) {
  document.querySelectorAll('#memberGroup .btn-choice').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  state.isMember = val;
}

// ========== ãƒ—ãƒ©ãƒ³æç”» ==========
let currentPlans = [];

function renderPlans() {
  const summary = document.getElementById('step3Summary');
  summary.textContent = `å‚åˆ—äºˆå®šï¼š${getAttendanceLabel(state.attendance)}ã€€è‘¬å„€å½¢å¼ï¼š${getFuneralTypeLabel(state.funeralType)}`;
  
  currentPlans = getPlans(state.attendance, state.funeralType);
  const container = document.getElementById('planCards');
  container.innerHTML = '';
  
  currentPlans.forEach(plan => {
    const badgeClass = plan.label === 'small' ? 'badge-small' : (plan.label === 'rec' ? 'badge-rec' : 'badge-large');
    const badgeText = plan.label === 'small' ? 'ğŸ”µ å°è¦æ¨¡' : (plan.label === 'rec' ? 'â­ ãŠã™ã™ã‚' : 'ğŸ”´ å¤§è¦æ¨¡');
    
    const card = document.createElement('div');
    card.className = 'plan-card' + (state.selectedPlan && state.selectedPlan.id === plan.id ? ' selected' : '');
    card.id = 'plan_' + plan.id;
    card.onclick = () => selectPlan(plan.id);
    card.innerHTML = `
      <div class="plan-card-badge ${badgeClass}">${badgeText} <span class="plan-type-tag tag-${plan.priceType}">${plan.sizeTag}</span></div>
      <div class="plan-card-body">
        <div class="plan-card-title">${plan.icon} ${plan.name}</div>
        <div class="plan-card-sub">å¯¾å¿œãƒ›ãƒ¼ãƒ«ï¼š${plan.halls.map(h=>HALLS[h]?.short||h).join('ãƒ»')}</div>
        <div class="plan-card-desc">${plan.desc}</div>
        <div style="margin-top:8px; font-size:0.8rem; color:#8b6f47;">
          ç›®å®‰ä¾¡æ ¼ï¼ˆä¼šå“¡ï¼‰ï¼š${formatPrice(getMinPrice(plan.priceType))}ã€œ
        </div>
      </div>
    `;
    container.appendChild(card);
  });
  
  if(!state.selectedPlan) document.getElementById('planError').style.display='none';
}

function getMinPrice(priceType) {
  // ç›´è‘¬ãƒ»ç«è‘¬å¼ã¯ single ã‚­ãƒ¼ã®ã¿
  if(priceType === 'chokuso' || priceType === 'kasou') {
    const pc = PRICING[priceType];
    return pc ? pc.single[0] : 148000;
  }
  const pc = PRICING[priceType] || PRICING.compact;
  return pc.ai[0];
}

// ========== ãƒ›ãƒ¼ãƒ«æç”» ==========
function renderHalls() {
  const summary = document.getElementById('step4Summary');
  const planName = state.selectedPlan ? state.selectedPlan.name : '';
  summary.textContent = `é¸æŠãƒ—ãƒ©ãƒ³ï¼š${planName}`;
  
  const { recommended, others } = getRecommendedHalls(state.attendance, state.funeralType, state.selectedPlan);
  state.showingAllHalls = false;
  
  const container = document.getElementById('hallCards');
  container.innerHTML = '';
  
  renderHallCards(recommended, container, true);
  
  const showAllBtn = document.getElementById('showAllHallsBtn');
  if(others.length > 0) {
    showAllBtn.style.display = 'block';
    showAllBtn._othersToAdd = others;
  } else {
    showAllBtn.style.display = 'none';
  }
  
  if(!state.selectedHall) document.getElementById('hallError').style.display='none';
}

function renderHallCards(hallIds, container, isRecommended) {
  hallIds.forEach(hallId => {
    const hall = HALLS[hallId];
    if(!hall) return;
    
    const card = document.createElement('div');
    card.className = 'hall-card hall-card-wrapper' + (state.selectedHall && state.selectedHall.id === hallId ? ' selected' : '');
    card.id = 'hall_' + hallId;
    card.onclick = () => selectHall(hallId);
    
    const badge = hall.badge ? `<span class="hall-recommended-badge">${hall.badge}</span>` : '';
    const livingBadge = hall.special === 'living' ? `<div class="living-badge">ğŸ¡ 1æ—¥1çµ„ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ</div>` : '';
    
    card.innerHTML = `
      <span class="hall-selected-check">âœ”</span>
      <img class="hall-card-img" src="${hall.image}" alt="${hall.name}" loading="lazy" onerror="this.style.background='#e0d5c8';this.style.height='110px';">
      ${badge}
      <div class="hall-card-body">
        <div class="hall-card-name">${hall.name}</div>
        ${livingBadge}
        <div class="hall-card-cap">${hall.capacity}</div>
        <div class="hall-card-addr">${hall.address}</div>
        <div class="hall-card-addr" style="color:#8b6f47; margin-top:2px;">${hall.special === 'chokuso' ? '' : 'ğŸšƒ '}${hall.access}</div>
        ${hall.url && hall.url !== 'https://saiki-sousai.com/' ? `<div style="margin-top:6px;"><a href="${hall.url}" target="_blank" onclick="event.stopPropagation();" style="font-size:0.78rem;color:#8b6f47;text-decoration:underline;">ğŸ”— è©³ç´°ãƒ»ãƒ—ãƒ©ãƒ³ã‚’è¦‹ã‚‹</a></div>` : ''}
      </div>
    `;
    container.appendChild(card);
  });
}

function showAllHalls() {
  const btn = document.getElementById('showAllHallsBtn');
  const others = btn._othersToAdd;
  const container = document.getElementById('hallCards');
  renderHallCards(others, container, false);
  btn.style.display = 'none';
}

// ========== ã‚³ãƒ¼ã‚¹æç”» ==========
function renderCourses() {
  const plan = state.selectedPlan;
  const hall = state.selectedHall;

  // ç›´è‘¬ãƒ»ç«è‘¬å¼ã¯ã‚³ãƒ¼ã‚¹é¸æŠä¸è¦
  if(plan && plan.isSimplePlan) {
    // â˜…ä¿®æ­£: DOMã«ä¾å­˜ã›ãšå…ˆã«stateã‚’ã‚»ãƒƒãƒˆï¼ˆvalidateé€šéã®ãŸã‚ï¼‰
    state.selectedCourse = 'single';
    const coursesContainer = document.getElementById('courseCards');
    if(coursesContainer) {
      coursesContainer.innerHTML = `
        <div style="background:#f0f8f0;border:2px solid #a8d8a8;border-radius:12px;padding:20px;text-align:center;">
          <div style="font-size:2rem;margin-bottom:8px;">ğŸ•Šï¸</div>
          <div style="font-weight:bold;color:#4a7c59;font-size:1.05rem;margin:8px 0;">ç¥­å£‡ã‚³ãƒ¼ã‚¹ã®é¸æŠã¯ä¸è¦ã§ã™</div>
          <div style="font-size:0.85rem;color:#666;line-height:1.6;">ç›´è‘¬ãƒ»ç«è‘¬å¼ãƒ—ãƒ©ãƒ³ã¯ç¥­å£‡ã‚³ãƒ¼ã‚¹ãŒã”ã–ã„ã¾ã›ã‚“ã€‚<br>ãã®ã¾ã¾ã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³ã§ãŠé€²ã¿ãã ã•ã„ã€‚</div>
        </div>`;
    }
    // step5ã‚¿ã‚¤ãƒˆãƒ«ã‚‚æ›´æ–°
    const step5Title = document.querySelector('#step5 .step-title');
    if(step5Title) step5Title.innerHTML = '<span class="step-num">5</span>ãƒ—ãƒ©ãƒ³ç¢ºèªï¼ˆã‚³ãƒ¼ã‚¹é¸æŠä¸è¦ï¼‰';
    // courseErrorã‚’éè¡¨ç¤ºã«ã™ã‚‹
    const errEl = document.getElementById('courseError');
    if(errEl) errEl.style.display = 'none';
    return;
  }
  // hall/plan æœªé¸æŠãƒã‚§ãƒƒã‚¯ï¼ˆæ—§ã‚³ãƒ¼ãƒ‰ã¨åŒç­‰ï¼‰
  if(!hall || !plan) return;
  
  // â˜…ä¿®æ­£v6: priceType ã‚’å…ˆã«ç¢ºå®šï¼ˆTDZã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
  // ãƒªãƒ“ãƒ³ã‚°å°‚ç”¨ãƒ›ãƒ¼ãƒ«ã¯ living å›ºå®šã€ãã‚Œä»¥å¤–ã¯ãƒ—ãƒ©ãƒ³ã® priceType ã‚’å„ªå…ˆ
  const isLiving = hall.special === 'living';
  const priceType = isLiving ? 'living' : (plan.priceType || hall.pricingType);
  const pricing = PRICING[priceType] || PRICING.compact;
  
  const summary = document.getElementById('step5Summary');
  const priceTypeLabel = {'compact':'ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆå®¶æ—è‘¬','living':'ãƒªãƒ“ãƒ³ã‚°è‘¬','family':'å®¶æ—è‘¬çš„ãªãŠè‘¬å¼','normal':'ä¸€èˆ¬è‘¬ï¼ãµã¤ã†ã®ãŠè‘¬å¼'};
  summary.textContent = `ãƒ›ãƒ¼ãƒ«ï¼š${hall.name}ã€€ãƒ—ãƒ©ãƒ³ï¼š${plan.name}ã€€ã€${priceTypeLabel[priceType] || priceType}ã€‘`;
  
  const courseIds = ['ai','hana','kaori','kaga'];
  const priceKeys = ['ai','hana','kaori','kaga'];
  
  const container = document.getElementById('courseCards');
  container.innerHTML = '';
  
  courseIds.forEach((cId, i) => {
    const course = COURSES[cId];
    const prices = pricing[priceKeys[i]];
    const memberPrice = prices[0];
    const normalPrice = prices[1];
    
    // ç”»åƒé¸æŠï¼šä¸€èˆ¬è‘¬ã¯ normal_ ç”»åƒã€ãƒªãƒ“ãƒ³ã‚°è‘¬ã¯ living_ ç”»åƒã€ãã‚Œä»¥å¤–ã¯å…±é€šç”»åƒ
    let imgSrc;
    if(isLiving) {
      imgSrc = IMG['living_'+cId] || IMG[cId];
    } else if(priceType === 'normal') {
      imgSrc = IMG['normal_'+cId] || IMG[cId];
    } else {
      imgSrc = IMG[cId];
    }
    
    const card = document.createElement('div');
    card.className = 'course-card' + (state.selectedCourse === cId ? ' selected' : '');
    card.id = 'course_' + cId;
    card.onclick = () => selectCourse(cId);
    card.innerHTML = `
      <img class="course-card-img" src="${imgSrc}" alt="${course.name}ç¥­å£‡" loading="lazy" onerror="this.style.background='#f5e6d0';this.style.height='130px';">
      <div class="course-card-body" style="background:${course.color};">
        <div class="course-card-name">âš˜ ${course.name}</div>
        <div class="course-card-price">
          ä¼šå“¡ <span class="member-price">${formatPrice(memberPrice)}</span><br>
          <span style="font-size:0.75rem;">ä¸€èˆ¬ ${formatPrice(normalPrice)}</span>
        </div>
        <div class="course-card-desc">${course.desc}</div>
      </div>
      <div class="course-selected-mark">âœ” é¸æŠä¸­</div>
    `;
    container.appendChild(card);
  });
  
  if(!state.selectedCourse) document.getElementById('courseError').style.display='none';
}

// ========== è¦‹ç©ã‚‚ã‚Šæç”» ==========
function renderEstimate() {
  const hall = state.selectedHall;
  const plan = state.selectedPlan;
  const course = state.selectedCourse;
  
  if(!hall || !plan || !course) return;
  
  // â˜…ä¿®æ­£: ãƒªãƒ“ãƒ³ã‚°å°‚ç”¨ãƒ›ãƒ¼ãƒ«ã¯ living å›ºå®šã€ãã‚Œä»¥å¤–ã¯ãƒ—ãƒ©ãƒ³ã® priceType ã‚’å„ªå…ˆ
  const priceType = (hall.special === 'living') ? 'living' : (plan.priceType || hall.pricingType);
  const pricing = PRICING[priceType] || PRICING.compact;
  
  // â˜…ç›´è‘¬ãƒ»ç«è‘¬å¼ãƒ—ãƒ©ãƒ³ï¼ˆisSimplePlanï¼‰ã®å ´åˆã¯ single ã‚­ãƒ¼ã§ä¾¡æ ¼å–å¾—
  let prices;
  if(plan.isSimplePlan || course === 'single') {
    const simplePricing = PRICING[priceType] || PRICING.chokuso;
    prices = simplePricing ? simplePricing.single : [198000, 248000];
  } else {
    const priceKey = course;
    if(!pricing[priceKey]) {
      console.error('[v8] renderEstimate: pricing not found for course=', priceKey, 'priceType=', priceType);
      document.getElementById('estimateCard').innerHTML = '<div style="color:red;padding:12px;">âš ï¸ ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã€‚ãŠæ‰‹æ•°ã§ã™ãŒæœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚</div>';
      return;
    }
    prices = pricing[priceKey];
  }
  const isMember = state.isMember === 'yes' || state.isMember === 'join';
  const basePrice = isMember ? prices[0] : prices[1];
  
  // â˜…v10ä¿®æ­£: ãŠã‚‚ã¦ãªã—è²»ãƒ»ã‚ªãƒ—ã‚·ãƒ§ãƒ³è²»ã¯ã€Œã‚³ãƒ¼ã‚¹æ–™é‡‘ã«åŠ ç®—ã€ã™ã‚‹åˆ¥è²»ç”¨
  // å‚åˆ—è€…æ•°ã«å¿œã˜ãŸãŠã‚‚ã¦ãªã—ç›®å®‰ã‚’è¨­å®š
  // ç›´è‘¬ãƒ»ç«è‘¬å¼ã®å ´åˆã¯ãŠã‚‚ã¦ãªã—è²»ãªã—ã€æ¬é€è²»ã®ã¿
  const isSimple = plan.isSimplePlan || course === 'single';
  const attendanceHospitality = {
    'under5':   100000,
    'under15':  150000,
    '15to30':   250000,
    '30to50':   400000,
    'over50':   600000
  };
  const hospitalityEstimate = isSimple ? 30000 : (attendanceHospitality[state.attendance] || 200000);
  const optionEstimate = isSimple ? 0 : 200000; // ç›´è‘¬ã¯è¿½åŠ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãªã—
  const totalEstimate = basePrice + hospitalityEstimate;
  
  const courseInfo = COURSES[course];
  const relationLabel = getRelationLabel(state.relation);
  const memberNote = state.isMember === 'yes' ? 'ï¼ˆä¼šå“¡ä¾¡æ ¼é©ç”¨ï¼‰' : state.isMember === 'join' ? 'ï¼ˆå½“æ—¥ä¼šå“¡å…¥ä¼šãƒ»30%å‰²å¼•äºˆå®šï¼‰' : state.isMember === 'unknown' ? 'ï¼ˆä¼šå“¡ç¢ºèªè¦ï¼‰' : 'ï¼ˆä¸€èˆ¬ä¾¡æ ¼ï¼‰';
  
  const card = document.getElementById('estimateCard');
  card.innerHTML = `
    <div class="estimate-section-title">ğŸ“‹ ãŠå®¢æ§˜æƒ…å ±</div>
    <div class="estimate-row"><span class="estimate-label">ãŠå®¢æ§˜ã®ãŠåå‰</span><span class="estimate-value">${escHtml(state.name)} æ§˜</span></div>
    <div class="estimate-row"><span class="estimate-label">æ•…äººã¨ã®é–¢ä¿‚</span><span class="estimate-value">${relationLabel}</span></div>
    <div class="estimate-row"><span class="estimate-label">å‚åˆ—äºˆå®šäººæ•°</span><span class="estimate-value">${getAttendanceLabel(state.attendance)}</span></div>
    <div class="estimate-row"><span class="estimate-label">è‘¬å„€å½¢å¼</span><span class="estimate-value">${getFuneralTypeLabel(state.funeralType)}</span></div>
    
    <div class="estimate-section-title" style="margin-top:14px">ğŸ›ï¸ é¸æŠå†…å®¹</div>
    <div class="estimate-row"><span class="estimate-label">ãƒ—ãƒ©ãƒ³</span><span class="estimate-value">${escHtml(plan.name)}</span></div>
    <div class="estimate-row"><span class="estimate-label">ãƒ›ãƒ¼ãƒ«</span><span class="estimate-value">${escHtml(hall.name)}</span></div>
    <div class="estimate-row"><span class="estimate-label">ç¥­å£‡ã‚³ãƒ¼ã‚¹</span><span class="estimate-value">âš˜ ${courseInfo.name}</span></div>
    <div class="estimate-row"><span class="estimate-label" style="color:#888;font-size:0.78rem;">ä¾¡æ ¼ç¨®åˆ¥</span><span class="estimate-value" style="font-size:0.78rem;color:#8b6f47;">${{'compact':'ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆå®¶æ—è‘¬','living':'ãƒªãƒ“ãƒ³ã‚°è‘¬','family':'å®¶æ—è‘¬çš„ãªãŠè‘¬å¼','normal':'ä¸€èˆ¬è‘¬ï¼ãµã¤ã†ã®ãŠè‘¬å¼'}[priceType] || priceType}</span></div>
    <div class="estimate-row"><span class="estimate-label">ãƒ›ãƒ¼ãƒ«ä½æ‰€</span><span class="estimate-value" style="font-size:0.78rem;">${hall.address}</span></div>
    <div class="estimate-row"><span class="estimate-label">ã‚¢ã‚¯ã‚»ã‚¹</span><span class="estimate-value" style="font-size:0.78rem;">${hall.access}</span></div>
    
    <div class="estimate-section-title" style="margin-top:14px">ğŸ’° è²»ç”¨ç›®å®‰</div>
    <div class="estimate-row">
      <span class="estimate-label">${isSimple ? 'ç›´è‘¬ãƒ»ç«è‘¬è²»ç”¨' : 'è‘¬å„€åŸºæœ¬ã‚»ãƒƒãƒˆ'}</span>
      <span class="estimate-value">${formatPrice(basePrice)}</span>
    </div>
    <div class="estimate-row" style="font-size:0.8rem;color:#888;">
      <span class="estimate-label">${isSimple ? 'â”” æ¬é€ãƒ»å®‰ç½®ãƒ»ç«è‘¬ç«‹ä¼šç­‰' : 'â”” ç¥­å£‡ãƒ»æ£ºãƒ»æ¬é€ãƒ»éºå½±ç­‰'}</span>
      <span class="estimate-value">ï¼ˆ${isSimple ? 'ãƒ—ãƒ©ãƒ³æ–™é‡‘' : 'ã‚³ãƒ¼ã‚¹æ–™é‡‘'}ï¼‰</span>
    </div>
    <div class="estimate-row">
      <span class="estimate-label">${isSimple ? 'æ¬é€è²»ç›®å®‰' : 'ãŠã‚‚ã¦ãªã—è²»ç”¨ï¼ˆç›®å®‰ï¼‰'}</span>
      <span class="estimate-value">${formatPrice(hospitalityEstimate)}</span>
    </div>
    <div class="estimate-row" style="font-size:0.8rem;color:#888;">
      <span class="estimate-label">${isSimple ? 'â”” ã”éºä½“æ¬é€ãƒ»ãƒ‰ãƒ©ã‚¤ã‚¢ã‚¤ã‚¹ç­‰' : 'â”” è¿”ç¤¼å“ãƒ»é£Ÿäº‹ãƒ»ä¼šé¤¨ä½¿ç”¨æ–™ç­‰'}</span>
      <span class="estimate-value">${isSimple ? '' : 'ï¼ˆå‚åˆ—è€…æ•°ã«ã‚ˆã‚Šå¤‰å‹•ï¼‰'}</span>
    </div>
    <div class="estimate-total">
      <div class="estimate-total-label">ç·åˆè¨ˆï¼ˆç›®å®‰ï¼‰${memberNote}</div>
      <div class="estimate-total-price">${formatPrice(totalEstimate)}</div>
      <div class="estimate-total-note">â€»ãŠã‚‚ã¦ãªã—è²»ç”¨ã¯å‚åˆ—è€…æ•°ã«ã‚ˆã‚Šå¤‰å‹•ã—ã¾ã™ã€‚è©³ç´°ã¯æ‹…å½“è€…ã«ã”ç¢ºèªãã ã•ã„</div>
    </div>
    
    <div style="margin-top:16px;padding:14px 16px;background:#fff5f5;border:2.5px solid #e53935;border-radius:10px;position:relative;">      <div style="position:absolute;top:-11px;left:14px;background:#e53935;color:#fff;font-size:0.72rem;font-weight:bold;padding:2px 10px;border-radius:20px;letter-spacing:0.05em;">âš ï¸ ã”ç¢ºèªãã ã•ã„</div>      <p style="margin:6px 0 0 0;font-size:0.88rem;font-weight:bold;color:#c62828;line-height:1.7;">        ã‚ãã¾ã§ã“ã¡ã‚‰ã®é‡‘é¡ã¯<u>ç›®å®‰</u>ã§ã€ã—ã£ã‹ã‚Šã€ŒãŠè¦‹é€ã‚Šäºˆç®—ã€ã‚’åŠ ãˆãŸå ´åˆã®æ•°å­—ã§ã™ã€‚<br>        é¸ã¶ã®ã¯ãŠå®¢æ§˜ã§ã™ã®ã§<strong>ä¸è¦ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯å‰Šé™¤å¯èƒ½</strong>ã§ã™ã€‚<br>        <span style="font-size:0.85rem;color:#e53935;">ã”å®‰å¿ƒãã ã•ã„ï¼</span>      </p>    </div>
    
    ${!isSimple ? `
    <div style="margin-top:12px; padding:10px 12px; background:#fdf6ec; border:1px dashed #d4a76a; border-radius:8px;">
      <div style="font-size:0.82rem; font-weight:bold; color:#8b6f47; margin-bottom:4px;">ğŸ’¡ ã‚ˆãã‚ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç›®å®‰ï¼ˆå‚è€ƒï¼‰</div>
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span style="font-size:0.82rem; color:#666;">â”” ç”ŸèŠ±ãƒ»æ–™ç†ãƒ»ãƒã‚¹ã‚¿ã‚¯ã‚·ãƒ¼ç­‰</span>
        <span style="font-size:0.88rem; font-weight:bold; color:#8b6f47;">${formatPrice(optionEstimate)} å‰å¾Œ</span>
      </div>
      <div style="font-size:0.75rem; color:#aaa; margin-top:4px;">â€»ã”å¸Œæœ›ã®å†…å®¹ã«ã‚ˆã‚Šå¤‰å‹•ã—ã¾ã™ã€‚ä¸Šè¨˜åˆè¨ˆã«ã¯å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>
    </div>` : ''}
  `;
}

// ========== å®Œäº†ç”»é¢ ==========
function renderFinalSummary() {
  // chatLogã‹ã‚‰è¦æœ›ãƒ»ä¸å®‰ã‚’ã¾ã¨ã‚ã‚‹
  if(chatState.log.length > 0) {
    state.wishes = chatState.log.filter(l=>l.role==='user').map(l=>l.msg).join(' ï¼ ');
  }
  
  const summary = document.getElementById('finalSummary');
  const hall = state.selectedHall;
  const plan = state.selectedPlan;
  const course = state.selectedCourse;
  const courseInfo = COURSES[course] || {};

  // è¦‹ç©ã‚‚ã‚Šä¾¡æ ¼å†è¨ˆç®— (v10: ç›´è‘¬ãƒ»ç«è‘¬å¼å¯¾å¿œ)
  const priceType = hall ? ((hall.special === 'living') ? 'living' : (plan?.priceType || hall.pricingType)) : 'compact';
  const pricing = PRICING[priceType] || PRICING.compact;
  // ç›´è‘¬ãƒ»ç«è‘¬å¼ã¯ single ã‚­ãƒ¼
  let prices;
  if(priceType === 'chokuso' || priceType === 'kasou') {
    prices = PRICING[priceType] ? PRICING[priceType].single : [198000, 248000];
  } else {
    prices = course ? (pricing[course] || (() => { console.error('[v10] ã‚³ãƒ¼ã‚¹ã‚­ãƒ¼æœªç™ºè¦‹:', course, 'priceType:', priceType); return pricing.kaga || pricing.ai; })()) : pricing.ai;
  }
  const isMember = state.isMember === 'yes' || state.isMember === 'join';
  const basePrice = isMember ? prices[0] : prices[1];
  const memberNote = state.isMember === 'yes' ? 'ï¼ˆä¼šå“¡ä¾¡æ ¼ 35%å‰²å¼•ï¼‰'
    : state.isMember === 'join' ? 'ï¼ˆå½“æ—¥å…¥ä¼š 30%å‰²å¼•ï¼‰'
    : state.isMember === 'unknown' ? 'ï¼ˆä¼šå“¡ç¢ºèªè¦ï¼‰' : 'ï¼ˆä¸€èˆ¬ä¾¡æ ¼ï¼‰';
  
  summary.innerHTML = `
    <strong style="color:#5c3d2e; display:block; margin-bottom:10px; font-size:0.95rem; border-bottom:2px solid #d4a76a; padding-bottom:6px;">ğŸ“‹ ã”è‘¬å„€ ç¢ºèªå†…å®¹ã‚µãƒãƒªãƒ¼</strong>
    <table style="width:100%; border-collapse:collapse; font-size:0.86rem; line-height:1.9;">
      <tr><td style="color:#888; width:42%; padding:3px 0;">ğŸ‘¤ ãŠå®¢æ§˜ã®ãŠåå‰</td><td><strong>${escHtml(state.name)}</strong> æ§˜</td></tr>
      <tr><td style="color:#888;">ğŸ”— æ•…äººã¨ã®é–¢ä¿‚</td><td>${getRelationLabel(state.relation)}</td></tr>
      <tr><td style="color:#888;">ğŸ“ ãŠé›»è©±ç•ªå·</td><td>${escHtml(state.phone) || 'æœªå…¥åŠ›'}</td></tr>
      <tr><td style="color:#888;">ğŸ‘¥ å‚åˆ—äºˆå®šäººæ•°</td><td><strong>${getAttendanceLabel(state.attendance)}</strong></td></tr>
      <tr><td style="color:#888;">âš˜ è‘¬å„€å½¢å¼</td><td><strong>${getFuneralTypeLabel(state.funeralType)}</strong></td></tr>
      <tr><td colspan="2" style="padding-top:8px; border-top:1px solid #e0d5c8;"></td></tr>
      <tr><td style="color:#888;">ğŸ“‹ é¸æŠãƒ—ãƒ©ãƒ³</td><td><strong>${escHtml(plan?.name||'')}</strong></td></tr>
      <tr><td style="color:#888;">ğŸ›ï¸ å¼å ´ãƒ›ãƒ¼ãƒ«</td><td><strong>${escHtml(hall?.name||'')}</strong></td></tr>
      <tr><td style="color:#888;">ğŸ“ ä½æ‰€</td><td style="font-size:0.78rem;">${hall?.address||''}</td></tr>
      <tr><td style="color:#888;">ğŸšƒ ã‚¢ã‚¯ã‚»ã‚¹</td><td style="font-size:0.78rem;">${hall?.access||''}</td></tr>
      <tr><td style="color:#888;">ğŸ‹ ç¥­å£‡ã‚³ãƒ¼ã‚¹</td><td><strong>${courseInfo.name||''}</strong></td></tr>
      <tr><td colspan="2" style="padding-top:8px; border-top:1px solid #e0d5c8;"></td></tr>
      <tr><td style="color:#888;">ğŸ’³ ä¼šå“¡åŒºåˆ†</td><td>${getMemberLabel(state.isMember)}</td></tr>
      <tr><td style="color:#888;">ğŸ’° è²»ç”¨ç›®å®‰</td><td><strong style="color:#5c3d2e; font-size:1rem;">${formatPrice(basePrice)}</strong> ${memberNote}</td></tr>
    </table>
  `;

  // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’PDFç”¨ã«æç”»
  renderPrintChatLog();
}

function renderPrintChatLog() {
  const log = chatState.log;
  const container = document.getElementById('printChatMessages');
  const section = document.getElementById('printChatLog');
  if(!container) return;
  container.innerHTML = '';

  if(!log || log.length === 0) {
    section.style.display = 'none';
    return;
  }

  // ãƒœãƒƒãƒˆã®æœ€åˆã®ç™ºè¨€ã‚’å…ˆé ­ã«è¿½åŠ 
  const firstBot = { role: 'bot', msg: 'ã“ã‚“ã«ã¡ã¯ ğŸ™\nã”è‘¬å„€ã«é–¢ã™ã‚‹ã”å¸Œæœ›ã‚„ã”ä¸å®‰ã‚’ã€ã©ã†ããŠæ°—è»½ã«ãŠèã‹ã›ãã ã•ã„ã€‚\nã¾ãšã€æ•…äººæ§˜ã®ãŠè¦‹é€ã‚Šã«ã¤ã„ã¦ã€ä½•ã‹ã”å¸Œæœ›ã¯ã”ã–ã„ã¾ã™ã‹ï¼Ÿ' };
  const fullLog = [firstBot, ...log];

  fullLog.forEach((entry, idx) => {
    const isBot = entry.role === 'bot';
    const row = document.createElement('div');
    row.className = 'pdf-chat-row' + (isBot ? '' : ' user-row');

    const label = document.createElement('div');
    label.className = 'pdf-chat-label';
    label.textContent = isBot ? 'ğŸ¤ æ‹…å½“' : 'ğŸ‘¤ ãŠå®¢æ§˜';

    const bubbleWrap = document.createElement('div');
    bubbleWrap.style.display = 'flex'; bubbleWrap.style.flexDirection = 'column';
    bubbleWrap.style.maxWidth = '82%';

    const bubble = document.createElement('div');
    bubble.className = isBot ? 'pdf-chat-bubble-bot' : 'pdf-chat-bubble-user';
    bubble.innerHTML = escHtml(entry.msg).replace(/\n/g, '<br>');

    bubbleWrap.appendChild(bubble);
    if(isBot) { row.appendChild(label); row.appendChild(bubbleWrap); }
    else       { row.appendChild(bubbleWrap); row.appendChild(label); }
    container.appendChild(row);
  });

  // ãƒœãƒƒãƒˆã®çµã³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  const closingRow = document.createElement('div');
  closingRow.className = 'pdf-chat-row';
  const closingLabel = document.createElement('div');
  closingLabel.className = 'pdf-chat-label'; closingLabel.textContent = 'ğŸ¤ æ‹…å½“';
  const closingBubble = document.createElement('div');
  closingBubble.className = 'pdf-chat-bubble-bot';
  closingBubble.innerHTML = 'ã”å…¥åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ ğŸ™<br>æ‹…å½“è€…ãŒå†…å®¹ã‚’ç¢ºèªã—ã€å¿ƒã‚’è¾¼ã‚ã¦ã”å¯¾å¿œã„ãŸã—ã¾ã™ã€‚';
  closingRow.appendChild(closingLabel); closingRow.appendChild(closingBubble);
  container.appendChild(closingRow);

  section.style.display = 'block';
}

// ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==========
function formatPrice(n) {
  return 'ï¿¥' + n.toLocaleString('ja-JP');
}

function escHtml(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function getAttendanceLabel(v) {
  const m = {under5:'5åä»¥ä¸‹',under15:'15åä»¥ä¸‹','15to30':'15ã€œ30å','30to50':'30ã€œ50å',over50:'50åä»¥ä¸Š'};
  return m[v] || v;
}

function getFuneralTypeLabel(v) {
  const m = {family:'å®¶æ—è‘¬',family_friends:'å®¶æ—è‘¬ï¼ˆå‹äººå°‘æ•°å‚åŠ ï¼‰',general:'ä¸€èˆ¬è‘¬',general_company:'ä¸€èˆ¬è‘¬ï¼ˆä¼šç¤¾ãƒ»å›£ä½“ï¼‰',chokuso:'ç›´è‘¬ãƒ»ç«è‘¬å¼',kasouonly:'ç«è‘¬ã®ã¿'};
  return m[v] || v;
}

function getRelationLabel(v) {
  const m = {spouse:'é…å¶è€…',parent:'è¦ªï¼ˆçˆ¶ãƒ»æ¯ï¼‰',child:'å­ã©ã‚‚',sibling:'å…„å¼Ÿãƒ»å§‰å¦¹',grandparent:'ç¥–çˆ¶ãƒ»ç¥–æ¯',inlaw:'ç¾©ç†ã®è¦ª',relative:'ãã®ä»–è¦ªæ—',other:'ãã®ä»–'};
  return m[v] || v;
}

function getMemberLabel(v) {
  const m = {yes:'ä¼šå“¡ï¼ˆ35%å‰²å¼•é©ç”¨ï¼‰',join:'å½“æ—¥ä¼šå“¡å…¥ä¼šå¸Œæœ›ï¼ˆ30%å‰²å¼•ï¼‰',no:'éä¼šå“¡ï¼ˆä¸€èˆ¬ä¾¡æ ¼ï¼‰',unknown:'ä¸æ˜ï¼ˆè¦ç¢ºèªï¼‰'};
  return m[v] || 'æœªå›ç­”';
}


// ============================================================
// ===== é€ä¿¡å‡¦ç†ï¼ˆEmailJS + Google Apps Scriptï¼‰=====
// ============================================================

// â–¼â–¼â–¼ è¨­å®šç®‡æ‰€ â–¼â–¼â–¼ -----------------------------------------------
// ã€EmailJSè¨­å®šæ‰‹é †ã€‘
// 1. https://www.emailjs.com/ ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆï¼ˆç„¡æ–™ãƒ—ãƒ©ãƒ³ã‚ã‚Šï¼‰
// 2. ã€ŒAdd New Serviceã€ã§Gmailç­‰ã‚’é€£æº â†’ Service IDã‚’ã‚³ãƒ”ãƒ¼
// 3. ã€ŒEmail Templatesã€ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ â†’ Template IDã‚’ã‚³ãƒ”ãƒ¼
// 4. ã€ŒAccount > API Keysã€ã§Public Keyã‚’ã‚³ãƒ”ãƒ¼
// 5. ä¸‹è¨˜3è¡Œã«è²¼ã‚Šä»˜ã‘ã‚‹ã ã‘ã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ï¼
const EMAILJS_SERVICE_ID  = 'YOUR_SERVICE_ID';   // â† æ‰‹é †2ã®Service ID
const EMAILJS_TEMPLATE_ID = 'YOUR_TEMPLATE_ID';  // â† æ‰‹é †3ã®Template ID
const EMAILJS_PUBLIC_KEY  = 'YOUR_PUBLIC_KEY';   // â† æ‰‹é †4ã®Public Key
const EMAILJS_TO_EMAIL    = 'info@saiki-sousai.com'; // â† é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ï¼ˆè¨­å®šæ¸ˆï¼‰

// ã€GASè¨­å®šï¼šã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã—ãŸã„å ´åˆã®ã¿ï¼ˆçœç•¥å¯ï¼‰ã€‘
// 1. Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ
// 2. æ‹¡å¼µæ©Ÿèƒ½ > Apps Script ã§GASã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤
// 3. ãƒ‡ãƒ—ãƒ­ã‚¤ã§å–å¾—ã—ãŸURLã‚’ä¸‹è¨˜ã«è²¼ã‚Šä»˜ã‘
const GAS_WEBHOOK_URL = 'YOUR_GAS_WEBHOOK_URL';  // â† GAS Webã‚¢ãƒ—ãƒªã®URLï¼ˆçœç•¥å¯ï¼‰
// â–²â–²â–² è¨­å®šç®‡æ‰€ã“ã“ã¾ã§ â–²â–²â–² ----------------------------------------

function submitAndComplete() {
  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆSTEP 7 é€šéãƒã‚§ãƒƒã‚¯ï¼‰
  if(!state.selectedHall || !state.selectedCourse) {
    alert('å¼å ´ãƒ»ç¥­å£‡ã‚³ãƒ¼ã‚¹ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å‰ã®æ‰‹é †ã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
    return;
  }

  // é€ä¿¡ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–
  const btn = document.getElementById('submitBtn');
  if(btn) btn.disabled = true;

  // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º
  document.getElementById('submitOverlay').classList.add('show');

  // é€ä¿¡ãƒ‡ãƒ¼ã‚¿ä½œæˆ
  const hall = state.selectedHall;
  const plan = state.selectedPlan;
  const course = state.selectedCourse;
  const courseInfo = COURSES[course] || {};
  const priceType = hall ? ((hall.special === 'living') ? 'living' : (plan?.priceType || hall.pricingType)) : 'compact';
  const pricing   = PRICING[priceType] || PRICING.compact;
  // â˜…v10ä¿®æ­£: ç›´è‘¬ãƒ»ç«è‘¬å¼å¯¾å¿œã€‚é¸æŠã‚³ãƒ¼ã‚¹ã‚­ãƒ¼ã§æ­£ç¢ºã«å‚ç…§
  let prices;
  if(priceType === 'chokuso' || priceType === 'kasou') {
    prices = PRICING[priceType] ? PRICING[priceType].single : [198000, 248000];
  } else {
    prices = course ? (pricing[course] || (() => { console.error('[v10] submitAndComplete ã‚³ãƒ¼ã‚¹ã‚­ãƒ¼æœªç™ºè¦‹:', course); return pricing.kaga || pricing.ai; })()) : pricing.ai;
  }
  const isMember  = state.isMember === 'yes' || state.isMember === 'join';
  const basePrice = isMember ? prices[0] : prices[1];

  const chatLog = chatState.log
    .map(l => (l.role === 'bot' ? '[æ‹…å½“AI] ' : '[ãŠå®¢æ§˜] ') + l.msg)
    .join('\n');

  const now = new Date();
  const dateStr = now.getFullYear() + '/' +
    String(now.getMonth()+1).padStart(2,'0') + '/' +
    String(now.getDate()).padStart(2,'0') + ' ' +
    String(now.getHours()).padStart(2,'0') + ':' +
    String(now.getMinutes()).padStart(2,'0');

  const payload = {
    submitted_at:    dateStr,
    name:            state.name,
    relation:        getRelationLabel(state.relation),
    phone:           state.phone || 'æœªå…¥åŠ›',
    attendance:      getAttendanceLabel(state.attendance),
    funeral_type:    getFuneralTypeLabel(state.funeralType),
    plan_name:       plan?.name || '',
    hall_name:       hall?.name || '',
    hall_address:    hall?.address || '',
    hall_access:     hall?.access || '',
    course_name:     courseInfo.name || '',
    member_status:   getMemberLabel(state.isMember),
    price_estimate:  formatPrice(basePrice),
    price_type:      priceType,
    wishes:          state.wishes || 'ï¼ˆãªã—ï¼‰',
    chat_log:        chatLog || 'ï¼ˆãªã—ï¼‰',
    to_email:        EMAILJS_TO_EMAIL
  };

  // ä¸¦è¡Œé€ä¿¡ï¼ˆEmailJS + GASï¼‰
  const emailPromise = sendViaEmailJS(payload);
  const gasPromise   = sendViaGAS(payload);

  Promise.allSettled([emailPromise, gasPromise]).then(results => {
    // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤éè¡¨ç¤º
    document.getElementById('submitOverlay').classList.remove('show');

    const emailOk = results[0].status === 'fulfilled';
    const gasOk   = results[1].status === 'fulfilled';

    // STEP 8 ã«é·ç§»
    goToStep(8);

    // çµæœãƒãƒŠãƒ¼è¡¨ç¤º
    setTimeout(() => {
      const banner = document.getElementById('submitResultBanner');
      if(!banner) return;
      if(emailOk && gasOk) {
        banner.className = 'submit-result-banner success';
        banner.innerHTML = 'âœ… é€ä¿¡å®Œäº†ï¼<br>æ‹…å½“è€…ã¸ã®ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®è¨˜éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸã€‚<br>ãŠç´„æŸã®ãŠæ™‚é–“ã«ãªã‚Šã¾ã—ãŸã‚‰æ‹…å½“è€…ãŒãŠä¼ºã„ã„ãŸã—ã¾ã™ã€‚';
      } else if(emailOk || gasOk) {
        banner.className = 'submit-result-banner success';
        const detail = emailOk ? 'ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã¯é€ä¿¡æ¸ˆã¿ã§ã™ã€‚' : 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®è¨˜éŒ²ã¯å®Œäº†ã—ã¾ã—ãŸã€‚';
        banner.innerHTML = 'âœ… é€ä¿¡å®Œäº†ï¼ˆä¸€éƒ¨ï¼‰<br>' + detail;
      } else {
        banner.className = 'submit-result-banner error';
        banner.innerHTML = 'âš ï¸ é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>ãŠæ‰‹æ•°ã§ã™ãŒ <strong>ğŸ“ 0120-315-312</strong> ã¾ã§ãŠé›»è©±ã„ãŸã ãã‹ã€ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦å†é€ä¿¡ã—ã¦ãã ã•ã„ã€‚';
        if(btn) btn.disabled = false;
      }
    }, 400);

    console.log('Email:', results[0].status, results[0].reason || '');
    console.log('GAS:',   results[1].status, results[1].reason || '');
  });
}

// ---------- EmailJS é€ä¿¡ ----------
function sendViaEmailJS(payload) {
  return new Promise((resolve, reject) => {
    // EmailJSæœªè¨­å®šãƒã‚§ãƒƒã‚¯
    if(EMAILJS_PUBLIC_KEY === 'YOUR_PUBLIC_KEY') {
      console.warn('EmailJS: æœªè¨­å®šã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
      return reject('EmailJS not configured');
    }
    emailjs.init(EMAILJS_PUBLIC_KEY);
    const templateParams = {
      to_email:         payload.to_email,
      submitted_at:     payload.submitted_at,
      name:             payload.name,
      relation:         payload.relation,
      phone:            payload.phone,
      attendance:       payload.attendance,
      funeral_type:     payload.funeral_type,
      plan_name:        payload.plan_name,
      hall_name:        payload.hall_name,
      hall_address:     payload.hall_address,
      hall_access:      payload.hall_access,
      course_name:      payload.course_name,
      member_status:    payload.member_status,
      price_estimate:   payload.price_estimate,
      wishes:           payload.wishes,
      chat_log:         payload.chat_log,
      estimate_detail:  payload.estimate_detail || ''
    };
    emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams)
      .then(() => resolve('email_ok'))
      .catch(err => reject(err));
  });
}

// ---------- Google Apps Script é€ä¿¡ ----------
function sendViaGAS(payload) {
  return new Promise((resolve, reject) => {
    // GASæœªè¨­å®šãƒã‚§ãƒƒã‚¯
    if(GAS_WEBHOOK_URL === 'YOUR_GAS_WEBHOOK_URL') {
      console.warn('GAS: æœªè¨­å®šã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
      return reject('GAS not configured');
    }
    fetch(GAS_WEBHOOK_URL, {
      method: 'POST',
      mode: 'no-cors', // GASã¯no-corsã§é€ä¿¡
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(() => resolve('gas_ok'))
    .catch(err => reject(err));
  });
}

function printPage() {
  // å°åˆ·æ—¥æ™‚ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã‚»ãƒƒãƒˆ
  const now = new Date();
  const dateStr = now.getFullYear() + 'å¹´' +
    String(now.getMonth()+1).padStart(2,'0') + 'æœˆ' +
    String(now.getDate()).padStart(2,'0') + 'æ—¥ ' +
    String(now.getHours()).padStart(2,'0') + ':' +
    String(now.getMinutes()).padStart(2,'0') +
    ' ä½œæˆ';
  const pd = document.getElementById('printDate');
  if(pd) pd.textContent = dateStr + 'ã€€ğŸ“ 0120-315-312';
  window.print();
}

// ========== è¦‹ç©ã‚‚ã‚Šãƒ¡ãƒ¼ãƒ«è‡ªå‹•é€ä¿¡ ==========
async function sendEstimateEmail() {
  const hall = state.selectedHall;
  const plan = state.selectedPlan;
  const course = state.selectedCourse;

  // EmailJSæœªè¨­å®šãƒã‚§ãƒƒã‚¯
  if(EMAILJS_PUBLIC_KEY === 'YOUR_PUBLIC_KEY') {
    showEstimateEmailBanner('warning',
      'âš ï¸ EmailJSãŒæœªè¨­å®šã§ã™ã€‚<br>' +
      'HTMLãƒ•ã‚¡ã‚¤ãƒ«å†…ã® <code>EMAILJS_SERVICE_ID</code>ãƒ»<code>EMAILJS_TEMPLATE_ID</code>ãƒ»<code>EMAILJS_PUBLIC_KEY</code> ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚<br>' +
      '<a href="https://www.emailjs.com/" target="_blank" style="color:#1565c0;">â–¶ EmailJSè¨­å®šãƒšãƒ¼ã‚¸ã¸</a>'
    );
    return;
  }
  if(!hall || !plan || !course) {
    showEstimateEmailBanner('error', 'âš ï¸ è¦‹ç©ã‚‚ã‚ŠãŒå®Œæˆã—ã¦ã„ã¾ã›ã‚“ã€‚å„ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚');
    return;
  }

  const btn = document.getElementById('sendEstimateEmailBtn');
  if(btn) { btn.disabled = true; btn.textContent = 'â³ é€ä¿¡ä¸­...'; }

  // ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰çµ„ã¿ç«‹ã¦ï¼ˆsubmitAndCompleteã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
  const courseInfo = COURSES[course] || {};
  const priceType  = (hall.special === 'living') ? 'living' : (plan.priceType || hall.pricingType);
  const pricing    = PRICING[priceType] || PRICING.compact;
  const isSimple   = plan.isSimplePlan || course === 'single';
  let prices;
  if(isSimple) {
    const sp = PRICING[priceType] || PRICING.chokuso;
    prices = sp ? sp.single : [198000, 248000];
  } else {
    prices = pricing[course] || pricing.ai || [0,0];
  }
  const isMember  = state.isMember === 'yes' || state.isMember === 'join';
  const basePrice = isMember ? prices[0] : prices[1];
  const attendHosp = { under5:100000, under15:150000, '15to30':250000, '30to50':400000, over50:600000 };
  const hospEst   = isSimple ? 30000 : (attendHosp[state.attendance] || 200000);
  const totalEst  = basePrice + hospEst;
  const memberTag = isMember ? 'ä¼šå“¡ä¾¡æ ¼' : 'ä¸€èˆ¬ä¾¡æ ¼';

  const chatLog = chatState.log.length > 0
    ? chatState.log.map(l => (l.role==='bot'?'[æ‹…å½“AI] ':'[ãŠå®¢æ§˜] ') + l.msg).join('\n')
    : 'ï¼ˆãªã—ï¼‰';

  const now = new Date();
  const dateStr = now.getFullYear() + '/' +
    String(now.getMonth()+1).padStart(2,'0') + '/' +
    String(now.getDate()).padStart(2,'0') + ' ' +
    String(now.getHours()).padStart(2,'0') + ':' +
    String(now.getMinutes()).padStart(2,'0');

  // è¦‹ç©ã‚‚ã‚Šè©³ç´°ãƒ†ã‚­ã‚¹ãƒˆï¼ˆãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ç”¨ï¼‰
  const estimateDetail = [
    'ã€ãŠå®¢æ§˜æƒ…å ±ã€‘',
    'ãŠåå‰ï¼š' + (state.name || 'æœªå…¥åŠ›'),
    'ç¶šæŸ„ï¼š' + getRelationLabel(state.relation),
    'é›»è©±ç•ªå·ï¼š' + (state.phone || 'æœªå…¥åŠ›'),
    'å‚åˆ—äºˆå®šäººæ•°ï¼š' + getAttendanceLabel(state.attendance),
    'è‘¬å„€å½¢å¼ï¼š' + getFuneralTypeLabel(state.funeralType),
    '',
    'ã€é¸æŠå†…å®¹ã€‘',
    'ãƒ—ãƒ©ãƒ³ï¼š' + (plan.name || ''),
    'ä¼šå ´ï¼š' + (hall.name || '') + 'ã€€' + (hall.address || ''),
    'ç¥­å£‡ã‚³ãƒ¼ã‚¹ï¼š' + (isSimple ? 'ï¼ˆç›´è‘¬ãƒ»ç«è‘¬å¼ã®ãŸã‚ã‚³ãƒ¼ã‚¹ãªã—ï¼‰' : (courseInfo.name || course)),
    'ä¼šå“¡åŒºåˆ†ï¼š' + getMemberLabel(state.isMember),
    '',
    'ã€è²»ç”¨ç›®å®‰ã€‘',
    (isSimple ? 'ç›´è‘¬ãƒ»ç«è‘¬è²»ç”¨' : 'è‘¬å„€åŸºæœ¬ã‚»ãƒƒãƒˆ') + 'ï¼š' + formatPrice(basePrice) + 'ï¼ˆ' + memberTag + 'ï¼‰',
    (isSimple ? 'æ¬é€è²»ç›®å®‰' : 'ãŠã‚‚ã¦ãªã—è²»ç”¨ç›®å®‰') + 'ï¼š' + formatPrice(hospEst),
    'åˆè¨ˆç›®å®‰ï¼š' + formatPrice(totalEst),
    '',
    'ã€ã”å¸Œæœ›ãƒ»å‚™è€ƒã€‘',
    state.wishes || 'ï¼ˆãªã—ï¼‰',
    '',
    'ã€ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã€‘',
    chatLog
  ].join('\n');

  const payload = {
    submitted_at:     dateStr,
    name:             state.name || 'æœªå…¥åŠ›',
    relation:         getRelationLabel(state.relation),
    phone:            state.phone || 'æœªå…¥åŠ›',
    attendance:       getAttendanceLabel(state.attendance),
    funeral_type:     getFuneralTypeLabel(state.funeralType),
    plan_name:        plan.name || '',
    hall_name:        hall.name || '',
    hall_address:     hall.address || '',
    hall_access:      hall.access || '',
    course_name:      isSimple ? 'ï¼ˆç›´è‘¬ãƒ»ç«è‘¬å¼ï¼‰' : (courseInfo.name || ''),
    member_status:    getMemberLabel(state.isMember),
    price_estimate:   formatPrice(totalEst) + 'ï¼ˆç›®å®‰ï¼‰',
    wishes:           state.wishes || 'ï¼ˆãªã—ï¼‰',
    chat_log:         chatLog,
    to_email:         EMAILJS_TO_EMAIL,
    estimate_detail:  estimateDetail
  };

  try {
    await sendViaEmailJS(payload);
    showEstimateEmailBanner('success',
      'âœ… ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†ï¼<br>' +
      '<strong>' + EMAILJS_TO_EMAIL + '</strong> ã«è¦‹ç©ã‚‚ã‚Šå†…å®¹ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚<br>' +
      'æ‹…å½“è€…ã‚ˆã‚Šã”é€£çµ¡ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚'
    );
    // é€ä¿¡æ¸ˆã¿ãƒ•ãƒ©ã‚°
    if(btn) { btn.textContent = 'âœ… é€ä¿¡æ¸ˆã¿'; btn.style.background = '#4caf50'; }
  } catch(err) {
    console.error('è¦‹ç©ã‚‚ã‚Šãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼:', err);
    let msg = 'âŒ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>';
    if(err === 'EmailJS not configured') {
      msg += 'EmailJSãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚SERVICE_IDãƒ»TEMPLATE_IDãƒ»PUBLIC_KEYã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
    } else if(err && err.status === 400) {
      msg += 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°åãŒä¸€è‡´ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚EmailJSãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
    } else if(err && err.status === 401) {
      msg += 'PUBLIC_KEYãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚EmailJSãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
    } else {
      msg += 'ãŠæ‰‹æ•°ã§ã™ãŒ <strong>ğŸ“ 0120-315-312</strong> ã¾ã§ãŠé›»è©±ãã ã•ã„ã€‚<br>';
      msg += '<small style="color:#999;">' + JSON.stringify(err) + '</small>';
    }
    showEstimateEmailBanner('error', msg);
    if(btn) { btn.disabled = false; btn.textContent = 'âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«é€ä¿¡'; }
  }
}

function showEstimateEmailBanner(type, html) {
  const el = document.getElementById('estimateEmailBanner');
  if(!el) return;
  const styles = {
    success: 'background:#e8f5e9; border:2px solid #4caf50; color:#1b5e20;',
    error:   'background:#ffebee; border:2px solid #f44336; color:#b71c1c;',
    warning: 'background:#fff8e1; border:2px solid #ffa000; color:#e65100;'
  };
  el.style.cssText = 'display:block; margin-top:12px; padding:14px 16px; border-radius:10px; font-size:0.9rem; font-weight:bold; line-height:1.8; ' + (styles[type] || styles.warning);
  el.innerHTML = html;
  el.scrollIntoView({ behavior:'smooth', block:'nearest' });
}

// ========== PDFä¿å­˜ï¼ˆhtml2canvas + jsPDFï¼‰ ==========
async function downloadEstimatePDF() {
  const btn = event.currentTarget;
  btn.textContent = 'â³ ç”Ÿæˆä¸­...';
  btn.disabled = true;
  try {
    // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå‹•çš„ãƒ­ãƒ¼ãƒ‰
    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');

    const el = document.getElementById('estimateCard');
    const canvas = await html2canvas(el, { scale: 2, useCORS: true, backgroundColor: '#fff' });
    const imgData = canvas.toDataURL('image/jpeg', 0.92);

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();
    const margin = 12;
    const imgW = pageW - margin * 2;
    const imgH = (canvas.height / canvas.width) * imgW;

    // ã‚¿ã‚¤ãƒˆãƒ«
    pdf.setFontSize(13);
    pdf.setTextColor(92, 61, 46);
    pdf.text('âš˜ ã•ã„ãè‘¬ç¥­ ãŠè¦‹ç©ã‚‚ã‚Š', margin, 14);
    const now2 = new Date();
    pdf.setFontSize(9);
    pdf.setTextColor(150,150,150);
    pdf.text(now2.getFullYear()+'å¹´'+String(now2.getMonth()+1).padStart(2,'0')+'æœˆ'+String(now2.getDate()).padStart(2,'0')+'æ—¥ ä½œæˆ', pageW - margin, 14, { align:'right' });

    // è¦‹ç©ã‚«ãƒ¼ãƒ‰ç”»åƒ
    let yPos = 20;
    if(yPos + imgH <= pageH - margin) {
      pdf.addImage(imgData, 'JPEG', margin, yPos, imgW, imgH);
    } else {
      // è¤‡æ•°ãƒšãƒ¼ã‚¸åˆ†å‰²
      let remaining = imgH;
      let srcY = 0;
      while(remaining > 0) {
        const sliceH = Math.min(remaining, pageH - margin - yPos);
        const sliceCanvas = document.createElement('canvas');
        sliceCanvas.width = canvas.width;
        sliceCanvas.height = (sliceH / imgW) * canvas.width;
        const ctx = sliceCanvas.getContext('2d');
        ctx.drawImage(canvas, 0, srcY * (canvas.width / imgW), canvas.width, sliceCanvas.height, 0, 0, canvas.width, sliceCanvas.height);
        pdf.addImage(sliceCanvas.toDataURL('image/jpeg',0.92), 'JPEG', margin, yPos, imgW, sliceH);
        remaining -= sliceH;
        srcY += sliceH;
        if(remaining > 0) { pdf.addPage(); yPos = margin; }
      }
    }

    // ãƒ•ãƒƒã‚¿ãƒ¼
    pdf.setFontSize(8);
    pdf.setTextColor(150,150,150);
    pdf.text('ğŸ“ 0120-315-312 | https://saiki-sousai.com/', margin, pageH - 6);

    const fname = 'saiki_estimate_' + now2.getFullYear() + String(now2.getMonth()+1).padStart(2,'0') + String(now2.getDate()).padStart(2,'0') + '.pdf';
    pdf.save(fname);
  } catch(e) {
    alert('PDFç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\nå°åˆ·ãƒœã‚¿ãƒ³ã‹ã‚‰PDFä¿å­˜ã‚‚ãŠè©¦ã—ãã ã•ã„ã€‚');
    console.error(e);
  } finally {
    btn.textContent = 'ğŸ“„ PDFä¿å­˜';
    btn.disabled = false;
  }
}

function loadScript(src) {
  return new Promise((resolve, reject) => {
    if(document.querySelector(`script[src="${src}"]`)) { resolve(); return; }
    const s = document.createElement('script');
    s.src = src; s.onload = resolve; s.onerror = reject;
    document.head.appendChild(s);
  });
}

// ========== LINEå…±æœ‰ ==========
function shareToLINE() {
  const hall = state.selectedHall;
  const plan = state.selectedPlan;
  const course = state.selectedCourse;
  if(!hall || !plan) { alert('å…ˆã«è¦‹ç©ã‚‚ã‚Šã‚’å®Œæˆã•ã›ã¦ãã ã•ã„ã€‚'); return; }

  const priceType = (hall.special === 'living') ? 'living' : (plan.priceType || hall.pricingType);
  const pricing = PRICING[priceType] || PRICING.compact;
  const isSimple = plan.isSimplePlan || course === 'single';
  let prices;
  if(isSimple) {
    const sp = PRICING[priceType] || PRICING.chokuso;
    prices = sp ? sp.single : [198000, 248000];
  } else {
    prices = pricing[course] || [0,0];
  }
  const isMember = state.isMember === 'yes' || state.isMember === 'join';
  const basePrice = isMember ? prices[0] : prices[1];
  const attendHosp = { under5:100000, under15:150000, '15to30':250000, '30to50':400000, over50:600000 };
  const hospEst = isSimple ? 30000 : (attendHosp[state.attendance] || 200000);
  const total = basePrice + hospEst;

  const courseName = isSimple ? 'ï¼ˆã‚³ãƒ¼ã‚¹é¸æŠãªã—ï¼‰' : (COURSES[course] ? COURSES[course].name : course);
  const memberTag = isMember ? 'ã€ä¼šå“¡ä¾¡æ ¼ã€‘' : 'ã€ä¸€èˆ¬ä¾¡æ ¼ã€‘';

  const text = [
    'âš˜ ã•ã„ãè‘¬ç¥­ ãŠè¦‹ç©ã‚‚ã‚Š',
    'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
    `ğŸ“‹ ${state.name || ''}æ§˜`,
    `ğŸ› ${plan.name} / ${hall.name}`,
    `âš˜ ${courseName}`,
    `ğŸ’° ç·åˆè¨ˆç›®å®‰: ${formatPrice(total)} ${memberTag}`,
    'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
    'â€»é‡‘é¡ã¯ç›®å®‰ã§ã™ã€‚ä¸è¦ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯å‰Šé™¤å¯èƒ½ã§ã™ã€‚',
    'ğŸ“ 0120-315-312ï¼ˆ24æ™‚é–“å—ä»˜ï¼‰',
    'https://saiki-sousai.com/'
  ].join('\n');

  const url = 'https://line.me/R/msg/text/?' + encodeURIComponent(text);
  window.open(url, '_blank');
}

// ========== localStorage é€”ä¸­ä¿å­˜ ==========
const SAVE_KEY = 'saiki_form_draft';

function saveFormData() {
  try {
    const draft = {
      state: {
        name: state.name, relation: state.relation,
        attendance: state.attendance, funeralType: state.funeralType,
        isMember: state.isMember, wishes: state.wishes,
        selectedPlan: state.selectedPlan ? state.selectedPlan.id : null,
        selectedHall: state.selectedHall ? state.selectedHall.id : null,
        selectedCourse: state.selectedCourse,
        currentStep: state.currentStep
      },
      savedAt: new Date().toISOString()
    };
    localStorage.setItem(SAVE_KEY, JSON.stringify(draft));
    showAutoSaveBanner('ğŸ’¾ å…¥åŠ›å†…å®¹ã‚’è‡ªå‹•ä¿å­˜ã—ã¾ã—ãŸ');
  } catch(e) { console.warn('è‡ªå‹•ä¿å­˜å¤±æ•—:', e); }
}

function loadFormData() {
  try {
    const raw = localStorage.getItem(SAVE_KEY);
    if(!raw) return false;
    const draft = JSON.parse(raw);
    if(!draft || !draft.state) return false;
    const saved = draft.state;
    const savedAt = draft.savedAt ? new Date(draft.savedAt) : null;
    const now = new Date();
    if(savedAt && (now - savedAt) > 48 * 60 * 60 * 1000) {
      localStorage.removeItem(SAVE_KEY); return false;
    }
    // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    const dateStr = savedAt ? (savedAt.getMonth()+1)+'æœˆ'+savedAt.getDate()+'æ—¥ '+String(savedAt.getHours()).padStart(2,'0')+':'+String(savedAt.getMinutes()).padStart(2,'0') : '';
    const msg = `å‰å›ã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼ˆ${dateStr}ä¿å­˜ï¼‰ã€‚\nç¶šãã‹ã‚‰å†é–‹ã—ã¾ã™ã‹ï¼Ÿ`;
    if(!confirm(msg)) { localStorage.removeItem(SAVE_KEY); return false; }
    // stateã‚’å¾©å…ƒ
    state.name = saved.name || '';
    state.relation = saved.relation || '';
    state.attendance = saved.attendance || '';
    state.funeralType = saved.funeralType || '';
    state.isMember = saved.isMember || '';
    state.wishes = saved.wishes || '';
    if(saved.selectedPlan) {
      // planã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å†å–å¾—ï¼ˆPLANSå†…ã‚’æ¤œç´¢ï¼‰
      for(const k in PLANS){ if(PLANS[k].id === saved.selectedPlan){ state.selectedPlan = PLANS[k]; break; } }
    }
    if(saved.selectedHall) {
      state.selectedHall = HALLS[saved.selectedHall] || null;
    }
    state.selectedCourse = saved.selectedCourse || null;
    const step = Math.max(1, Math.min(saved.currentStep || 1, 7));
    showAutoSaveBanner('âœ… å‰å›ã®å…¥åŠ›å†…å®¹ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
    return step;
  } catch(e) { console.warn('å¾©å…ƒå¤±æ•—:', e); return false; }
}

function clearSavedData() {
  localStorage.removeItem(SAVE_KEY);
  showAutoSaveBanner('ğŸ—‘ ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  setTimeout(() => {
    const b = document.getElementById('autoSaveBanner');
    if(b) b.style.display = 'none';
  }, 2000);
}

let _saveTimer = null;
function autoSaveDebounced() {
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(() => saveFormData(), 1500);
}

function showAutoSaveBanner(msg) {
  const b = document.getElementById('autoSaveBanner');
  const m = document.getElementById('autoSaveMsg');
  if(b && m) {
    m.textContent = msg;
    b.style.display = 'flex';
    clearTimeout(b._hideTimer);
    b._hideTimer = setTimeout(() => { b.style.display = 'none'; }, 3000);
  }
}

// ========== èµ·å‹•æ™‚ï¼šé€”ä¸­ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ ==========
(function initApp() {
  const savedStep = loadFormData();
  if(savedStep && savedStep > 1) {
    // ç¾åœ¨ã®step1ã‚’hideã—ã¦ä¿å­˜æ¸ˆã¿stepã¸é·ç§»
    document.getElementById('step1').classList.remove('active');
    document.getElementById('dot1').classList.remove('active');
    // 1ã€œsavedStep-1 ã‚’ done ã«ã™ã‚‹
    for(let i = 1; i < savedStep; i++) {
      const dot = document.getElementById('dot'+i);
      if(dot) { dot.classList.remove('active'); dot.classList.add('done'); }
      const con = document.getElementById('con'+i);
      if(con) con.classList.add('done');
    }
    state.currentStep = savedStep;
    const stepEl = document.getElementById('step'+savedStep);
    if(stepEl) stepEl.classList.add('active');
    const dotEl = document.getElementById('dot'+savedStep);
    if(dotEl) { dotEl.classList.add('active'); dotEl.classList.remove('done'); }
    // ã‚¹ãƒ†ãƒƒãƒ—å›ºæœ‰ã®æç”»
    if(savedStep === 3) renderPlans();
    if(savedStep === 4) renderHalls();
    if(savedStep === 5) renderCourses();
    if(savedStep === 7) renderEstimate();
  }
})();
</script>
</body>
</html>
